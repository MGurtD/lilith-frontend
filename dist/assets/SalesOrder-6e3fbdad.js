import{d as Q,j as ee,C as te,T as ae,r as g,h as y,a as v,c as V,k as t,e as c,i as s,s as P,n as H,l as E,D as Z,p as ke,b as we,f as re,x as Ie,w as u,Q as Se,H as S,R,P as X,G as x,m as G,L as oe,ah as Ce,F as C,v as ge,g as he,u as Ne,E as Te,o as xe,X as Ee,I as q,J as Ve}from"./index-d4f01faf.js";import{u as se}from"./order-9c20d57c.js";import{u as le}from"./reference-1f2c96f9.js";import{u as de}from"./customers-728aaa3d.js";import{u as Be}from"./plantmodel-8bfb9a3a.js";import{u as ie}from"./lifecycle-1f6a3992.js";import{u as Fe}from"./tax-fdd31c7a.js";import{c as $e,a as j,F as Re}from"./form-validator-e18d88f5.js";import{u as ne}from"./deliveryNote-4827cd92.js";import{u as ue}from"./budget-54cde807.js";import{_ as We}from"./FormBudgetOrderDetail.vue_vue_type_script_setup_true_lang-1ad718a0.js";import{L as Me}from"./LinkReference-8502fbe8.js";import{_ as Ae}from"./FormCreateWorkorder.vue_vue_type_script_setup_true_lang-c35e3c34.js";import{u as ce}from"./workmaster-3649af81.js";import{u as me}from"./workorder-78c0d402.js";import{F as Ue}from"./FileEntityPicker-8c490b5e.js";import{a as Le,b as qe}from"./report.service-f31ba490.js";import{S as Ge}from"./index-4ca6dbb1.js";import"./index-402f70f9.js";import"./DropdownReference.vue_vue_type_script_setup_true_lang-9e7acd0e.js";const Y=B=>(ke("data-v-9ef3c9d3"),B=B(),we(),B),ze={key:0},Pe={class:"four-columns mt-2"},je=Y(()=>c("label",{class:"block text-900 mb-2"},"Client",-1)),Xe=Y(()=>c("label",{class:"block text-900 mb-2"},"Estat",-1)),Ye={class:"four-columns mt-2"},He=Y(()=>c("label",{class:"block text-900 mb-2"},"Data Alta",-1)),Qe=Y(()=>c("label",{class:"block text-900 mb-2"},"Data Entrega",-1)),Je=Q({__name:"FormSalesOrder",emits:["submit","cancel"],setup(B,{expose:D,emit:O}){const W=se(),F=de(),h=ie(),k=ne(),p=ue(),_=ee(),{salesOrder:r}=te(W),f=ae(()=>k.deliveryNote?k.deliveryNote.number:""),M=$e().shape({siteId:j().required("L'origen es obligatori"),customerId:j().required("El client es obligatori"),statusId:j().required("L'estat es obligatori"),exerciseId:j().required("L'exercici es obligatori")}),w=g({result:!1,errors:{}}),N=()=>{const a=new Re(M);w.value=a.validate(r.value)};D({submitForm:async()=>{if(N(),w.value.result)U(),O("submit",r.value);else{let a="";Object.entries(w.value.errors).forEach(e=>{a+=`${e[1].map(i=>i)}.   `}),_.add({severity:"warn",summary:"Formulari inválid",detail:a,life:5e3})}}});const $=()=>{var e;const a=(e=F.customers)==null?void 0:e.find(i=>{var m;return i.id===((m=r.value)==null?void 0:m.customerId)});a&&r.value&&(r.value.customerCode=a.code,r.value.customerComercialName=a.comercialName,r.value.customerTaxName=a.taxName,r.value.customerVatNumber=a.vatNumber,r.value.customerAccountNumber=a.accountNumber)},U=()=>{r.value&&(r.value.date=Z(r.value.date),r.value.expectedDate&&(r.value.expectedDate=Z(r.value.expectedDate)))};return(a,e)=>{var T,o;const i=y("BaseInput"),m=y("Dropdown"),I=y("Calendar");return v(),V("div",null,[t(r)?(v(),V("form",ze,[c("section",Pe,[c("div",null,[s(i,{type:t(P).TEXT,label:"Num. Comanda",id:"salesOrderNumber",modelValue:t(r).number,"onUpdate:modelValue":e[0]||(e[0]=n=>t(r).number=n),disabled:""},null,8,["type","modelValue"])]),c("div",null,[je,s(m,{modelValue:t(r).customerId,"onUpdate:modelValue":[e[1]||(e[1]=n=>t(r).customerId=n),e[2]||(e[2]=n=>$())],editable:"",options:t(F).customers,optionValue:"id",optionLabel:"comercialName",class:H(["w-full",{"p-invalid":w.value.errors.customerId}])},null,8,["modelValue","options","class"])]),c("div",null,[s(i,{type:t(P).TEXT,label:"Comanda Client",id:"customerSalesOrderNumber",modelValue:t(r).customerNumber,"onUpdate:modelValue":e[3]||(e[3]=n=>t(r).customerNumber=n)},null,8,["type","modelValue"])]),c("div",null,[Xe,s(m,{modelValue:t(r).statusId,"onUpdate:modelValue":e[4]||(e[4]=n=>t(r).statusId=n),editable:"",options:(T=t(h).lifecycle)==null?void 0:T.statuses,optionValue:"id",optionLabel:"name",class:H(["w-full",{"p-invalid":w.value.errors.statusId}])},null,8,["modelValue","options","class"])])]),c("section",Ye,[c("div",null,[He,s(I,{modelValue:t(r).date,"onUpdate:modelValue":e[5]||(e[5]=n=>t(r).date=n),dateFormat:"dd/mm/yy"},null,8,["modelValue"])]),c("div",null,[Qe,s(I,{modelValue:t(r).expectedDate,"onUpdate:modelValue":e[6]||(e[6]=n=>t(r).expectedDate=n),dateFormat:"dd/mm/yy"},null,8,["modelValue"])]),c("div",null,[s(i,{type:t(P).TEXT,label:"Num. Pressupost",id:"budgetNumber",disabled:"",value:(o=t(p).budget)==null?void 0:o.number},null,8,["type","value"])]),c("div",null,[s(i,{type:t(P).TEXT,disabled:!0,label:"Albarà Entrega",id:"deliveryNote",modelValue:f.value,"onUpdate:modelValue":e[7]||(e[7]=n=>f.value=n)},null,8,["type","modelValue"])])])])):E("",!0)])}}});const Ke=re(Je,[["__scopeId","data-v-9ef3c9d3"]]),Ze={key:0},et={key:1},tt=["onClick"],at={class:"total"},rt={class:"total-text"},ot=Q({__name:"TableSalesOrderDetails",props:{salesOrder:{},salesOrderDetails:{}},emits:["edit","delete","createWorkOrder","openWorkOrder"],setup(B,{emit:D}){const O=B,W=Ie();le();const F=ce(),h=me(),k=ae(()=>O.salesOrderDetails?O.salesOrderDetails.reduce((a,e)=>a+e.amount,0):0);var p=void 0;const _=g({closable:!0,modal:!0,title:"Generar ordre de fabricació",visible:!1}),r=g([]),f=g({workMasterId:"",plannedDate:"",plannedQuantity:0,comment:""}),M=a=>{O.salesOrder.deliveryNoteId||a.originalEvent.target.className.includes("grid_delete_column_button")||D("edit",a.data)},w=(a,e)=>{W.require({target:a.currentTarget,message:"Está segur que vol eliminar la referència?",icon:"pi pi-question-circle",acceptIcon:"pi pi-check",rejectIcon:"pi pi-times",accept:()=>{D("delete",e)}})},N=a=>{if(!a.workOrderId)return 0;const e=h.getWorkOrderCost(a.workOrderId);return e===0?0:e/a.quantity},A=a=>{r.value=F.getByReferenceId(a.referenceId),f.value.workMasterId="",r.value.length>0&&(f.value.workMasterId=r.value[0].id),f.value.plannedQuantity=a.quantity,f.value.plannedDate=O.salesOrder.expectedDate?Ce(O.salesOrder.expectedDate):"",f.value.comment="",p=a,_.value.visible=!0},$=a=>{console.log(a),D("openWorkOrder",a)},U=()=>{const a={workOrderDto:f.value,orderDetail:p};_.value.visible=!1,D("createWorkOrder",a)};return(a,e)=>{const i=y("Column"),m=y("Button"),I=y("DataTable"),T=y("Dialog");return v(),V(oe,null,[s(I,{onRowClick:M,value:a.salesOrderDetails,tableStyle:"min-width: 100%",class:"p-datatable-sm",selectionMode:"single",dataKey:"id",sortMode:"single",sortField:"reference.code",sortOrder:1},{header:u(()=>[Se(a.$slots,"header",{},void 0,!0)]),footer:u(()=>[c("div",at,[c("span",rt,"Total "+S(t(R)(k.value)),1)])]),default:u(()=>[s(i,{field:"quantity",header:"Un.",style:{width:"3%"}}),s(i,{header:"Referencia",field:"reference.code",sortable:"",style:{width:"15%"}},{body:u(o=>[s(Me,{id:o.data.referenceId},null,8,["id"])]),_:1}),s(i,{field:"description",header:"Descripció",style:{width:"25%"}}),s(i,{field:"workOrderId",header:"Ordre fabr.",style:{width:"8%"}},{body:u(o=>[t(h).getWorkOrderCodeById(o.data.workOrderId)?(v(),V("div",Ze,[s(m,{size:"small",severity:"success",label:t(h).getWorkOrderCodeById(o.data.workOrderId),onClick:n=>$(o.data.workOrderId)},null,8,["label","onClick"])])):(v(),V("div",et,[s(m,{disabled:a.salesOrder.deliveryNoteId!==null,size:"small",icon:t(X).PLUS_CIRCLE,value:"Generar OF",onClick:n=>A(o.data)},null,8,["disabled","icon","onClick"])]))]),_:1}),s(i,{field:"unitCost",header:"Cost un. teo.",style:{width:"8%"}},{body:u(o=>[x(S(t(R)(o.data.unitCost)),1)]),_:1}),s(i,{field:"totalCost",header:"Cost teòric",style:{width:"8%"}},{body:u(o=>[x(S(t(R)(o.data.totalCost)),1)]),_:1}),s(i,{header:"Cost un. r.",style:{width:"8%"}},{body:u(o=>[x(S(t(R)(N(o.data))),1)]),_:1}),s(i,{header:"Cost real",style:{width:"6%"}},{body:u(o=>[x(S(t(R)(t(h).getWorkOrderCost(o.data.workOrderId))),1)]),_:1}),s(i,{field:"discount",header:"% Bene.",style:{width:"6%"}},{body:u(o=>[x(S(o.data.profit)+" % ",1)]),_:1}),s(i,{field:"profit",header:"% Desc.",style:{width:"6%"}},{body:u(o=>[x(S(o.data.discount)+" % ",1)]),_:1}),s(i,{header:"Preu un.",style:{width:"6%"}},{body:u(o=>[x(S(t(R)(o.data.unitPrice)),1)]),_:1}),s(i,{field:"amount",header:"Total",style:{width:"6%"}},{body:u(o=>[x(S(t(R)(o.data.amount)),1)]),_:1}),a.salesOrder.deliveryNoteId?E("",!0):(v(),G(i,{key:0,style:{width:"5%"}},{body:u(o=>[!o.data.isDelivered&&!o.data.workOrderId?(v(),V("i",{key:0,class:H([t(X).TIMES,"grid_delete_column_button"]),onClick:n=>w(n,o.data)},null,10,tt)):E("",!0)]),_:1}))]),_:3},8,["value"]),s(T,{closable:_.value.closable,visible:_.value.visible,"onUpdate:visible":e[0]||(e[0]=o=>_.value.visible=o),header:_.value.title,modal:_.value.modal,style:{width:"50vw"}},{default:u(()=>[s(Ae,{createWorkOrderDto:f.value,"filtered-work-masters":r.value,onSubmit:U},null,8,["createWorkOrderDto","filtered-work-masters"])]),_:1},8,["closable","visible","header","modal"])],64)}}});const st=re(ot,[["__scopeId","data-v-d0fbfefc"]]),lt={class:"flex flex-wrap align-items-center justify-content-between gap-2"},dt=c("span",{class:"text-l text-900 font-bold"},"Linies de la comanda",-1),it={key:0},nt="Línia de comanda",xt=Q({__name:"SalesOrder",setup(B){const D=g(),O=g(C.EDIT),W=ge(),F=he(),h=Ne(),k=ee(),p=se(),_=de(),r=Be(),f=Te(),M=ie(),w=le(),N=ne(),A=ce(),$=me(),U=Fe(),a=ue(),{salesOrder:e}=te(p),i=[{label:"Descarregar",icon:X.FILE_WORD,command:()=>_e()}],m=g(!1),I=g(C.EDIT),T=g(void 0),o=async()=>{const l=W.params.id;await p.GetById(l),w.fetchReferencesByModule("sales"),M.fetchOneByName("SalesOrder"),r.fetchSites(),f.fetchAll(),_.fetchCustomers(),U.fetchAll(),$.fetchBySalesOrder(l),A.workmasters||A.fetchAllActives();let d="";e.value&&(O.value=C.EDIT,d=`Comanda ${e.value.number}`,e.value.date=q(e.value.date),e.value.expectedDate&&(e.value.expectedDate=q(e.value.expectedDate)),e.value.deliveryNoteId?N.GetById(e.value.deliveryNoteId):N.deliveryNote&&(N.deliveryNote=void 0),e.value.budgetId?await a.GetById(e.value.budgetId):a.budget=void 0),h.setMenuItem({icon:X.BUILDING,backButtonVisible:!0,title:d})};xe(async()=>{await o()});const n=()=>{D.value.submitForm()},J=(l,d)=>{l===C.CREATE&&(d={id:Ve(),referenceId:"",quantity:1,profit:0,discount:0,unitCost:0,serviceCost:0,transportCost:0,unitPrice:0,totalCost:0,amount:0,salesOrderHeaderId:"",lastCost:0,workMasterCost:0,description:"",estimatedDeliveryDate:new Date,isDelivered:!1,isInvoiced:!1,workMasterId:null,workOrderId:null}),d.salesOrderHeaderId=e.value.id,T.value=Object.assign({},d),I.value=l,m.value=!0},ve=async l=>{let d=!1,b="";d=await p.Update(l.id,l),b=d?"Comanda actualitzada":"Error a l'actualitzar la comanda",k.add({life:5e3,severity:d?"success":"error",summary:b}),d&&F.back()},pe=async l=>{if(l=l,I.value===C.CREATE)await p.CreateDetail(l);else if(I.value===C.EDIT){await p.UpdateDetail(l);const d=e.value.salesOrderDetails.findIndex(b=>b.id===l.id);e.value.salesOrderDetails[d]=l}m.value=!1,e.value&&(e.value.date=q(e.value.date),e.value.expectedDate&&(e.value.expectedDate=q(e.value.expectedDate)))},fe=async l=>{O.value===C.EDIT&&await p.DeleteDetail(l);const d=e.value.salesOrderDetails.filter(b=>b.id!==l.id);e.value.salesOrderDetails=d,m.value=!1,e.value.date=q(e.value.date)},be=async l=>{const d=await $.create(l.workOrderDto);d.result?(l.orderDetail.workOrderId=d.content.id,await p.UpdateDetail(l.orderDetail)&&(k.add({severity:"success",summary:"Generació OF",detail:`Ordre de fabricació ${d.content.code} generada`,life:5e3}),$.fetchBySalesOrder(e.value.id))):k.add({severity:"error",summary:"Generació OF",detail:"Error al generar la ordre de fabricació",life:5e3})},ye=l=>{F.push({path:`/workorder/${l}`})},_e=async()=>{var d;const l=await Ge.SalesOrder.GetReportDataById(e.value.id);if(l){const b=`Comanda_${(d=e.value)==null?void 0:d.number}.docx`,L=await new qe().Download(l,Le.Order,b);L?Ee(b,L):k.add({severity:"warn",summary:"Error",detail:"No s'ha pugut generar fulla de la comanda"})}};return(l,d)=>{const b=y("SplitButton"),K=y("Button"),L=y("TabPanel"),Oe=y("TabView"),De=y("Dialog");return v(),V(oe,null,[s(b,{label:"Guardar",onClick:n,model:i,size:"small",class:"grid_add_row_button"}),s(Ke,{class:"mt-3 mb-3",ref_key:"salesOrderForm",ref:D,salesOrder:"salesOrder",onSubmit:ve},null,512),s(Oe,null,{default:u(()=>[s(L,{header:"Detall"},{default:u(()=>[t(e)?(v(),G(st,{key:0,salesOrder:t(e),salesOrderDetails:t(e).salesOrderDetails,onEdit:d[1]||(d[1]=z=>J(t(C).EDIT,z)),onDelete:fe,onCreateWorkOrder:be,onOpenWorkOrder:ye},{header:u(()=>[c("div",lt,[dt,t(N).deliveryNote?E("",!0):(v(),V("section",it,[s(K,{size:"small",label:"Afegir línea",onClick:d[0]||(d[0]=z=>J(t(C).CREATE,{})),class:"mr-2"})]))])]),_:1},8,["salesOrder","salesOrderDetails"])):E("",!0)]),_:1}),s(L,{header:"Fitxers"},{default:u(()=>[t(e)?(v(),G(Ue,{key:0,entity:"SalesOrder",id:t(e).id,title:""},null,8,["id"])):E("",!0)]),_:1})]),_:1}),t(e)?(v(),G(De,{key:0,closable:!0,visible:m.value,"onUpdate:visible":d[2]||(d[2]=z=>m.value=z),header:nt,style:{width:"80%"},modal:!0},{default:u(()=>[T.value?(v(),G(We,{key:0,formAction:I.value,header:t(e),detail:T.value,onSubmit:pe},null,8,["formAction","header","detail"])):E("",!0)]),_:1},8,["visible"])):E("",!0)],64)}}});export{xt as default};
