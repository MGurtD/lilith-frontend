import{u as L}from"./suppliers-cd00f0d2.js";import{u as T}from"./masterData-d1c6a4ed.js";import{d as U,j as M,r as V,h as d,a as N,c as $,e as o,i as s,k as l,x as Q,g as K,u as W,E as X,o as Z,P as R,w as b,G as ee,C,D as q,n as te,l as se}from"./index-53820b8d.js";import{c as ae,a as B,e as oe,F as ie}from"./form-validator-f8953ae6.js";import{c as re,a as F,f as le,g as ce}from"./functions-4d7ada1d.js";import{_ as ne}from"./ExerciseDatePicker.vue_vue_type_script_setup_true_lang-ba9b1f03.js";import{u as de}from"./receipt-75b6bb4a.js";import{u as ue}from"./lifecycle-3c6f7322.js";import"./suppliers.service-f3160156.js";import"./base.service-80f81d45.js";import"./index-6d4d46b9.js";import"./reference.service-f83d13c3.js";import"./_commonjsHelpers-725317a4.js";import"./v4-a960c1f4.js";import"./index-c96e9700.js";const pe={class:"mt-2"},me=o("label",{class:"block text-900 mb-2"},"Proveïdor",-1),fe={class:"mt-2"},be=o("label",{class:"block text-900 mb-2"},"Exercici",-1),_e={class:"mt-2"},ve=o("label",{class:"block text-900 mb-2"},"Data",-1),he={class:"mt-2"},ye=U({__name:"FormCreateReceipt",props:{createRequest:{}},emits:["submit"],setup(E,{emit:S}){const _=E,I=M(),r=T(),v=L(),u=ae().shape({exerciseId:B().required("L'exercici és obligatori"),supplierId:B().required("El client és obligatori"),date:oe().required("La data és obligatoria")}),p=V({result:!1,errors:{}}),g=()=>{const e=new ie(u);p.value=e.validate(_.createRequest)},h=()=>{if(g(),p.value.result)_.createRequest.date=re(_.createRequest.date),S("submit",_.createRequest);else{let e="";Object.entries(p.value.errors).forEach(c=>{e+=`${c[1].map(y=>y)}.   `}),I.add({severity:"warn",summary:"Formulari inválid",detail:e,life:5e3})}};return(e,c)=>{const y=d("Dropdown"),w=d("Calendar"),D=d("Button");return N(),$("form",null,[o("div",pe,[me,s(y,{class:"w-full",modelValue:e.createRequest.supplierId,"onUpdate:modelValue":c[0]||(c[0]=m=>e.createRequest.supplierId=m),editable:"",options:l(v).suppliers,optionValue:"id",optionLabel:"comercialName"},null,8,["modelValue","options"])]),o("div",fe,[be,s(y,{class:"w-full",modelValue:e.createRequest.exerciseId,"onUpdate:modelValue":c[1]||(c[1]=m=>e.createRequest.exerciseId=m),editable:"",options:l(r).exercises,optionValue:"id",optionLabel:"name"},null,8,["modelValue","options"])]),o("div",_e,[ve,s(w,{modelValue:e.createRequest.date,"onUpdate:modelValue":c[2]||(c[2]=m=>e.createRequest.date=m)},null,8,["modelValue"])]),o("footer",he,[s(D,{label:"Crear",onClick:h,style:{float:"right"}})])])}}}),we={class:"flex flex-wrap align-items-center justify-content-between gap-2"},xe={class:"datatable-filter"},ge={class:"filter-field"},Re={class:"filter-field"},Se=o("label",{class:"block text-900 mb-2"},"Proveïdor",-1),Ie={class:"datatable-buttons"},ke=["onClick"],je=U({__name:"Receipts",setup(E){const S=M(),_=Q(),I=K(),r=W(),v=ue(),u=de(),p=L(),g=T(),h=V({supplierId:void 0,exercise:void 0}),e=X({visible:!1,title:"Crear albarà",closable:!0,position:"center",modal:!0});Z(async()=>{r.setMenuItem({icon:R.MONEY_BILL,title:"Albarans de compra"}),p.fetchSuppliers(),v.fetchOneByName("Receipts"),await g.fetchMasterData(),await u.fetchReceipts(),c(),await w()});const c=()=>{var n;const a=new Date().getFullYear().toString(),t=(n=g.exercises)==null?void 0:n.find(f=>f.name===a);t&&(r.exercisePicker.exercise=t,r.exercisePicker.dates=[new Date(r.exercisePicker.exercise.startDate),new Date(r.exercisePicker.exercise.endDate)])},y=()=>{r.cleanExercisePicker(),h.value.supplierId=void 0},w=async()=>{if(r.exercisePicker.dates){const a=F(r.exercisePicker.dates[0]),t=F(r.exercisePicker.dates[1]);await u.fetchFiltered(a,t,h.value.supplierId)}else S.add({severity:"info",summary:"Filtre invàlid",detail:"Seleccioni un període",life:5e3})},D=a=>{var n;const t=(n=p.suppliers)==null?void 0:n.find(f=>f.id===a);return t?t.comercialName:""},m=a=>{if(v.lifecycle){const t=v.lifecycle.statuses.find(n=>n.id===a);if(t)return t.name}return""},O=()=>{k.value=j(),e.visible=!0},k=V({}),j=()=>({id:ce(),supplierId:"",exerciseId:"",date:new Date}),A=async()=>{await u.createReceipt(k.value)&&I.push({path:`/receipts/${k.value.id}`})},Y=a=>{a.originalEvent.target.className.includes("grid_delete_column_button")||I.push({path:`/receipts/${a.data.id}`})},H=(a,t)=>{_.require({target:a.currentTarget,message:`Està segur que vol eliminar l'albarà ${t.number}?`,icon:"pi pi-question-circle",acceptIcon:"pi pi-check",rejectIcon:"pi pi-times",accept:async()=>{await u.deleteReceipt(t.id)&&(S.add({severity:"success",summary:"Eliminat",life:3e3}),await w())}})};return(a,t)=>{const n=d("Dropdown"),f=d("Button"),x=d("Column"),z=d("DataTable"),G=d("Dialog");return N(),$(ee,null,[o("div",null,[s(z,{class:"small-datatable",tableStyle:"min-width: 100%",scrollable:"",scrollHeight:"75vh",sortMode:"multiple",value:l(u).receipts,onRowClick:Y},{header:b(()=>[o("div",we,[o("div",xe,[o("div",ge,[s(ne,{exercises:l(g).exercises,onRangeSelected:w},null,8,["exercises"])]),o("div",Re,[Se,s(n,{modelValue:h.value.supplierId,"onUpdate:modelValue":t[0]||(t[0]=i=>h.value.supplierId=i),editable:"",options:l(p).suppliers,optionValue:"id",optionLabel:"comercialName",class:"w-full"},null,8,["modelValue","options"])])]),o("div",Ie,[s(f,{class:"datatable-button mr-2",icon:l(R).FILTER,rounded:"",raised:"",onClick:w},null,8,["icon"]),s(f,{class:"datatable-button mr-2",icon:l(R).FILTER_SLASH,rounded:"",raised:"",onClick:y},null,8,["icon"]),s(f,{icon:l(R).PLUS,rounded:"",raised:"",onClick:O},null,8,["icon"])])])]),default:b(()=>[s(x,{field:"number",header:"Número",sortable:!0,style:{width:"10%"}}),s(x,{header:"Data",field:"date",sortable:"",style:{width:"10%"}},{body:b(i=>[C(q(l(le)(i.data.date)),1)]),_:1}),s(x,{header:"Proveïdor",style:{width:"15%"}},{body:b(i=>[C(q(D(i.data.supplierId)),1)]),_:1}),s(x,{header:"Número Albarà",style:{width:"15%"},field:"supplierNumber"}),s(x,{header:"Estat",style:{width:"15%"}},{body:b(i=>[C(q(m(i.data.statusId)),1)]),_:1}),s(x,{style:{width:"5%"}},{body:b(i=>{var P;return[((P=l(v).lifecycle)==null?void 0:P.initialStatusId)===i.data.statusId?(N(),$("i",{key:0,class:te([l(R).TIMES,"grid_delete_column_button"]),onClick:J=>H(J,i.data)},null,10,ke)):se("",!0)]}),_:1})]),_:1},8,["value"])]),s(G,{visible:e.visible,"onUpdate:visible":t[1]||(t[1]=i=>e.visible=i),header:e.title,closable:e.closable,modal:e.modal},{default:b(()=>[s(ye,{"create-request":k.value,onSubmit:A},null,8,["create-request"])]),_:1},8,["visible","header","closable","modal"])],64)}}});export{je as default};
