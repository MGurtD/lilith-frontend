import{d as N,E as J,j as A,C as K,r as S,h as D,a as C,c as k,i as a,k as i,e as r,s as q,z as P,n as L,l as U,D as ue,p as me,b as pe,f as H,g as W,v as X,o as Y,S as fe,m as Z,w as v,Q as ve,H as E,G as $,I as x,R as j,P as Q,u as _e,x as be,K as ye,F as T,J as G}from"./index-1148c571.js";import{u as M}from"./order-8249fdec.js";import{u as ee}from"./suppliers-20c934a4.js";import{_ as te}from"./DropdownLifecycle.vue_vue_type_script_setup_true_lang-ea676751.js";import{c as ae,a as O,F as se,d as he}from"./form-validator-29f20267.js";import{L as De}from"./LinkReference-6d76215a.js";import{_ as we}from"./DropdownReference.vue_vue_type_script_setup_true_lang-18049e8d.js";import{R as Ie}from"./index-7cbe1881.js";import{u as Ve}from"./reference-bb12ed1b.js";import{u as Ce}from"./lifecycle-a813ed1f.js";import{u as Re}from"./referenceType-fa06ad01.js";import"./index-f8ea6542.js";import"./suppliers.service-46dffa72.js";const F=h=>(me("data-v-0624241f"),h=h(),pe(),h),ge=F(()=>r("br",null,null,-1)),Se={key:0},Ee={class:"three-columns"},xe={class:"mt-1"},ke={class:"mt-1"},$e=F(()=>r("label",{class:"block text-900 mb-2"},"Exercici",-1)),Te={class:"mt-1"},Oe=F(()=>r("label",{class:"block text-900 mb-2"},"Data Comanda",-1)),Ne={class:"three-columns"},Ue={class:"mt-1"},Fe={class:"mt-1"},Be=F(()=>r("label",{class:"block text-900 mb-2"},"Proveïdor",-1)),qe=N({__name:"FormOrder",emits:["submit","cancel"],setup(h,{expose:w,emit:I}){const R=M(),g=ee(),p=J(),b=A(),{order:l}=K(R),s=ae().shape({supplierId:O().required("El client es obligatori"),statusId:O().required("L'estat es obligatori"),exerciseId:O().required("L'exercici es obligatori")}),d=S({result:!1,errors:{}}),y=()=>{const u=new se(s);d.value=u.validate(l.value)},n=async()=>{if(y(),d.value.result)l.value.date=ue(l.value.date),I("submit",l.value);else{let u="";Object.entries(d.value.errors).forEach(o=>{u+=`${o[1].map(m=>m)}.   `}),b.add({severity:"warn",summary:"Formulari inválid",detail:u,life:5e3})}};return w({submitForm:n}),(u,o)=>{const m=D("Button"),e=D("Dropdown"),_=D("Calendar");return C(),k("div",null,[a(m,{label:"Guardar",size:"small",class:"grid_add_row_button",onClick:n}),ge,i(l)?(C(),k("form",Se,[r("section",Ee,[r("div",xe,[a(P,{type:i(q).TEXT,label:"Número",id:"number",modelValue:i(l).number,"onUpdate:modelValue":o[0]||(o[0]=t=>i(l).number=t),disabled:""},null,8,["type","modelValue"])]),r("div",ke,[$e,a(e,{modelValue:i(l).exerciseId,"onUpdate:modelValue":o[1]||(o[1]=t=>i(l).exerciseId=t),editable:"",options:i(p).exercises,optionValue:"id",optionLabel:"name",class:L(["w-full",{"p-invalid":d.value.errors.exerciseId}])},null,8,["modelValue","options","class"])]),r("div",Te,[Oe,a(_,{modelValue:i(l).date,"onUpdate:modelValue":o[2]||(o[2]=t=>i(l).date=t),dateFormat:"dd/mm/yy"},null,8,["modelValue"])])]),r("section",Ne,[r("div",Ue,[a(te,{label:"Estat",name:"PurchaseOrder",modelValue:i(l).statusId,"onUpdate:modelValue":o[3]||(o[3]=t=>i(l).statusId=t)},null,8,["modelValue"])]),r("div",Fe,[Be,a(e,{modelValue:i(l).supplierId,"onUpdate:modelValue":o[4]||(o[4]=t=>i(l).supplierId=t),editable:"",options:i(g).suppliers,optionValue:"id",optionLabel:"comercialName",class:L(["w-full",{"p-invalid":d.value.errors.customerId}])},null,8,["modelValue","options","class"])])])])):U("",!0)])}}});const Pe=H(qe,[["__scopeId","data-v-0624241f"]]),Le=["onClick"],Qe={class:"expanded-details"},Ae=["onClick"],Me=N({__name:"TableOrderDetails",props:{details:{}},emits:["edit","delete"],setup(h,{emit:w}){const I=h,R=W(),g=X(),p=M(),b=S(void 0),l=S({}),s=S([]);Y(async()=>{var o;await p.getReceptions(g.params.id),p.receptions&&(s.value=((o=I.details)==null?void 0:o.map(m=>{var e;return{...m,receptions:(e=p.receptions)==null?void 0:e.filter(_=>_.purchaseOrderDetailId===m.id)}}))||[],console.log(s.value),b.value=await fe.Lifecycle.getByName("PurchaseOrderDetail"))});const d=o=>{if(!b.value)return"";const m=b.value.statuses.find(e=>e.id===o);return m?m.name:""},y=o=>{try{o.originalEvent.target.className.includes("grid_delete_column_button")||w("edit",o.data)}catch{}},n=(o,m)=>{w("delete",m)},u=o=>{const m=`/receipts/${o}`;R.push(m)};return(o,m)=>{const e=D("Column"),_=D("DataTable");return C(),Z(_,{onRowClick:y,value:s.value,tableStyle:"min-width: 100%",class:"p-datatable-sm","sort-mode":"single","sort-field":"reference.code","sort-order":1,dataKey:"id",expandedRows:l.value,"onUpdate:expandedRows":m[0]||(m[0]=t=>l.value=t)},{header:v(()=>[ve(o.$slots,"header",{},void 0,!0)]),expansion:v(({data:t})=>[r("div",Qe,[a(_,{value:t.receptions},{default:v(()=>[a(e,{field:"receiptDetail.receipt.number",header:"Albarà"},{body:v(({data:V})=>[r("span",{class:"link",onClick:z=>u(V.receiptDetail.receipt.id)},E(V.receiptDetail.receipt.number),9,Ae)]),_:2},1024),a(e,{field:"quantity",header:"Quantitat"}),a(e,{field:"createdOn",header:"Data"},{body:v(({data:V})=>[$(E(i(x)(V.createdOn)),1)]),_:2},1024),a(e,{field:"user",header:"Usuari"})]),_:2},1032,["value"])])]),default:v(()=>[a(e,{expander:"",style:{width:"2%"}}),a(e,{field:"quantity",header:"Quantitat",style:{width:"5%"}}),a(e,{field:"receivedQuantity",header:"Q. Rebuda",style:{width:"6%"}}),a(e,{field:"reference.code",sortable:"",header:"Material",style:{width:"40%"}},{body:v(({data:t})=>[a(De,{id:t.referenceId,category:t.reference.categoryName,fullName:!0},null,8,["id","category"])]),_:1}),a(e,{field:"statusId",header:"Estat",style:{width:"7.5%"}},{body:v(({data:t})=>[$(E(d(t.statusId)),1)]),_:1}),a(e,{field:"expectedReceiptDate",header:"Data Recepció",style:{width:"7.5%"}},{body:v(({data:t})=>[$(E(i(x)(t.expectedReceiptDate)),1)]),_:1}),a(e,{field:"unitPrice",header:"Preu Un.",style:{width:"5%"}},{body:v(({data:t})=>[$(E(i(j)(t.unitPrice)),1)]),_:1}),a(e,{field:"amount",header:"Preu",style:{width:"5%"}},{body:v(({data:t})=>[$(E(i(j)(t.amount)),1)]),_:1}),a(e,{style:{width:"5%"}},{body:v(({data:t})=>[t.receivedQuantity===0?(C(),k("i",{key:0,class:L([i(Q).TIMES,"grid_delete_column_button"]),onClick:V=>n(V,t)},null,10,Le)):U("",!0)]),_:1})]),_:3},8,["value","expandedRows"])}}});const ze=H(Me,[["__scopeId","data-v-5c28d977"]]),je={key:0},Ge={class:"three-columns"},Je=r("label",{class:"block text-900 mb-2"},"Data prevista",-1),Ke={class:"three-columns mt-2"},He=N({__name:"FormOrderDetail",props:{detail:{}},emits:["submit","cancel"],setup(h,{emit:w}){const I=h,R=A(),g=ae().shape({quantity:he().min(1).required("La quantitat ha de ser superior a 1"),referenceId:O().required("La referencia és obligatoria")}),p=S({result:!1,errors:{}}),b=()=>{const s=new se(g);p.value=s.validate(I.detail)},l=async()=>{if(b(),p.value.result)w("submit",I.detail);else{let s="";Object.entries(p.value.errors).forEach(d=>{s+=`${d[1].map(y=>y)}.   `}),R.add({severity:"warn",summary:"Formulari inválid",detail:s,life:5e3})}};return(s,d)=>{const y=D("Calendar"),n=D("Button");return s.detail?(C(),k("form",je,[r("section",Ge,[r("div",null,[a(we,{label:"Material",modelValue:s.detail.referenceId,"onUpdate:modelValue":d[0]||(d[0]=u=>s.detail.referenceId=u),fullName:!0,disabled:s.detail.receivedQuantity>0},null,8,["modelValue","disabled"])]),r("div",null,[a(te,{label:"Estat",name:"PurchaseOrderDetail",modelValue:s.detail.statusId,"onUpdate:modelValue":d[1]||(d[1]=u=>s.detail.statusId=u)},null,8,["modelValue"])]),r("div",null,[Je,a(y,{label:"Data prevista",modelValue:s.detail.expectedReceiptDate,"onUpdate:modelValue":d[2]||(d[2]=u=>s.detail.expectedReceiptDate=u),dateFormat:"dd/mm/yy"},null,8,["modelValue"])])]),r("section",Ke,[r("div",null,[a(P,{disabled:s.detail.receivedQuantity>0,type:i(q).NUMERIC,label:"Quantitat",modelValue:s.detail.quantity,"onUpdate:modelValue":d[3]||(d[3]=u=>s.detail.quantity=u)},null,8,["disabled","type","modelValue"])]),r("div",null,[a(P,{type:i(q).CURRENCY,label:"Preu",modelValue:s.detail.amount,"onUpdate:modelValue":d[4]||(d[4]=u=>s.detail.amount=u),disabled:s.detail.receivedQuantity>0},null,8,["type","modelValue","disabled"])])]),a(n,{label:"Crear",onClick:l,style:{float:"right"},size:"small",class:"mt-2"})])):U("",!0)}}}),We={key:0},Xe=r("br",null,null,-1),Ye={class:"flex flex-wrap align-items-center justify-content-between gap-2"},Ze=r("span",{class:"text-xl text-900 font-bold"},"Detall de la comanda",-1),et={key:1},ft=N({__name:"Order",setup(h){const w=W(),I=X(),R=_e(),g=be(),p=Ve(),b=Re(),l=M(),s=ee(),d=J(),y=Ce(),{order:n}=K(l),u=async()=>{var c;await l.fetchOne(I.params.id),y.lifecycle||y.fetchOneByName("PurchaseOrder"),d.exercises||d.fetchActive(),s.suppliers||s.fetchSuppliers(),b.referenceTypes||b.fetchActive(),(!p.references||p.module!=="purchase")&&p.fetchReferencesByModule("purchase"),n.value&&(n.value.date=x(n.value.date)),R.setMenuItem({icon:Q.BUILDING,title:`Comanda de compra ${(c=n.value)==null?void 0:c.number}`,backButtonVisible:!0})};Y(async()=>{await u()});const o=A(),m=async()=>{let c=!1,f="";n.value&&(c=await l.update(n.value.id,n.value),f="Comanda actualizada correctament",c&&(o.add({severity:"success",summary:f,life:5e3}),w.back()))},e=ye({visible:!1,title:"Linea",closable:!0,position:"center",modal:!0}),_=S(T.CREATE),t=S({}),V=()=>{_.value=T.CREATE,t.value={id:G(),purchaseOrderId:n.value.id,amount:0,unitPrice:0,quantity:0,receivedQuantity:0,referenceId:"",statusId:"",expectedReceiptDate:null,workOrderPhaseId:null,disabled:!1},e.title="Crear línia",e.visible=!0},z=c=>{_.value=T.EDIT,t.value=c,p.setNewReference(G(),Ie.MATERIAL),e.title="Modificar línia",e.visible=!0},oe=c=>{_.value===T.CREATE?le(c):_.value===T.EDIT&&ie(c),e.visible=!1},le=async c=>{const f=await l.createDetail(c);n.value.date=x(n.value.date),f.result||B(f)},ie=async c=>{const f=await l.updateDetail(c.id,c);n.value.date=x(n.value.date),f.result||B(f)},re=async c=>{g.require({message:"Está segur que vols la línia?",icon:"pi pi-question-circle",acceptIcon:"pi pi-check",rejectIcon:"pi pi-times",accept:async()=>{const f=await l.deleteDetail(c.id);n.value.date=x(n.value.date),f.result||B(f)}})},B=c=>{o.add({severity:"error",summary:c.errors[0],life:1e4,closable:!0})};return(c,f)=>{const ne=D("Button"),de=D("Dialog");return i(n)?(C(),k("main",We,[a(Pe,{onSubmit:m}),Xe,i(n).details?(C(),Z(ze,{key:0,details:i(n).details,onEdit:z,onDelete:re},{header:v(()=>[r("div",Ye,[Ze,r("div",null,[a(ne,{size:"small",icon:i(Q).PLUS,rounded:"",onClick:V},null,8,["icon"])])])]),_:1},8,["details"])):U("",!0),a(de,{visible:e.visible,"onUpdate:visible":f[0]||(f[0]=ce=>e.visible=ce),header:e.title,closable:e.closable,modal:e.modal},{default:v(()=>[a(He,{detail:t.value,onSubmit:oe},null,8,["detail"])]),_:1},8,["visible","header","closable","modal"])])):(C(),k("main",et,"Carregant comanda ..."))}}});export{ft as default};
