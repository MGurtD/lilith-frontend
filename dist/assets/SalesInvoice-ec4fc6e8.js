import{d as x,j,r as T,h as y,c as $,e as a,i as l,k as u,H as N,l as k,a as b,$ as E,x as ne,R as J,o as H,m as L,w as v,Q as re,n as Q,P as q,G as C,I as R,a0 as de,z as A,s as P,Z as ce,p as ue,b as me,f as ve,v as pe,g as ye,u as _e,C as be,K,W as fe,ah as De,L as he,D as Ne}from"./index-abfce291.js";import{u as Ie}from"./invoice-4d5d39ff.js";import{u as ge}from"./customers-82526395.js";import{u as z}from"./masterData-7d768ff1.js";import{u as O}from"./lifecycle-5d58652b.js";import{c as Z,a as W,d as Y,F as we}from"./form-validator-012be6a9.js";import{L as Se}from"./LinkReference-dd934e5c.js";import{u as $e}from"./deliveryNote-ccc0d717.js";import{u as Ce}from"./reference-cfffd00c.js";import{S as Ve}from"./index-f2d7d7d6.js";import{a as ke,b as Be}from"./report.service-a8e70f6a.js";const Te={key:0},Re={class:"four-columns"},Fe={class:"mt-2"},Ee={class:"mt-2"},qe=a("label",{class:"block text-900 mb-2"},"Data Factura",-1),xe={class:"mt-2"},Ue=a("label",{class:"block text-900 mb-2"},"Estat",-1),Me={class:"mt-2"},Ae=a("label",{class:"block text-900 mb-2"},"Métode Pagament",-1),Le={class:"four-columns"},ze={class:"mt-1"},Oe=a("label",{class:"block text-900 mb-2"},"Base",-1),Ge={class:"summary-field"},Pe={class:"mt-1"},je=a("label",{class:"block text-900 mb-2"},"Impostos",-1),He={class:"summary-field"},Qe={class:"mt-1"},Ke=a("label",{class:"block text-900 mb-2"},"Total",-1),We={class:"summary-field"},Ye=x({__name:"FormSalesInvoice",props:{invoice:{}},emits:["submit","cancel"],setup(f,{emit:w}){j();const c=z(),D=O();return Z().shape({invoiceDate:W().required("La data és obligatoria"),paymentMethodId:W().required("El métode de pagament és obligatori")}),T({result:!1,errors:{}}),(r,m)=>{var d;const I=y("BaseInput"),h=y("Calendar"),g=y("Dropdown");return r.invoice?(b(),$("form",Te,[a("section",Re,[a("div",Fe,[l(I,{modelValue:r.invoice.invoiceNumber,"onUpdate:modelValue":m[0]||(m[0]=e=>r.invoice.invoiceNumber=e),label:"Número",disabled:!0},null,8,["modelValue"])]),a("div",Ee,[qe,l(h,{modelValue:r.invoice.invoiceDate,"onUpdate:modelValue":m[1]||(m[1]=e=>r.invoice.invoiceDate=e),dateFormat:"dd/mm/yy"},null,8,["modelValue"])]),a("div",xe,[Ue,l(g,{modelValue:r.invoice.statusId,"onUpdate:modelValue":m[2]||(m[2]=e=>r.invoice.statusId=e),editable:"",options:(d=u(D).lifecycle)==null?void 0:d.statuses,optionValue:"id",optionLabel:"name",class:"w-full"},null,8,["modelValue","options"])]),a("div",Me,[Ae,l(g,{modelValue:r.invoice.paymentMethodId,"onUpdate:modelValue":m[3]||(m[3]=e=>r.invoice.paymentMethodId=e),editable:"",options:u(c).paymentMethods,optionValue:"id",optionLabel:"name",class:"w-full"},null,8,["modelValue","options"])])]),a("section",Le,[a("div",ze,[Oe,a("span",Ge,N(u(E)(r.invoice.baseAmount)),1)]),a("div",Pe,[je,a("span",He,N(u(E)(r.invoice.taxAmount)),1)]),a("div",Qe,[Ke,a("span",We,N(u(E)(r.invoice.netAmount)),1)])])])):k("",!0)}}}),Je=["onClick"],Ze={class:"vertical-align-middle ml-2 font-bold line-height-3"},Xe={key:0},et={key:1},tt=["onClick"],ot=x({__name:"TableInvoiceDetails",props:{details:{},deliveryNotes:{},canDelete:{type:Boolean}},emits:["delete","deleteDeliveryNote"],setup(f,{emit:w}){const c=f,D=ne(),r=O(),m=z(),I=J(()=>{let e=[];if(!c.details)return e;const i=c.details.filter(s=>!s.deliveryNoteDetailId).map(s=>({deliveryNoteId:"",deliveryNoteNumber:"Sense albarà",deliveryNoteDate:"",...s}));i.length>0&&e.push(...i);const t=c.details.filter(s=>s.deliveryNoteDetailId).map(s=>{var B;const o=(B=c.deliveryNotes)==null?void 0:B.find(F=>{var U;return F.id===((U=s.deliveryNoteDetail)==null?void 0:U.deliveryNoteId)}),n=o&&o.deliveryDate?`Entregat ${R(o.deliveryDate)}`:"No entregat";return{deliveryNoteId:o==null?void 0:o.id,deliveryNoteNumber:`Albarà ${o?`${o.number} - ${n}`:"--"}`,deliveryNoteDate:o&&o.deliveryDate?` - ${R(o.deliveryDate)}`:"",...s}});return t.length>0&&e.push(...t),console.log(t,e),de.orderBy(e,s=>s.deliveryNoteNumber)});H(async()=>{await r.fetchOneByName("SalesInvoice")});const h=e=>{var t;const i=(t=m.taxes)==null?void 0:t.find(s=>s.id===e);if(i)return`${i.name}`},g=(e,i)=>{D.require({message:`Està segur que vol eliminar la línea ${i.description}?`,icon:"pi pi-question-circle",acceptIcon:"pi pi-check",rejectIcon:"pi pi-times",accept:async()=>{w("delete",i)}})},d=(e,i)=>{if(!c.deliveryNotes)return;const t=c.deliveryNotes.find(s=>s.id===i.deliveryNoteId);t&&D.require({message:`Està segur que vol treure l'${i.deliveryNoteNumber}?`,icon:"pi pi-question-circle",acceptIcon:"pi pi-check",rejectIcon:"pi pi-times",accept:async()=>{w("deleteDeliveryNote",t)}})};return(e,i)=>{const t=y("Column"),s=y("DataTable");return b(),L(s,{class:"p-datatable-sm",tableStyle:"min-width: 100%",scrollable:"",scrollHeight:"62vh",sortMode:"single",sortField:"description",sortOrder:1,value:I.value,rowGroupMode:"subheader",groupRowsBy:"deliveryNoteNumber"},{header:v(()=>[re(e.$slots,"header")]),groupheader:v(o=>[e.canDelete&&o.data.deliveryNoteNumber!=="Sense albarà"?(b(),$("i",{key:0,class:Q([u(q).TIMES,"grid_delete_column_button"]),onClick:n=>d(n,o.data)},null,10,Je)):k("",!0),C("   "),a("span",Ze,N(o.data.deliveryNoteNumber),1)]),default:v(()=>[l(t,{header:"Albarà",field:"deliveryNoteNumber",style:{width:"5%"}}),l(t,{header:"",field:"",style:{width:"2%"}}),l(t,{header:"Quantitat",field:"quantity",style:{width:"10%"}}),l(t,{header:"Referència",style:{width:"15%"}},{body:v(o=>[o.data.deliveryNoteDetail?(b(),$("span",Xe,[l(Se,{id:o.data.deliveryNoteDetail.referenceId},null,8,["id"])])):(b(),$("span",et,"--"))]),_:1}),l(t,{header:"Descripció",sortable:"",field:"description",style:{width:"40%"}}),l(t,{header:"Preu unitat",style:{width:"10%"}},{body:v(o=>[C(N(u(E)(o.data.unitPrice)),1)]),_:1}),l(t,{header:"Impost",style:{width:"10%"}},{body:v(o=>[C(N(h(o.data.taxId)),1)]),_:1}),l(t,{header:"Total",field:"totalCost",style:{width:"10%"}},{body:v(o=>[C(N(u(E)(o.data.amount)),1)]),_:1}),l(t,{style:{width:"10%"}},{body:v(o=>[o.data.deliveryNoteDetailId?k("",!0):(b(),$("i",{key:0,class:Q([u(q).TIMES,"grid_delete_column_button"]),onClick:n=>g(n,o.data)},null,10,tt))]),_:1})]),_:3},8,["value"])}}}),at={key:0},it={class:"two-columns-7525"},lt={class:"mt-2"},st={class:"mt-2"},nt=a("label",{class:"block text-900 mb-2"},"Impost",-1),rt={class:"three-columns"},dt={class:"mt-2"},ct={class:"mt-2"},ut={class:"mt-2"},mt=x({__name:"FormSalesInvoiceDetail",props:{invoiceDetail:{}},emits:["submit","cancel"],setup(f,{emit:w}){const c=f,D=j(),r=z(),m=()=>{const e=c.invoiceDetail;e.quantity&&e.quantity>0&&e.unitPrice&&e.unitPrice>0&&(c.invoiceDetail.unitCost=e.unitPrice,c.invoiceDetail.amount=ce.round(e.quantity*e.unitPrice,2),c.invoiceDetail.totalCost=c.invoiceDetail.amount)},I=Z().shape({quantity:Y().min(1).required("La quantitat ha de ser superior a 1"),unitPrice:Y().min(.01).required("El preu unitat és obligatori")}),h=T({result:!1,errors:{}}),g=()=>{const e=new we(I);h.value=e.validate(c.invoiceDetail)},d=async()=>{if(g(),h.value.result)w("submit",c.invoiceDetail);else{let e="";Object.entries(h.value.errors).forEach(i=>{e+=`${i[1].map(t=>t)}.   `}),D.add({severity:"warn",summary:"Formulari inválid",detail:e,life:5e3})}};return(e,i)=>{const t=y("Dropdown"),s=y("Button");return e.invoiceDetail?(b(),$("form",at,[a("section",it,[a("div",lt,[l(A,{label:"Descripció",modelValue:e.invoiceDetail.description,"onUpdate:modelValue":i[0]||(i[0]=o=>e.invoiceDetail.description=o)},null,8,["modelValue"])]),a("div",st,[nt,l(t,{modelValue:e.invoiceDetail.taxId,"onUpdate:modelValue":i[1]||(i[1]=o=>e.invoiceDetail.taxId=o),editable:"",options:u(r).taxes,optionValue:"id",optionLabel:"name",class:"w-full"},null,8,["modelValue","options"])])]),a("section",rt,[a("div",dt,[l(A,{type:u(P).NUMERIC,label:"Quantitat",modelValue:e.invoiceDetail.quantity,"onUpdate:modelValue":[i[2]||(i[2]=o=>e.invoiceDetail.quantity=o),m]},null,8,["type","modelValue"])]),a("div",ct,[l(A,{type:u(P).CURRENCY,label:"Preu Unitat","model-value":e.invoiceDetail.unitPrice,"onUpdate:modelValue":[i[3]||(i[3]=o=>e.invoiceDetail.unitPrice=o),m]},null,8,["type","model-value"])]),a("div",ut,[l(A,{type:u(P).CURRENCY,label:"Total","model-value":e.invoiceDetail.amount,"onUpdate:modelValue":i[4]||(i[4]=o=>e.invoiceDetail.amount=o),disabled:""},null,8,["type","model-value"])])]),l(s,{label:"Crear",onClick:d,style:{float:"right"},size:"small",class:"mt-2"})])):k("",!0)}}}),vt=f=>(ue("data-v-1516f95e"),f=f(),me(),f),pt={class:"selector-filter"},yt={class:"selector-filter-field"},_t=vt(()=>a("label",{for:""},"Buscar",-1)),bt={class:"selector-filter-button"},ft={class:"flex align-items-center gap-2"},Dt=x({__name:"SelectorDeliveryNotes",props:{deliveryNotes:{},headerVisible:{type:Boolean}},emits:["selected"],setup(f,{emit:w}){const c=f;H(()=>{D.fetchOneByName("DeliveryNote")});const D=O(),r=T([]),m=T(""),I=J(()=>{var d=[];return c.deliveryNotes&&(d=c.deliveryNotes.filter(e=>e.number.toString().includes(m.value))),d}),h=d=>{var i;const e=(i=D.lifecycle)==null?void 0:i.statuses.find(t=>t.id===d);return e?e.name:""},g=()=>{r.value.length!==0&&w("selected",r.value)};return(d,e)=>{const i=y("InputText"),t=y("Button"),s=y("Column"),o=y("DataTable");return b(),L(o,{class:"small-datatable",tableStyle:"min-width: 100%",scrollable:"",scrollHeight:"75vh",metaKeySelection:!1,value:I.value,selectionMode:"multiple",selection:r.value,"onUpdate:selection":e[1]||(e[1]=n=>r.value=n)},{header:v(()=>[a("header",pt,[a("div",yt,[_t,C("   "),l(i,{style:{width:"150px",height:"35px"},modelValue:m.value,"onUpdate:modelValue":e[0]||(e[0]=n=>m.value=n),size:"small"},null,8,["modelValue"])]),a("div",bt,[l(t,{onClick:g,size:"small",icon:u(q).CHECK_SQUARE},null,8,["icon"])])])]),groupheader:v(n=>[a("div",ft,[a("b",null,"Albarà d'entrega "+N(n.data.salesOrderNumber)+" - "+N(u(R)(n.data.salesOrderDate)),1)])]),default:v(()=>[l(s,{header:"Número",field:"number",style:{width:"10%"}}),l(s,{header:"Estat",field:"status",style:{width:"10%"}},{body:v(n=>[C(N(h(n.data.statusId)),1)]),_:1}),l(s,{header:"Data Entrega",field:"deliveryDate",style:{width:"10%"}},{body:v(n=>[C(N(n.data.deliveryDate?u(R)(n.data.deliveryDate):""),1)]),_:1})]),_:1},8,["value","selection"])}}});const ht=ve(Dt,[["__scopeId","data-v-1516f95e"]]),Nt={key:0},It={class:"flex flex-wrap align-items-center justify-content-between gap-2"},gt=a("span",{class:"text-xl text-900 font-bold"},"Detall de la factura",-1),qt=x({__name:"SalesInvoice",setup(f){const w=[{label:"Descarregar",icon:q.FILE_WORD,command:()=>X()}],c=pe(),D=ye(),r=_e(),m=j(),I=z(),h=ge(),g=O(),d=Ie(),e=$e(),i=Ce(),{invoice:t}=be(d),s={Free:0,FromDeliveryNote:1},o=T(0),n=K({visible:!1,title:"",closable:!0,position:"center",modal:!0}),B=T("");H(async()=>{B.value=c.params.id,I.fetchMasterData(),h.fetchCustomers(),await i.fetchReferencesByModule("sales"),await F(),r.setMenuItem({icon:q.WALLET,title:`Factura de venta ${t.value.invoiceNumber} - ${t.value.customerComercialName}`,backButtonVisible:!0})});const F=async()=>{g.fetchOneByName("SalesInvoice"),await d.GetById(B.value),await e.GetByInvoiceId(B.value),t.value&&(t.value.invoiceDate=R(t.value.invoiceDate))},U=async()=>{t.value&&(t.value.invoiceDate=Ne(t.value.invoiceDate),await d.Update(t.value)&&D.back())},X=async()=>{var _;const p=await Ve.SalesInvoice.GetReportDataById(t.value.id);if(p){const S=`Factura_${(_=t.value)==null?void 0:_.invoiceNumber}.docx`,M=await new Be().Download(p,ke.Invoice,S);M?fe(S,M):m.add({severity:"warn",summary:"Error",detail:"No s'ha pugut generar fulla de la comanda"})}},ee=async()=>{t.value&&(await e.GetToInvoice(t.value.customerId),o.value=s.FromDeliveryNote,n.title="Selector d'albarans d'entrega",n.visible=!0)},te=async p=>{for(let _=0;_<p.length;_++){const S=p[_];await d.AddDeliveryNote(t.value.id,S)}n.visible=!1,F()},oe=async p=>{await d.RemoveDeliveryNote(t.value.id,p),F()},V=K({}),ae=()=>{var p;if(o.value=s.Free,t.value){V.salesInvoiceId=t.value.id,V.quantity=1,V.description="",V.totalCost=0;const _=(p=I.taxes)==null?void 0:p.find(S=>S.percentatge===21);_&&(V.taxId=_.id),n.title="Introducció de línea lliure",n.visible=!0}},ie=async()=>{await d.CreateInvoiceDetail(V),n.visible=!1},le=async p=>{await d.DeleteInvoiceDetail(p),d.invoice.invoiceDate=R(d.invoice.invoiceDate)};return(p,_)=>{const S=y("SplitButton"),G=y("Button"),M=y("Dialog");return b(),$(he,null,[l(S,{label:"Guardar",onClick:U,model:w,size:"small",class:"grid_add_row_button"}),u(t)?(b(),$("main",Nt,[l(Ye,{class:"mt-3 mr-3",invoice:u(t)},null,8,["invoice"]),l(ot,{class:"mt-3",canDelete:!0,details:u(t).salesInvoiceDetails,deliveryNotes:u(e).deliveryNotes,onDeleteDeliveryNote:oe,onDelete:le},{header:v(()=>[a("div",It,[gt,a("div",null,[l(G,{size:"small",label:"Afegir albarà",onClick:ee}),C("    "),l(G,{size:"small",label:"Afegir linia lliure",onClick:ae})])])]),_:1},8,["details","deliveryNotes"])])):k("",!0),l(M,{visible:n.visible,"onUpdate:visible":_[0]||(_[0]=se=>n.visible=se),header:n.title,closable:n.closable,modal:n.modal,style:De({width:o.value===s.Free?"50vw":"60vw"}),maximizable:o.value===s.FromDeliveryNote},{default:v(()=>[o.value===s.Free?(b(),L(mt,{key:0,invoiceDetail:V,onSubmit:ie},null,8,["invoiceDetail"])):k("",!0),o.value===s.FromDeliveryNote?(b(),L(ht,{key:1,headerVisible:!0,deliveryNotes:u(e).invoiceableDeliveryNotes,onSelected:te},{header:v(()=>[]),_:1},8,["deliveryNotes"])):k("",!0)]),_:1},8,["visible","header","closable","modal","style","maximizable"])],64)}}});export{qt as default};
