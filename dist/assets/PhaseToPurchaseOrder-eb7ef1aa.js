import{d as C,g as D,u as O,j as N,r as c,o as B,P as V,h as l,m as T,w as u,a as E,e as w,i as t,G as F,H as G}from"./index-8529e343.js";import{u as H}from"./workorder-10c545f8.js";import{S as M}from"./suppliers.service-ad882777.js";import{u as U}from"./reference-4d9dd56a.js";import{u as W}from"./order-b2a03b03.js";import"./index-41f85f67.js";import"./index-4d477ef8.js";const j={class:"flex flex-wrap align-items-center justify-content-between gap-2"},q=w("span",{class:"text-xl text-900 font-bold"},"Seleccionar fases",-1),Z=C({__name:"PhaseToPurchaseOrder",setup(A){const S=D(),g=O(),p=N(),s=H(),I=new M("/supplier"),y=U(),k=W(),d=c([]),f=c({}),h=c({}),i=c([]),b=(e,a)=>{const n=d.value.findIndex(r=>r.phaseId===e);if(n!==-1)d.value[n].supplierId=a;else{const r=i.value.find(m=>m.phaseId===e);r&&(r.supplierId=a)}},R=async()=>{if(await s.fetchExternalPhases(),s.workorderPhases){for(const e of s.workorderPhases)if(e&&(await s.fetchOne(e.workOrderId),s.workorder)){const a={workorderId:e.workOrderId,workorderDescription:s.workorder.code||"",phaseId:e.id,phaseDescription:e.code+" - "+e.description||"",serviceReferenceId:e.serviceReferenceId??"",serviceReferenceName:_(e.serviceReferenceId??"")??"Desconeguda",supplierId:h.value[e.id],quantity:s.workorder.plannedQuantity||0};i.value.push(a)}}};B(async()=>{if(g.setMenuItem({icon:V.SHOPPING_CART,title:"Generació de comandes de compra"}),await s.fetchExternalPhases(),await y.fetchReferences(),await R(),i.value&&i.value.length>0){for(const e of i.value)if(e&&e.serviceReferenceId!=null){const a=await I.getSuppliersReferenceById(e.serviceReferenceId);if(f.value[e.phaseId]=a,a.length==0){const n=await I.getAll();n&&(f.value[e.phaseId]=n)}}}});const _=e=>y.getFullNameById(e)||"Desconeguda",x=async()=>{for(const a of d.value)if(a.supplierId==null||!a.supplierId||a.supplierId==""){p.add({severity:"error",summary:"Proveïdors buits",detail:"No poden haver-hi proveïdors buits",life:5e3});return}(await k.createFromWo(d.value)).result?(p.add({severity:"success",summary:"Creació comandes",detail:"Comandes creades correctament",life:5e3}),S.push("/purchase-orders")):p.add({severity:"error",summary:"Error creació",detail:"Error al crear la comanda",life:5e3})};return(e,a)=>{const n=l("Button"),r=l("Column"),m=l("Dropdown"),P=l("DataTable");return E(),T(P,{value:i.value,selection:d.value,"onUpdate:selection":a[0]||(a[0]=o=>d.value=o),class:"p-datatable-sm small-datatable",tableStyle:"min-width: 100%",scrollable:"",scrollHeight:"79vh","sort-order":1,"sort-field":"date",paginator:"",rows:25,dataKey:"phaseId"},{header:u(()=>[w("div",j,[q,w("div",null,[t(n,{size:"small",label:"Crear comandes",rounded:"",onClick:x})])])]),default:u(()=>[t(r,{selectionMode:"multiple",headerStyle:"width: 1rem"}),t(r,{field:"workorderDescription",header:"Ordre de fabricació"}),t(r,{field:"phaseDescription",header:"Fase",style:{width:"15%"}}),t(r,{header:"Referència"},{body:u(o=>[F(G(_(o.data.serviceReferenceId)),1)]),_:1}),t(r,{field:"quantity",header:"Quantitat planificada"}),t(r,{header:"Proveïdor"},{body:u(o=>[t(m,{modelValue:h.value[o.data.phaseId],"onUpdate:modelValue":v=>h.value[o.data.phaseId]=v,options:f.value[o.data.phaseId],placeholder:"Selecciona...",optionValue:"id",optionLabel:"comercialName",onChange:v=>b(o.data.phaseId,v.value)},null,8,["modelValue","onUpdate:modelValue","options","onChange"])]),_:1})]),_:1},8,["value","selection"])}}});export{Z as default};
