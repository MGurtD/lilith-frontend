import{d as P,j as K,C as Y,o as H,r as U,h as V,a as D,c as k,i as t,k as s,e as o,s as h,z as y,n as B,l as O,D as re,p as de,b as ue,f as ce,m as Z,w as _,Q as me,G as z,H as $,R as pe,P as j,v as fe,u as be,T as ve,K as he,F as T,I as A,J as M,V as ye}from"./index-709c40c8.js";import{u as Q}from"./receipt-1ad859e0.js";import{u as _e}from"./suppliers-27f42676.js";import{u as ee}from"./lifecycle-3d27f6c5.js";import{c as te,a as L,F as ae,d as Ve}from"./form-validator-6d089293.js";import{u as ge}from"./masterData-e92fe107.js";import{_ as we}from"./DropdownReference.vue_vue_type_script_setup_true_lang-e1a79f67.js";import{_ as Re}from"./FormMaterial.vue_vue_type_script_setup_true_lang-b40545db.js";import{u as Ie}from"./reference-ced38a82.js";import{R as G}from"./index-7cbe1881.js";import{u as Ce}from"./referenceType-cec45e1b.js";import"./index-ff11ca19.js";import"./suppliers.service-e9e84f10.js";import"./DropdownReferenceType.vue_vue_type_script_setup_true_lang-eba1e3e7.js";import"./tax-c1d8198c.js";const N=g=>(de("data-v-70931d13"),g=g(),ue(),g),De=N(()=>o("br",null,null,-1)),Ee={key:0},ke={class:"three-columns"},Se={class:"mt-1"},Te={class:"mt-1"},Ue=N(()=>o("label",{class:"block text-900 mb-2"},"Exercici",-1)),Ne={class:"mt-1"},Fe=N(()=>o("label",{class:"block text-900 mb-2"},"Data Albarà",-1)),$e={class:"three-columns"},Ae={class:"mt-1"},Me=N(()=>o("label",{class:"block text-900 mb-2"},"Estat",-1)),Be={class:"mt-1"},Le=N(()=>o("label",{class:"block text-900 mb-2"},"Proveïdor",-1)),Pe={class:"mt-1"},Oe=P({__name:"FormReceipt",emits:["submit","cancel"],setup(g,{expose:R,emit:f}){const p=Q(),I=_e(),c=ge(),v=ee(),l=K(),{receipt:r}=Y(p);H(async()=>{await c.fetchMasterData(),await I.fetchSuppliers(),await v.fetchOneByName("Receipts")});const m=te().shape({supplierId:L().required("El client es obligatori"),statusId:L().required("L'estat es obligatori"),exerciseId:L().required("L'exercici es obligatori")}),e=U({result:!1,errors:{}}),i=()=>{const a=new ae(m);e.value=a.validate(r.value)},w=async()=>{if(i(),e.value.result)r.value.date=re(r.value.date),f("submit",r.value);else{let a="";Object.entries(e.value.errors).forEach(u=>{a+=`${u[1].map(C=>C)}.   `}),l.add({severity:"warn",summary:"Formulari inválid",detail:a,life:5e3})}};return R({submitForm:w}),(a,u)=>{var F;const C=V("Button"),S=V("Dropdown"),x=V("Calendar");return D(),k("div",null,[t(C,{label:"Guardar",size:"small",class:"grid_add_row_button",onClick:w}),De,s(r)?(D(),k("form",Ee,[o("section",ke,[o("div",Se,[t(y,{type:s(h).TEXT,label:"Número",id:"number",modelValue:s(r).number,"onUpdate:modelValue":u[0]||(u[0]=b=>s(r).number=b),disabled:""},null,8,["type","modelValue"])]),o("div",Te,[Ue,t(S,{modelValue:s(r).exerciseId,"onUpdate:modelValue":u[1]||(u[1]=b=>s(r).exerciseId=b),editable:"",options:s(c).exercises,optionValue:"id",optionLabel:"name",class:B(["w-full",{"p-invalid":e.value.errors.exerciseId}])},null,8,["modelValue","options","class"])]),o("div",Ne,[Fe,t(x,{modelValue:s(r).date,"onUpdate:modelValue":u[2]||(u[2]=b=>s(r).date=b),dateFormat:"dd/mm/yy"},null,8,["modelValue"])])]),o("section",$e,[o("div",Ae,[Me,t(S,{modelValue:s(r).statusId,"onUpdate:modelValue":u[3]||(u[3]=b=>s(r).statusId=b),editable:"",options:(F=s(v).lifecycle)==null?void 0:F.statuses,optionValue:"id",optionLabel:"name",class:B(["w-full",{"p-invalid":e.value.errors.statusId}])},null,8,["modelValue","options","class"])]),o("div",Be,[Le,t(S,{modelValue:s(r).supplierId,"onUpdate:modelValue":u[4]||(u[4]=b=>s(r).supplierId=b),editable:"",options:s(I).suppliers,optionValue:"id",optionLabel:"comercialName",class:B(["w-full",{"p-invalid":e.value.errors.customerId}])},null,8,["modelValue","options","class"])]),o("div",Pe,[t(y,{type:s(h).TEXT,label:"Número Albarà",id:"supplierNumber",modelValue:s(r).supplierNumber,"onUpdate:modelValue":u[5]||(u[5]=b=>s(r).supplierNumber=b)},null,8,["type","modelValue"])])])])):O("",!0)])}}});const xe=ce(Oe,[["__scopeId","data-v-70931d13"]]),qe=["onClick"],We=P({__name:"TableReceiptDetails",props:{details:{}},emits:["edit","delete"],setup(g,{emit:R}){const f=g,p=c=>{c.originalEvent.target.className.includes("grid_delete_column_button")||R("edit",c.data)},I=(c,v)=>{R("delete",v)};return(c,v)=>{const l=V("Column"),r=V("DataTable");return D(),Z(r,{onRowClick:p,value:f.details,tableStyle:"min-width: 100%",class:"p-datatable-sm"},{header:_(()=>[me(c.$slots,"header")]),default:_(()=>[t(l,{field:"quantity",header:"Quantitat",style:{width:"7.5%"}}),t(l,{header:"Material",style:{width:"25%"}},{body:_(m=>[z($(m.data.reference.code)+" - "+$(m.data.reference.description),1)]),_:1}),t(l,{field:"width",header:"Amplada",style:{width:"7.5%"}}),t(l,{field:"height",header:"Alçada",style:{width:"7.5%"}}),t(l,{field:"lenght",header:"Longitud",style:{width:"7.5%"}}),t(l,{field:"thickness",header:"Gruix",style:{width:"7.5%"}}),t(l,{field:"diameter",header:"Diàmetre",style:{width:"7.5%"}}),t(l,{field:"totalWeight",header:"Pes",style:{width:"7.5%"}},{body:_(m=>[z($(m.data.totalWeight)+" KG",1)]),_:1}),t(l,{field:"amount",header:"Preu",style:{width:"7.5%"}},{body:_(m=>[z($(s(pe)(m.data.amount)),1)]),_:1}),t(l,{style:{width:"5%"}},{body:_(m=>[m.data.stockMovementId===null?(D(),k("i",{key:0,class:B([s(j).TIMES,"grid_delete_column_button"]),onClick:e=>I(e,m.data)},null,10,qe)):O("",!0)]),_:1})]),_:3},8,["value"])}}}),ze={key:0},Ge={class:"two-columns-7525"},je={class:"three-columns mt-2"},Ke={class:"three-columns mt-2"},Qe={class:"two-columns mt-2"},Je=P({__name:"FormReceiptDetail",props:{detail:{}},emits:["submit","cancel"],setup(g,{emit:R}){const f=g,p=K(),I=Q(),c=async()=>{const e=await I.calculateDetailWeightAndPrice(f.detail);e.result?(f.detail.unitWeight=e.content.unitWeight,f.detail.totalWeight=e.content.totalWeight,f.detail.unitPrice=e.content.unitPrice,f.detail.amount=e.content.amount):p.add({summary:"Calculadora de pes/preu",detail:e.errors[0],severity:"warn",life:6e3})},v=te().shape({quantity:Ve().min(1).required("La quantitat ha de ser superior a 1"),referenceId:L().required("La referencia és obligatoria")}),l=U({result:!1,errors:{}}),r=()=>{const e=new ae(v);l.value=e.validate(f.detail)},m=async()=>{if(r(),l.value.result)R("submit",f.detail);else{let e="";Object.entries(l.value.errors).forEach(i=>{e+=`${i[1].map(w=>w)}.   `}),p.add({severity:"warn",summary:"Formulari inválid",detail:e,life:5e3})}};return(e,i)=>{const w=V("Button");return e.detail?(D(),k("form",ze,[o("section",Ge,[o("div",null,[t(we,{label:"Material",modelValue:e.detail.referenceId,"onUpdate:modelValue":i[0]||(i[0]=a=>e.detail.referenceId=a),fullName:!0},null,8,["modelValue"])]),o("div",null,[t(y,{type:s(h).CURRENCY,label:"Preu / Kilo",highlightOnFocus:"",modelValue:e.detail.kilogramPrice,"onUpdate:modelValue":i[1]||(i[1]=a=>e.detail.kilogramPrice=a)},null,8,["type","modelValue"])])]),o("section",je,[o("div",null,[t(y,{type:s(h).NUMERIC,highlightOnFocus:"",label:"Amplada (mm)",decimals:2,modelValue:e.detail.width,"onUpdate:modelValue":i[2]||(i[2]=a=>e.detail.width=a)},null,8,["type","modelValue"])]),o("div",null,[t(y,{type:s(h).NUMERIC,decimals:2,label:"Alçada (mm)",highlightOnFocus:"",modelValue:e.detail.height,"onUpdate:modelValue":i[3]||(i[3]=a=>e.detail.height=a)},null,8,["type","modelValue"])]),o("div",null,[t(y,{type:s(h).NUMERIC,decimals:2,label:"Longitud (mm)",highlightOnFocus:"",modelValue:e.detail.lenght,"onUpdate:modelValue":i[4]||(i[4]=a=>e.detail.lenght=a)},null,8,["type","modelValue"])])]),o("section",Ke,[o("div",null,[t(y,{type:s(h).NUMERIC,decimals:2,label:"Diàmetre (mm)",highlightOnFocus:"",modelValue:e.detail.diameter,"onUpdate:modelValue":i[5]||(i[5]=a=>e.detail.diameter=a)},null,8,["type","modelValue"])]),o("div",null,[t(y,{type:s(h).NUMERIC,decimals:2,label:"Gruix (mm)",highlightOnFocus:"",modelValue:e.detail.thickness,"onUpdate:modelValue":i[6]||(i[6]=a=>e.detail.thickness=a)},null,8,["type","modelValue"])]),o("div",null,[t(y,{type:s(h).NUMERIC,decimals:2,label:"Pes (kg)",modelValue:e.detail.totalWeight,"onUpdate:modelValue":i[7]||(i[7]=a=>e.detail.totalWeight=a)},null,8,["type","modelValue"])])]),o("section",Qe,[o("div",null,[t(y,{type:s(h).NUMERIC,label:"Quantitat",highlightOnFocus:"",modelValue:e.detail.quantity,"onUpdate:modelValue":i[8]||(i[8]=a=>e.detail.quantity=a)},null,8,["type","modelValue"])]),o("div",null,[t(y,{type:s(h).CURRENCY,label:"Preu",modelValue:e.detail.amount,"onUpdate:modelValue":i[9]||(i[9]=a=>e.detail.amount=a)},null,8,["type","modelValue"])])]),t(w,{label:"Crear",onClick:m,style:{float:"right"},size:"small",class:"mt-2"}),t(w,{label:"Calcular",onClick:c,style:{float:"right"},size:"small",class:"mt-2 mr-2"})])):O("",!0)}}}),Xe={key:0},Ye=o("br",null,null,-1),He={class:"flex flex-wrap align-items-center justify-content-between gap-2"},Ze=o("span",{class:"text-xl text-900 font-bold"},"Detall de l'albarà",-1),et={key:1},vt=P({__name:"Receipt",setup(g){const R=fe(),f=be(),p=Ie(),I=Ce(),c=Q(),v=ee(),{receipt:l}=Y(c),r=U(0),m=async()=>{var n;await c.fetchReceipt(R.params.id),v.fetchOneByName("Receipts"),p.fetchReferencesByModule("purchase"),I.fetchActive(),l.value&&(l.value.date=A(l.value.date)),f.setMenuItem({icon:j.BUILDING,title:`Albarà de recepció ${(n=l.value)==null?void 0:n.number}`,backButtonVisible:!0})};H(async()=>{await m()});const e=K(),i=ve(()=>{var d;if(!v.lifecycle)return!1;const n=v.lifecycle.statuses.find(E=>E.name==="Recepcionat");return n?((d=l.value)==null?void 0:d.statusId)===n.id:!1}),w=async()=>{let n=!1,d="";l.value&&(n=await c.updateReceipt(l.value.id,l.value),d="Albarà actualizat correctament",n&&(e.add({severity:"success",summary:d,life:5e3}),ye.back()))},a=he({visible:!1,title:"Linea",closable:!0,position:"center",modal:!0}),u=U(T.CREATE),C=U({}),S=()=>{u.value=T.CREATE,C.value={id:M(),receiptId:l.value.id,amount:0,diameter:0,height:0,kilogramPrice:0,lenght:0,quantity:1,thickness:0,totalWeight:0,unitPrice:0,unitWeight:0,width:0,disabled:!1},p.setNewReference(M(),G.MATERIAL),a.title="Crear línia",a.visible=!0},x=n=>{u.value=T.EDIT,C.value=n,p.setNewReference(M(),G.MATERIAL),a.title="Modificar línia",a.visible=!0},F=n=>{u.value===T.CREATE?b(n):u.value===T.EDIT&&le(n),a.visible=!1},b=async n=>{const d=await c.createReceiptDetail(n);l.value.date=A(l.value.date),d.result||q(d)},le=async n=>{const d=await c.updateReceiptDetail(n.id,n);l.value.date=A(l.value.date),d.result||q(d)},se=async n=>{const d=await c.deleteReceiptDetail(n.id);l.value.date=A(l.value.date),d.result||q(d)},q=n=>{e.add({severity:"error",summary:n.errors[0],life:1e4,closable:!0})},oe=async n=>{let d=!1,E="";d=await p.createReference(n),d?E="Referència creada correctament":E="La referència + versió introduïda ja existeix",e.add({severity:d?"success":"warn",summary:E,life:5e3}),d&&(C.value.referenceId=n.id,r.value=0,p.setNewReference(M(),G.MATERIAL))};return(n,d)=>{var X;const E=V("Button"),J=V("TabPanel"),ie=V("TabView"),ne=V("Dialog");return s(l)?(D(),k("main",Xe,[t(xe,{onSubmit:w}),Ye,t(We,{details:(X=s(l))==null?void 0:X.details,onEdit:x,onDelete:se},{header:_(()=>[o("div",He,[Ze,o("div",null,[t(E,{size:"small",icon:s(j).PLUS,rounded:"",disabled:i.value,onClick:S},null,8,["icon","disabled"])])])]),_:1},8,["details"]),t(ne,{visible:a.visible,"onUpdate:visible":d[1]||(d[1]=W=>a.visible=W),header:a.title,closable:a.closable,modal:a.modal},{default:_(()=>[t(ie,{activeIndex:r.value,"onUpdate:activeIndex":d[0]||(d[0]=W=>r.value=W)},{default:_(()=>[t(J,{header:"Línea"},{default:_(()=>[t(Je,{detail:C.value,onSubmit:F},null,8,["detail"])]),_:1}),t(J,{header:"Referencia"},{default:_(()=>[s(p).reference?(D(),Z(Re,{key:0,reference:s(p).reference,onSubmit:oe},null,8,["reference"])):O("",!0)]),_:1})]),_:1},8,["activeIndex"])]),_:1},8,["visible","header","closable","modal"])])):(D(),k("main",et,"Carregant albarà ..."))}}});export{vt as default};
