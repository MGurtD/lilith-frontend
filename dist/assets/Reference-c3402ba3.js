import{d as j,j as A,o as P,r as S,h as f,c as q,e as o,i as a,n as B,y as C,k as r,l as U,G as z,a as _,s as T,F as y,v as K,g as Z,u as ee,x as te,z as ae,m as N,w as d,P as x,C as k,D as R}from"./index-d7d79c10.js";import{c as oe,a as E,d as L,F as se}from"./form-validator-f8953ae6.js";import{_ as re}from"./DropdownCustomers.vue_vue_type_script_setup_true_lang-d11ed60e.js";import{u as W}from"./tax-6fd2b2ec.js";import{F as le}from"./FileEntityPicker-2790cebd.js";import{u as ie}from"./reference-b617521b.js";import{u as ne}from"./workmaster-73882f61.js";import{e as I,g as de}from"./functions-e7c8fc70.js";import"./_commonjsHelpers-725317a4.js";import"./customers-59280db1.js";import"./base.service-fd6835a1.js";import"./index-f5d7f8d3.js";import"./reference.service-9f0aa22c.js";import"./index-eb566870.js";import"./v4-a960c1f4.js";const ce=o("br",null,null,-1),ue={key:0},me={class:"four-columns"},pe={class:"mt-1"},fe={class:"mt-1"},be={class:"mt-1"},ve={class:"mt-1"},Ce={class:"five-columns"},ye={class:"mt-1"},_e={class:"mt-1"},we={class:"mt-1"},he={class:"mt-1"},Ve=o("label",{class:"block text-900 mb-2"},"Impost",-1),ke={class:"mt-1"},Re=o("label",{class:"block text-900 mb-2"},"Servei",-1),Ie=j({__name:"FormReference",props:{reference:{},defaultCustomerId:{}},emits:["submit","cancel"],setup(M,{emit:b}){const u=M,w=A(),D=W();P(()=>{u.defaultCustomerId&&u.reference&&(u.reference.customerId=u.defaultCustomerId)});const $=oe().shape({code:E().required("El codi és obligatori").max(50,"El codi no pot superar els 50 carácters"),description:E().required("La descripció és obligatori").max(250,"La descripció pot superar els 250 carácters"),version:E().required("La versió és obligatoria").max(20,"La versió pot superar els 20 carácters"),cost:L().required("El cost es obligatori"),price:L().required("El preu es obligatori"),taxId:E().required("El tipus d'iva es obligatori")}),n=S({result:!1,errors:{}}),c=()=>{const e=new se($);n.value=e.validate(u.reference)},F=async()=>{if(c(),n.value.result)b("submit",u.reference);else{let e="";Object.entries(n.value.errors).forEach(t=>{e+=`${t[1].map(h=>h)}.   `}),w.add({severity:"warn",summary:"Formulari inválid",detail:e,life:5e3})}};return(e,t)=>{const h=f("Button"),g=f("Dropdown"),V=f("Checkbox");return _(),q(z,null,[o("div",null,[a(h,{label:"Guardar",class:"grid_add_row_button",size:"small",onClick:F}),ce]),e.reference?(_(),q("form",ue,[o("section",me,[o("div",pe,[a(C,{class:B(["mb-2",{"p-invalid":n.value.errors.code}]),label:"Codi",id:"code",modelValue:e.reference.code,"onUpdate:modelValue":t[0]||(t[0]=s=>e.reference.code=s)},null,8,["modelValue","class"])]),o("div",fe,[a(C,{class:B(["mb-2",{"p-invalid":n.value.errors.description}]),label:"Descripció",id:"description",modelValue:e.reference.description,"onUpdate:modelValue":t[1]||(t[1]=s=>e.reference.description=s)},null,8,["modelValue","class"])]),o("div",be,[a(C,{type:r(T).TEXT,label:"Versió",id:"version",modelValue:e.reference.version,"onUpdate:modelValue":t[2]||(t[2]=s=>e.reference.version=s)},null,8,["type","modelValue"])]),o("div",ve,[a(re,{label:"Client",modelValue:e.reference.customerId,"onUpdate:modelValue":t[3]||(t[3]=s=>e.reference.customerId=s)},null,8,["modelValue"])])]),o("section",Ce,[o("div",ye,[a(C,{type:r(T).CURRENCY,label:"Cost Teóric Fabricació",id:"workMasterCost",modelValue:e.reference.workMasterCost,"onUpdate:modelValue":t[4]||(t[4]=s=>e.reference.workMasterCost=s),disabled:""},null,8,["type","modelValue"])]),o("div",_e,[a(C,{type:r(T).CURRENCY,label:"Cost Última Fabricació",id:"lastCost",modelValue:e.reference.lastCost,"onUpdate:modelValue":t[5]||(t[5]=s=>e.reference.lastCost=s),disabled:""},null,8,["type","modelValue"])]),o("div",we,[a(C,{type:r(T).CURRENCY,label:"Preu",id:"price",modelValue:e.reference.price,"onUpdate:modelValue":t[6]||(t[6]=s=>e.reference.price=s)},null,8,["type","modelValue"])]),o("div",he,[Ve,a(g,{modelValue:e.reference.taxId,"onUpdate:modelValue":t[7]||(t[7]=s=>e.reference.taxId=s),editable:"",options:r(D).taxes,optionValue:"id",optionLabel:"name",class:B(["w-full",{"p-invalid":n.value.errors.taxid}])},null,8,["modelValue","options","class"])]),o("div",ke,[Re,a(V,{modelValue:e.reference.isService,"onUpdate:modelValue":t[8]||(t[8]=s=>e.reference.isService=s),class:"w-full",binary:!0},null,8,["modelValue"])])])])):U("",!0)],64)}}}),ge={class:"flex flex-wrap align-items-center justify-content-between gap-2"},Te=o("div",null,[o("label",{class:"block text-900"},"Rutes de fabricació")],-1),Ee={class:"datatable-buttons"},Se=["onClick"],Ge=j({__name:"Reference",setup(M){const b=S(y.EDIT),u=K(),w=Z(),D=ee(),$=W(),n=ie(),c=ne(),F=te(),{reference:e}=ae(n),t=S(""),h=S(""),g=async()=>{$.fetchAll(),c.fetchByReferenceId(t.value),await n.fetchReference(t.value);let l="";e.value?(b.value=y.EDIT,l=`Referència ${e.value.code} - ${e.value.description}`):(b.value=y.CREATE,n.setNewReference(t.value),l="Alta de referència"),D.setMenuItem({icon:x.BUILDING,backButtonVisible:!0,title:l})};P(async()=>{t.value=u.params.id,h.value=u.params.module,await g()});const V=A(),s=async()=>{const l=e.value;let m=!1,p="";b.value===y.CREATE?(m=await n.createReference(l),m?p="Referència creada correctament":p="La referència + versió introduïda ja existeix"):(m=await n.updateReference(l.id,l),p="Referència actualizada correctament"),V.add({severity:m?"success":"warn",summary:p,life:5e3}),m&&(b.value===y.EDIT?w.back():g())},G=async()=>{if(e.value){const l=de();c.setNew(l,e.value.id),c.workmaster&&await c.create(c.workmaster)&&w.push({path:`/workmaster/${l}`})}},Y=l=>{w.push({path:`/workmaster/${l.data.id}`})},Q=async(l,m)=>{l.stopPropagation(),F.require({target:l.currentTarget,message:"Está segur que vol eliminar la ruta seleccionada?",icon:"pi pi-question-circle",acceptIcon:"pi pi-check",rejectIcon:"pi pi-times",accept:async()=>{await c.delete(m.id)?(V.add({severity:"success",summary:"Ruta eliminada correctament",life:5e3}),await c.fetchByReferenceId(e.value.id)):V.add({severity:"warn",summary:"No s'ha pogut eliminar la ruta",life:5e3})}})};return(l,m)=>{const p=f("TabPanel"),H=f("Button"),v=f("Column"),O=f("DataTable"),X=f("TabView");return _(),q(z,null,[r(e)?(_(),N(Ie,{key:0,reference:r(e),onSubmit:s},null,8,["reference"])):U("",!0),r(e)?(_(),N(X,{key:1},{default:d(()=>[a(p,{header:"Documentació"},{default:d(()=>[a(le,{title:"Documentació",entity:"referenceMaps",id:r(e).id},null,8,["id"])]),_:1}),b.value===r(y).EDIT?(_(),N(p,{key:0,header:"Rutes de fabricació"},{default:d(()=>[a(O,{value:r(c).workmasters,tableStyle:"min-width: 100%",scrollable:"",scrollHeight:"80vh","sort-field":"reference.code","sort-order":1,onRowClick:Y},{header:d(()=>[o("div",ge,[Te,o("div",Ee,[a(H,{icon:r(x).PLUS,rounded:"",raised:"",onClick:G},null,8,["icon"])])])]),default:d(()=>[a(v,{field:"baseQuantity",header:"Quantitat Base",style:{width:"10%"}}),a(v,{field:"machineCost",header:"Cost màquina",style:{width:"10%"}},{body:d(i=>[k(R(r(I)(i.data.machineCost)),1)]),_:1}),a(v,{field:"operatorCost",header:"Cost operari",style:{width:"10%"}},{body:d(i=>[k(R(r(I)(i.data.operatorCost)),1)]),_:1}),a(v,{field:"materialCost",header:"Cost material",style:{width:"10%"}},{body:d(i=>[k(R(r(I)(i.data.materialCost)),1)]),_:1}),a(v,{field:"externalCost",header:"Cost extern",style:{width:"10%"}},{body:d(i=>[k(R(r(I)(i.data.externalCost)),1)]),_:1}),a(v,{header:"Cost total",style:{width:"10%"}},{body:d(i=>[k(R(r(I)(i.data.machineCost+i.data.operatorCost+i.data.materialCost+i.data.externalCost)),1)]),_:1}),a(v,null,{body:d(i=>[o("i",{class:B([r(x).TIMES,"grid_delete_column_button"]),onClick:J=>Q(J,i.data)},null,10,Se)]),_:1})]),_:1},8,["value"])]),_:1})):U("",!0)]),_:1})):U("",!0)],64)}}});export{Ge as default};
