import{_ as h}from"./DropdownReference.vue_vue_type_script_setup_true_lang-4d725b8f.js";import{c as ee,d as x,F as te}from"./form-validator-74a9b5a3.js";import{d as O,h as w,a as N,c as A,H as F,l as L,i as n,w as V,a4 as oe,k as o,r as g,K as Q,X as ae,V as z,o as H,af as le,m as J,e as s,s as u,z as j,G as X,B as re,j as ne,ag as se,F as G,n as k,ad as S}from"./index-3259d18c.js";import{u as Z}from"./reference-1e4fc38c.js";import{u as K}from"./workmaster-dd0e5417.js";import{u as ie}from"./plantmodel-b960b490.js";const ue={class:"mb-2"},de={key:0,class:"block text-900 mb-2"},ce={key:0,class:"flex align-items-center"},me=O({__name:"DropdownWorkmasters",props:{label:{},modelValue:{},referenceId:{}},emits:["update:modelValue"],setup(q,{emit:$}){const m=Z(),T=K(),P=d=>{var e;const C=m.getShortNameById(d.referenceId);let b=(e=T.workmasterModes.find(U=>U.id===d.mode))==null?void 0:e.value;return`${C}  (Base = ${d.baseQuantity} )  ${b}`};return(d,C)=>{const b=w("Dropdown");return N(),A("div",ue,[d.label.length>0?(N(),A("label",de,F(d.label),1)):L("",!0),n(b,oe({showClear:"",filter:"",options:d.referenceId?o(T).getByReferenceId(d.referenceId):o(T).workmasters,optionValue:"id",optionLabel:P,class:"w-full"},d.$attrs,{"model-value":d.modelValue,onChange:C[0]||(C[0]=e=>$("update:modelValue",e.value))}),{option:V(e=>[e.option?(N(),A("div",ce,F(P(e.option)),1)):L("",!0)]),_:1},16,["options","model-value"])])}}}),pe={class:"flex flex-wrap align-items-center justify-content-between gap-2"},ve=s("span",{class:"text-l text-900"},"Temps total operatiu: ",-1),fe=s("span",{class:"text-l text-900 font-bold"},"Benefici ponderat ",-1),Ce=O({__name:"TableWorkmasterProfit",props:{workMasterId:{},quantity:{}},emits:["updateProfitAverage"],setup(q,{emit:$}){const m=q,T=g([{field:"code",order:1},{field:"order",order:1}]),P=K(),d=ie(),C=g([]),b=g(void 0),e=g(void 0),U=Q({}),I=Q({}),E=g(0),f=Q({}),B=(a,t)=>a.flatMap(r=>r.details.map(i=>{const y=`${r.code}-${i.order}-${r.workcenterTypeId}`;return y in f||(f[y]=r.profitPercentage??0),{id:i.id,code:r.code,order:i.order,workcenterTypeId:r.workcenterTypeId||"",machineStatusId:i.machineStatusId||"",estimatedTime:i.isCycleTime?i.estimatedTime*t:i.estimatedTime,isCycleTime:i.isCycleTime,profitPercentage:r.isExternalWork?0:f[y]}}));ae(()=>m.quantity,(a,t)=>{R()});const M=z(()=>B(C.value,m.quantity)),D=z(()=>M.value.reduce((a,t)=>a+t.estimatedTime,0));H(async()=>{await d.fetchWorkcenterTypes(),await d.fetchMachineStatuses(),b.value=d.workcenterTypes||[],e.value=d.machineStatuses||[],M.value.forEach(a=>{const t=p(a);a.workcenterTypeId in U||(U[t]=a.profitPercentage),a.workcenterTypeId in I||(I[t]=a.estimatedTime)}),R()}),le(async()=>{var a;m.workMasterId?(await P.fetchOne(m.workMasterId),C.value=((a=P.workmaster)==null?void 0:a.phases)||[]):C.value=[],R()});const p=a=>`${a.code}-${a.order}-${a.workcenterTypeId}`,W=a=>{var r;const t=(r=b.value)==null?void 0:r.find(i=>i.id===a);return(t==null?void 0:t.name)||"No definit"},Y=a=>{var r;const t=(r=e.value)==null?void 0:r.find(i=>i.id===a);return(t==null?void 0:t.name)||"No definit"},v=()=>{$("updateProfitAverage",E.value)},_=(a,t)=>{if(typeof t=="number"){const r=p(a);f[r]=t,a.profitPercentage=t,U[r]=t,R()}else console.error("Attempted to set a non-number value for profit percentage:",t)},R=()=>{let a=0,t=0;M.value.forEach(r=>{const i=p(r),y=f[i],c=I[i]??r.estimatedTime;a+=c,t+=c*y}),console.log(t),console.log(a),console.log(Number((t/a).toFixed(2))),E.value=!isNaN(a)&&a>0&&!isNaN(t)?Number((t/a).toFixed(2)):0};return(a,t)=>{const r=w("Column"),i=w("Button"),y=w("DataTable");return N(),J(y,{sortMode:"multiple",multiSortMeta:T.value,value:M.value},{footer:V(()=>[s("div",pe,[ve,n(j,{type:o(u).NUMERIC,minFractionDigits:0,class:"mb-2",id:"totalTime",modelValue:D.value,readonly:"",disabled:""},null,8,["type","modelValue"]),fe,n(j,{type:o(u).NUMERIC,minFractionDigits:2,class:"mb-2",id:"profitAverage",modelValue:E.value,suffix:"%",readonly:""},null,8,["type","modelValue"]),n(i,{onClick:v,icon:"pi pi-copy",label:"Aplicar"})])]),default:V(()=>[n(r,{field:"code",sortable:"",header:"Fase"}),n(r,{field:"order",sortable:"",header:"Pas"}),n(r,{field:"workcenterTypeId",header:"Màquina"},{body:V(c=>[X(F(W(c.data.workcenterTypeId)),1)]),_:1}),n(r,{field:"machineStatusId",header:"Estat"},{body:V(c=>[X(F(Y(c.data.machineStatusId)),1)]),_:1}),n(r,{field:"estimatedTime",header:"Temps total"}),n(r,{field:"isCycleTime",header:"Temps de cicle"},{body:V(c=>[n(re,{value:c.data.isCycleTime},null,8,["value"])]),_:1}),n(r,{header:"% de benefici"},{body:V(c=>[n(j,{type:o(u).NUMERIC,minFractionDigits:2,class:"mb-2",id:"profitPercentage",modelValue:c.data.profitPercentage,"onUpdate:modelValue":l=>c.data.profitPercentage=l,onInput:l=>_(c.data,l.value),suffix:"%"},null,8,["type","modelValue","onUpdate:modelValue","onInput"])]),_:1})]),_:1},8,["multiSortMeta","value"])}}}),be={key:0},ye={class:"three-columns"},Ve={class:"mb-2"},ge={class:"mb-2"},Pe={class:"seven-columns"},Ie={class:"seven-columns"},Re=O({__name:"FormBudgetOrderDetail",props:{formAction:{},header:{},detail:{},readonly:{type:Boolean}},emits:["submit"],setup(q,{emit:$}){const m=q,T=K(),P=Z(),d=ne(),C=a=>{m.detail.productionProfit=a,p(),b.value=0},b=g(0),{detail:e}=se(m),U=z(()=>m.formAction===G.CREATE?"Afegir":"Modificar");H(async()=>{m.formAction===G.EDIT&&e.value.productionCost===0&&e.value.productionProfit===0&&e.value.workMasterId!==null&&(e.value.productionCost=e.value.totalCost-(e.value.serviceCost+e.value.transportCost),e.value.productionCost>0&&(e.value.productionProfit=e.value.profit),e.value.serviceCost>0&&e.value.transportCost>0&&(e.value.externalProfit=e.value.profit),console.log("regularització inicial 'productionCost', 'productionProfit' i 'externalProfit'",e.value.productionCost,e.value.productionProfit,e.value.externalProfit))});const I=g(0),E=()=>{const a=P.references.find(t=>t.id===e.value.referenceId);a?(e.value.description=a.description,I.value=a.price,e.value.unitPrice=a.price,e.value.workMasterId=null,e.value.unitCost=a.lastCost,p()):(I.value=0,e.value.description="",e.value.unitPrice=0,e.value.workMasterId=null,e.value.unitCost=0,e.value.totalCost=0,e.value.amount=0)},f=g({machineCost:0,materialCost:0,operatorCost:0,externalTransportCost:0,externalServiceCost:0}),B=async a=>{if(e.value.workMasterId){const t=await T.getCosts(e.value.workMasterId,e.value.quantity);t.result&&t.content&&(f.value=t.content,a||(e.value.transportCost=f.value.externalTransportCost,e.value.serviceCost=f.value.externalServiceCost,e.value.productionCost=f.value.machineCost+f.value.operatorCost,e.value.materialCost=f.value.materialCost),e.value.totalCost=e.value.transportCost+e.value.serviceCost+e.value.productionCost+e.value.materialCost,e.value.unitCost=e.value.totalCost/e.value.quantity,p())}else E(),e.value.transportCost=0,e.value.serviceCost=0,e.value.productionCost=0,e.value.materialCost=0,e.value.totalCost=0},M=()=>{e.value.totalCost=e.value.productionCost+e.value.serviceCost+e.value.materialCost+e.value.transportCost,e.value.unitCost=e.value.totalCost/e.value.quantity,p()},D=()=>{e.value.quantity||(e.value.quantity=1),e.value.workMasterId&&B(!0),p()},p=()=>{if(e.value.unitPrice=e.value.unitCost,e.value.unitPrice===0){const a=P.references.find(t=>t.id===e.value.referenceId);e.value.unitPrice=(a==null?void 0:a.price)||0}(e.value.productionProfit>0||e.value.externalProfit>0||e.value.materialProfit>0)&&(console.log("production",e.value.productionCost*(1+e.value.productionProfit/100)),console.log("material",e.value.materialCost*(1+e.value.materialProfit/100)),console.log("external",(e.value.transportCost+e.value.serviceCost)*(1+e.value.externalProfit/100)),e.value.unitPrice=(e.value.productionCost*(1+e.value.productionProfit/100)+e.value.materialCost*(1+e.value.materialProfit/100)+(e.value.transportCost+e.value.serviceCost)*(1+e.value.externalProfit/100))/e.value.quantity,console.log("unitcost",e.value.unitCost),console.log("unitprice",e.value.unitPrice),e.value.unitCost>0&&(e.value.profit=S.round(e.value.unitPrice*100/e.value.unitCost-100,2)),console.log("profit",e.value.profit)),e.value.discount>0&&(e.value.unitPrice*=1-e.value.discount/100),e.value.unitPrice=S.round(e.value.unitPrice,2),e.value.amount=S.round(e.value.unitPrice*e.value.quantity,2)},W=()=>{e.value.amount=S.round(e.value.unitPrice*e.value.quantity,2)},Y=ee().shape({quantity:x().required("La quantitat és obligatoria").min(1,"La quantitat ha de ser un número positiu"),amount:x().required("El total és obligatori").min(0,"El total ha de ser un número igual o major que 0"),profit:x().required("El benefici és obligatori"),discount:x().required("El descompte és obligatori"),unitPrice:x().required("El preu unitari és obligatori")}),v=g({result:!1,errors:{}}),_=()=>{const a=new te(Y);v.value=a.validate(m.detail)},R=async()=>{if(_(),v.value.result)$("submit",m.detail);else{let a="";Object.entries(v.value.errors).forEach(t=>{a+=`${t[1].map(r=>r)}.   `}),d.add({severity:"warn",summary:"Formulari inválid",detail:a,life:5e3})}};return(a,t)=>{const r=w("BaseInput"),i=w("Button"),y=w("TabPanel"),c=w("TabView");return N(),J(c,{activeIndex:b.value,"onUpdate:activeIndex":t[28]||(t[28]=l=>b.value=l)},{default:V(()=>[n(y,{header:"Referència"},{default:V(()=>[o(e)?(N(),A("form",be,[s("section",ye,[s("div",Ve,[n(h,{label:"Referència",modelValue:o(e).referenceId,"onUpdate:modelValue":[t[0]||(t[0]=l=>o(e).referenceId=l),t[1]||(t[1]=l=>E())],customerId:a.header.customerId,fullName:!0},null,8,["modelValue","customerId"])]),s("div",null,[n(r,{class:"mb-2",label:"Preu",modelValue:I.value,"onUpdate:modelValue":t[2]||(t[2]=l=>I.value=l),type:o(u).CURRENCY,disabled:""},null,8,["modelValue","type"])]),s("div",ge,[n(me,{label:"Ruta de fabricació",modelValue:o(e).workMasterId,"onUpdate:modelValue":[t[3]||(t[3]=l=>o(e).workMasterId=l),t[4]||(t[4]=l=>B(!1))],referenceId:o(e).referenceId},null,8,["modelValue","referenceId"])])]),s("section",Pe,[s("div",null,[n(r,{class:"mb-2 budgetordercostinput",label:"Cost Producció",modelValue:o(e).productionCost,"onUpdate:modelValue":t[5]||(t[5]=l=>o(e).productionCost=l),type:o(u).CURRENCY,disabled:""},null,8,["modelValue","type"])]),s("div",null,[n(r,{class:k(["mb-2 budgetordercostinput",{"p-invalid":v.value.errors.profit}]),label:"% Benefici Producció",modelValue:o(e).productionProfit,"onUpdate:modelValue":[t[6]||(t[6]=l=>o(e).productionProfit=l),t[7]||(t[7]=l=>p())],type:o(u).NUMERIC,decimals:2},null,8,["modelValue","type","class"])]),s("div",null,[n(r,{class:"mb-2 budgetordercostinput",label:"Cost Material",modelValue:o(e).materialCost,"onUpdate:modelValue":t[8]||(t[8]=l=>o(e).materialCost=l),type:o(u).CURRENCY,disabled:""},null,8,["modelValue","type"])]),s("div",null,[n(r,{class:k(["mb-2 budgetordercostinput",{"p-invalid":v.value.errors.profit}]),label:"% Benefici Material",modelValue:o(e).materialProfit,"onUpdate:modelValue":[t[9]||(t[9]=l=>o(e).materialProfit=l),t[10]||(t[10]=l=>p())],type:o(u).NUMERIC,decimals:2},null,8,["modelValue","type","class"])]),s("div",null,[n(r,{class:"mb-2 budgetordercostinput",label:"Cost Servei",modelValue:o(e).serviceCost,"onUpdate:modelValue":[t[11]||(t[11]=l=>o(e).serviceCost=l),t[12]||(t[12]=l=>M())],type:o(u).CURRENCY,disabled:o(e).workMasterId===null},null,8,["modelValue","type","disabled"])]),s("div",null,[n(r,{class:"mb-2 budgetordercostinput",label:"Cost Transport ",modelValue:o(e).transportCost,"onUpdate:modelValue":[t[13]||(t[13]=l=>o(e).transportCost=l),t[14]||(t[14]=l=>M())],type:o(u).CURRENCY,disabled:o(e).workMasterId===null},null,8,["modelValue","type","disabled"])]),s("div",null,[n(r,{class:k(["mb-2 budgetordercostinput",{"p-invalid":v.value.errors.profit}]),label:"% Benefici Externs",modelValue:o(e).externalProfit,"onUpdate:modelValue":[t[15]||(t[15]=l=>o(e).externalProfit=l),t[16]||(t[16]=l=>p())],type:o(u).NUMERIC,decimals:2},null,8,["modelValue","type","class"])])]),s("section",Ie,[s("div",null,[n(r,{class:k(["mb-2 budgetordercostinput",{"p-invalid":v.value.errors.quantity}]),label:"Quantitat",modelValue:o(e).quantity,"onUpdate:modelValue":[t[17]||(t[17]=l=>o(e).quantity=l),t[18]||(t[18]=l=>D())],type:o(u).NUMERIC},null,8,["modelValue","type","class"])]),s("div",null,[n(r,{class:"mb-2 budgetordercostinput",label:"Cost Unitari",modelValue:o(e).unitCost,"onUpdate:modelValue":t[19]||(t[19]=l=>o(e).unitCost=l),type:o(u).CURRENCY,disabled:""},null,8,["modelValue","type"])]),s("div",null,[n(r,{class:"mb-2 budgetordercostinput",label:"Cost Total",modelValue:o(e).totalCost,"onUpdate:modelValue":t[20]||(t[20]=l=>o(e).totalCost=l),type:o(u).CURRENCY,disabled:""},null,8,["modelValue","type"])]),s("div",null,[n(r,{class:k(["mb-2 budgetordercostinput",{"p-invalid":v.value.errors.profit}]),label:"% Benefici",modelValue:o(e).profit,"onUpdate:modelValue":t[21]||(t[21]=l=>o(e).profit=l),type:o(u).NUMERIC,disabled:""},null,8,["modelValue","type","class"])]),s("div",null,[n(r,{class:k(["mb-2 budgetordercostinput",{"p-invalid":v.value.errors.discount}]),label:"% Descompte",modelValue:o(e).discount,"onUpdate:modelValue":[t[22]||(t[22]=l=>o(e).discount=l),t[23]||(t[23]=l=>p())],type:o(u).NUMERIC,decimals:2},null,8,["modelValue","type","class"])]),n(r,{class:"mb-2 budgetordercostinput",label:"Preu Unitari",modelValue:o(e).unitPrice,"onUpdate:modelValue":[t[24]||(t[24]=l=>o(e).unitPrice=l),t[25]||(t[25]=l=>W())],type:o(u).CURRENCY},null,8,["modelValue","type"]),s("div",null,[n(r,{class:k(["mb-2 budgetordercostinput",{"p-invalid":v.value.errors.amount}]),label:"Total",modelValue:o(e).amount,"onUpdate:modelValue":t[26]||(t[26]=l=>o(e).amount=l),disabled:"",type:o(u).CURRENCY},null,8,["modelValue","type","class"])])]),s("section",null,[s("div",null,[n(r,{class:k(["mb-2 budgetordercostinput",{"p-invalid":v.value.errors.description}]),label:"Descripció",modelValue:o(e).description,"onUpdate:modelValue":t[27]||(t[27]=l=>o(e).description=l),type:o(u).TEXT},null,8,["modelValue","type","class"])])]),n(i,{disabled:a.readonly,label:U.value,onClick:R,style:{float:"right"}},null,8,["disabled","label"])])):L("",!0)]),_:1}),n(y,{header:"Marges"},{default:V(()=>[n(Ce,{workMasterId:o(e).workMasterId,quantity:o(e).quantity,onUpdateProfitAverage:C},null,8,["workMasterId","quantity"])]),_:1})]),_:1},8,["activeIndex"])}}});export{Re as _};
