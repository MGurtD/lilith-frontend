import{d as J,j as ee,C as te,T as ae,r as N,h as _,a as v,c as V,k as a,e as u,i as o,s as j,n as Q,l as E,D as Z,p as we,b as Ie,f as re,x as Se,o as oe,w as n,Q as Ce,H as g,R as $,P as Y,G as x,m as z,L as se,ah as ge,F as h,v as he,g as Ne,u as Te,E as xe,X as Ee,I as G,J as Ve}from"./index-8529e343.js";import{u as le}from"./order-e5a750ac.js";import{u as de}from"./reference-4d9dd56a.js";import{u as ie}from"./customers-22f796ee.js";import{u as Be}from"./plantmodel-9213c5b9.js";import{u as ne}from"./lifecycle-5f73524a.js";import{u as Fe}from"./tax-9d65b597.js";import{c as We,a as X,F as $e}from"./form-validator-9bee509e.js";import{u as ue}from"./deliveryNote-22c6204d.js";import{u as ce}from"./budget-30267abc.js";import{_ as Re}from"./FormBudgetOrderDetail.vue_vue_type_script_setup_true_lang-b89f8443.js";import{L as Le}from"./LinkReference-d1f36b4e.js";import{_ as Me}from"./FormCreateWorkorder.vue_vue_type_script_setup_true_lang-aa32601c.js";import{u as me}from"./workmaster-236b3b5e.js";import{u as ve}from"./workorder-10c545f8.js";import{F as Ae}from"./FileEntityPicker-7c9b684c.js";import{a as Ue,b as qe}from"./report.service-6b90f343.js";import{S as Ge}from"./index-02e2a02a.js";import"./index-41f85f67.js";import"./DropdownReference.vue_vue_type_script_setup_true_lang-e5a98945.js";const H=B=>(we("data-v-9ef3c9d3"),B=B(),Ie(),B),ze={key:0},Pe={class:"four-columns mt-2"},je=H(()=>u("label",{class:"block text-900 mb-2"},"Client",-1)),Xe=H(()=>u("label",{class:"block text-900 mb-2"},"Estat",-1)),Ye={class:"four-columns mt-2"},He=H(()=>u("label",{class:"block text-900 mb-2"},"Data Alta",-1)),Qe=H(()=>u("label",{class:"block text-900 mb-2"},"Data Entrega",-1)),Je=J({__name:"FormSalesOrder",emits:["submit","cancel"],setup(B,{expose:I,emit:f}){const M=le(),F=ie(),D=ne(),k=ue(),p=ce(),O=ee(),{salesOrder:r}=te(M),y=ae(()=>k.deliveryNote?k.deliveryNote.number:""),W=We().shape({siteId:X().required("L'origen es obligatori"),customerId:X().required("El client es obligatori"),statusId:X().required("L'estat es obligatori"),exerciseId:X().required("L'exercici es obligatori")}),S=N({result:!1,errors:{}}),T=()=>{const c=new $e(W);S.value=c.validate(r.value)};I({submitForm:async()=>{if(T(),S.value.result)U(),f("submit",r.value);else{let c="";Object.entries(S.value.errors).forEach(e=>{c+=`${e[1].map(i=>i)}.   `}),O.add({severity:"warn",summary:"Formulari inválid",detail:c,life:5e3})}}});const C=()=>{var e;const c=(e=F.customers)==null?void 0:e.find(i=>{var d;return i.id===((d=r.value)==null?void 0:d.customerId)});c&&r.value&&(r.value.customerCode=c.code,r.value.customerComercialName=c.comercialName,r.value.customerTaxName=c.taxName,r.value.customerVatNumber=c.vatNumber,r.value.customerAccountNumber=c.accountNumber)},U=()=>{r.value&&(r.value.date=Z(r.value.date),r.value.expectedDate&&(r.value.expectedDate=Z(r.value.expectedDate)))};return(c,e)=>{var w,R;const i=_("BaseInput"),d=_("Dropdown"),m=_("Calendar");return v(),V("div",null,[a(r)?(v(),V("form",ze,[u("section",Pe,[u("div",null,[o(i,{type:a(j).TEXT,label:"Num. Comanda",id:"salesOrderNumber",modelValue:a(r).number,"onUpdate:modelValue":e[0]||(e[0]=t=>a(r).number=t),disabled:""},null,8,["type","modelValue"])]),u("div",null,[je,o(d,{modelValue:a(r).customerId,"onUpdate:modelValue":[e[1]||(e[1]=t=>a(r).customerId=t),e[2]||(e[2]=t=>C())],editable:"",options:a(F).customers,optionValue:"id",optionLabel:"comercialName",class:Q(["w-full",{"p-invalid":S.value.errors.customerId}])},null,8,["modelValue","options","class"])]),u("div",null,[o(i,{type:a(j).TEXT,label:"Comanda Client",id:"customerSalesOrderNumber",modelValue:a(r).customerNumber,"onUpdate:modelValue":e[3]||(e[3]=t=>a(r).customerNumber=t)},null,8,["type","modelValue"])]),u("div",null,[Xe,o(d,{modelValue:a(r).statusId,"onUpdate:modelValue":e[4]||(e[4]=t=>a(r).statusId=t),editable:"",options:(w=a(D).lifecycle)==null?void 0:w.statuses,optionValue:"id",optionLabel:"name",class:Q(["w-full",{"p-invalid":S.value.errors.statusId}])},null,8,["modelValue","options","class"])])]),u("section",Ye,[u("div",null,[He,o(m,{modelValue:a(r).date,"onUpdate:modelValue":e[5]||(e[5]=t=>a(r).date=t),dateFormat:"dd/mm/yy"},null,8,["modelValue"])]),u("div",null,[Qe,o(m,{modelValue:a(r).expectedDate,"onUpdate:modelValue":e[6]||(e[6]=t=>a(r).expectedDate=t),dateFormat:"dd/mm/yy"},null,8,["modelValue"])]),u("div",null,[o(i,{type:a(j).TEXT,label:"Num. Pressupost",id:"budgetNumber",disabled:"",value:(R=a(p).budget)==null?void 0:R.number},null,8,["type","value"])]),u("div",null,[o(i,{type:a(j).TEXT,disabled:!0,label:"Albarà Entrega",id:"deliveryNote",modelValue:y.value,"onUpdate:modelValue":e[7]||(e[7]=t=>y.value=t)},null,8,["type","modelValue"])])])])):E("",!0)])}}});const Ke=re(Je,[["__scopeId","data-v-9ef3c9d3"]]),Ze={key:0},et={key:1},tt=["onClick"],at={class:"total"},rt={class:"total-text"},ot=J({__name:"TableSalesOrderDetails",props:{salesOrder:{},salesOrderDetails:{},secondaryLifecycle:{},workorders:{}},emits:["edit","delete","createWorkOrder","openWorkOrder"],setup(B,{emit:I}){const f=B,M=Se();de();const F=me(),D=ve(),k=ae(()=>f.salesOrderDetails?f.salesOrderDetails.reduce((e,i)=>e+i.amount,0):0);oe(async()=>{D.fetchBySalesOrder(f.salesOrder.id)});var p=void 0;const O=N({closable:!0,modal:!0,title:"Generar ordre de fabricació",visible:!1}),r=N([]),y=N({workMasterId:"",plannedDate:"",plannedQuantity:0,comment:""}),W=e=>{f.salesOrder.deliveryNoteId||e.originalEvent.target.className.includes("grid_delete_column_button")||I("edit",e.data)},S=(e,i)=>{M.require({target:e.currentTarget,message:"Está segur que vol eliminar la referència?",icon:"pi pi-question-circle",acceptIcon:"pi pi-check",rejectIcon:"pi pi-times",accept:()=>{I("delete",i)}})},T=e=>{if(!e.workOrderId)return 0;const i=D.getWorkOrderCost(e.workOrderId);return i===0?0:i/e.quantity},A=e=>{r.value=F.getByReferenceId(e.referenceId),y.value.workMasterId="",r.value.length>0&&(y.value.workMasterId=r.value[0].id),y.value.plannedQuantity=e.quantity,y.value.plannedDate=f.salesOrder.expectedDate?ge(f.salesOrder.expectedDate):"",y.value.comment="",p=e,O.value.visible=!0},C=e=>{var d;if(!e)return"contrast";const i=D.getWorkOrderStatusById(e);if(i){console.log(i);const m=(d=f.secondaryLifecycle)==null?void 0:d.statuses.find(w=>w.id===i);if(m)return m.color}return"contrast"},U=e=>{I("openWorkOrder",e)},c=()=>{const e={workOrderDto:y.value,orderDetail:p};O.value.visible=!1,I("createWorkOrder",e)};return(e,i)=>{const d=_("Column"),m=_("Button"),w=_("DataTable"),R=_("Dialog");return v(),V(se,null,[o(w,{onRowClick:W,value:e.salesOrderDetails,tableStyle:"min-width: 100%",class:"p-datatable-sm",selectionMode:"single",dataKey:"id",sortMode:"single",sortField:"reference.code",sortOrder:1},{header:n(()=>[Ce(e.$slots,"header",{},void 0,!0)]),footer:n(()=>[u("div",at,[u("span",rt,"Total "+g(a($)(k.value)),1)])]),default:n(()=>[o(d,{field:"quantity",header:"Un.",style:{width:"3%"}}),o(d,{header:"Referencia",field:"reference.code",sortable:"",style:{width:"15%"}},{body:n(t=>[o(Le,{id:t.data.referenceId},null,8,["id"])]),_:1}),o(d,{field:"description",header:"Descripció",style:{width:"25%"}}),o(d,{field:"workOrderId",header:"Ordre fabr.",style:{width:"8%"}},{body:n(t=>[a(D).getWorkOrderCodeById(t.data.workOrderId)?(v(),V("div",Ze,[o(m,{size:"small",severity:C(t.data.workOrderId),label:a(D).getWorkOrderCodeById(t.data.workOrderId),onClick:L=>U(t.data.workOrderId)},null,8,["severity","label","onClick"])])):(v(),V("div",et,[o(m,{disabled:e.salesOrder.deliveryNoteId!==null,size:"small",icon:a(Y).PLUS_CIRCLE,value:"Generar OF",onClick:L=>A(t.data)},null,8,["disabled","icon","onClick"])]))]),_:1}),o(d,{field:"unitCost",header:"Cost un. teo.",style:{width:"8%"}},{body:n(t=>[x(g(a($)(t.data.unitCost)),1)]),_:1}),o(d,{field:"totalCost",header:"Cost teòric",style:{width:"8%"}},{body:n(t=>[x(g(a($)(t.data.totalCost)),1)]),_:1}),o(d,{header:"Cost un. r.",style:{width:"8%"}},{body:n(t=>[x(g(a($)(T(t.data))),1)]),_:1}),o(d,{header:"Cost real",style:{width:"6%"}},{body:n(t=>[x(g(a($)(a(D).getWorkOrderCost(t.data.workOrderId))),1)]),_:1}),o(d,{field:"discount",header:"% Bene.",style:{width:"6%"}},{body:n(t=>[x(g(t.data.profit)+" % ",1)]),_:1}),o(d,{field:"profit",header:"% Desc.",style:{width:"6%"}},{body:n(t=>[x(g(t.data.discount)+" % ",1)]),_:1}),o(d,{header:"Preu un.",style:{width:"6%"}},{body:n(t=>[x(g(a($)(t.data.unitPrice)),1)]),_:1}),o(d,{field:"amount",header:"Total",style:{width:"6%"}},{body:n(t=>[x(g(a($)(t.data.amount)),1)]),_:1}),e.salesOrder.deliveryNoteId?E("",!0):(v(),z(d,{key:0,style:{width:"5%"}},{body:n(t=>[!t.data.isDelivered&&!t.data.workOrderId?(v(),V("i",{key:0,class:Q([a(Y).TIMES,"grid_delete_column_button"]),onClick:L=>S(L,t.data)},null,10,tt)):E("",!0)]),_:1}))]),_:3},8,["value"]),o(R,{closable:O.value.closable,visible:O.value.visible,"onUpdate:visible":i[0]||(i[0]=t=>O.value.visible=t),header:O.value.title,modal:O.value.modal,style:{width:"50vw"}},{default:n(()=>[o(Me,{createWorkOrderDto:y.value,"filtered-work-masters":r.value,onSubmit:c},null,8,["createWorkOrderDto","filtered-work-masters"])]),_:1},8,["closable","visible","header","modal"])],64)}}});const st=re(ot,[["__scopeId","data-v-93b097ee"]]),lt={class:"flex flex-wrap align-items-center justify-content-between gap-2"},dt=u("span",{class:"text-l text-900 font-bold"},"Linies de la comanda",-1),it={key:0},nt="Línia de comanda",xt=J({__name:"SalesOrder",setup(B){const I=N(),f=N(h.EDIT),M=he(),F=Ne(),D=Te(),k=ee(),p=le(),O=ie(),r=Be(),y=xe(),W=ne(),S=de(),T=ue(),A=me(),C=ve(),U=Fe(),c=ce(),{salesOrder:e}=te(p),i=[{label:"Descarregar",icon:Y.FILE_WORD,command:()=>Oe()}],d=N(!1),m=N(h.EDIT),w=N(void 0),R=async()=>{const s=M.params.id;await p.GetById(s),S.fetchReferencesByModule("sales"),W.fetchOneByName("SalesOrder"),W.fetchSecondaryByName("WorkOrder"),r.fetchSites(),y.fetchAll(),O.fetchCustomers(),U.fetchAll(),C.fetchBySalesOrder(s),console.log("dins",C.workorders),A.workmasters||A.fetchAllActives();let l="";e.value&&(f.value=h.EDIT,l=`Comanda ${e.value.number}`,e.value.date=G(e.value.date),e.value.expectedDate&&(e.value.expectedDate=G(e.value.expectedDate)),e.value.deliveryNoteId?T.GetById(e.value.deliveryNoteId):T.deliveryNote&&(T.deliveryNote=void 0),e.value.budgetId?await c.GetById(e.value.budgetId):c.budget=void 0),D.setMenuItem({icon:Y.BUILDING,backButtonVisible:!0,title:l})};oe(async()=>{await R()});const t=()=>{I.value.submitForm()},L=(s,l)=>{s===h.CREATE&&(l={id:Ve(),referenceId:"",quantity:1,profit:0,discount:0,unitCost:0,serviceCost:0,transportCost:0,unitPrice:0,totalCost:0,amount:0,salesOrderHeaderId:"",lastCost:0,workMasterCost:0,description:"",estimatedDeliveryDate:new Date,isDelivered:!1,isInvoiced:!1,workMasterId:null,workOrderId:null}),l.salesOrderHeaderId=e.value.id,w.value=Object.assign({},l),m.value=s,d.value=!0},fe=async s=>{if(!s.date)return k.add({severity:"error",summary:"Error al crear la comanda ",detail:"La data no pot estar buida",life:5e3}),!1;let l=!1,b="";l=await p.Update(s.id,s),b=l?"Comanda actualitzada":"Error a l'actualitzar la comanda",k.add({life:5e3,severity:l?"success":"error",summary:b}),l&&F.back()},pe=async s=>{if(s=s,m.value===h.CREATE)await p.CreateDetail(s);else if(m.value===h.EDIT){await p.UpdateDetail(s);const l=e.value.salesOrderDetails.findIndex(b=>b.id===s.id);e.value.salesOrderDetails[l]=s}d.value=!1,e.value&&(e.value.date=G(e.value.date),e.value.expectedDate&&(e.value.expectedDate=G(e.value.expectedDate)))},ye=async s=>{f.value===h.EDIT&&await p.DeleteDetail(s);const l=e.value.salesOrderDetails.filter(b=>b.id!==s.id);e.value.salesOrderDetails=l,d.value=!1,e.value.date=G(e.value.date)},be=async s=>{const l=await C.create(s.workOrderDto);l.result?(s.orderDetail.workOrderId=l.content.id,await p.UpdateDetail(s.orderDetail)&&(k.add({severity:"success",summary:"Generació OF",detail:`Ordre de fabricació ${l.content.code} generada`,life:5e3}),C.fetchBySalesOrder(e.value.id))):k.add({severity:"error",summary:"Generació OF",detail:"Error al generar la ordre de fabricació",life:5e3})},_e=s=>{F.push({path:`/workorder/${s}`})},Oe=async()=>{var l;const s=await Ge.SalesOrder.GetReportDataById(e.value.id);if(s){const b=`Comanda_${(l=e.value)==null?void 0:l.number}.docx`,q=await new qe().Download(s,Ue.Order,b);q?Ee(b,q):k.add({severity:"warn",summary:"Error",detail:"No s'ha pugut generar fulla de la comanda"})}};return(s,l)=>{const b=_("SplitButton"),K=_("Button"),q=_("TabPanel"),De=_("TabView"),ke=_("Dialog");return v(),V(se,null,[o(b,{label:"Guardar",onClick:t,model:i,size:"small",class:"grid_add_row_button"}),o(Ke,{class:"mt-3 mb-3",ref_key:"salesOrderForm",ref:I,salesOrder:"salesOrder",onSubmit:fe},null,512),o(De,null,{default:n(()=>[o(q,{header:"Detall"},{default:n(()=>[a(e)?(v(),z(st,{key:0,salesOrder:a(e),salesOrderDetails:a(e).salesOrderDetails,secondaryLifecycle:a(W).secondaryLifecycle,workorders:a(C).workorders,onEdit:l[1]||(l[1]=P=>L(a(h).EDIT,P)),onDelete:ye,onCreateWorkOrder:be,onOpenWorkOrder:_e},{header:n(()=>[u("div",lt,[dt,a(T).deliveryNote?E("",!0):(v(),V("section",it,[o(K,{size:"small",label:"Afegir línea",onClick:l[0]||(l[0]=P=>L(a(h).CREATE,{})),class:"mr-2"})]))])]),_:1},8,["salesOrder","salesOrderDetails","secondaryLifecycle","workorders"])):E("",!0)]),_:1}),o(q,{header:"Fitxers"},{default:n(()=>[a(e)?(v(),z(Ae,{key:0,entity:"SalesOrder",id:a(e).id,title:""},null,8,["id"])):E("",!0)]),_:1})]),_:1}),a(e)?(v(),z(ke,{key:0,closable:!0,visible:d.value,"onUpdate:visible":l[2]||(l[2]=P=>d.value=P),header:nt,style:{width:"80%"},modal:!0},{default:n(()=>[w.value?(v(),z(Re,{key:0,formAction:m.value,header:a(e),detail:w.value,onSubmit:pe},null,8,["formAction","header","detail"])):E("",!0)]),_:1},8,["visible"])):E("",!0)],64)}}});export{xt as default};
