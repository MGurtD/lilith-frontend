import{_ as J}from"./DropdownReference.vue_vue_type_script_setup_true_lang-e1a79f67.js";import{c as Z,d as S,F as ee}from"./form-validator-6d089293.js";import{d as z,h as w,a as R,c as F,H as D,l as h,i as r,w as y,k as a,a5 as te,r as V,K as L,a7 as oe,T as W,o as ae,af as le,m as H,e as i,s as c,z as j,G,B as se,j as ne,ag as re,n as B,F as ie,a0 as O}from"./index-709c40c8.js";import{u as X}from"./reference-ced38a82.js";import{u as K}from"./workmaster-699a1a15.js";import{u as ue}from"./plantmodel-06593ba6.js";const de={class:"mb-2"},me={key:0,class:"block text-900 mb-2"},ce={key:0,class:"flex align-items-center"},pe=z({__name:"DropdownWorkmasters",props:{label:{},modelValue:{},referenceId:{}},emits:["update:modelValue"],setup(x,{emit:E}){const p=X(),P=K();return(v,C)=>{const T=w("Dropdown");return R(),F("div",de,[v.label.length>0?(R(),F("label",me,D(v.label),1)):h("",!0),r(T,te({showClear:"",filter:"",options:v.referenceId?a(P).getByReferenceId(v.referenceId):a(P).workmasters,optionValue:"id",optionLabel:d=>a(p).getShortNameById(d.referenceId)+" (Base = "+d.baseQuantity+")",class:"w-full"},v.$attrs,{"model-value":v.modelValue,onChange:C[0]||(C[0]=d=>E("update:modelValue",d.value))}),{option:y(d=>[d.option?(R(),F("div",ce,D(a(p).getShortNameById(d.option.referenceId)+" (Base = "+d.option.baseQuantity+" )"),1)):h("",!0)]),_:1},16,["options","optionLabel","model-value"])])}}}),ve={class:"flex flex-wrap align-items-center justify-content-between gap-2"},fe=i("span",{class:"text-l text-900"},"Temps total operatiu: ",-1),ye=i("span",{class:"text-l text-900 font-bold"},"Benefici ponderat ",-1),Ce=z({__name:"TableWorkmasterProfit",props:{workMasterId:{},quantity:{}},emits:["updateProfitAverage"],setup(x,{emit:E}){const p=x,P=V([{field:"code",order:1},{field:"order",order:1}]),v=K(),C=ue(),T=V([]),d=V(void 0),e=V(void 0),N=L({}),g=L({}),M=V(0),u=L({}),_=(s,o)=>s.flatMap(t=>t.details.map(n=>{const I=`${t.code}-${n.order}-${t.workcenterTypeId}`;return I in u||(u[I]=t.profitPercentage??0),{id:n.id,code:t.code,order:n.order,workcenterTypeId:t.workcenterTypeId||"",machineStatusId:n.machineStatusId||"",estimatedTime:n.isCycleTime?n.estimatedTime*o:n.estimatedTime,isCycleTime:n.isCycleTime,profitPercentage:t.isExternalWork?0:u[I]}}));oe(()=>p.quantity,(s,o)=>{U()});const k=W(()=>_(T.value,p.quantity)),A=W(()=>k.value.reduce((s,o)=>s+o.estimatedTime,0));ae(async()=>{await C.fetchWorkcenterTypes(),await C.fetchMachineStatuses(),d.value=C.workcenterTypes||[],e.value=C.machineStatuses||[],k.value.forEach(s=>{const o=$(s);s.workcenterTypeId in N||(N[o]=s.profitPercentage),s.workcenterTypeId in g||(g[o]=s.estimatedTime)}),U()}),le(async()=>{var s;p.workMasterId?(await v.fetchOne(p.workMasterId),T.value=((s=v.workmaster)==null?void 0:s.phases)||[]):T.value=[],U()});const $=s=>`${s.code}-${s.order}-${s.workcenterTypeId}`,b=s=>{var t;const o=(t=d.value)==null?void 0:t.find(n=>n.id===s);return(o==null?void 0:o.name)||"No definit"},Y=s=>{var t;const o=(t=e.value)==null?void 0:t.find(n=>n.id===s);return(o==null?void 0:o.name)||"No definit"},Q=()=>{E("updateProfitAverage",M.value)},f=(s,o)=>{if(typeof o=="number"){const t=$(s);u[t]=o,s.profitPercentage=o,N[t]=o,U()}else console.error("Attempted to set a non-number value for profit percentage:",o)},U=()=>{let s=0,o=0;k.value.forEach(t=>{const n=$(t),I=u[n],m=g[n]??t.estimatedTime;s+=m,o+=m*I}),console.log(o),console.log(s),console.log(Number((o/s).toFixed(2))),M.value=!isNaN(s)&&s>0&&!isNaN(o)?Number((o/s).toFixed(2)):0};return(s,o)=>{const t=w("Column"),n=w("Button"),I=w("DataTable");return R(),H(I,{sortMode:"multiple",multiSortMeta:P.value,value:k.value},{footer:y(()=>[i("div",ve,[fe,r(j,{type:a(c).NUMERIC,minFractionDigits:0,class:"mb-2",id:"totalTime",modelValue:A.value,readonly:"",disabled:""},null,8,["type","modelValue"]),ye,r(j,{type:a(c).NUMERIC,minFractionDigits:2,class:"mb-2",id:"profitAverage",modelValue:M.value,suffix:"%",readonly:""},null,8,["type","modelValue"]),r(n,{onClick:Q,icon:"pi pi-copy",label:"Aplicar"})])]),default:y(()=>[r(t,{field:"code",sortable:"",header:"Fase"}),r(t,{field:"order",sortable:"",header:"Pas"}),r(t,{field:"workcenterTypeId",header:"Màquina"},{body:y(m=>[G(D(b(m.data.workcenterTypeId)),1)]),_:1}),r(t,{field:"machineStatusId",header:"Estat"},{body:y(m=>[G(D(Y(m.data.machineStatusId)),1)]),_:1}),r(t,{field:"estimatedTime",header:"Temps total"}),r(t,{field:"isCycleTime",header:"Temps de cicle"},{body:y(m=>[r(se,{value:m.data.isCycleTime},null,8,["value"])]),_:1}),r(t,{header:"% de benefici"},{body:y(m=>[r(j,{type:a(c).NUMERIC,minFractionDigits:2,class:"mb-2",id:"profitPercentage",modelValue:m.data.profitPercentage,"onUpdate:modelValue":q=>m.data.profitPercentage=q,onInput:q=>f(m.data,q.value),suffix:"%"},null,8,["type","modelValue","onUpdate:modelValue","onInput"])]),_:1})]),_:1},8,["multiSortMeta","value"])}}}),be={key:0},Ie={class:"three-columns"},Ve={class:"mb-2"},ge={class:"mb-2"},ke={class:"five-columns"},we={class:"five-columns"},Ne=z({__name:"FormBudgetOrderDetail",props:{formAction:{},header:{},detail:{},readonly:{type:Boolean}},emits:["submit"],setup(x,{emit:E}){const p=x,P=K(),v=X(),C=ne(),T=o=>{p.detail.profit=o,b(),d.value=0},d=V(0),{detail:e}=re(p),N=W(()=>p.formAction===ie.CREATE?"Afegir":"Modificar"),g=V(0),M=()=>{const o=v.references.find(t=>t.id===e.value.referenceId);o?(e.value.description=o.description,g.value=o.price,e.value.unitPrice=o.price,e.value.workMasterId=null,e.value.unitCost=o.lastCost,b()):(g.value=0,e.value.description="",e.value.unitPrice=0,e.value.workMasterId=null,e.value.unitCost=0,e.value.totalCost=0,e.value.amount=0)},u=V({machineCost:0,materialCost:0,operatorCost:0,externalTransportCost:0,externalServiceCost:0}),_=async o=>{if(e.value.workMasterId){const t=await P.getCosts(e.value.workMasterId,e.value.quantity);t.result&&t.content&&(u.value=t.content,o||(e.value.transportCost=u.value.externalTransportCost,e.value.serviceCost=u.value.externalServiceCost),e.value.totalCost=u.value.machineCost+u.value.materialCost+u.value.operatorCost+e.value.transportCost+e.value.serviceCost,e.value.unitCost=e.value.totalCost/e.value.quantity,b())}else M(),e.value.transportCost=0,e.value.serviceCost=0,e.value.totalCost=0},k=W(()=>e.value.workMasterId?u.value.machineCost===0&&u.value.machineCost===0&&u.value.operatorCost===0?e.value.totalCost-e.value.serviceCost-e.value.transportCost:u.value.machineCost+u.value.materialCost+u.value.operatorCost:0),A=()=>{e.value.totalCost=k.value+e.value.serviceCost+e.value.transportCost,e.value.unitCost=e.value.totalCost/e.value.quantity,b()},$=()=>{e.value.quantity||(e.value.quantity=1),e.value.workMasterId&&_(!0),b()},b=()=>{if(e.value.unitPrice=e.value.unitCost,e.value.unitPrice===0){const o=v.references.find(t=>t.id===e.value.referenceId);e.value.unitPrice=(o==null?void 0:o.price)||0}e.value.profit>0&&(e.value.unitPrice*=1+e.value.profit/100),e.value.discount>0&&(e.value.unitPrice*=1-e.value.discount/100),e.value.unitPrice=O.round(e.value.unitPrice,2),e.value.amount=O.round(e.value.unitPrice*e.value.quantity,2)},Y=()=>{e.value.amount=O.round(e.value.unitPrice*e.value.quantity,2)},Q=Z().shape({quantity:S().required("La quantitat és obligatoria").min(1,"La quantitat ha de ser un número positiu"),amount:S().required("El total és obligatori").min(1,"El total ha de ser un número positiu"),profit:S().required("El benefici és obligatori"),discount:S().required("El descompte és obligatori"),unitPrice:S().required("El preu unitari és obligatori")}),f=V({result:!1,errors:{}}),U=()=>{const o=new ee(Q);f.value=o.validate(p.detail)},s=async()=>{if(U(),f.value.result)E("submit",p.detail);else{let o="";Object.entries(f.value.errors).forEach(t=>{o+=`${t[1].map(n=>n)}.   `}),C.add({severity:"warn",summary:"Formulari inválid",detail:o,life:5e3})}};return(o,t)=>{const n=w("BaseInput"),I=w("Button"),m=w("TabPanel"),q=w("TabView");return R(),H(q,{activeIndex:d.value,"onUpdate:activeIndex":t[22]||(t[22]=l=>d.value=l)},{default:y(()=>[r(m,{header:"Referència"},{default:y(()=>[a(e)?(R(),F("form",be,[i("section",Ie,[i("div",Ve,[r(J,{label:"Referència",modelValue:a(e).referenceId,"onUpdate:modelValue":[t[0]||(t[0]=l=>a(e).referenceId=l),t[1]||(t[1]=l=>M())],customerId:o.header.customerId,fullName:!0},null,8,["modelValue","customerId"])]),i("div",null,[r(n,{class:"mb-2",label:"Preu",modelValue:g.value,"onUpdate:modelValue":t[2]||(t[2]=l=>g.value=l),type:a(c).CURRENCY,disabled:""},null,8,["modelValue","type"])]),i("div",ge,[r(pe,{label:"Ruta de fabricació",modelValue:a(e).workMasterId,"onUpdate:modelValue":[t[3]||(t[3]=l=>a(e).workMasterId=l),t[4]||(t[4]=l=>_(!1))],referenceId:a(e).referenceId},null,8,["modelValue","referenceId"])])]),i("section",ke,[i("div",null,[r(n,{class:"mb-2",label:"Cost Intern",modelValue:k.value,"onUpdate:modelValue":t[5]||(t[5]=l=>k.value=l),type:a(c).CURRENCY,disabled:""},null,8,["modelValue","type"])]),i("div",null,[r(n,{class:"mb-2",label:"Cost Servei",modelValue:a(e).serviceCost,"onUpdate:modelValue":[t[6]||(t[6]=l=>a(e).serviceCost=l),t[7]||(t[7]=l=>A())],type:a(c).CURRENCY,disabled:a(e).workMasterId===null},null,8,["modelValue","type","disabled"])]),i("div",null,[r(n,{class:"mb-2",label:"Cost Transport",modelValue:a(e).transportCost,"onUpdate:modelValue":[t[8]||(t[8]=l=>a(e).transportCost=l),t[9]||(t[9]=l=>A())],type:a(c).CURRENCY,disabled:a(e).workMasterId===null},null,8,["modelValue","type","disabled"])]),i("div",null,[r(n,{class:"mb-2",label:"Cost Unitari",modelValue:a(e).unitCost,"onUpdate:modelValue":t[10]||(t[10]=l=>a(e).unitCost=l),type:a(c).CURRENCY,disabled:""},null,8,["modelValue","type"])]),i("div",null,[r(n,{class:"mb-2",label:"Cost Total",modelValue:a(e).totalCost,"onUpdate:modelValue":t[11]||(t[11]=l=>a(e).totalCost=l),type:a(c).CURRENCY,disabled:""},null,8,["modelValue","type"])])]),i("section",we,[i("div",null,[r(n,{class:B(["mb-2",{"p-invalid":f.value.errors.quantity}]),label:"Quantitat",modelValue:a(e).quantity,"onUpdate:modelValue":[t[12]||(t[12]=l=>a(e).quantity=l),t[13]||(t[13]=l=>$())],type:a(c).NUMERIC},null,8,["modelValue","type","class"])]),i("div",null,[r(n,{class:B(["mb-2",{"p-invalid":f.value.errors.profit}]),label:"% Benefici",modelValue:a(e).profit,"onUpdate:modelValue":[t[14]||(t[14]=l=>a(e).profit=l),t[15]||(t[15]=l=>b())],type:a(c).NUMERIC},null,8,["modelValue","type","class"])]),i("div",null,[r(n,{class:B(["mb-2",{"p-invalid":f.value.errors.discount}]),label:"% Descompte",modelValue:a(e).discount,"onUpdate:modelValue":[t[16]||(t[16]=l=>a(e).discount=l),t[17]||(t[17]=l=>b())],type:a(c).NUMERIC},null,8,["modelValue","type","class"])]),r(n,{class:"mb-2",label:"Preu Unitari",modelValue:a(e).unitPrice,"onUpdate:modelValue":[t[18]||(t[18]=l=>a(e).unitPrice=l),t[19]||(t[19]=l=>Y())],type:a(c).CURRENCY},null,8,["modelValue","type"]),i("div",null,[r(n,{class:B(["mb-2",{"p-invalid":f.value.errors.amount}]),label:"Total",modelValue:a(e).amount,"onUpdate:modelValue":t[20]||(t[20]=l=>a(e).amount=l),disabled:"",type:a(c).CURRENCY},null,8,["modelValue","type","class"])])]),i("section",null,[i("div",null,[r(n,{class:B(["mb-2",{"p-invalid":f.value.errors.description}]),label:"Descripció",modelValue:a(e).description,"onUpdate:modelValue":t[21]||(t[21]=l=>a(e).description=l),type:a(c).TEXT},null,8,["modelValue","type","class"])])]),r(I,{disabled:o.readonly,label:N.value,onClick:s,style:{float:"right"}},null,8,["disabled","label"])])):h("",!0)]),_:1}),r(m,{header:"Marges"},{default:y(()=>[r(Ce,{workMasterId:a(e).workMasterId,quantity:a(e).quantity,onUpdateProfitAverage:T},null,8,["workMasterId","quantity"])]),_:1})]),_:1},8,["activeIndex"])}}});export{Ne as _};
