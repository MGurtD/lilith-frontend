import{d as j,j as A,V as de,r as R,h as I,a as S,c as z,e,i as o,k as a,n as W,s as x,z as F,l as E,K as X,x as ne,w as p,P as L,G as O,H as T,m as N,L as Y,J as Z,Q as ie,aj as ue,v as ce,g as me,u as pe,C as fe,o as ke,I as be,D as we,R as H,p as he,b as _e,f as ve}from"./index-eea64e26.js";import{u as G}from"./plantmodel-756ce4ca.js";import{u as ee}from"./workorder-0c7f66a6.js";import{c as te,a as U,d as Q,F as oe}from"./form-validator-9374e474.js";import{_ as ye}from"./DropdownReference.vue_vue_type_script_setup_true_lang-931007a0.js";import{u as K}from"./lifecycle-f4be269e.js";import{_ as Pe}from"./DropdownLifecycle.vue_vue_type_script_setup_true_lang-fe833678.js";import{_ as Ie}from"./FormWorkorderPhase.vue_vue_type_script_setup_true_lang-20a25b27.js";import{u as re}from"./productionpart-ca09b770.js";import{u as Te}from"./reference-0201b480.js";import"./index-56fae9cf.js";import"./index-7cbe1881.js";const Ce={key:0},Ve={class:"mt-2"},Oe=e("label",{class:"block text-900 mb-2"},"Fase | Activitat",-1),ge={class:"three-columns mt-2"},De=e("label",{class:"block text-900 mb-2"},"Màquina",-1),$e=e("label",{class:"block text-900 mb-2"},"Operari",-1),Se=e("label",{class:"block text-900 mb-2"},"Data Tíquet",-1),qe={class:"three-columns mt-2"},We=e("br",null,null,-1),Be={class:"flex-right"},Ue=j({__name:"FormWorkOrderProductionPart",props:{productionPart:{},avoidWorkOrderRefresh:{type:Boolean}},emits:["submit","cancel"],setup(g,{emit:D}){const h=g,v=A(),$=G(),y=ee(),k=de(()=>{var f,V,q;if(!h.productionPart.workOrderPhaseId)return[];const n=(V=(f=y.workorder)==null?void 0:f.phases)==null?void 0:V.find(i=>i.id===h.productionPart.workOrderPhaseId);return n?(q=$.workcenters)==null?void 0:q.filter(i=>i.workcenterTypeId===n.workcenterTypeId):$.workcenters}),d=R(void 0),r=()=>{d.value.value&&(h.productionPart.workOrderId=d.value.value.workOrderId,h.productionPart.workOrderPhaseId=d.value.value.workOrderPhaseId,h.productionPart.workOrderPhaseDetailId=d.value.value.workOrderPhaseDetailId)},l=te().shape({operatorId:U().required("Escull un operari"),workcenterId:U().required("Escull una màquina"),workOrderId:U().required("Escull una ordre de fabricació"),workOrderPhaseId:U().required("Escull una fase"),workOrderPhaseDetailId:U().required("Escull una activitat"),quantity:Q().required("Has d'introduir una quantitat entera (pot ser 0)").integer(),workcenterTime:Q().required("Has d'introduir el temps de màquina i ha de ser major que 0").moreThan(0)}),t=R({result:!1,errors:{}}),_=()=>{const n=new oe(l);t.value=n.validate(h.productionPart)},C=async n=>{h.avoidWorkOrderRefresh||(d.value=void 0,await y.fetchByWorkcenterId(n))},u=async()=>{if(_(),t.value.result)D("submit",h.productionPart);else{let n="";Object.entries(t.value.errors).forEach(f=>{n+=`${f[1].map(V=>V)}.   `}),v.add({severity:"warn",summary:"Formulari inválid",detail:n,life:5e3})}};return(n,f)=>{var m,w,b;const V=I("Dropdown"),q=I("Calendar"),i=I("Button");return n.productionPart?(S(),z("form",Ce,[e("section",Ve,[e("div",null,[Oe,o(V,{modelValue:d.value,"onUpdate:modelValue":f[0]||(f[0]=s=>d.value=s),editable:"",filter:!0,options:(m=a(y).detailedWorkOrders)==null?void 0:m.map(s=>({label:"Fase "+s.workOrderPhaseCode+"  ("+s.workOrderPhaseDescription+") | "+s.machineStatusDescription,value:s})).sort((s,c)=>s.label.localeCompare(c.label)),optionLabel:"label",class:W(["w-full",{"p-invalid":t.value.errors.workOrderId}]),onChange:r},null,8,["modelValue","options","class"])])]),e("section",ge,[e("div",null,[De,o(V,{modelValue:n.productionPart.workcenterId,"onUpdate:modelValue":f[1]||(f[1]=s=>n.productionPart.workcenterId=s),editable:"",filter:!0,options:(w=k.value)==null?void 0:w.sort((s,c)=>s.description.localeCompare(c.description)),optionValue:"id",optionLabel:"description",class:"w-full",onChange:f[2]||(f[2]=s=>C(n.productionPart.workcenterId))},null,8,["modelValue","options"])]),e("div",null,[$e,o(V,{modelValue:n.productionPart.operatorId,"onUpdate:modelValue":f[3]||(f[3]=s=>n.productionPart.operatorId=s),editable:"",filter:!0,options:(b=a($).operators)==null?void 0:b.sort((s,c)=>s.surname.localeCompare(c.surname)).map(s=>({value:s.id,label:s.name+" "+s.surname})),optionValue:"value",optionLabel:"label",class:W(["w-full",{"p-invalid":t.value.errors.operatorid}])},null,8,["modelValue","options","class"])]),e("div",null,[Se,o(q,{modelValue:n.productionPart.date,"onUpdate:modelValue":f[4]||(f[4]=s=>n.productionPart.date=s),dateFormat:"dd/mm/yy"},null,8,["modelValue"])])]),e("section",qe,[e("div",null,[o(F,{type:a(x).NUMERIC,label:"Quantitat",id:"quantity",modelValue:n.productionPart.quantity,"onUpdate:modelValue":f[5]||(f[5]=s=>n.productionPart.quantity=s)},null,8,["type","modelValue"])]),e("div",null,[o(F,{type:a(x).NUMERIC,label:"Temps total centre de treball (minuts)",id:"time",modelValue:n.productionPart.workcenterTime,"onUpdate:modelValue":f[6]||(f[6]=s=>n.productionPart.workcenterTime=s)},null,8,["type","modelValue"])]),e("div",null,[o(F,{type:a(x).NUMERIC,label:"Temps total operari (minuts)",id:"time",modelValue:n.productionPart.operatorTime,"onUpdate:modelValue":f[7]||(f[7]=s=>n.productionPart.operatorTime=s)},null,8,["type","modelValue"])])]),We,e("div",Be,[o(i,{label:"Guardar",size:"small",onClick:u})])])):E("",!0)}}}),Ee={key:0},Me=e("br",null,null,-1),Ne={class:"four-columns"},Fe=e("label",{class:"block text-900 mb-2"},"Data Prevista",-1),Re={class:"four-columns"},xe=e("label",{class:"block text-900 mb-2"},"Data Inici",-1),Le=e("label",{class:"block text-900 mb-2"},"Data Fi",-1),je=e("label",{class:"block text-900 mb-2"},"Comentari Fabricació",-1),He=j({__name:"FormWorkorder",props:{workorder:{}},emits:["submit","cancel"],setup(g,{emit:D}){const h=g;K();const v=A(),$=te().shape({plannedQuantity:Q().min(1,"La quantitat ha de ser superior a 0").required("La quanitat és obligatoria"),referenceId:U().required("La referència és obligatoria"),order:Q().required("L'ordre és obligatori"),plannedDate:U().required("La data prevista és obligatoria")}),y=R({result:!1,errors:{}}),k=()=>{const r=new oe($);y.value=r.validate(h.workorder)},d=async()=>{if(k(),y.value.result)D("submit",h.workorder);else{let r="";Object.entries(y.value.errors).forEach(l=>{r+=`${l[1].map(t=>t)}.   `}),v.add({severity:"warn",summary:"Formulari inválid",detail:r,life:5e3})}};return(r,l)=>{const t=I("Button"),_=I("Calendar"),C=I("Textarea");return r.workorder?(S(),z("form",Ee,[e("div",null,[o(t,{label:"Guardar",class:"grid_add_row_button",size:"small",onClick:d}),Me]),e("section",Ne,[e("div",null,[o(F,{label:"Codi",modelValue:r.workorder.code,"onUpdate:modelValue":l[0]||(l[0]=u=>r.workorder.code=u),disabled:""},null,8,["modelValue"])]),e("div",null,[o(ye,{label:"Referència",modelValue:r.workorder.referenceId,"onUpdate:modelValue":l[1]||(l[1]=u=>r.workorder.referenceId=u),fullName:!0,disabled:""},null,8,["modelValue"])]),e("div",null,[o(F,{type:a(x).NUMERIC,label:"Quantitat",modelValue:r.workorder.plannedQuantity,"onUpdate:modelValue":l[2]||(l[2]=u=>r.workorder.plannedQuantity=u),class:W({"p-invalid":y.value.errors.plannedQuantity})},null,8,["type","modelValue","class"])]),e("div",null,[Fe,o(_,{modelValue:r.workorder.plannedDate,"onUpdate:modelValue":l[3]||(l[3]=u=>r.workorder.plannedDate=u),dateFormat:"dd/mm/yy",class:W(["mt-2",{"p-invalid":y.value.errors.plannedDate}])},null,8,["modelValue","class"])])]),e("section",Re,[e("div",null,[o(Pe,{label:"Estat",modelValue:r.workorder.statusId,"onUpdate:modelValue":l[4]||(l[4]=u=>r.workorder.statusId=u),name:"WorkOrder",class:W({"p-invalid":y.value.errors.statusId})},null,8,["modelValue","class"])]),e("div",null,[xe,o(_,{modelValue:r.workorder.startTime,"onUpdate:modelValue":l[5]||(l[5]=u=>r.workorder.startTime=u),dateFormat:"dd/mm/yy",class:"mt-2"},null,8,["modelValue"])]),e("div",null,[Le,o(_,{modelValue:r.workorder.endTime,"onUpdate:modelValue":l[6]||(l[6]=u=>r.workorder.endTime=u),dateFormat:"dd/mm/yy",class:"mt-2"},null,8,["modelValue"])]),e("div",null,[o(F,{type:a(x).NUMERIC,label:"Prioritat",modelValue:r.workorder.order,"onUpdate:modelValue":l[7]||(l[7]=u=>r.workorder.order=u),class:W({"p-invalid":y.value.errors.plannedorderQuantity})},null,8,["type","modelValue","class"])])]),e("div",null,[je,o(C,{class:"w-full",modelValue:r.workorder.comment,"onUpdate:modelValue":l[8]||(l[8]=u=>r.workorder.comment=u)},null,8,["modelValue"])])])):E("",!0)}}}),Qe={class:"flex flex-wrap align-items-center justify-content-between gap-2"},Ae=e("span",{class:"text-xl text-900 font-bold"},"Fases",-1),ze=["onClick"],Ge=j({__name:"TableWorkorderPhases",props:{workorder:{},workorderPhases:{}},emits:["add","edit","delete"],setup(g,{emit:D}){const h=g,v=X({visible:!1,title:"Nova fase",closable:!0,position:"center",modal:!0}),$=A(),y=ne(),k=G(),d=K(),r=i=>{var w;if(!k.workcenterTypes)return"";const m=(w=k.workcenterTypes)==null?void 0:w.find(b=>i===b.id);return m?m.name:""},l=i=>{var w;if(!k.workcenters)return"";const m=(w=k.workcenters)==null?void 0:w.find(b=>i===b.id);return m?m.name:""},t=i=>{var w;if(!k.operatorTypes)return"";const m=(w=k.operatorTypes)==null?void 0:w.find(b=>i===b.id);return m?m.name:""},_=i=>{var w;if(!d.lifecycle||!d.lifecycle.statuses)return"";const m=(w=d.lifecycle.statuses)==null?void 0:w.find(b=>i===b.id);return m?m.name:""},C=()=>{const m=h.workorder.phases.reduce((b,s)=>{const c=parseInt(s.code,10)||0;return Math.max(b,c)},0);return(Math.ceil((m+1)/10)*10).toString()},u=R({}),n=()=>{u.value={id:Z(),workOrderId:h.workorder.id,disabled:!1,code:C(),description:"",operatorTypeId:null,workcenterTypeId:null,preferredWorkcenterId:null,isExternalWork:!1,externalWorkCost:0,transportCost:0,serviceReferenceId:null,statusId:"",startTime:null,endTime:null,profitPercentage:0,workOrderPhaseDetails:[],workOrderPhaseBillOfMaterials:[]},v.visible=!0},f=i=>{if(h.workorder.phases.find(w=>w.code===i.code)){$.add({severity:"warn",summary:"Fase invàlida",detail:`La fase ${i.code} ja existeix`,life:5e3});return}v.visible=!1,D("add",i)},V=i=>{i.originalEvent.target.className.includes("grid_delete_column_button")||D("edit",i.data)},q=(i,m)=>{y.require({target:i.currentTarget,message:"Está segur que vol eliminar la fase?",icon:"pi pi-question-circle",acceptIcon:"pi pi-check",rejectIcon:"pi pi-times",accept:()=>{D("delete",m)}})};return(i,m)=>{const w=I("Button"),b=I("Column"),s=I("BooleanColumn"),c=I("DataTable"),M=I("Dialog");return S(),z(Y,null,[o(c,{onRowClick:V,class:"p-datatable-sm",value:i.workorderPhases,tableStyle:"min-width: 100%","sort-field":"code","sort-order":1},{header:p(()=>[e("div",Qe,[Ae,o(w,{icon:a(L).PLUS,rounded:"",raised:"",onClick:n},null,8,["icon"])])]),default:p(()=>[o(b,{field:"code",header:"Codi",sortable:"",style:{width:"10%"}}),o(b,{field:"description",header:"Descripció",style:{width:"15%"}}),o(b,{header:"Tipus de màquina",style:{width:"15%"}},{body:p(P=>[O(T(r(P.data.workcenterTypeId)),1)]),_:1}),o(b,{header:"Màquina preferida",style:{width:"15%"}},{body:p(P=>[O(T(l(P.data.preferredWorkcenterId)),1)]),_:1}),o(b,{header:"Tipus d'operari",style:{width:"15%"}},{body:p(P=>[O(T(t(P.data.operatorTypeId)),1)]),_:1}),o(b,{header:"Estat",style:{width:"15%"}},{body:p(P=>[O(T(_(P.data.statusId)),1)]),_:1}),o(b,{header:"Extern",style:{width:"5%"}},{body:p(P=>[o(s,{value:P.data.isExternalWork},null,8,["value"])]),_:1}),o(b,{style:{width:"5%"}},{body:p(P=>[e("i",{class:W([a(L).TIMES,"grid_delete_column_button"]),onClick:J=>q(J,P.data)},null,10,ze)]),_:1})]),_:1},8,["value"]),o(M,{visible:v.visible,"onUpdate:visible":m[0]||(m[0]=P=>v.visible=P),header:v.title,closable:v.closable,modal:v.modal},{default:p(()=>[u.value?(S(),N(Ie,{key:0,workorder:i.workorder,phase:u.value,onSubmit:f},null,8,["workorder","phase"])):E("",!0)]),_:1},8,["visible","header","closable","modal"])],64)}}}),Je=["onClick"],Ke=j({__name:"TableProductionParts",emits:["delete"],setup(g,{emit:D}){const h=re(),v=G(),$=k=>{if(!k)return"";if(k.workOrderPhase&&k.workOrderPhaseDetail){const d=v.getMachineStatusNameById(k.workOrderPhaseDetail.machineStatusId);return`(${k.workOrderPhase.code}) ${k.workOrderPhase.description} - ${d}`}},y=(k,d)=>{k.stopPropagation(),D("delete",d)};return(k,d)=>{const r=I("Column"),l=I("DataTable");return S(),N(l,{value:a(h).productionParts,class:"p-datatable-sm",tableStyle:"min-width: 100%",scrollable:"",scrollHeight:"40vh"},{header:p(()=>[ie(k.$slots,"header")]),empty:p(()=>[O(" No s'han trobat tiquets. ")]),loading:p(()=>[O(" Carregant tiquets. Si us plau espera. ")]),default:p(()=>[o(r,{field:"operatorId",header:"Operari",style:{width:"20%"}},{body:p(t=>[O(T(a(v).getOperatorNameById(t.data.operatorId)),1)]),_:1}),o(r,{field:"workcenterId",header:"Màquina",style:{width:"20%"}},{body:p(t=>[O(T(a(v).getWorkcenterNameById(t.data.workcenterId)),1)]),_:1}),o(r,{field:"workOrderPhaseId",header:"Fase/Estat",style:{width:"25%"}},{body:p(t=>[O(T($(t.data)),1)]),_:1}),o(r,{field:"date",header:"Data",style:{width:"10%"}},{body:p(t=>[O(T(a(ue)(t.data.date)),1)]),_:1}),o(r,{field:"quantity",header:"Quantitat",style:{width:"7.5%"}}),o(r,{field:"workcenterTime",header:"Temps màquina",style:{width:"10%"}},{body:p(t=>[O(T(t.data.workcenterTime)+" min. ",1)]),_:1}),o(r,{field:"operatorTime",header:"Temps operari",style:{width:"10%"}},{body:p(t=>[O(T(t.data.operatorTime)+" min. ",1)]),_:1}),o(r,{style:{width:"5%"}},{body:p(t=>[e("i",{class:W([a(L).TIMES,"grid_delete_column_button"]),onClick:_=>y(_,t.data)},null,10,Je)]),_:1})]),_:3},8,["value"])}}}),B=g=>(he("data-v-43dd669f"),g=g(),_e(),g),Xe={class:"main"},Ye={class:"flex flex-wrap align-items-center justify-content-between gap-2"},Ze=B(()=>e("span",{class:"text-xl text-900 font-bold"},"Hores",-1)),et={class:"four-columns"},tt={class:"mt-1"},ot=B(()=>e("label",{class:"block text-900 mb-2"},"Cost Operari",-1)),rt={class:"summary-field"},at={class:"mt-1"},st=B(()=>e("label",{class:"block text-900 mb-2"},"Cost Máquina",-1)),lt={class:"summary-field"},dt={class:"mt-1"},nt=B(()=>e("label",{class:"block text-900 mb-2"},"Cost Material",-1)),it={class:"summary-field"},ut={class:"mt-1"},ct=B(()=>e("label",{class:"block text-900 mb-2"},"Cost Total",-1)),mt={class:"summary-field"},pt={class:"four-columns mt-4"},ft={class:"mt-1"},kt=B(()=>e("label",{class:"block text-900 mb-2"},"Temps Operari",-1)),bt={class:"summary-field"},wt={class:"mt-1"},ht=B(()=>e("label",{class:"block text-900 mb-2"},"Temps Màquina",-1)),_t={class:"summary-field"},vt=B(()=>e("div",{class:"mt-1"},null,-1)),yt=j({__name:"Workorder",setup(g){const D=ce(),h=me(),v=pe(),$=A(),y=K(),k=Te(),d=ee(),r=G(),l=re(),{workorder:t}=fe(d),_=R(""),C=X({visible:!1,title:"Crear tíquet de producció",closable:!0,position:"center",modal:!0});ke(async()=>{_.value=D.params.id,d.detailedWorkOrders=void 0,await n();let c="";c="Ordre de fabricació",t.value&&(c=`${c} ${t.value.code}`),v.setMenuItem({icon:L.BUILDING,backButtonVisible:!0,title:c})});const u=async()=>{await d.fetchOne(_.value),d.workorder&&(d.workorder.plannedDate=be(d.workorder.plannedDate))},n=async()=>{k.fetchReferencesByModule("sales"),r.fetchActiveModel(),y.fetchOneByName("WorkOrder"),l.fetchByWorkOrderId(_.value),await u()},f=async c=>{d.workorder&&(d.workorder.plannedDate=we(d.workorder.plannedDate)),await d.update(_.value,c)&&await n()},V=async c=>{await d.createPhase(c)?h.push({path:`/workorder/${_.value}/phase/${c.id}`}):$.add({severity:"error",summary:"Error al crear la fase",detail:"Revisi el log per a més informació",life:1e4})},q=c=>{h.push({path:`/workorder/${_.value}/phase/${c.id}`})},i=async c=>{await d.deletePhase(c.id)},m=R({}),w=()=>{m.value={id:Z(),workOrderId:_.value,workOrderPhaseId:"",workOrderPhaseDetailId:"",operatorId:"",workcenterId:"",operatorTime:0,workcenterTime:0,quantity:0,date:new Date,machineHourCost:0,operatorHourCost:0},t.value&&d.fetchByWorkOrderId(t.value.id),C.visible=!0},b=async()=>{C.visible=!1,await l.create(m.value)&&(l.fetchByWorkOrderId(_.value),u())},s=async c=>{await l.delete(c.id),l.fetchByWorkOrderId(_.value),u()};return(c,M)=>{const P=I("TabPanel"),J=I("Button"),ae=I("TabView"),se=I("Dialog");return S(),z(Y,null,[e("header",null,[a(t)?(S(),N(He,{key:0,workorder:a(t),onSubmit:f},null,8,["workorder"])):E("",!0)]),e("main",Xe,[o(ae,null,{default:p(()=>[o(P,{header:"Fases"},{default:p(()=>[a(t)&&a(t).phases?(S(),N(Ge,{key:0,workorder:a(t),workorderPhases:a(t).phases,onAdd:V,onEdit:q,onDelete:i},null,8,["workorder","workorderPhases"])):E("",!0)]),_:1}),o(P,{header:"Hores"},{default:p(()=>[a(l).productionParts?(S(),N(Ke,{key:0,productionParts:a(l).productionParts,onDelete:s},{header:p(()=>[e("div",Ye,[Ze,o(J,{icon:a(L).PLUS,rounded:"",raised:"",onClick:w},null,8,["icon"])])]),_:1},8,["productionParts"])):E("",!0)]),_:1}),a(t)?(S(),N(P,{key:0,header:"Costs"},{default:p(()=>[e("section",et,[e("div",tt,[ot,e("span",rt,T(a(H)(a(t).operatorCost)),1)]),e("div",at,[st,e("span",lt,T(a(H)(a(t).machineCost)),1)]),e("div",dt,[nt,e("span",it,T(a(H)(a(t).materialCost)),1)]),e("div",ut,[ct,e("span",mt,T(a(H)(a(t).machineCost+a(t).materialCost+a(t).operatorCost)),1)])]),e("section",pt,[e("div",ft,[kt,e("span",bt,T(a(t).operatorTime)+" mins.",1)]),e("div",wt,[ht,e("span",_t,T(a(t).machineTime)+" mins.",1)]),vt])]),_:1})):E("",!0)]),_:1})]),o(se,{visible:C.visible,"onUpdate:visible":M[0]||(M[0]=le=>C.visible=le),header:C.title,closable:C.closable,modal:C.modal},{default:p(()=>[o(Ue,{productionPart:m.value,"avoid-work-order-refresh":!0,onSubmit:b},null,8,["productionPart"])]),_:1},8,["visible","header","closable","modal"])],64)}}});const Bt=ve(yt,[["__scopeId","data-v-43dd669f"]]);export{Bt as default};
