import{d as L,E as H,j as z,C as Z,r as S,h as w,k as i,a as C,c as T,e as l,i as s,s as P,z as B,n as M,l as A,D as De,p as we,b as Ie,f as ee,g as te,v as ae,X as se,o as oe,S as re,m as ie,w as f,Q as Re,H as x,G as O,I as J,R as K,P as U,u as Se,x as Ve,K as ge,F as k,Y as Ce,J as Y}from"./index-eea64e26.js";import{u as j}from"./order-181f4c13.js";import{u as le}from"./suppliers-50a1eacc.js";import{_ as ne}from"./DropdownLifecycle.vue_vue_type_script_setup_true_lang-fe833678.js";import{c as de,a as q,F as ce,d as Ee}from"./form-validator-9374e474.js";import{L as xe}from"./LinkReference-f9b29e5a.js";import{u as G}from"./reference-0201b480.js";import{_ as Oe}from"./DropdownReference.vue_vue_type_script_setup_true_lang-931007a0.js";import{E as ue}from"./index-ff493971.js";import{R as ke}from"./index-7cbe1881.js";import{u as Te}from"./lifecycle-f4be269e.js";import{u as $e}from"./referenceType-80bee852.js";import{a as Fe,b as Ne}from"./report.service-a6c533c3.js";import"./suppliers.service-eb1c0285.js";const W=D=>(we("data-v-aed0ba68"),D=D(),Ie(),D),Pe={key:0},Be={class:"three-columns"},Ue={class:"mt-1"},qe={class:"mt-1"},Le=W(()=>l("label",{class:"block text-900 mb-2"},"Exercici",-1)),Ae={class:"mt-1"},Qe=W(()=>l("label",{class:"block text-900 mb-2"},"Data Comanda",-1)),Me={class:"three-columns"},ze={class:"mt-1"},je={class:"mt-1"},Ge=W(()=>l("label",{class:"block text-900 mb-2"},"Proveïdor",-1)),We=L({__name:"FormOrder",emits:["submit","cancel"],setup(D,{expose:I,emit:d}){const V=j(),R=le(),b=H(),y=z(),{order:c}=Z(V),p=de().shape({supplierId:q().required("El client es obligatori"),statusId:q().required("L'estat es obligatori"),exerciseId:q().required("L'exercici es obligatori")}),v=S({result:!1,errors:{}}),h=()=>{const e=new ce(p);v.value=e.validate(c.value)};return I({submitForm:async()=>{if(h(),v.value.result)c.value.date=De(c.value.date),d("submit",c.value);else{let e="";Object.entries(v.value.errors).forEach(a=>{e+=`${a[1].map(o=>o)}.   `}),y.add({severity:"warn",summary:"Formulari inválid",detail:e,life:5e3})}}}),(e,a)=>{const o=w("Dropdown"),u=w("Calendar");return i(c)?(C(),T("form",Pe,[l("section",Be,[l("div",Ue,[s(B,{type:i(P).TEXT,label:"Número",id:"number",modelValue:i(c).number,"onUpdate:modelValue":a[0]||(a[0]=t=>i(c).number=t),disabled:""},null,8,["type","modelValue"])]),l("div",qe,[Le,s(o,{modelValue:i(c).exerciseId,"onUpdate:modelValue":a[1]||(a[1]=t=>i(c).exerciseId=t),editable:"",options:i(b).exercises,optionValue:"id",optionLabel:"name",class:M(["w-full",{"p-invalid":v.value.errors.exerciseId}])},null,8,["modelValue","options","class"])]),l("div",Ae,[Qe,s(u,{modelValue:i(c).date,"onUpdate:modelValue":a[2]||(a[2]=t=>i(c).date=t),dateFormat:"dd/mm/yy"},null,8,["modelValue"])])]),l("section",Me,[l("div",ze,[s(ne,{label:"Estat",name:"PurchaseOrder",modelValue:i(c).statusId,"onUpdate:modelValue":a[3]||(a[3]=t=>i(c).statusId=t)},null,8,["modelValue"])]),l("div",je,[Ge,s(o,{modelValue:i(c).supplierId,"onUpdate:modelValue":a[4]||(a[4]=t=>i(c).supplierId=t),editable:"",options:i(R).suppliers,optionValue:"id",optionLabel:"comercialName",class:M(["w-full",{"p-invalid":v.value.errors.customerId}])},null,8,["modelValue","options","class"])])])])):A("",!0)}}});const Xe=ee(We,[["__scopeId","data-v-aed0ba68"]]),Je=["onClick"],Ke={class:"expanded-details"},Ye=["onClick"],He=L({__name:"TableOrderDetails",props:{details:{}},emits:["edit","delete"],setup(D,{emit:I}){const d=D,V=te(),R=ae(),b=j(),y=S(void 0),c=S({}),p=S([]);G(),se(()=>{var o;return(o=d.details)==null?void 0:o.length},async o=>{o&&await v()}),oe(async()=>{await b.getReceptions(R.params.id),b.receptions&&(await v(),y.value=await re.Lifecycle.getByName("PurchaseOrderDetail"))});const v=async()=>{var o;p.value=((o=d.details)==null?void 0:o.map(u=>{var t;return{...u,receptions:(t=b.receptions)==null?void 0:t.filter(E=>E.purchaseOrderDetailId===u.id)}}))||[]},h=o=>{if(!y.value)return"";const u=y.value.statuses.find(t=>t.id===o);return u?u.name:""},g=o=>{try{o.originalEvent.target.className.includes("grid_delete_column_button")||I("edit",o.data)}catch{}},e=(o,u)=>{I("delete",u)},a=o=>{const u=`/receipts/${o}`;V.push(u)};return(o,u)=>{const t=w("Column"),E=w("DataTable");return C(),ie(E,{onRowClick:g,value:p.value,tableStyle:"min-width: 100%",class:"p-datatable-sm","sort-mode":"single","sort-field":"reference.code","sort-order":1,dataKey:"id",expandedRows:c.value,"onUpdate:expandedRows":u[0]||(u[0]=r=>c.value=r)},{header:f(()=>[Re(o.$slots,"header",{},void 0,!0)]),expansion:f(({data:r})=>[l("div",Ke,[s(E,{value:r.receptions},{default:f(()=>[s(t,{field:"receiptDetail.receipt.number",header:"Albarà"},{body:f(({data:_})=>[l("span",{class:"link",onClick:$=>a(_.receiptDetail.receipt.id)},x(_.receiptDetail.receipt.number),9,Ye)]),_:2},1024),s(t,{field:"quantity",header:"Quantitat"}),s(t,{field:"createdOn",header:"Data"},{body:f(({data:_})=>[O(x(i(J)(_.createdOn)),1)]),_:2},1024),s(t,{field:"user",header:"Usuari"})]),_:2},1032,["value"])])]),default:f(()=>[s(t,{expander:"",style:{width:"2%"}}),s(t,{field:"quantity",header:"Quantitat",style:{width:"5%"}}),s(t,{field:"receivedQuantity",header:"Q. Rebuda",style:{width:"6%"}}),s(t,{field:"reference.code",sortable:"",header:"Referència",style:{width:"20%"}},{body:f(({data:r})=>[s(xe,{id:r.referenceId,category:r.reference.categoryName,fullName:!0},null,8,["id","category"])]),_:1}),s(t,{field:"description",header:"Descripció",style:{width:"25%"}}),s(t,{field:"statusId",header:"Estat",style:{width:"7.5%"}},{body:f(({data:r})=>[O(x(h(r.statusId)),1)]),_:1}),s(t,{field:"expectedReceiptDate",header:"Data Recepció",style:{width:"7.5%"}},{body:f(({data:r})=>[O(x(i(J)(r.expectedReceiptDate)),1)]),_:1}),s(t,{field:"unitPrice",header:"Preu Un.",style:{width:"5%"}},{body:f(({data:r})=>[O(x(i(K)(r.unitPrice)),1)]),_:1}),s(t,{field:"amount",header:"Preu",style:{width:"5%"}},{body:f(({data:r})=>[O(x(i(K)(r.amount)),1)]),_:1}),s(t,{style:{width:"5%"}},{body:f(({data:r})=>[r.receivedQuantity===0?(C(),T("i",{key:0,class:M([i(U).TIMES,"grid_delete_column_button"]),onClick:_=>e(_,r)},null,10,Je)):A("",!0)]),_:1})]),_:3},8,["value","expandedRows"])}}});const Ze=ee(He,[["__scopeId","data-v-ce42cd3d"]]),et={key:0},tt={class:"three-columns"},at=l("label",{class:"block text-900 mb-2"},"Data prevista",-1),st={class:"three-columns mt-2"},ot=L({__name:"FormOrderDetail",props:{detail:{},order:{}},emits:["submit","cancel"],setup(D,{emit:I}){const d=D,V=z(),R=de().shape({quantity:Ee().min(1).required("La quantitat ha de ser superior a 1"),referenceId:q().required("La referencia és obligatoria")}),b=S({result:!1,errors:{}}),y=G(),c=()=>{const e=new ce(R);b.value=e.validate(d.detail)};se(()=>d.detail.quantity,async e=>{e&&h()});const p=async e=>{if(!(e==null||d.order.supplierId=="")){var a=await ue.Supplier.getSupplierReferenceBySupplierIdAndReferenceId(d.order.supplierId,e);if(a)d.detail.unitPrice=a.supplierPrice,d.detail.expectedReceiptDate=v(a.supplyDays),d.detail.description=a.supplierDescription;else{const o=await re.Reference.getById(e);o&&(d.detail.unitPrice=o.price,d.detail.description=o.description)}h()}};function v(e){let a=new Date;return a.setDate(a.getDate()+e),a}const h=()=>{const e=y.references.find(a=>a.id==d.detail.referenceId);e&&(e.categoryName=="Service"?d.detail.amount=d.detail.unitPrice:d.detail.amount=d.detail.quantity*d.detail.unitPrice)},g=async()=>{if(c(),b.value.result)I("submit",d.detail);else{let e="";Object.entries(b.value.errors).forEach(a=>{e+=`${a[1].map(o=>o)}.   `}),V.add({severity:"warn",summary:"Formulari inválid",detail:e,life:5e3})}};return(e,a)=>{const o=w("Calendar"),u=w("Button");return e.detail?(C(),T("form",et,[l("section",tt,[l("div",null,[s(Oe,{label:"Referència de compra",modelValue:e.detail.referenceId,"onUpdate:modelValue":[a[0]||(a[0]=t=>e.detail.referenceId=t),p],fullName:!0,disabled:e.detail.receivedQuantity>0},null,8,["modelValue","disabled"])]),l("div",null,[s(ne,{label:"Estat",name:"PurchaseOrderDetail",modelValue:e.detail.statusId,"onUpdate:modelValue":a[1]||(a[1]=t=>e.detail.statusId=t)},null,8,["modelValue"])]),l("div",null,[at,s(o,{label:"Data prevista",modelValue:e.detail.expectedReceiptDate,"onUpdate:modelValue":a[2]||(a[2]=t=>e.detail.expectedReceiptDate=t),dateFormat:"dd/mm/yy"},null,8,["modelValue"])])]),l("section",null,[l("div",null,[s(B,{type:i(P).TEXT,label:"Descripció",id:"description",modelValue:e.detail.description,"onUpdate:modelValue":a[3]||(a[3]=t=>e.detail.description=t)},null,8,["type","modelValue"])])]),l("section",st,[l("div",null,[s(B,{disabled:e.detail.receivedQuantity>0,type:i(P).NUMERIC,label:"Quantitat",modelValue:e.detail.quantity,"onUpdate:modelValue":a[4]||(a[4]=t=>e.detail.quantity=t),onInput:h},null,8,["disabled","type","modelValue"])]),l("div",null,[s(B,{type:i(P).CURRENCY,label:"Preu",modelValue:e.detail.amount,"onUpdate:modelValue":a[5]||(a[5]=t=>e.detail.amount=t),disabled:e.detail.receivedQuantity>0},null,8,["type","modelValue","disabled"])])]),s(u,{label:"Crear",onClick:g,style:{float:"right"},size:"small",class:"mt-2"})])):A("",!0)}}}),rt={key:0},it=l("br",null,null,-1),lt={class:"flex flex-wrap align-items-center justify-content-between gap-2"},nt=l("span",{class:"text-xl text-900 font-bold"},"Detall de la comanda",-1),dt={key:1},St=L({__name:"Order",setup(D){const I=te(),d=ae(),V=Se(),R=S(),b=Ve(),y=G(),c=$e(),p=j(),v=le(),h=H(),g=Te(),{order:e}=Z(p),a=[{label:"Descarregar",icon:U.FILE_WORD,command:()=>_e()}],o=async()=>{var n;await p.fetchOne(d.params.id),g.lifecycle||g.fetchOneByName("PurchaseOrder"),h.exercises||h.fetchActive(),v.suppliers||v.fetchSuppliers(),c.referenceTypes||c.fetchActive(),(!y.references||y.module!=="purchase")&&y.fetchReferencesByModule("purchase"),V.setMenuItem({icon:U.BUILDING,title:`Comanda de compra ${(n=e.value)==null?void 0:n.number}`,backButtonVisible:!0})};oe(async()=>{await o()});const u=z(),t=async()=>{var m;if(!((m=e.value)!=null&&m.date))return u.add({severity:"error",summary:"Error al crear la comanda ",detail:"La data no pot estar buida",life:5e3}),!1;R.value.submitForm()},E=async()=>{let n=!1,m="";e.value&&(n=await p.update(e.value.id,e.value),m="Comanda actualizada correctament",n&&(u.add({severity:"success",summary:m,life:5e3}),I.back()))},r=ge({visible:!1,title:"Linea",closable:!0,position:"center",modal:!0}),_=S(k.CREATE),$=S({}),me=()=>{_.value=k.CREATE,$.value={id:Y(),purchaseOrderId:e.value.id,amount:0,unitPrice:0,quantity:0,receivedQuantity:0,referenceId:"",statusId:"",expectedReceiptDate:null,workOrderPhaseId:null,disabled:!1},r.title="Crear línia",r.visible=!0},pe=n=>{_.value=k.EDIT,$.value=n,y.setNewReference(Y(),ke.MATERIAL),r.title="Modificar línia",r.visible=!0},fe=async n=>{_.value===k.CREATE?await ve(n):_.value===k.EDIT&&await ye(n),r.visible=!1,await p.fetchOne(d.params.id)},ve=async n=>{const m=await p.createDetail(n);m.result||Q(m)},ye=async n=>{const m=await p.updateDetail(n.id,n);m.result||Q(m)},be=async n=>{b.require({message:"Está segur que vols la línia?",icon:"pi pi-question-circle",acceptIcon:"pi pi-check",rejectIcon:"pi pi-times",accept:async()=>{const m=await p.deleteDetail(n.id,n);m.result||Q(m)}})},Q=n=>{u.add({severity:"error",summary:n.errors[0],life:1e4,closable:!0})},_e=async()=>{var m;const n=await ue.Order.GetReportDataById(e.value.id);if(n){const F=`ComandaCompra_${(m=e.value)==null?void 0:m.number}.docx`,N=await new Ne().Download(n,Fe.PurchaseOrder,F);N?Ce(F,N):u.add({severity:"warn",summary:"Error",detail:"No s'ha pugut generar fulla de la comanda"})}};return(n,m)=>{const F=w("SplitButton"),X=w("Button"),N=w("Dialog");return i(e)?(C(),T("main",rt,[s(F,{label:"Guardar",onClick:t,model:a,size:"small",class:"grid_add_row_button"}),s(Xe,{class:"pt-3",ref_key:"orderForm",ref:R,onSubmit:E},null,512),it,i(e).details?(C(),ie(Ze,{key:0,details:i(e).details,onEdit:pe,onDelete:be},{header:f(()=>[l("div",lt,[nt,l("div",null,[s(X,{size:"small",icon:i(U).PLUS,rounded:"",onClick:me},null,8,["icon"])])])]),_:1},8,["details"])):A("",!0),s(N,{visible:r.visible,"onUpdate:visible":m[0]||(m[0]=he=>r.visible=he),header:r.title,closable:r.closable,modal:r.modal},{default:f(()=>[s(ot,{detail:$.value,order:i(e),onSubmit:fe},null,8,["detail","order"])]),_:1},8,["visible","header","closable","modal"])])):(C(),T("main",dt,"Carregant comanda ..."))}}});export{St as default};
