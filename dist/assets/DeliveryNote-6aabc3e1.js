import{d as U,r as V,T as C,h as N,a as I,m as E,w as b,e as d,G as B,i as l,k as p,P as F,H as w,I as R,p as K,b as X,f as J,j as W,c as L,z as q,n as G,l as M,D as ae,s as le,x as ie,Q as de,R as z,F as Q,v as ne,g as ue,u as ce,C as me,X as ve,o as fe,L as pe}from"./index-8529e343.js";import{u as Y}from"./customers-22f796ee.js";import{u as Z}from"./lifecycle-5f73524a.js";import{u as ye}from"./masterData-9fbe04cf.js";import{c as be,a as x,F as _e}from"./form-validator-9bee509e.js";import{L as he}from"./LinkReference-d1f36b4e.js";import{u as Ne}from"./reference-4d9dd56a.js";import{u as De}from"./plantmodel-9213c5b9.js";import{u as Se}from"./deliveryNote-22c6204d.js";import{u as ge}from"./order-e5a750ac.js";import{S as we}from"./index-02e2a02a.js";import{a as Ie,b as Oe}from"./report.service-6b90f343.js";import"./index-41f85f67.js";const Ve=y=>(K("data-v-8f6728d6"),y=y(),X(),y),Ce={class:"selector-filter"},Te={class:"selector-filter-field"},Be=Ve(()=>d("label",{for:""},"Buscar",-1)),ke={class:"selector-filter-button"},$e={class:"flex align-items-center gap-2"},xe=U({__name:"SelectorOrders",props:{orders:{},headerVisible:{type:Boolean}},emits:["selected"],setup(y,{emit:g}){const m=y,n=V([]),h=V(""),O=C(()=>{if(h.value==="")return m.orders||[];var o=[];return m.orders&&(o=m.orders.filter(s=>s.number.includes(h.value)||s.customerNumber.includes(h.value))),o}),_=()=>{if(n.value.length===0)return;const o=n.value;g("selected",o)};return(o,s)=>{const e=N("InputText"),u=N("Button"),r=N("Column"),i=N("DataTable");return I(),E(i,{class:"small-datatable",tableStyle:"min-width: 100%",scrollable:"",scrollHeight:"75vh",metaKeySelection:!1,value:O.value,selectionMode:"multiple",selection:n.value,"onUpdate:selection":s[1]||(s[1]=t=>n.value=t)},{header:b(()=>[d("header",Ce,[d("div",Te,[Be,B("   "),l(e,{style:{width:"150px",height:"35px"},modelValue:h.value,"onUpdate:modelValue":s[0]||(s[0]=t=>h.value=t),size:"small"},null,8,["modelValue"])]),d("div",ke,[l(u,{onClick:_,size:"small",icon:p(F).CHECK_SQUARE},null,8,["icon"])])])]),groupheader:b(t=>[d("div",$e,[d("b",null,"Comanda "+w(t.data.number)+" - "+w(p(R)(t.data.date)),1)])]),default:b(()=>[l(r,{selectionMode:"multiple",style:{width:"3%"}}),l(r,{header:"Número",field:"number",style:{width:"10%"}}),l(r,{header:"Número client",field:"customerNumber",style:{width:"20%"}}),l(r,{header:"Data",field:"date",style:{width:"10%"}},{body:b(t=>[B(w(p(R)(t.data.date)),1)]),_:1})]),_:1},8,["value","selection"])}}});const Ee=J(xe,[["__scopeId","data-v-8f6728d6"]]),j=y=>(K("data-v-f0037178"),y=y(),X(),y),Fe={key:0},Re={class:"three-columns"},Le={class:"mt-1"},Me={class:"mt-1"},Ue=j(()=>d("label",{class:"block text-900 mb-2"},"Client",-1)),Ae={class:"mt-2"},qe={class:"three-columns"},ze={class:"mt-2"},Ge=j(()=>d("label",{class:"block text-900 mb-2"},"Estat",-1)),je={class:"mt-2"},He=j(()=>d("label",{class:"block text-900 mb-2"},"Data Entrega",-1)),Pe={class:"mt-2"},Qe=U({__name:"FormDeliveryNote",props:{deliveryNote:{}},emits:["submit","cancel"],setup(y,{expose:g,emit:m}){const n=y,h=Y();ye();const O=Z(),_=W(),o=C(()=>n.deliveryNote&&n.deliveryNote.salesInvoice?n.deliveryNote.salesInvoice.invoiceNumber:""),s=C(()=>n.deliveryNote&&n.deliveryNote.createdOn?R(n.deliveryNote.createdOn):""),e=be().shape({siteId:x().required("L'origen es obligatori"),customerId:x().required("El client es obligatori"),statusId:x().required("L'estat es obligatori"),exerciseId:x().required("L'exercici es obligatori")}),u=V({result:!1,errors:{}}),r=()=>{const t=new _e(e);u.value=t.validate(n.deliveryNote)};return g({submitForm:async()=>{if(r(),u.value.result)n.deliveryNote.deliveryDate&&(n.deliveryNote.deliveryDate=ae(n.deliveryNote.deliveryDate)),m("submit",n.deliveryNote);else{let t="";Object.entries(u.value.errors).forEach(v=>{t+=`${v[1].map(D=>D)}.   `}),_.add({severity:"warn",summary:"Formulari inválid",detail:t,life:5e3})}}}),(t,v)=>{var T;const D=N("Dropdown"),k=N("Calendar");return I(),L("div",null,[t.deliveryNote?(I(),L("form",Fe,[d("section",Re,[d("div",Le,[l(q,{type:p(le).TEXT,label:"Número Albarà",id:"salesOrderNumber",modelValue:t.deliveryNote.number,"onUpdate:modelValue":v[0]||(v[0]=f=>t.deliveryNote.number=f),disabled:""},null,8,["type","modelValue"])]),d("div",Me,[Ue,l(D,{modelValue:t.deliveryNote.customerId,"onUpdate:modelValue":v[1]||(v[1]=f=>t.deliveryNote.customerId=f),editable:"",options:p(h).customers,optionValue:"id",optionLabel:"comercialName",class:G(["w-full",{"p-invalid":u.value.errors.customerId}])},null,8,["modelValue","options","class"])]),d("div",Ae,[l(q,{modelValue:s.value,"onUpdate:modelValue":v[2]||(v[2]=f=>s.value=f),label:"Data Creació",disabled:!0},null,8,["modelValue"])])]),d("section",qe,[d("div",ze,[Ge,l(D,{modelValue:t.deliveryNote.statusId,"onUpdate:modelValue":v[3]||(v[3]=f=>t.deliveryNote.statusId=f),editable:"",options:(T=p(O).lifecycle)==null?void 0:T.statuses,optionValue:"id",optionLabel:"name",class:G(["w-full",{"p-invalid":u.value.errors.statusId}])},null,8,["modelValue","options","class"])]),d("div",je,[He,l(k,{modelValue:t.deliveryNote.deliveryDate,"onUpdate:modelValue":v[4]||(v[4]=f=>t.deliveryNote.deliveryDate=f),dateFormat:"dd/mm/yy",class:"mt-2"},null,8,["modelValue"])]),d("div",Pe,[l(q,{modelValue:o.value,"onUpdate:modelValue":v[5]||(v[5]=f=>o.value=f),label:"Número de factura",disabled:!0},null,8,["modelValue"])])])])):M("",!0)])}}});const Ke=J(Qe,[["__scopeId","data-v-f0037178"]]),Xe=["onClick"],Je={class:"vertical-align-middle ml-2 font-bold line-height-3"},We={class:"flex-right"},Ye=U({__name:"TableDeliveryNoteDetails",props:{orders:{},canDelete:{type:Boolean}},emits:["delete"],setup(y,{emit:g}){const m=y,n=C(()=>{if(!m.orders)return[];let o=[];for(let s=0;s<m.orders.length;s++){if(!m.orders[s].salesOrderDetails)continue;const e=m.orders[s];e.salesOrderDetails.forEach(u=>{o.push({salesOrderId:e.id,salesOrderNumber:e.number,salesOrderDate:e.date,customerNumber:e.customerNumber,...u})})}return o}),h=ie(),O=(o,s)=>{var u;if(!m.orders)return;const e=(u=m.orders)==null?void 0:u.find(r=>r.id===s.salesOrderId);e&&h.require({target:o.currentTarget,message:`Está segur que vol desassignar la comanda ${e.number}?`,icon:"pi pi-question-circle",acceptIcon:"pi pi-check",rejectIcon:"pi pi-times",accept:()=>{g("delete",e)}})},_=C(()=>m.orders?m.orders.reduce((o,s)=>s.salesOrderDetails?o+s.salesOrderDetails.reduce((e,u)=>e+u.amount,0):o,0):0);return(o,s)=>{const e=N("Column"),u=N("DataTable");return I(),E(u,{value:n.value,tableStyle:"min-width: 100%",class:"p-datatable-sm",rowGroupMode:"subheader",groupRowsBy:"salesOrderNumber",sortMode:"multiple",sortOrder:1,scrollable:"",scrollHeight:"60vh"},{header:b(()=>[de(o.$slots,"header")]),groupheader:b(r=>[o.canDelete?(I(),L("i",{key:0,class:G([p(F).TIMES,"grid_delete_column_button"]),onClick:i=>O(i,r.data)},null,10,Xe)):M("",!0),B("   "),d("span",Je,"Comanda "+w(r.data.salesOrderNumber)+" (Núm. Client: "+w(r.data.customerNumber)+")",1)]),footer:b(()=>[d("div",We,[d("span",null," Total: "+w(p(z)(_.value)),1)])]),default:b(()=>[l(e,{field:"salesOrderNumber",header:"Comanda",style:{width:"5%"}}),l(e,{field:"",header:"",style:{width:"2%"}}),l(e,{field:"quantity",header:"Quantitat",style:{width:"5%"}}),l(e,{header:"Referència",field:"reference.code",sortable:"",style:{width:"15%"}},{body:b(r=>[l(he,{id:r.data.referenceId},null,8,["id"])]),_:1}),l(e,{field:"description",header:"Descripció",style:{width:"30%"}}),l(e,{field:"unitPrice",header:"Preu un.",style:{width:"10%"}},{body:b(r=>[B(w(p(z)(r.data.unitPrice)),1)]),_:1}),l(e,{field:"amount",header:"Total",style:{width:"10%"}},{body:b(r=>[B(w(p(z)(r.data.amount)),1)]),_:1})]),_:3},8,["value"])}}}),Ze={class:"flex flex-wrap align-items-center justify-content-between gap-2"},et=d("span",{class:"text-l text-900 font-bold"},"Linies de l'albarà",-1),tt="Selector de comandes",pt=U({__name:"DeliveryNote",setup(y){const g=V(),m=V(Q.EDIT),n=ne(),h=ue(),O=ce(),_=Se(),o=ge(),s=Y(),e=De(),u=Ne(),r=Z(),{deliveryNote:i}=me(_),t=[{label:"Descarregar",icon:F.FILE_WORD,command:()=>v()}],v=async()=>{var a;const c=await we.DeliveryNote.GetReportDataById(i.value.id);if(c){const S=`AlbaraEntrega_${(a=i.value)==null?void 0:a.number}.docx`,$=await new Oe().Download(c,Ie.DeliveryNote,S);$?ve(S,$):A.add({severity:"warn",summary:"Error",detail:"No s'ha pugut generar fulla de la comanda"})}},D=V(!1),k=V(""),T=C(()=>{if(!r.lifecycle||!r.lifecycle.statuses||i.value&&i.value.salesInvoiceId&&i.value.salesInvoiceId!==null)return!1;const c=r.lifecycle.statuses.find(a=>a.name==="Entregat");return c?c.id!==k.value:!1}),f=async()=>{const c=n.params.id;await _.GetById(c),k.value=_.deliveryNote.statusId,await o.GetByDeliveryNote(c),u.fetchReferencesByModule("sales"),e.fetchSites(),s.customers||s.fetchCustomers(),r.lifecycle||r.fetchOneByName("DeliveryNote");let a="";i.value&&(m.value=Q.EDIT,a=`Albarà d'entrega ${i.value.number}`,i.value.deliveryDate&&(i.value.deliveryDate=R(i.value.deliveryDate))),O.setMenuItem({icon:F.BUILDING,backButtonVisible:!0,title:a})};fe(async()=>{await f()});const ee=()=>{var a;if(!((a=i.value)!=null&&a.createdOn))return A.add({severity:"error",summary:"Error al crear la comanda ",detail:"La data no pot estar buida",life:5e3}),!1;g.value.submitForm()},A=W(),te=async c=>{let a=!1,S="";a=await _.Update(c.id,c),S=a?"Albarà actualitzat":"Error al actualitzar l'albarà",A.add({life:5e3,severity:a?"success":"error",summary:S}),a&&h.back()},oe=async()=>{i.value&&await o.GetToDeliver(i.value.customerId),D.value=!0},se=async c=>{for(let a=0;a<c.length;a++){const S=c[a];await _.AddOrder(i.value.id,S)}D.value=!1,f()},re=async c=>{await _.DeleteOrder(i.value.id,c),f()};return(c,a)=>{const S=N("SplitButton"),H=N("Button"),$=N("Dialog");return I(),L(pe,null,[l(S,{label:"Guardar",onClick:ee,model:t,size:"small",class:"grid_add_row_button"}),p(i)?(I(),E(Ke,{key:0,class:"mt-3 mb-3",ref_key:"deliveryNoteForm",ref:g,deliveryNote:p(i),onSubmit:te},null,8,["deliveryNote"])):M("",!0),p(i)?(I(),E(Ye,{key:1,orders:p(o).salesOrders,canDelete:T.value,onDelete:re},{header:b(()=>[d("div",Ze,[et,d("div",null,[l(H,{disabled:!T.value,size:"small",label:"Afegir comanda",onClick:a[0]||(a[0]=P=>oe())},null,8,["disabled"])])])]),_:1},8,["orders","canDelete"])):M("",!0),l($,{closable:!0,visible:D.value,"onUpdate:visible":a[1]||(a[1]=P=>D.value=P),header:tt,modal:!0,style:{width:"50rem"},breakpoints:{"1199px":"75vw","575px":"90vw"}},{default:b(()=>[l(Ee,{orders:p(o).salesOrdersToDeliver,onSelected:se},null,8,["orders"])]),_:1},8,["visible"])],64)}}});export{pt as default};
