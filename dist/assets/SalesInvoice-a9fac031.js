import{d as x,j,r as T,h as y,c as $,e as a,i as l,k as u,D as N,l as k,a as f,x as ne,K as Y,o as H,m as z,w as v,J as re,n as K,P as q,C,y as A,s as P,p as ce,b as de,f as ue,v as me,g as ve,u as pe,z as ye,E as Q,Z as _e,G as fe}from"./index-e365f3be.js";import{u as be}from"./invoice-bb7a18d6.js";import{u as De}from"./customers-f17ddf3b.js";import{u as L}from"./masterData-afc35dba.js";import{u as O}from"./lifecycle-5aa2399a.js";import{e as R,f as E,_ as he,l as Ne,b as Ie,c as ge}from"./functions-e7c8fc70.js";import{c as Z,a as J,d as W,F as we}from"./form-validator-f8953ae6.js";import{L as Se}from"./LinkReference-b53b20c5.js";import{u as $e}from"./deliveryNote-312d95f7.js";import{u as Ce}from"./reference-3f326116.js";import{S as Ve}from"./index-dc8700c2.js";import{a as ke,b as Be}from"./report.service-45e6858b.js";import"./base.service-8e7a55c1.js";import"./index-42d34089.js";import"./reference.service-33e64e53.js";import"./_commonjsHelpers-725317a4.js";import"./v4-a960c1f4.js";import"./index-348057aa.js";const Te={key:0},Ee={class:"four-columns"},Fe={class:"mt-2"},Re={class:"mt-2"},qe=a("label",{class:"block text-900 mb-2"},"Data Factura",-1),xe={class:"mt-2"},Ue=a("label",{class:"block text-900 mb-2"},"Estat",-1),Me={class:"mt-2"},Ae=a("label",{class:"block text-900 mb-2"},"Métode Pagament",-1),ze={class:"four-columns"},Le={class:"mt-1"},Oe=a("label",{class:"block text-900 mb-2"},"Base",-1),Ge={class:"summary-field"},Pe={class:"mt-1"},je=a("label",{class:"block text-900 mb-2"},"Impostos",-1),He={class:"summary-field"},Ke={class:"mt-1"},Qe=a("label",{class:"block text-900 mb-2"},"Total",-1),Je={class:"summary-field"},We=x({__name:"FormSalesInvoice",props:{invoice:{}},emits:["submit","cancel"],setup(b,{emit:w}){j();const d=L(),D=O();return Z().shape({invoiceDate:J().required("La data és obligatoria"),paymentMethodId:J().required("El métode de pagament és obligatori")}),T({result:!1,errors:{}}),(r,m)=>{var c;const I=y("BaseInput"),h=y("Calendar"),g=y("Dropdown");return r.invoice?(f(),$("form",Te,[a("section",Ee,[a("div",Fe,[l(I,{modelValue:r.invoice.invoiceNumber,"onUpdate:modelValue":m[0]||(m[0]=e=>r.invoice.invoiceNumber=e),label:"Número",disabled:!0},null,8,["modelValue"])]),a("div",Re,[qe,l(h,{modelValue:r.invoice.invoiceDate,"onUpdate:modelValue":m[1]||(m[1]=e=>r.invoice.invoiceDate=e),dateFormat:"dd/mm/yy"},null,8,["modelValue"])]),a("div",xe,[Ue,l(g,{modelValue:r.invoice.statusId,"onUpdate:modelValue":m[2]||(m[2]=e=>r.invoice.statusId=e),editable:"",options:(c=u(D).lifecycle)==null?void 0:c.statuses,optionValue:"id",optionLabel:"name",class:"w-full"},null,8,["modelValue","options"])]),a("div",Me,[Ae,l(g,{modelValue:r.invoice.paymentMethodId,"onUpdate:modelValue":m[3]||(m[3]=e=>r.invoice.paymentMethodId=e),editable:"",options:u(d).paymentMethods,optionValue:"id",optionLabel:"name",class:"w-full"},null,8,["modelValue","options"])])]),a("section",ze,[a("div",Le,[Oe,a("span",Ge,N(u(R)(r.invoice.baseAmount)),1)]),a("div",Pe,[je,a("span",He,N(u(R)(r.invoice.taxAmount)),1)]),a("div",Ke,[Qe,a("span",Je,N(u(R)(r.invoice.netAmount)),1)])])])):k("",!0)}}}),Ye=["onClick"],Ze={class:"vertical-align-middle ml-2 font-bold line-height-3"},Xe={key:0},et={key:1},tt=["onClick"],ot=x({__name:"TableInvoiceDetails",props:{details:{},deliveryNotes:{},canDelete:{type:Boolean}},emits:["delete","deleteDeliveryNote"],setup(b,{emit:w}){const d=b,D=ne(),r=O(),m=L(),I=Y(()=>{let e=[];if(!d.details)return e;const i=d.details.filter(s=>!s.deliveryNoteDetailId).map(s=>({deliveryNoteId:"",deliveryNoteNumber:"Sense albarà",deliveryNoteDate:"",...s}));i.length>0&&e.push(...i);const t=d.details.filter(s=>s.deliveryNoteDetailId).map(s=>{var B;const o=(B=d.deliveryNotes)==null?void 0:B.find(F=>{var U;return F.id===((U=s.deliveryNoteDetail)==null?void 0:U.deliveryNoteId)}),n=o&&o.deliveryDate?`Entregat ${E(o.deliveryDate)}`:"No entregat";return{deliveryNoteId:o==null?void 0:o.id,deliveryNoteNumber:`Albarà ${o?`${o.number} - ${n}`:"--"}`,deliveryNoteDate:o&&o.deliveryDate?` - ${E(o.deliveryDate)}`:"",...s}});return t.length>0&&e.push(...t),console.log(t,e),he.orderBy(e,s=>s.deliveryNoteNumber)});H(async()=>{await r.fetchOneByName("SalesInvoice")});const h=e=>{var t;const i=(t=m.taxes)==null?void 0:t.find(s=>s.id===e);if(i)return`${i.name}`},g=(e,i)=>{D.require({message:`Està segur que vol eliminar la línea ${i.description}?`,icon:"pi pi-question-circle",acceptIcon:"pi pi-check",rejectIcon:"pi pi-times",accept:async()=>{w("delete",i)}})},c=(e,i)=>{if(!d.deliveryNotes)return;const t=d.deliveryNotes.find(s=>s.id===i.deliveryNoteId);t&&D.require({message:`Està segur que vol treure l'${i.deliveryNoteNumber}?`,icon:"pi pi-question-circle",acceptIcon:"pi pi-check",rejectIcon:"pi pi-times",accept:async()=>{w("deleteDeliveryNote",t)}})};return(e,i)=>{const t=y("Column"),s=y("DataTable");return f(),z(s,{class:"p-datatable-sm",tableStyle:"min-width: 100%",scrollable:"",scrollHeight:"62vh",sortMode:"single",sortField:"description",sortOrder:1,value:I.value,rowGroupMode:"subheader",groupRowsBy:"deliveryNoteNumber"},{header:v(()=>[re(e.$slots,"header")]),groupheader:v(o=>[e.canDelete&&o.data.deliveryNoteNumber!=="Sense albarà"?(f(),$("i",{key:0,class:K([u(q).TIMES,"grid_delete_column_button"]),onClick:n=>c(n,o.data)},null,10,Ye)):k("",!0),C("   "),a("span",Ze,N(o.data.deliveryNoteNumber),1)]),default:v(()=>[l(t,{header:"Albarà",field:"deliveryNoteNumber",style:{width:"5%"}}),l(t,{header:"",field:"",style:{width:"2%"}}),l(t,{header:"Quantitat",field:"quantity",style:{width:"10%"}}),l(t,{header:"Referència",style:{width:"15%"}},{body:v(o=>[o.data.deliveryNoteDetail?(f(),$("span",Xe,[l(Se,{id:o.data.deliveryNoteDetail.referenceId},null,8,["id"])])):(f(),$("span",et,"--"))]),_:1}),l(t,{header:"Descripció",sortable:"",field:"description",style:{width:"40%"}}),l(t,{header:"Preu unitat",style:{width:"10%"}},{body:v(o=>[C(N(u(R)(o.data.unitPrice)),1)]),_:1}),l(t,{header:"Impost",style:{width:"10%"}},{body:v(o=>[C(N(h(o.data.taxId)),1)]),_:1}),l(t,{header:"Total",field:"totalCost",style:{width:"10%"}},{body:v(o=>[C(N(u(R)(o.data.amount)),1)]),_:1}),l(t,{style:{width:"10%"}},{body:v(o=>[o.data.deliveryNoteDetailId?k("",!0):(f(),$("i",{key:0,class:K([u(q).TIMES,"grid_delete_column_button"]),onClick:n=>g(n,o.data)},null,10,tt))]),_:1})]),_:3},8,["value"])}}}),at={key:0},it={class:"two-columns-7525"},lt={class:"mt-2"},st={class:"mt-2"},nt=a("label",{class:"block text-900 mb-2"},"Impost",-1),rt={class:"three-columns"},ct={class:"mt-2"},dt={class:"mt-2"},ut={class:"mt-2"},mt=x({__name:"FormSalesInvoiceDetail",props:{invoiceDetail:{}},emits:["submit","cancel"],setup(b,{emit:w}){const d=b,D=j(),r=L(),m=()=>{const e=d.invoiceDetail;e.quantity&&e.quantity>0&&e.unitPrice&&e.unitPrice>0&&(d.invoiceDetail.unitCost=e.unitPrice,d.invoiceDetail.amount=Ne.round(e.quantity*e.unitPrice,2),d.invoiceDetail.totalCost=d.invoiceDetail.amount)},I=Z().shape({quantity:W().min(1).required("La quantitat ha de ser superior a 1"),unitPrice:W().min(.01).required("El preu unitat és obligatori")}),h=T({result:!1,errors:{}}),g=()=>{const e=new we(I);h.value=e.validate(d.invoiceDetail)},c=async()=>{if(g(),h.value.result)w("submit",d.invoiceDetail);else{let e="";Object.entries(h.value.errors).forEach(i=>{e+=`${i[1].map(t=>t)}.   `}),D.add({severity:"warn",summary:"Formulari inválid",detail:e,life:5e3})}};return(e,i)=>{const t=y("Dropdown"),s=y("Button");return e.invoiceDetail?(f(),$("form",at,[a("section",it,[a("div",lt,[l(A,{label:"Descripció",modelValue:e.invoiceDetail.description,"onUpdate:modelValue":i[0]||(i[0]=o=>e.invoiceDetail.description=o)},null,8,["modelValue"])]),a("div",st,[nt,l(t,{modelValue:e.invoiceDetail.taxId,"onUpdate:modelValue":i[1]||(i[1]=o=>e.invoiceDetail.taxId=o),editable:"",options:u(r).taxes,optionValue:"id",optionLabel:"name",class:"w-full"},null,8,["modelValue","options"])])]),a("section",rt,[a("div",ct,[l(A,{type:u(P).NUMERIC,label:"Quantitat",modelValue:e.invoiceDetail.quantity,"onUpdate:modelValue":[i[2]||(i[2]=o=>e.invoiceDetail.quantity=o),m]},null,8,["type","modelValue"])]),a("div",dt,[l(A,{type:u(P).CURRENCY,label:"Preu Unitat","model-value":e.invoiceDetail.unitPrice,"onUpdate:modelValue":[i[3]||(i[3]=o=>e.invoiceDetail.unitPrice=o),m]},null,8,["type","model-value"])]),a("div",ut,[l(A,{type:u(P).CURRENCY,label:"Total","model-value":e.invoiceDetail.amount,"onUpdate:modelValue":i[4]||(i[4]=o=>e.invoiceDetail.amount=o),disabled:""},null,8,["type","model-value"])])]),l(s,{label:"Crear",onClick:c,style:{float:"right"},size:"small",class:"mt-2"})])):k("",!0)}}}),vt=b=>(ce("data-v-1516f95e"),b=b(),de(),b),pt={class:"selector-filter"},yt={class:"selector-filter-field"},_t=vt(()=>a("label",{for:""},"Buscar",-1)),ft={class:"selector-filter-button"},bt={class:"flex align-items-center gap-2"},Dt=x({__name:"SelectorDeliveryNotes",props:{deliveryNotes:{},headerVisible:{type:Boolean}},emits:["selected"],setup(b,{emit:w}){const d=b;H(()=>{D.fetchOneByName("DeliveryNote")});const D=O(),r=T([]),m=T(""),I=Y(()=>{var c=[];return d.deliveryNotes&&(c=d.deliveryNotes.filter(e=>e.number.toString().includes(m.value))),c}),h=c=>{var i;const e=(i=D.lifecycle)==null?void 0:i.statuses.find(t=>t.id===c);return e?e.name:""},g=()=>{r.value.length!==0&&w("selected",r.value)};return(c,e)=>{const i=y("InputText"),t=y("Button"),s=y("Column"),o=y("DataTable");return f(),z(o,{class:"small-datatable",tableStyle:"min-width: 100%",scrollable:"",scrollHeight:"75vh",metaKeySelection:!1,value:I.value,selectionMode:"multiple",selection:r.value,"onUpdate:selection":e[1]||(e[1]=n=>r.value=n)},{header:v(()=>[a("header",pt,[a("div",yt,[_t,C("   "),l(i,{style:{width:"150px",height:"35px"},modelValue:m.value,"onUpdate:modelValue":e[0]||(e[0]=n=>m.value=n),size:"small"},null,8,["modelValue"])]),a("div",ft,[l(t,{onClick:g,size:"small",icon:u(q).CHECK_SQUARE},null,8,["icon"])])])]),groupheader:v(n=>[a("div",bt,[a("b",null,"Albarà d'entrega "+N(n.data.salesOrderNumber)+" - "+N(u(E)(n.data.salesOrderDate)),1)])]),default:v(()=>[l(s,{header:"Número",field:"number",style:{width:"10%"}}),l(s,{header:"Estat",field:"status",style:{width:"10%"}},{body:v(n=>[C(N(h(n.data.statusId)),1)]),_:1}),l(s,{header:"Data Entrega",field:"deliveryDate",style:{width:"10%"}},{body:v(n=>[C(N(n.data.deliveryDate?u(E)(n.data.deliveryDate):""),1)]),_:1})]),_:1},8,["value","selection"])}}});const ht=ue(Dt,[["__scopeId","data-v-1516f95e"]]),Nt={key:0},It={class:"flex flex-wrap align-items-center justify-content-between gap-2"},gt=a("span",{class:"text-xl text-900 font-bold"},"Detall de la factura",-1),Ot=x({__name:"SalesInvoice",setup(b){const w=[{label:"Descarregar",icon:q.FILE_WORD,command:()=>X()}],d=me(),D=ve(),r=pe(),m=j(),I=L(),h=De(),g=O(),c=be(),e=$e(),i=Ce(),{invoice:t}=ye(c),s={Free:0,FromDeliveryNote:1},o=T(0),n=Q({visible:!1,title:"",closable:!0,position:"center",modal:!0}),B=T("");H(async()=>{B.value=d.params.id,I.fetchMasterData(),h.fetchCustomers(),await i.fetchReferencesByModule("sales"),await F(),r.setMenuItem({icon:q.WALLET,title:`Factura de venta ${t.value.invoiceNumber} - ${t.value.customerComercialName}`,backButtonVisible:!0})});const F=async()=>{g.fetchOneByName("SalesInvoice"),await c.GetById(B.value),await e.GetByInvoiceId(B.value),t.value&&(t.value.invoiceDate=E(t.value.invoiceDate))},U=async()=>{t.value&&(t.value.invoiceDate=ge(t.value.invoiceDate),await c.Update(t.value)&&D.back())},X=async()=>{var _;const p=await Ve.SalesInvoice.GetReportDataById(t.value.id);if(p){const S=`Factura_${(_=t.value)==null?void 0:_.invoiceNumber}.docx`,M=await new Be().Download(p,ke.Invoice,S);M?Ie(S,M):m.add({severity:"warn",summary:"Error",detail:"No s'ha pugut generar fulla de la comanda"})}},ee=async()=>{t.value&&(await e.GetToInvoice(t.value.customerId),o.value=s.FromDeliveryNote,n.title="Selector d'albarans d'entrega",n.visible=!0)},te=async p=>{for(let _=0;_<p.length;_++){const S=p[_];await c.AddDeliveryNote(t.value.id,S)}n.visible=!1,F()},oe=async p=>{await c.RemoveDeliveryNote(t.value.id,p),F()},V=Q({}),ae=()=>{var p;if(o.value=s.Free,t.value){V.salesInvoiceId=t.value.id,V.quantity=1,V.description="",V.totalCost=0;const _=(p=I.taxes)==null?void 0:p.find(S=>S.percentatge===21);_&&(V.taxId=_.id),n.title="Introducció de línea lliure",n.visible=!0}},ie=async()=>{await c.CreateInvoiceDetail(V),n.visible=!1},le=async p=>{await c.DeleteInvoiceDetail(p),c.invoice.invoiceDate=E(c.invoice.invoiceDate)};return(p,_)=>{const S=y("SplitButton"),G=y("Button"),M=y("Dialog");return f(),$(fe,null,[l(S,{label:"Guardar",onClick:U,model:w,size:"small",class:"grid_add_row_button"}),u(t)?(f(),$("main",Nt,[l(We,{class:"mt-3 mr-3",invoice:u(t)},null,8,["invoice"]),l(ot,{class:"mt-3",canDelete:!0,details:u(t).salesInvoiceDetails,deliveryNotes:u(e).deliveryNotes,onDeleteDeliveryNote:oe,onDelete:le},{header:v(()=>[a("div",It,[gt,a("div",null,[l(G,{size:"small",label:"Afegir albarà",onClick:ee}),C("    "),l(G,{size:"small",label:"Afegir linia lliure",onClick:ae})])])]),_:1},8,["details","deliveryNotes"])])):k("",!0),l(M,{visible:n.visible,"onUpdate:visible":_[0]||(_[0]=se=>n.visible=se),header:n.title,closable:n.closable,modal:n.modal,style:_e({width:o.value===s.Free?"50vw":"60vw"}),maximizable:o.value===s.FromDeliveryNote},{default:v(()=>[o.value===s.Free?(f(),z(mt,{key:0,invoiceDetail:V,onSubmit:ie},null,8,["invoiceDetail"])):k("",!0),o.value===s.FromDeliveryNote?(f(),z(ht,{key:1,headerVisible:!0,deliveryNotes:u(e).invoiceableDeliveryNotes,onSelected:te},{header:v(()=>[]),_:1},8,["deliveryNotes"])):k("",!0)]),_:1},8,["visible","header","closable","modal","style","maximizable"])],64)}}});export{Ot as default};
