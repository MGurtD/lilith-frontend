import{d as H,j as ee,z as te,K as ae,r as g,h as y,a as p,c as x,k as t,e as n,i as r,s as P,n as Q,l as N,p as ke,b as we,f as re,x as Se,w as c,J as Ie,D as A,P as X,C as z,m as G,G as oe,F as C,v as Ce,g as ge,u as he,o as Te}from"./index-64fee6e6.js";import{c as Z,d as U,e as Ne,b as xe,f as L,g as Ee}from"./functions-2e154ea4.js";import{u as se}from"./order-608e20eb.js";import{u as le}from"./reference-372e33a9.js";import{u as de}from"./customers-2f2b50e9.js";import{u as Ve}from"./exercise-c26f1feb.js";import{u as Be}from"./plantmodel-13c630e1.js";import{u as ie}from"./lifecycle-e8c951ba.js";import{u as Fe}from"./tax-242ac9a8.js";import{c as $e,a as j,F as Me}from"./form-validator-f8953ae6.js";import{u as ne}from"./deliveryNote-9dfe015d.js";import{u as ue}from"./budget-aa258fae.js";import{_ as Re}from"./FormBudgetOrderDetail.vue_vue_type_script_setup_true_lang-6808874b.js";import{L as We}from"./LinkReference-92e3fd4f.js";import{_ as Ae}from"./FormCreateWorkorder.vue_vue_type_script_setup_true_lang-b5760512.js";import{u as ce}from"./workmaster-64ab54c8.js";import{u as me}from"./workorder-c497cf68.js";import{F as Ue}from"./FileEntityPicker-585ab65e.js";import{a as Le,b as Ge}from"./report.service-15ff2f35.js";import{S as qe}from"./index-2783be85.js";import"./_commonjsHelpers-725317a4.js";import"./v4-a960c1f4.js";import"./reference.service-10b4f35b.js";import"./base.service-0fa5a61f.js";import"./index-93e66ee5.js";import"./index-af0e943c.js";import"./DropdownReference.vue_vue_type_script_setup_true_lang-14e78baf.js";import"./file.service-20a290c1.js";import"./index-cee3d131.js";const Y=E=>(ke("data-v-9ef3c9d3"),E=E(),we(),E),Pe={key:0},ze={class:"four-columns mt-2"},je=Y(()=>n("label",{class:"block text-900 mb-2"},"Client",-1)),Xe=Y(()=>n("label",{class:"block text-900 mb-2"},"Estat",-1)),Ye={class:"four-columns mt-2"},Qe=Y(()=>n("label",{class:"block text-900 mb-2"},"Data Alta",-1)),He=Y(()=>n("label",{class:"block text-900 mb-2"},"Data Entrega",-1)),Je=H({__name:"FormSalesOrder",emits:["submit","cancel"],setup(E,{expose:k,emit:D}){const $=se(),V=de(),F=ie(),w=ne(),f=ue(),_=ee(),{salesOrder:a}=te($),b=ae(()=>w.deliveryNote?w.deliveryNote.number:""),M=$e().shape({siteId:j().required("L'origen es obligatori"),customerId:j().required("El client es obligatori"),statusId:j().required("L'estat es obligatori"),exerciseId:j().required("L'exercici es obligatori")}),S=g({result:!1,errors:{}}),h=()=>{const i=new Me(M);S.value=i.validate(a.value)};k({submitForm:async()=>{if(h(),S.value.result)d(),D("submit",a.value);else{let i="";Object.entries(S.value.errors).forEach(e=>{i+=`${e[1].map(m=>m)}.   `}),_.add({severity:"warn",summary:"Formulari inválid",detail:i,life:5e3})}}});const B=()=>{var e;const i=(e=V.customers)==null?void 0:e.find(m=>{var v;return m.id===((v=a.value)==null?void 0:v.customerId)});i&&a.value&&(a.value.customerCode=i.code,a.value.customerComercialName=i.comercialName,a.value.customerTaxName=i.taxName,a.value.customerVatNumber=i.vatNumber,a.value.customerAccountNumber=i.accountNumber)},d=()=>{a.value&&(a.value.date=Z(a.value.date),a.value.expectedDate&&(a.value.expectedDate=Z(a.value.expectedDate)))};return(i,e)=>{var l,T;const m=y("BaseInput"),v=y("Dropdown"),I=y("Calendar");return p(),x("div",null,[t(a)?(p(),x("form",Pe,[n("section",ze,[n("div",null,[r(m,{type:t(P).TEXT,label:"Num. Comanda",id:"salesOrderNumber",modelValue:t(a).number,"onUpdate:modelValue":e[0]||(e[0]=u=>t(a).number=u),disabled:""},null,8,["type","modelValue"])]),n("div",null,[je,r(v,{modelValue:t(a).customerId,"onUpdate:modelValue":[e[1]||(e[1]=u=>t(a).customerId=u),e[2]||(e[2]=u=>B())],editable:"",options:t(V).customers,optionValue:"id",optionLabel:"comercialName",class:Q(["w-full",{"p-invalid":S.value.errors.customerId}])},null,8,["modelValue","options","class"])]),n("div",null,[r(m,{type:t(P).TEXT,label:"Comanda Client",id:"customerSalesOrderNumber",modelValue:t(a).customerNumber,"onUpdate:modelValue":e[3]||(e[3]=u=>t(a).customerNumber=u)},null,8,["type","modelValue"])]),n("div",null,[Xe,r(v,{modelValue:t(a).statusId,"onUpdate:modelValue":e[4]||(e[4]=u=>t(a).statusId=u),editable:"",options:(l=t(F).lifecycle)==null?void 0:l.statuses,optionValue:"id",optionLabel:"name",class:Q(["w-full",{"p-invalid":S.value.errors.statusId}])},null,8,["modelValue","options","class"])])]),n("section",Ye,[n("div",null,[Qe,r(I,{modelValue:t(a).date,"onUpdate:modelValue":e[5]||(e[5]=u=>t(a).date=u),dateFormat:"dd/mm/yy"},null,8,["modelValue"])]),n("div",null,[He,r(I,{modelValue:t(a).expectedDate,"onUpdate:modelValue":e[6]||(e[6]=u=>t(a).expectedDate=u),dateFormat:"dd/mm/yy"},null,8,["modelValue"])]),n("div",null,[r(m,{type:t(P).TEXT,label:"Num. Pressupost",id:"budgetNumber",disabled:"",value:(T=t(f).budget)==null?void 0:T.number},null,8,["type","value"])]),n("div",null,[r(m,{type:t(P).TEXT,disabled:!0,label:"Albarà Entrega",id:"deliveryNote",modelValue:b.value,"onUpdate:modelValue":e[7]||(e[7]=u=>b.value=u)},null,8,["type","modelValue"])])])])):N("",!0)])}}});const Ke=re(Je,[["__scopeId","data-v-9ef3c9d3"]]),Ze={key:0},et={key:1},tt=["onClick"],at={class:"total"},rt={class:"total-text"},ot=H({__name:"TableSalesOrderDetails",props:{salesOrder:{},salesOrderDetails:{}},emits:["edit","delete","createWorkOrder","openWorkOrder"],setup(E,{emit:k}){const D=E,$=Se();le();const V=ce(),F=me(),w=ae(()=>D.salesOrderDetails?D.salesOrderDetails.reduce((d,i)=>d+i.amount,0):0);var f=void 0;const _=g({closable:!0,modal:!0,title:"Generar ordre de fabricació",visible:!1}),a=g([]),b=g({workMasterId:"",plannedDate:"",plannedQuantity:0,comment:""}),M=d=>{D.salesOrder.deliveryNoteId||d.originalEvent.target.className.includes("grid_delete_column_button")||k("edit",d.data)},S=(d,i)=>{$.require({target:d.currentTarget,message:"Está segur que vol eliminar la referència?",icon:"pi pi-question-circle",acceptIcon:"pi pi-check",rejectIcon:"pi pi-times",accept:()=>{k("delete",i)}})},h=d=>{a.value=V.getByReferenceId(d.referenceId),b.value.workMasterId="",a.value.length>0&&(b.value.workMasterId=a.value[0].id),b.value.plannedQuantity=d.quantity,b.value.plannedDate=D.salesOrder.expectedDate?Ne(D.salesOrder.expectedDate):"",b.value.comment="",f=d,_.value.visible=!0},R=d=>{console.log(d),k("openWorkOrder",d)},B=()=>{const d={workOrderDto:b.value,orderDetail:f};_.value.visible=!1,k("createWorkOrder",d)};return(d,i)=>{const e=y("Column"),m=y("Button"),v=y("DataTable"),I=y("Dialog");return p(),x(oe,null,[r(v,{onRowClick:M,value:d.salesOrderDetails,tableStyle:"min-width: 100%",class:"p-datatable-sm",selectionMode:"single",dataKey:"id",sortMode:"single",sortField:"reference.code",sortOrder:1},{header:c(()=>[Ie(d.$slots,"header",{},void 0,!0)]),footer:c(()=>[n("div",at,[n("span",rt,"Total "+A(t(U)(w.value)),1)])]),default:c(()=>[r(e,{field:"quantity",header:"Quantitat",style:{width:"10%"}}),r(e,{header:"Referencia",field:"reference.code",sortable:"",style:{width:"15%"}},{body:c(l=>[r(We,{id:l.data.referenceId},null,8,["id"])]),_:1}),r(e,{field:"description",header:"Descripció",style:{width:"30%"}}),r(e,{field:"workOrderId",header:"Ordre fabr.",style:{width:"10%"}},{body:c(l=>[t(F).getWorkOrderCodeById(l.data.workOrderId)?(p(),x("div",Ze,[r(m,{size:"small",severity:"success",label:t(F).getWorkOrderCodeById(l.data.workOrderId),onClick:T=>R(l.data.workOrderId)},null,8,["label","onClick"])])):(p(),x("div",et,[r(m,{size:"small",icon:t(X).PLUS_CIRCLE,value:"Generar OF",onClick:T=>h(l.data)},null,8,["icon","onClick"])]))]),_:1}),r(e,{field:"workMasterCost",header:"Cost Teóric",style:{width:"10%"}},{body:c(l=>[z(A(t(U)(l.data.workMasterCost)),1)]),_:1}),r(e,{field:"lastCost",header:"Últim Cost",style:{width:"10%"}},{body:c(l=>[z(A(t(U)(l.data.lastCost)),1)]),_:1}),r(e,{field:"unitPrice",header:"Preu un.",style:{width:"10%"}},{body:c(l=>[z(A(t(U)(l.data.unitPrice)),1)]),_:1}),r(e,{field:"amount",header:"Total",style:{width:"10%"}},{body:c(l=>[z(A(t(U)(l.data.amount)),1)]),_:1}),d.salesOrder.deliveryNoteId?N("",!0):(p(),G(e,{key:0,style:{width:"5%"}},{body:c(l=>[l.data.isDelivered?N("",!0):(p(),x("i",{key:0,class:Q([t(X).TIMES,"grid_delete_column_button"]),onClick:T=>S(T,l.data)},null,10,tt))]),_:1}))]),_:3},8,["value"]),r(I,{closable:_.value.closable,visible:_.value.visible,"onUpdate:visible":i[0]||(i[0]=l=>_.value.visible=l),header:_.value.title,modal:_.value.modal,style:{width:"50vw"}},{default:c(()=>[r(Ae,{createWorkOrderDto:b.value,"filtered-work-masters":a.value,onSubmit:B},null,8,["createWorkOrderDto","filtered-work-masters"])]),_:1},8,["closable","visible","header","modal"])],64)}}});const st=re(ot,[["__scopeId","data-v-56291077"]]),lt={class:"flex flex-wrap align-items-center justify-content-between gap-2"},dt=n("span",{class:"text-l text-900 font-bold"},"Linies de la comanda",-1),it={key:0},nt="Línia de comanda",At=H({__name:"SalesOrder",setup(E){const k=g(),D=g(C.EDIT),$=Ce(),V=ge(),F=he(),w=ee(),f=se(),_=de(),a=Be(),b=Ve(),M=ie(),S=le(),h=ne(),R=ce(),B=me(),d=Fe(),i=ue(),{salesOrder:e}=te(f),m=[{label:"Descarregar",icon:X.FILE_WORD,command:()=>_e()}],v=g(!1),I=g(C.EDIT),l=g(void 0),T=async()=>{const o=$.params.id;await f.GetById(o),S.fetchReferencesByModule("sales"),M.fetchOneByName("SalesOrder"),a.fetchSites(),b.fetchAll(),_.fetchCustomers(),d.fetchAll(),B.fetchBySalesOrder(o),R.workmasters||R.fetchAllActives();let s="";e.value&&(D.value=C.EDIT,s=`Comanda ${e.value.number}`,e.value.date=L(e.value.date),e.value.expectedDate&&(e.value.expectedDate=L(e.value.expectedDate)),e.value.deliveryNoteId?h.GetById(e.value.deliveryNoteId):h.deliveryNote&&(h.deliveryNote=void 0),e.value.budgetId?await i.GetById(e.value.budgetId):i.budget=void 0),F.setMenuItem({icon:X.BUILDING,backButtonVisible:!0,title:s})};Te(async()=>{await T()});const u=()=>{k.value.submitForm()},J=(o,s)=>{o===C.CREATE&&(s={id:Ee(),referenceId:"",quantity:0,profit:0,discount:0,unitCost:0,unitPrice:0,totalCost:0,amount:0,salesOrderHeaderId:"",lastCost:0,workMasterCost:0,description:"",estimatedDeliveryDate:new Date,isDelivered:!1,isInvoiced:!1,workMasterId:null,workOrderId:""}),s.salesOrderHeaderId=e.value.id,l.value=s,I.value=o,v.value=!0},ve=async o=>{let s=!1,O="";s=await f.Update(o.id,o),O=s?"Comanda actualitzada":"Error a l'actualitzar la comanda",w.add({life:5e3,severity:s?"success":"error",summary:O}),s&&V.back()},pe=async o=>{o=o,I.value===C.CREATE?await f.CreateDetail(o):I.value===C.EDIT&&await f.UpdateDetail(o),v.value=!1,e.value&&(e.value.date=L(e.value.date),e.value.expectedDate&&(e.value.expectedDate=L(e.value.expectedDate)))},fe=async o=>{D.value===C.EDIT&&await f.DeleteDetail(o);const s=e.value.salesOrderDetails.filter(O=>O.id!==o.id);e.value.salesOrderDetails=s,v.value=!1,e.value.date=L(e.value.date)},be=async o=>{const s=await B.create(o.workOrderDto);s.result?(o.orderDetail.workOrderId=s.content.id,await f.UpdateDetail(o.orderDetail)&&(w.add({severity:"success",summary:"Generació OF",detail:`Ordre de fabricació ${s.content.code} generada`}),B.fetchBySalesOrder(e.value.id))):w.add({severity:"error",summary:"Generació OF",detail:"Error al generar la ordre de fabricació"})},ye=o=>{V.push({path:`/workorder/${o}`})},_e=async()=>{var s;const o=await qe.SalesOrder.GetReportDataById(e.value.id);if(o){const O=`Comanda_${(s=e.value)==null?void 0:s.number}.docx`,W=await new Ge().Download(o,Le.Order,O);W?xe(O,W):w.add({severity:"warn",summary:"Error",detail:"No s'ha pugut generar fulla de la comanda"})}};return(o,s)=>{const O=y("SplitButton"),K=y("Button"),W=y("TabPanel"),De=y("TabView"),Oe=y("Dialog");return p(),x(oe,null,[r(O,{label:"Guardar",onClick:u,model:m,size:"small",class:"grid_add_row_button"}),r(Ke,{class:"mt-3 mb-3",ref_key:"salesOrderForm",ref:k,salesOrder:"salesOrder",onSubmit:ve},null,512),r(De,null,{default:c(()=>[r(W,{header:"Detall"},{default:c(()=>[t(e)?(p(),G(st,{key:0,salesOrder:t(e),salesOrderDetails:t(e).salesOrderDetails,onEdit:s[1]||(s[1]=q=>J(t(C).EDIT,q)),onDelete:fe,onCreateWorkOrder:be,onOpenWorkOrder:ye},{header:c(()=>[n("div",lt,[dt,t(h).deliveryNote?N("",!0):(p(),x("section",it,[r(K,{size:"small",label:"Afegir línea",onClick:s[0]||(s[0]=q=>J(t(C).CREATE,{})),class:"mr-2"})]))])]),_:1},8,["salesOrder","salesOrderDetails"])):N("",!0)]),_:1}),r(W,{header:"Fitxers"},{default:c(()=>[t(e)?(p(),G(Ue,{key:0,entity:"SalesOrder",id:t(e).id,title:""},null,8,["id"])):N("",!0)]),_:1})]),_:1}),t(e)?(p(),G(Oe,{key:0,closable:!0,visible:v.value,"onUpdate:visible":s[2]||(s[2]=q=>v.value=q),header:nt,modal:!0},{default:c(()=>[l.value?(p(),G(Re,{key:0,formAction:I.value,header:t(e),detail:l.value,onSubmit:pe},null,8,["formAction","header","detail"])):N("",!0)]),_:1},8,["visible"])):N("",!0)],64)}}});export{At as default};
