import{d as j,x as ce,h as f,a as v,m as P,w as p,J as me,i as s,C as B,D as E,k as t,c as F,n as z,P as N,l as k,j as H,z as Y,r as V,e as u,s as q,p as pe,b as fe,f as be,F as _,v as _e,g as ve,u as ye,o as ge,G as De}from"./index-ffbfd559.js";import{d as M,c as Q,b as Se,g as we}from"./functions-2e154ea4.js";import{u as Z}from"./reference-696ceffd.js";import{u as ee}from"./customers-87c7f85b.js";import{u as he}from"./exercise-bea5851e.js";import{u as Ie}from"./plantmodel-808978a6.js";import{u as te}from"./lifecycle-9de62ac9.js";import{u as Ce}from"./tax-92f3f07d.js";import{a as Te,b as Be}from"./report.service-0e00f0a8.js";import{S as Ee}from"./index-78d00281.js";import{u as Ve}from"./workmaster-e9b185bd.js";import{u as J}from"./budget-ab16e41e.js";import{L as ke}from"./LinkReference-56f52b3a.js";import{c as xe,a as G,F as Fe}from"./form-validator-f8953ae6.js";import{_ as Re}from"./FormBudgetOrderDetail.vue_vue_type_script_setup_true_lang-4e5b6bea.js";import{u as Ae}from"./order-492dc652.js";import"./_commonjsHelpers-725317a4.js";import"./v4-a960c1f4.js";import"./reference.service-92f0d222.js";import"./base.service-bfea8aa4.js";import"./index-79f187ed.js";import"./index-5c3ccbe9.js";import"./index-e7f0e049.js";import"./file.service-ddb51cac.js";import"./DropdownReference.vue_vue_type_script_setup_true_lang-1ea4bd71.js";const $e=["onClick"],Le=j({__name:"TableBudgetDetails",props:{budget:{},details:{}},emits:["edit","delete"],setup(h,{emit:g}){const I=ce(),C=J();Z();const T=n=>{n.originalEvent.target.className.includes("grid_delete_column_button")||g("edit",n.data)},x=(n,e)=>{I.require({target:n.currentTarget,message:"Está segur que vol eliminar la línea?",icon:"pi pi-question-circle",acceptIcon:"pi pi-check",rejectIcon:"pi pi-times",accept:()=>{g("delete",e)}})};return(n,e)=>{const c=f("Column"),b=f("DataTable");return v(),P(b,{onRowClick:T,value:n.details,tableStyle:"min-width: 100%",class:"p-datatable-sm",sortMode:"single",sortField:"reference.code",selectionMode:"single",dataKey:"id",sortOrder:1},{header:p(()=>[me(n.$slots,"header")]),default:p(()=>[s(c,{field:"quantity",header:"Quantitat",style:{width:"10%"}}),s(c,{header:"Referencia",field:"reference.code",sortable:"",style:{width:"15%"}},{body:p(l=>[s(ke,{id:l.data.referenceId},null,8,["id"])]),_:1}),s(c,{field:"description",header:"Descripció",style:{width:"25%"}}),s(c,{field:"unitPrice",header:"Preu un.",style:{width:"10%"}},{body:p(l=>[B(E(t(M)(l.data.unitPrice)),1)]),_:1}),s(c,{field:"unitCost",header:"Cost un.",style:{width:"10%"}},{body:p(l=>[B(E(t(M)(l.data.unitCost)),1)]),_:1}),s(c,{field:"totalCost",header:"Cost total",style:{width:"10%"}},{body:p(l=>[B(E(t(M)(l.data.totalCost)),1)]),_:1}),s(c,{field:"profit",header:"Benefici",style:{width:"10%"}},{body:p(l=>[B(E(l.data.profit)+" % ",1)]),_:1}),s(c,{field:"profit",header:"Descompte",style:{width:"10%"}},{body:p(l=>[B(E(l.data.discount)+" % ",1)]),_:1}),s(c,{field:"amount",header:"Total",style:{width:"10%"}},{body:p(l=>[B(E(t(M)(l.data.amount)),1)]),_:1}),s(c,{style:{width:"5%"}},{body:p(l=>[t(C).order===void 0?(v(),F("i",{key:0,class:z([t(N).TIMES,"grid_delete_column_button"]),onClick:R=>x(R,l.data)},null,10,$e)):k("",!0)]),_:1})]),_:3},8,["value"])}}}),U=h=>(pe("data-v-9af11046"),h=h(),fe(),h),Me={key:0},Pe={class:"four-columns mt-2"},Ne=U(()=>u("label",{class:"block text-900 mb-2"},"Data Alta",-1)),Ue=U(()=>u("label",{class:"block text-900 mb-2"},"Data Acceptació",-1)),Oe={class:"three-columns mt-2"},qe=U(()=>u("label",{class:"block text-900 mb-2"},"Estat",-1)),Ge=U(()=>u("label",{class:"block text-900 mb-2"},"Client",-1)),ze=j({__name:"FormBudget",emits:["submit","cancel"],setup(h,{expose:g,emit:I}){const C=J(),T=ee(),x=te(),n=H(),{budget:e}=Y(C),c=xe().shape({customerId:G().required("El client es obligatori"),statusId:G().required("L'estat es obligatori"),exerciseId:G().required("L'exercici es obligatori")}),b=V({result:!1,errors:{}}),l=()=>{const D=new Fe(c);b.value=D.validate(e.value)};g({submitForm:async()=>{if(l(),b.value.result)O(),I("submit",e.value);else{let D="";Object.entries(b.value.errors).forEach(i=>{D+=`${i[1].map(S=>S)}.   `}),n.add({severity:"warn",summary:"Formulari inválid",detail:D,life:5e3})}}});const O=()=>{e.value&&(e.value.date=Q(e.value.date),e.value.acceptanceDate&&(e.value.acceptanceDate=Q(e.value.acceptanceDate)))};return(D,i)=>{var y,w;const S=f("BaseInput"),r=f("Calendar"),A=f("Dropdown");return v(),F("div",null,[t(e)?(v(),F("form",Me,[u("section",Pe,[u("div",null,[s(S,{type:t(q).TEXT,label:"Pressupost",id:"number",modelValue:t(e).number,"onUpdate:modelValue":i[0]||(i[0]=d=>t(e).number=d),disabled:""},null,8,["type","modelValue"])]),u("div",null,[Ne,s(r,{modelValue:t(e).date,"onUpdate:modelValue":i[1]||(i[1]=d=>t(e).date=d),dateFormat:"dd/mm/yy"},null,8,["modelValue"])]),u("div",null,[Ue,s(r,{modelValue:t(e).acceptanceDate,"onUpdate:modelValue":i[2]||(i[2]=d=>t(e).acceptanceDate=d),dateFormat:"dd/mm/yy"},null,8,["modelValue"])]),u("div",null,[s(S,{type:t(q).TEXT,disabled:!0,label:"Comanda",value:(y=t(C).order)==null?void 0:y.number},null,8,["type","value"])])]),u("section",Oe,[u("div",null,[qe,s(A,{modelValue:t(e).statusId,"onUpdate:modelValue":i[3]||(i[3]=d=>t(e).statusId=d),editable:"",options:(w=t(x).lifecycle)==null?void 0:w.statuses,optionValue:"id",optionLabel:"name",class:z(["w-full",{"p-invalid":b.value.errors.statusId}])},null,8,["modelValue","options","class"])]),u("div",null,[Ge,s(A,{modelValue:t(e).customerId,"onUpdate:modelValue":i[4]||(i[4]=d=>t(e).customerId=d),editable:"",options:t(T).customers,optionValue:"id",optionLabel:"comercialName",class:z(["w-full",{"p-invalid":b.value.errors.customerId}])},null,8,["modelValue","options","class"])]),u("div",null,[s(S,{type:t(q).NUMERIC,label:"Dies entrega",id:"deliveryDays",modelValue:t(e).deliveryDays,"onUpdate:modelValue":i[5]||(i[5]=d=>t(e).deliveryDays=d)},null,8,["type","modelValue"])])])])):k("",!0)])}}});const je=be(ze,[["__scopeId","data-v-9af11046"]]),Je={class:"flex flex-wrap align-items-center justify-content-between gap-2"},We=u("span",{class:"text-l text-900 font-bold"},"Linies del pressupost",-1),Xe={key:0},Ke="Línia del pressupost",St=j({__name:"Budget",setup(h){const g=V(_.EDIT),I=V(),C=_e(),T=ve(),x=ye(),n=H(),e=J(),c=ee(),b=Ie(),l=he(),R=te(),O=Z(),D=Ve(),i=Ce(),S=Ae(),{budget:r}=Y(e),A=[{label:"Descarregar",icon:N.FILE_WORD,command:()=>ne()},{label:"Crear comanda",icon:N.FLAG_FILL,command:()=>ie()}],y=V(!1),w=V(_.EDIT),d=V(void 0),ae=async()=>{const o=C.params.id;await e.GetById(o),await e.GetAssociatedSalesOrders(o),O.fetchReferencesByModule("sales"),D.fetchAllActives(),R.fetchOneByName("Budget"),b.fetchSites(),l.fetchAll(),c.fetchCustomers(),i.fetchAll();let a="";r.value&&(g.value=_.EDIT,a=`Pressupost ${r.value.number}`),x.setMenuItem({icon:N.BUILDING,backButtonVisible:!0,title:a})};ge(async()=>{await ae()});const oe=()=>{I.value.submitForm()},W=(o,a)=>{o===_.CREATE&&(a={id:we(),referenceId:"",workMasterId:null,profit:0,discount:0,quantity:1,unitCost:0,unitPrice:0,totalCost:0,amount:0,budgetId:r.value.id,description:""}),d.value=a,w.value=o,y.value=!0},se=async o=>{let a=!1,m="";a=await e.Update(o.id,o),m=a?"Pressupost actualitzat correctament":"Error a l'actualitzar el pressupost",n.add({life:5e3,severity:a?"success":"error",summary:m}),a&&T.back()},le=async o=>{o=o,w.value===_.CREATE?await e.CreateDetail(o):w.value===_.EDIT&&await e.UpdateDetail(o),y.value=!1},re=async o=>{g.value===_.EDIT&&await e.DeleteDetail(o);const a=r.value.details.filter(m=>m.id!==o.id);r.value.details=a,y.value=!1},ie=async()=>{var o,a;if(e.order){n.add({severity:"warn",summary:"Aquest pressupost ja té una comanda associada",life:5e3});return}if(r.value){const m=await S.CreateFromBudget(r.value);m.result?(n.add({severity:"success",summary:`Comanda ${(o=m.content)==null?void 0:o.number} creada correctament`,life:5e3}),T.push(`/salesorder/${(a=m.content)==null?void 0:a.id}`)):n.add({severity:"error",summary:"Error al crear la comanda ",detail:m.errors[0],life:5e3})}},ne=async()=>{var a;const o=await Ee.Budget.GetReportDataById(r.value.id);if(o){const m=`Pressupost_${(a=r.value)==null?void 0:a.number}.docx`,$=await new Be().Download(o,Te.Budget,m);$?Se(m,$):n.add({severity:"warn",summary:"Error",detail:"No s'ha pugut generar fulla del pressupost"})}};return(o,a)=>{const m=f("SplitButton"),X=f("Button"),$=f("TabPanel"),de=f("TabView"),ue=f("Dialog");return v(),F(De,null,[s(m,{label:"Guardar",onClick:oe,model:A,size:"small",class:"grid_add_row_button"}),s(je,{class:"mt-3 mb-3",ref_key:"budgetForm",ref:I,onSubmit:se},null,512),s(de,null,{default:p(()=>[s($,{header:"Detall"},{default:p(()=>{var L;return[t(r)?(v(),P(Le,{key:0,budget:t(r),details:(L=t(r))==null?void 0:L.details,onEdit:a[1]||(a[1]=K=>W(t(_).EDIT,K)),onDelete:re},{header:p(()=>[u("div",Je,[We,t(e).order?k("",!0):(v(),F("section",Xe,[s(X,{size:"small",label:"Afegir línea",onClick:a[0]||(a[0]=K=>W(t(_).CREATE,{})),class:"mr-2"})]))])]),_:1},8,["budget","details"])):k("",!0)]}),_:1})]),_:1}),t(r)?(v(),P(ue,{key:0,closable:!0,visible:y.value,"onUpdate:visible":a[2]||(a[2]=L=>y.value=L),header:Ke,modal:!0},{default:p(()=>[t(r)&&d.value?(v(),P(Re,{key:0,formAction:w.value,header:t(r),detail:d.value,onSubmit:le},null,8,["formAction","header","detail"])):k("",!0)]),_:1},8,["visible"])):k("",!0)],64)}}});export{St as default};
