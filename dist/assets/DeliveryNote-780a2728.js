import{d as L,r as V,K as C,h as N,a as I,m as E,w as b,e as a,C as B,i as l,k as f,P as F,D as w,p as J,b as Q,f as W,j as X,c as R,y as A,n as z,l as M,s as le,x as ae,J as ie,F as K,v as ne,g as de,u as ce,z as ue,o as me,G as ve}from"./index-e365f3be.js";import{f as U,c as pe,e as q,b as fe}from"./functions-e7c8fc70.js";import{u as Y}from"./customers-f17ddf3b.js";import{u as Z}from"./lifecycle-5aa2399a.js";import{u as ye}from"./masterData-afc35dba.js";import{c as be,a as x,F as _e}from"./form-validator-f8953ae6.js";import{L as he}from"./LinkReference-b53b20c5.js";import{u as Ne}from"./reference-3f326116.js";import{u as De}from"./plantmodel-193b9447.js";import{u as Se}from"./deliveryNote-312d95f7.js";import{u as ge}from"./order-4ca6d58b.js";import{S as we}from"./index-dc8700c2.js";import{a as Ie,b as Oe}from"./report.service-45e6858b.js";import"./_commonjsHelpers-725317a4.js";import"./v4-a960c1f4.js";import"./base.service-8e7a55c1.js";import"./index-42d34089.js";import"./reference.service-33e64e53.js";import"./index-d8fe7816.js";import"./index-348057aa.js";const Ve=y=>(J("data-v-8f6728d6"),y=y(),Q(),y),Ce={class:"selector-filter"},Te={class:"selector-filter-field"},Be=Ve(()=>a("label",{for:""},"Buscar",-1)),ke={class:"selector-filter-button"},$e={class:"flex align-items-center gap-2"},xe=L({__name:"SelectorOrders",props:{orders:{},headerVisible:{type:Boolean}},emits:["selected"],setup(y,{emit:g}){const m=y,d=V([]),h=V(""),O=C(()=>{if(h.value==="")return m.orders||[];var o=[];return m.orders&&(o=m.orders.filter(s=>s.number.includes(h.value)||s.customerNumber.includes(h.value))),o}),_=()=>{if(d.value.length===0)return;const o=d.value;g("selected",o)};return(o,s)=>{const e=N("InputText"),c=N("Button"),r=N("Column"),i=N("DataTable");return I(),E(i,{class:"small-datatable",tableStyle:"min-width: 100%",scrollable:"",scrollHeight:"75vh",metaKeySelection:!1,value:O.value,selectionMode:"multiple",selection:d.value,"onUpdate:selection":s[1]||(s[1]=t=>d.value=t)},{header:b(()=>[a("header",Ce,[a("div",Te,[Be,B("   "),l(e,{style:{width:"150px",height:"35px"},modelValue:h.value,"onUpdate:modelValue":s[0]||(s[0]=t=>h.value=t),size:"small"},null,8,["modelValue"])]),a("div",ke,[l(c,{onClick:_,size:"small",icon:f(F).CHECK_SQUARE},null,8,["icon"])])])]),groupheader:b(t=>[a("div",$e,[a("b",null,"Comanda "+w(t.data.number)+" - "+w(f(U)(t.data.date)),1)])]),default:b(()=>[l(r,{selectionMode:"multiple",style:{width:"3%"}}),l(r,{header:"Número",field:"number",style:{width:"10%"}}),l(r,{header:"Número client",field:"customerNumber",style:{width:"20%"}}),l(r,{header:"Data",field:"date",style:{width:"10%"}},{body:b(t=>[B(w(f(U)(t.data.date)),1)]),_:1})]),_:1},8,["value","selection"])}}});const Ee=W(xe,[["__scopeId","data-v-8f6728d6"]]),G=y=>(J("data-v-f0037178"),y=y(),Q(),y),Fe={key:0},Re={class:"three-columns"},Me={class:"mt-1"},Ue={class:"mt-1"},Le=G(()=>a("label",{class:"block text-900 mb-2"},"Client",-1)),Ae={class:"mt-2"},qe={class:"three-columns"},ze={class:"mt-2"},Ge=G(()=>a("label",{class:"block text-900 mb-2"},"Estat",-1)),je={class:"mt-2"},Pe=G(()=>a("label",{class:"block text-900 mb-2"},"Data Entrega",-1)),He={class:"mt-2"},Ke=L({__name:"FormDeliveryNote",props:{deliveryNote:{}},emits:["submit","cancel"],setup(y,{expose:g,emit:m}){const d=y,h=Y();ye();const O=Z(),_=X(),o=C(()=>d.deliveryNote&&d.deliveryNote.salesInvoice?d.deliveryNote.salesInvoice.invoiceNumber:""),s=C(()=>d.deliveryNote&&d.deliveryNote.createdOn?U(d.deliveryNote.createdOn):""),e=be().shape({siteId:x().required("L'origen es obligatori"),customerId:x().required("El client es obligatori"),statusId:x().required("L'estat es obligatori"),exerciseId:x().required("L'exercici es obligatori")}),c=V({result:!1,errors:{}}),r=()=>{const t=new _e(e);c.value=t.validate(d.deliveryNote)};return g({submitForm:async()=>{if(r(),c.value.result)d.deliveryNote.deliveryDate&&(d.deliveryNote.deliveryDate=pe(d.deliveryNote.deliveryDate)),m("submit",d.deliveryNote);else{let t="";Object.entries(c.value.errors).forEach(v=>{t+=`${v[1].map(D=>D)}.   `}),_.add({severity:"warn",summary:"Formulari inválid",detail:t,life:5e3})}}}),(t,v)=>{var T;const D=N("Dropdown"),k=N("Calendar");return I(),R("div",null,[t.deliveryNote?(I(),R("form",Fe,[a("section",Re,[a("div",Me,[l(A,{type:f(le).TEXT,label:"Número Albarà",id:"salesOrderNumber",modelValue:t.deliveryNote.number,"onUpdate:modelValue":v[0]||(v[0]=p=>t.deliveryNote.number=p),disabled:""},null,8,["type","modelValue"])]),a("div",Ue,[Le,l(D,{modelValue:t.deliveryNote.customerId,"onUpdate:modelValue":v[1]||(v[1]=p=>t.deliveryNote.customerId=p),editable:"",options:f(h).customers,optionValue:"id",optionLabel:"comercialName",class:z(["w-full",{"p-invalid":c.value.errors.customerId}])},null,8,["modelValue","options","class"])]),a("div",Ae,[l(A,{modelValue:s.value,"onUpdate:modelValue":v[2]||(v[2]=p=>s.value=p),label:"Data Creació",disabled:!0},null,8,["modelValue"])])]),a("section",qe,[a("div",ze,[Ge,l(D,{modelValue:t.deliveryNote.statusId,"onUpdate:modelValue":v[3]||(v[3]=p=>t.deliveryNote.statusId=p),editable:"",options:(T=f(O).lifecycle)==null?void 0:T.statuses,optionValue:"id",optionLabel:"name",class:z(["w-full",{"p-invalid":c.value.errors.statusId}])},null,8,["modelValue","options","class"])]),a("div",je,[Pe,l(k,{modelValue:t.deliveryNote.deliveryDate,"onUpdate:modelValue":v[4]||(v[4]=p=>t.deliveryNote.deliveryDate=p),dateFormat:"dd/mm/yy",class:"mt-2"},null,8,["modelValue"])]),a("div",He,[l(A,{modelValue:o.value,"onUpdate:modelValue":v[5]||(v[5]=p=>o.value=p),label:"Número de factura",disabled:!0},null,8,["modelValue"])])])])):M("",!0)])}}});const Je=W(Ke,[["__scopeId","data-v-f0037178"]]),Qe=["onClick"],We={class:"vertical-align-middle ml-2 font-bold line-height-3"},Xe={class:"flex-right"},Ye=L({__name:"TableDeliveryNoteDetails",props:{orders:{},canDelete:{type:Boolean}},emits:["delete"],setup(y,{emit:g}){const m=y,d=C(()=>{if(!m.orders)return[];let o=[];for(let s=0;s<m.orders.length;s++){if(!m.orders[s].salesOrderDetails)continue;const e=m.orders[s];e.salesOrderDetails.forEach(c=>{o.push({salesOrderId:e.id,salesOrderNumber:e.number,salesOrderDate:e.date,customerNumber:e.customerNumber,...c})})}return o}),h=ae(),O=(o,s)=>{var c;if(!m.orders)return;const e=(c=m.orders)==null?void 0:c.find(r=>r.id===s.salesOrderId);e&&h.require({target:o.currentTarget,message:`Está segur que vol desassignar la comanda ${e.number}?`,icon:"pi pi-question-circle",acceptIcon:"pi pi-check",rejectIcon:"pi pi-times",accept:()=>{g("delete",e)}})},_=C(()=>m.orders?m.orders.reduce((o,s)=>s.salesOrderDetails?o+s.salesOrderDetails.reduce((e,c)=>e+c.amount,0):o,0):0);return(o,s)=>{const e=N("Column"),c=N("DataTable");return I(),E(c,{value:d.value,tableStyle:"min-width: 100%",class:"p-datatable-sm",rowGroupMode:"subheader",groupRowsBy:"salesOrderNumber",sortMode:"multiple",sortOrder:1,scrollable:"",scrollHeight:"60vh"},{header:b(()=>[ie(o.$slots,"header")]),groupheader:b(r=>[o.canDelete?(I(),R("i",{key:0,class:z([f(F).TIMES,"grid_delete_column_button"]),onClick:i=>O(i,r.data)},null,10,Qe)):M("",!0),B("   "),a("span",We,"Comanda "+w(r.data.salesOrderNumber)+" (Núm. Client: "+w(r.data.customerNumber)+")",1)]),footer:b(()=>[a("div",Xe,[a("span",null," Total: "+w(f(q)(_.value)),1)])]),default:b(()=>[l(e,{field:"salesOrderNumber",header:"Comanda",style:{width:"5%"}}),l(e,{field:"",header:"",style:{width:"2%"}}),l(e,{field:"quantity",header:"Quantitat",style:{width:"5%"}}),l(e,{header:"Referència",field:"reference.code",sortable:"",style:{width:"15%"}},{body:b(r=>[l(he,{id:r.data.referenceId},null,8,["id"])]),_:1}),l(e,{field:"description",header:"Descripció",style:{width:"30%"}}),l(e,{field:"unitPrice",header:"Preu un.",style:{width:"10%"}},{body:b(r=>[B(w(f(q)(r.data.unitPrice)),1)]),_:1}),l(e,{field:"amount",header:"Total",style:{width:"10%"}},{body:b(r=>[B(w(f(q)(r.data.amount)),1)]),_:1})]),_:3},8,["value"])}}}),Ze={class:"flex flex-wrap align-items-center justify-content-between gap-2"},et=a("span",{class:"text-l text-900 font-bold"},"Linies de l'albarà",-1),tt="Selector de comandes",St=L({__name:"DeliveryNote",setup(y){const g=V(),m=V(K.EDIT),d=ne(),h=de(),O=ce(),_=Se(),o=ge(),s=Y(),e=De(),c=Ne(),r=Z(),{deliveryNote:i}=ue(_),t=[{label:"Descarregar",icon:F.FILE_WORD,command:()=>v()}],v=async()=>{var n;const u=await we.DeliveryNote.GetReportDataById(i.value.id);if(u){const S=`AlbaraEntrega_${(n=i.value)==null?void 0:n.number}.docx`,$=await new Oe().Download(u,Ie.DeliveryNote,S);$?fe(S,$):j.add({severity:"warn",summary:"Error",detail:"No s'ha pugut generar fulla de la comanda"})}},D=V(!1),k=V(""),T=C(()=>{if(!r.lifecycle||!r.lifecycle.statuses||i.value&&i.value.salesInvoiceId&&i.value.salesInvoiceId!==null)return!1;const u=r.lifecycle.statuses.find(n=>n.name==="Entregat");return u?u.id!==k.value:!1}),p=async()=>{const u=d.params.id;await _.GetById(u),k.value=_.deliveryNote.statusId,await o.GetByDeliveryNote(u),c.fetchReferencesByModule("sales"),e.fetchSites(),s.customers||s.fetchCustomers(),r.lifecycle||r.fetchOneByName("DeliveryNote");let n="";i.value&&(m.value=K.EDIT,n=`Albarà d'entrega ${i.value.number}`,i.value.deliveryDate&&(i.value.deliveryDate=U(i.value.deliveryDate))),O.setMenuItem({icon:F.BUILDING,backButtonVisible:!0,title:n})};me(async()=>{await p()});const ee=()=>{g.value.submitForm()},j=X(),te=async u=>{let n=!1,S="";n=await _.Update(u.id,u),S=n?"Albarà actualitzat":"Error al actualitzar l'albarà",j.add({life:5e3,severity:n?"success":"error",summary:S}),n&&h.back()},oe=async()=>{i.value&&await o.GetToDeliver(i.value.customerId),D.value=!0},se=async u=>{for(let n=0;n<u.length;n++){const S=u[n];await _.AddOrder(i.value.id,S)}D.value=!1,p()},re=async u=>{await _.DeleteOrder(i.value.id,u),p()};return(u,n)=>{const S=N("SplitButton"),P=N("Button"),$=N("Dialog");return I(),R(ve,null,[l(S,{label:"Guardar",onClick:ee,model:t,size:"small",class:"grid_add_row_button"}),f(i)?(I(),E(Je,{key:0,class:"mt-3 mb-3",ref_key:"deliveryNoteForm",ref:g,deliveryNote:f(i),onSubmit:te},null,8,["deliveryNote"])):M("",!0),f(i)?(I(),E(Ye,{key:1,orders:f(o).salesOrders,canDelete:T.value,onDelete:re},{header:b(()=>[a("div",Ze,[et,a("div",null,[l(P,{disabled:!T.value,size:"small",label:"Afegir comanda",onClick:n[0]||(n[0]=H=>oe())},null,8,["disabled"])])])]),_:1},8,["orders","canDelete"])):M("",!0),l($,{closable:!0,visible:D.value,"onUpdate:visible":n[1]||(n[1]=H=>D.value=H),header:tt,modal:!0,style:{width:"50rem"},breakpoints:{"1199px":"75vw","575px":"90vw"}},{default:b(()=>[l(Ee,{orders:f(o).salesOrdersToDeliver,onSelected:se},null,8,["orders"])]),_:1},8,["visible"])],64)}}});export{St as default};
