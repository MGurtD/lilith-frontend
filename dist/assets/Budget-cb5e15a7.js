import{d as z,x as ue,h as f,a as v,m as P,w as p,Q as ce,i as s,G as B,H as E,k as t,$ as M,c as F,n as j,P as N,l as k,j as Q,C as Y,r as V,e as u,s as q,D as K,p as me,b as pe,f as fe,F as _,v as be,g as _e,u as ve,E as ye,o as ge,W as De,L as Se,J as we}from"./index-0165ef2a.js";import{u as he}from"./reference-3a204a36.js";import{u as Z}from"./customers-7ea2bdbb.js";import{u as Ie}from"./plantmodel-b6f0255e.js";import{u as ee}from"./lifecycle-491d1308.js";import{u as Ce}from"./tax-d88f1d3d.js";import{a as Te,b as Be}from"./report.service-5554abfa.js";import{S as Ee}from"./index-cc513c2f.js";import{u as Ve}from"./workmaster-f6a81062.js";import{u as W}from"./budget-807d9b84.js";import{L as ke}from"./LinkReference-ea1e455d.js";import{c as xe,a as G,F as Fe}from"./form-validator-29ed56b4.js";import{_ as Re}from"./FormBudgetOrderDetail.vue_vue_type_script_setup_true_lang-9f4acb55.js";import{u as Ae}from"./order-33dbdef2.js";import"./index-836a0692.js";import"./DropdownReference.vue_vue_type_script_setup_true_lang-71e36068.js";const $e=["onClick"],Le=z({__name:"TableBudgetDetails",props:{budget:{},details:{}},emits:["edit","delete"],setup(h,{emit:g}){const I=ue(),C=W(),T=i=>{i.originalEvent.target.className.includes("grid_delete_column_button")||g("edit",i.data)},x=(i,e)=>{I.require({target:i.currentTarget,message:"Está segur que vol eliminar la línea?",icon:"pi pi-question-circle",acceptIcon:"pi pi-check",rejectIcon:"pi pi-times",accept:()=>{g("delete",e)}})};return(i,e)=>{const c=f("Column"),b=f("DataTable");return v(),P(b,{onRowClick:T,value:i.details,tableStyle:"min-width: 100%",class:"p-datatable-sm",sortMode:"single",sortField:"reference.code",selectionMode:"single",dataKey:"id",sortOrder:1},{header:p(()=>[ce(i.$slots,"header")]),default:p(()=>[s(c,{field:"quantity",header:"Un.",style:{width:"3%"}}),s(c,{header:"Referencia",field:"reference.code",sortable:"",style:{width:"15%"}},{body:p(l=>[s(ke,{id:l.data.referenceId},null,8,["id"])]),_:1}),s(c,{field:"description",header:"Descripció",style:{width:"25%"}}),s(c,{field:"unitCost",header:"Cost un.",style:{width:"10%"}},{body:p(l=>[B(E(t(M)(l.data.unitCost)),1)]),_:1}),s(c,{field:"totalCost",header:"Cost total",style:{width:"10%"}},{body:p(l=>[B(E(t(M)(l.data.totalCost)),1)]),_:1}),s(c,{field:"profit",header:"Benefici",style:{width:"10%"}},{body:p(l=>[B(E(l.data.profit)+" % ",1)]),_:1}),s(c,{field:"discount",header:"Descompte",style:{width:"10%"}},{body:p(l=>[B(E(l.data.discount)+" % ",1)]),_:1}),s(c,{field:"unitPrice",header:"Preu un.",style:{width:"10%"}},{body:p(l=>[B(E(t(M)(l.data.unitPrice)),1)]),_:1}),s(c,{field:"amount",header:"Total",style:{width:"10%"}},{body:p(l=>[B(E(t(M)(l.data.amount)),1)]),_:1}),s(c,{style:{width:"5%"}},{body:p(l=>[t(C).order===void 0?(v(),F("i",{key:0,class:j([t(N).TIMES,"grid_delete_column_button"]),onClick:R=>x(R,l.data)},null,10,$e)):k("",!0)]),_:1})]),_:3},8,["value"])}}}),U=h=>(me("data-v-9af11046"),h=h(),pe(),h),Me={key:0},Pe={class:"four-columns mt-2"},Ne=U(()=>u("label",{class:"block text-900 mb-2"},"Data Alta",-1)),Ue=U(()=>u("label",{class:"block text-900 mb-2"},"Data Acceptació",-1)),Oe={class:"three-columns mt-2"},qe=U(()=>u("label",{class:"block text-900 mb-2"},"Estat",-1)),Ge=U(()=>u("label",{class:"block text-900 mb-2"},"Client",-1)),je=z({__name:"FormBudget",emits:["submit","cancel"],setup(h,{expose:g,emit:I}){const C=W(),T=Z(),x=ee(),i=Q(),{budget:e}=Y(C),c=xe().shape({customerId:G().required("El client es obligatori"),statusId:G().required("L'estat es obligatori"),exerciseId:G().required("L'exercici es obligatori")}),b=V({result:!1,errors:{}}),l=()=>{const D=new Fe(c);b.value=D.validate(e.value)};g({submitForm:async()=>{if(l(),b.value.result)O(),I("submit",e.value);else{let D="";Object.entries(b.value.errors).forEach(n=>{D+=`${n[1].map(S=>S)}.   `}),i.add({severity:"warn",summary:"Formulari inválid",detail:D,life:5e3})}}});const O=()=>{e.value&&(e.value.date=K(e.value.date),e.value.acceptanceDate&&(e.value.acceptanceDate=K(e.value.acceptanceDate)))};return(D,n)=>{var y,w;const S=f("BaseInput"),r=f("Calendar"),A=f("Dropdown");return v(),F("div",null,[t(e)?(v(),F("form",Me,[u("section",Pe,[u("div",null,[s(S,{type:t(q).TEXT,label:"Pressupost",id:"number",modelValue:t(e).number,"onUpdate:modelValue":n[0]||(n[0]=d=>t(e).number=d),disabled:""},null,8,["type","modelValue"])]),u("div",null,[Ne,s(r,{modelValue:t(e).date,"onUpdate:modelValue":n[1]||(n[1]=d=>t(e).date=d),dateFormat:"dd/mm/yy"},null,8,["modelValue"])]),u("div",null,[Ue,s(r,{modelValue:t(e).acceptanceDate,"onUpdate:modelValue":n[2]||(n[2]=d=>t(e).acceptanceDate=d),dateFormat:"dd/mm/yy"},null,8,["modelValue"])]),u("div",null,[s(S,{type:t(q).TEXT,disabled:!0,label:"Comanda",value:(y=t(C).order)==null?void 0:y.number},null,8,["type","value"])])]),u("section",Oe,[u("div",null,[qe,s(A,{modelValue:t(e).statusId,"onUpdate:modelValue":n[3]||(n[3]=d=>t(e).statusId=d),editable:"",options:(w=t(x).lifecycle)==null?void 0:w.statuses,optionValue:"id",optionLabel:"name",class:j(["w-full",{"p-invalid":b.value.errors.statusId}])},null,8,["modelValue","options","class"])]),u("div",null,[Ge,s(A,{modelValue:t(e).customerId,"onUpdate:modelValue":n[4]||(n[4]=d=>t(e).customerId=d),editable:"",options:t(T).customers,optionValue:"id",optionLabel:"comercialName",class:j(["w-full",{"p-invalid":b.value.errors.customerId}])},null,8,["modelValue","options","class"])]),u("div",null,[s(S,{type:t(q).NUMERIC,label:"Dies entrega",id:"deliveryDays",modelValue:t(e).deliveryDays,"onUpdate:modelValue":n[5]||(n[5]=d=>t(e).deliveryDays=d)},null,8,["type","modelValue"])])])])):k("",!0)])}}});const ze=fe(je,[["__scopeId","data-v-9af11046"]]),We={class:"flex flex-wrap align-items-center justify-content-between gap-2"},Je=u("span",{class:"text-l text-900 font-bold"},"Linies del pressupost",-1),Xe={key:0},He="Línia del pressupost",mt=z({__name:"Budget",setup(h){const g=V(_.EDIT),I=V(),C=be(),T=_e(),x=ve(),i=Q(),e=W(),c=Z(),b=Ie(),l=ye(),R=ee(),O=he(),D=Ve(),n=Ce(),S=Ae(),{budget:r}=Y(e),A=[{label:"Descarregar",icon:N.FILE_WORD,command:()=>ne()},{label:"Crear comanda",icon:N.FLAG_FILL,command:()=>re()}],y=V(!1),w=V(_.EDIT),d=V(void 0),te=async()=>{const o=C.params.id;await e.GetById(o),await e.GetAssociatedSalesOrders(o),O.fetchReferencesByModule("sales"),D.fetchAllActives(),R.fetchOneByName("Budget"),b.fetchSites(),l.fetchAll(),c.fetchCustomers(),n.fetchAll();let a="";r.value&&(g.value=_.EDIT,a=`Pressupost ${r.value.number}`),x.setMenuItem({icon:N.BUILDING,backButtonVisible:!0,title:a})};ge(async()=>{await te()});const ae=()=>{I.value.submitForm()},J=(o,a)=>{o===_.CREATE&&(a={id:we(),referenceId:"",workMasterId:null,profit:0,discount:0,quantity:1,unitCost:0,unitPrice:0,totalCost:0,amount:0,budgetId:r.value.id,description:""}),d.value=a,w.value=o,y.value=!0},oe=async o=>{let a=!1,m="";a=await e.Update(o.id,o),m=a?"Pressupost actualitzat correctament":"Error a l'actualitzar el pressupost",i.add({life:5e3,severity:a?"success":"error",summary:m}),a&&T.back()},se=async o=>{o=o,w.value===_.CREATE?await e.CreateDetail(o):w.value===_.EDIT&&await e.UpdateDetail(o),y.value=!1},le=async o=>{g.value===_.EDIT&&await e.DeleteDetail(o);const a=r.value.details.filter(m=>m.id!==o.id);r.value.details=a,y.value=!1},re=async()=>{var o,a;if(e.order){i.add({severity:"warn",summary:"Aquest pressupost ja té una comanda associada",life:5e3});return}if(r.value){const m=await S.CreateFromBudget(r.value);m.result?(i.add({severity:"success",summary:`Comanda ${(o=m.content)==null?void 0:o.number} creada correctament`,life:5e3}),T.push(`/salesorder/${(a=m.content)==null?void 0:a.id}`)):i.add({severity:"error",summary:"Error al crear la comanda ",detail:m.errors[0],life:5e3})}},ne=async()=>{var a;const o=await Ee.Budget.GetReportDataById(r.value.id);if(o){const m=`Pressupost_${(a=r.value)==null?void 0:a.number}.docx`,$=await new Be().Download(o,Te.Budget,m);$?De(m,$):i.add({severity:"warn",summary:"Error",detail:"No s'ha pugut generar fulla del pressupost"})}};return(o,a)=>{const m=f("SplitButton"),X=f("Button"),$=f("TabPanel"),ie=f("TabView"),de=f("Dialog");return v(),F(Se,null,[s(m,{label:"Guardar",onClick:ae,model:A,size:"small",class:"grid_add_row_button"}),s(ze,{class:"mt-3 mb-3",ref_key:"budgetForm",ref:I,onSubmit:oe},null,512),s(ie,null,{default:p(()=>[s($,{header:"Detall"},{default:p(()=>{var L;return[t(r)?(v(),P(Le,{key:0,budget:t(r),details:(L=t(r))==null?void 0:L.details,onEdit:a[1]||(a[1]=H=>J(t(_).EDIT,H)),onDelete:le},{header:p(()=>[u("div",We,[Je,t(e).order?k("",!0):(v(),F("section",Xe,[s(X,{size:"small",label:"Afegir línea",onClick:a[0]||(a[0]=H=>J(t(_).CREATE,{})),class:"mr-2"})]))])]),_:1},8,["budget","details"])):k("",!0)]}),_:1})]),_:1}),t(r)?(v(),P(de,{key:0,closable:!0,visible:y.value,"onUpdate:visible":a[2]||(a[2]=L=>y.value=L),header:He,modal:!0},{default:p(()=>[t(r)&&d.value?(v(),P(Re,{key:0,formAction:w.value,header:t(r),detail:d.value,onSubmit:se},null,8,["formAction","header","detail"])):k("",!0)]),_:1},8,["visible"])):k("",!0)],64)}}});export{mt as default};
