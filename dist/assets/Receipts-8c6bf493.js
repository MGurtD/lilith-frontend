import{u as F}from"./suppliers-c41f6a2c.js";import{u as T}from"./masterData-6d455d54.js";import{d as U,j as M,r as V,h as d,a as N,c as $,e as o,i as s,k as r,D as K,x as Q,g as W,u as X,K as Z,o as ee,P as g,O as L,w as b,L as te,G as C,H as q,I as se,n as ae,l as oe,J as ie}from"./index-0165ef2a.js";import{c as le,a as B,e as re,F as ne}from"./form-validator-29ed56b4.js";import{_ as ce}from"./ExerciseDatePicker.vue_vue_type_script_setup_true_lang-9cdb8c27.js";import{u as de}from"./receipt-25cfc7bc.js";import{u as ue}from"./lifecycle-491d1308.js";import"./suppliers.service-a7d0b185.js";import"./index-84fff38f.js";const pe={class:"mt-2"},me=o("label",{class:"block text-900 mb-2"},"Proveïdor",-1),fe={class:"mt-2"},be=o("label",{class:"block text-900 mb-2"},"Exercici",-1),_e={class:"mt-2"},ve=o("label",{class:"block text-900 mb-2"},"Data",-1),he={class:"mt-2"},ye=U({__name:"FormCreateReceipt",props:{createRequest:{}},emits:["submit"],setup(E,{emit:I}){const _=E,S=M(),l=T(),v=F(),u=le().shape({exerciseId:B().required("L'exercici és obligatori"),supplierId:B().required("El client és obligatori"),date:re().required("La data és obligatoria")}),p=V({result:!1,errors:{}}),R=()=>{const e=new ne(u);p.value=e.validate(_.createRequest)},h=()=>{if(R(),p.value.result)_.createRequest.date=K(_.createRequest.date),I("submit",_.createRequest);else{let e="";Object.entries(p.value.errors).forEach(n=>{e+=`${n[1].map(y=>y)}.   `}),S.add({severity:"warn",summary:"Formulari inválid",detail:e,life:5e3})}};return(e,n)=>{const y=d("Dropdown"),w=d("Calendar"),D=d("Button");return N(),$("form",null,[o("div",pe,[me,s(y,{class:"w-full",modelValue:e.createRequest.supplierId,"onUpdate:modelValue":n[0]||(n[0]=m=>e.createRequest.supplierId=m),editable:"",options:r(v).suppliers,optionValue:"id",optionLabel:"comercialName"},null,8,["modelValue","options"])]),o("div",fe,[be,s(y,{class:"w-full",modelValue:e.createRequest.exerciseId,"onUpdate:modelValue":n[1]||(n[1]=m=>e.createRequest.exerciseId=m),editable:"",options:r(l).exercises,optionValue:"id",optionLabel:"name"},null,8,["modelValue","options"])]),o("div",_e,[ve,s(w,{modelValue:e.createRequest.date,"onUpdate:modelValue":n[2]||(n[2]=m=>e.createRequest.date=m)},null,8,["modelValue"])]),o("footer",he,[s(D,{label:"Crear",onClick:h,style:{float:"right"}})])])}}}),we={class:"flex flex-wrap align-items-center justify-content-between gap-2"},xe={class:"datatable-filter"},Re={class:"filter-field"},ge={class:"filter-field"},Ie=o("label",{class:"block text-900 mb-2"},"Proveïdor",-1),Se={class:"datatable-buttons"},ke=["onClick"],Be=U({__name:"Receipts",setup(E){const I=M(),_=Q(),S=W(),l=X(),v=ue(),u=de(),p=F(),R=T(),h=V({supplierId:void 0,exercise:void 0}),e=Z({visible:!1,title:"Crear albarà",closable:!0,position:"center",modal:!0});ee(async()=>{l.setMenuItem({icon:g.MONEY_BILL,title:"Albarans de compra"}),p.fetchSuppliers(),v.fetchOneByName("Receipts"),await R.fetchMasterData(),await u.fetchReceipts(),n(),await w()});const n=()=>{var c;const a=new Date().getFullYear().toString(),t=(c=R.exercises)==null?void 0:c.find(f=>f.name===a);t&&(l.exercisePicker.exercise=t,l.exercisePicker.dates=[new Date(l.exercisePicker.exercise.startDate),new Date(l.exercisePicker.exercise.endDate)])},y=()=>{l.cleanExercisePicker(),h.value.supplierId=void 0},w=async()=>{if(l.exercisePicker.dates){const a=L(l.exercisePicker.dates[0]),t=L(l.exercisePicker.dates[1]);await u.fetchFiltered(a,t,h.value.supplierId)}else I.add({severity:"info",summary:"Filtre invàlid",detail:"Seleccioni un període",life:5e3})},D=a=>{var c;const t=(c=p.suppliers)==null?void 0:c.find(f=>f.id===a);return t?t.comercialName:""},m=a=>{if(v.lifecycle){const t=v.lifecycle.statuses.find(c=>c.id===a);if(t)return t.name}return""},O=()=>{k.value=j(),e.visible=!0},k=V({}),j=()=>({id:ie(),supplierId:"",exerciseId:"",date:new Date}),A=async()=>{await u.createReceipt(k.value)&&S.push({path:`/receipts/${k.value.id}`})},H=a=>{a.originalEvent.target.className.includes("grid_delete_column_button")||S.push({path:`/receipts/${a.data.id}`})},Y=(a,t)=>{_.require({target:a.currentTarget,message:`Està segur que vol eliminar l'albarà ${t.number}?`,icon:"pi pi-question-circle",acceptIcon:"pi pi-check",rejectIcon:"pi pi-times",accept:async()=>{await u.deleteReceipt(t.id)&&(I.add({severity:"success",summary:"Eliminat",life:3e3}),await w())}})};return(a,t)=>{const c=d("Dropdown"),f=d("Button"),x=d("Column"),J=d("DataTable"),z=d("Dialog");return N(),$(te,null,[o("div",null,[s(J,{class:"small-datatable",tableStyle:"min-width: 100%",scrollable:"",scrollHeight:"75vh",sortMode:"multiple",value:r(u).receipts,onRowClick:H},{header:b(()=>[o("div",we,[o("div",xe,[o("div",Re,[s(ce,{exercises:r(R).exercises,onRangeSelected:w},null,8,["exercises"])]),o("div",ge,[Ie,s(c,{modelValue:h.value.supplierId,"onUpdate:modelValue":t[0]||(t[0]=i=>h.value.supplierId=i),editable:"",options:r(p).suppliers,optionValue:"id",optionLabel:"comercialName",class:"w-full"},null,8,["modelValue","options"])])]),o("div",Se,[s(f,{class:"datatable-button mr-2",icon:r(g).FILTER,rounded:"",raised:"",onClick:w},null,8,["icon"]),s(f,{class:"datatable-button mr-2",icon:r(g).FILTER_SLASH,rounded:"",raised:"",onClick:y},null,8,["icon"]),s(f,{icon:r(g).PLUS,rounded:"",raised:"",onClick:O},null,8,["icon"])])])]),default:b(()=>[s(x,{field:"number",header:"Número",sortable:!0,style:{width:"10%"}}),s(x,{header:"Data",field:"date",sortable:"",style:{width:"10%"}},{body:b(i=>[C(q(r(se)(i.data.date)),1)]),_:1}),s(x,{header:"Proveïdor",style:{width:"15%"}},{body:b(i=>[C(q(D(i.data.supplierId)),1)]),_:1}),s(x,{header:"Número Albarà",style:{width:"15%"},field:"supplierNumber"}),s(x,{header:"Estat",style:{width:"15%"}},{body:b(i=>[C(q(m(i.data.statusId)),1)]),_:1}),s(x,{style:{width:"5%"}},{body:b(i=>{var P;return[((P=r(v).lifecycle)==null?void 0:P.initialStatusId)===i.data.statusId?(N(),$("i",{key:0,class:ae([r(g).TIMES,"grid_delete_column_button"]),onClick:G=>Y(G,i.data)},null,10,ke)):oe("",!0)]}),_:1})]),_:1},8,["value"])]),s(z,{visible:e.visible,"onUpdate:visible":t[1]||(t[1]=i=>e.visible=i),header:e.title,closable:e.closable,modal:e.modal},{default:b(()=>[s(ye,{"create-request":k.value,onSubmit:A},null,8,["create-request"])]),_:1},8,["visible","header","closable","modal"])],64)}}});export{Be as default};
