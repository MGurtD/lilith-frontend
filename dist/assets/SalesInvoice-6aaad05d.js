import{d as T,j as P,r as k,h as b,c as S,e as i,i as l,k as m,H as g,l as $,a as _,R as L,x as me,T as K,o as Y,m as M,w as y,Q as ve,n as J,P as F,G as V,I as E,ad as pe,z as A,s as z,$ as ye,p as fe,b as be,f as _e,v as De,g as he,u as Ne,C as Ie,K as X,X as we,ai as ge,L as Se,D as $e}from"./index-797fdaef.js";import{u as Ce}from"./invoice-0ee3ce0e.js";import{u as Ve}from"./customers-e5fab7a6.js";import{u as G}from"./masterData-bde952f2.js";import{u as Q}from"./lifecycle-eb1cb5ae.js";import{c as W,a as Z,d as H,F as ee}from"./form-validator-7fd5796d.js";import{L as ke}from"./LinkReference-c23d7b15.js";import{u as Re}from"./deliveryNote-64d4de3c.js";import{u as Be}from"./reference-0fda136f.js";import{S as qe}from"./index-91cd924c.js";import{a as Fe,b as Ee}from"./report.service-76e17ffe.js";const Te={key:0},xe={class:"four-columns"},Ue={class:"mt-2"},Ae={class:"mt-2"},Le=i("label",{class:"block text-900 mb-2"},"Data Factura",-1),Me={class:"mt-2"},Oe=i("label",{class:"block text-900 mb-2"},"Estat",-1),ze={class:"mt-2"},Pe=i("label",{class:"block text-900 mb-2"},"Métode Pagament",-1),Ge={class:"four-columns"},Qe={class:"mt-1"},je=i("label",{class:"block text-900 mb-2"},"Base",-1),He={class:"summary-field"},Ke={class:"mt-1"},Ye=i("label",{class:"block text-900 mb-2"},"Impostos",-1),We={class:"summary-field"},Je={class:"mt-1"},Xe=i("label",{class:"block text-900 mb-2"},"Total",-1),Ze={class:"summary-field"},et=T({__name:"FormSalesInvoice",props:{invoice:{}},emits:["submit","cancel"],setup(D,{emit:w}){P();const c=G(),f=Q();return W().shape({invoiceDate:Z().required("La data és obligatoria"),paymentMethodId:Z().required("El métode de pagament és obligatori")}),k({result:!1,errors:{}}),(d,u)=>{var r;const N=b("BaseInput"),h=b("Calendar"),v=b("Dropdown");return d.invoice?(_(),S("form",Te,[i("section",xe,[i("div",Ue,[l(N,{modelValue:d.invoice.invoiceNumber,"onUpdate:modelValue":u[0]||(u[0]=e=>d.invoice.invoiceNumber=e),label:"Número",disabled:!0},null,8,["modelValue"])]),i("div",Ae,[Le,l(h,{modelValue:d.invoice.invoiceDate,"onUpdate:modelValue":u[1]||(u[1]=e=>d.invoice.invoiceDate=e),dateFormat:"dd/mm/yy"},null,8,["modelValue"])]),i("div",Me,[Oe,l(v,{modelValue:d.invoice.statusId,"onUpdate:modelValue":u[2]||(u[2]=e=>d.invoice.statusId=e),editable:"",options:(r=m(f).lifecycle)==null?void 0:r.statuses,optionValue:"id",optionLabel:"name",class:"w-full"},null,8,["modelValue","options"])]),i("div",ze,[Pe,l(v,{modelValue:d.invoice.paymentMethodId,"onUpdate:modelValue":u[3]||(u[3]=e=>d.invoice.paymentMethodId=e),editable:"",options:m(c).paymentMethods,optionValue:"id",optionLabel:"name",class:"w-full"},null,8,["modelValue","options"])])]),i("section",Ge,[i("div",Qe,[je,i("span",He,g(m(L)(d.invoice.baseAmount)),1)]),i("div",Ke,[Ye,i("span",We,g(m(L)(d.invoice.taxAmount)),1)]),i("div",Je,[Xe,i("span",Ze,g(m(L)(d.invoice.netAmount)),1)])])])):$("",!0)}}}),tt=["onClick"],at={class:"vertical-align-middle ml-2 font-bold line-height-3"},it={key:0},ot={key:1},lt=["onClick"],st=T({__name:"TableInvoiceDetails",props:{details:{},deliveryNotes:{},canDelete:{type:Boolean}},emits:["delete","deleteDeliveryNote"],setup(D,{emit:w}){const c=D,f=me(),d=Q(),u=G(),N=K(()=>{let e=[];if(!c.details)return e;const o=c.details.filter(s=>!s.deliveryNoteDetailId).map(s=>({deliveryNoteId:"",deliveryNoteNumber:"Sense albarà",deliveryNoteDate:"",...s}));o.length>0&&e.push(...o);const t=c.details.filter(s=>s.deliveryNoteDetailId).map(s=>{var B;const a=(B=c.deliveryNotes)==null?void 0:B.find(x=>{var q;return x.id===((q=s.deliveryNoteDetail)==null?void 0:q.deliveryNoteId)}),n=a&&a.deliveryDate?`Entregat ${E(a.deliveryDate)}`:"No entregat";return{deliveryNoteId:a==null?void 0:a.id,deliveryNoteNumber:`Albarà ${a?`${a.number} - ${n}`:"--"}`,deliveryNoteDate:a&&a.deliveryDate?` - ${E(a.deliveryDate)}`:"",...s}});return t.length>0&&e.push(...t),console.log(t,e),pe.orderBy(e,s=>s.deliveryNoteNumber)});Y(async()=>{await d.fetchOneByName("SalesInvoice")});const h=e=>{var t;const o=(t=u.taxes)==null?void 0:t.find(s=>s.id===e);if(o)return`${o.name}`},v=(e,o)=>{f.require({message:`Està segur que vol eliminar la línea ${o.description}?`,icon:"pi pi-question-circle",acceptIcon:"pi pi-check",rejectIcon:"pi pi-times",accept:async()=>{w("delete",o)}})},r=(e,o)=>{if(!c.deliveryNotes)return;const t=c.deliveryNotes.find(s=>s.id===o.deliveryNoteId);t&&f.require({message:`Està segur que vol treure l'${o.deliveryNoteNumber}?`,icon:"pi pi-question-circle",acceptIcon:"pi pi-check",rejectIcon:"pi pi-times",accept:async()=>{w("deleteDeliveryNote",t)}})};return(e,o)=>{const t=b("Column"),s=b("DataTable");return _(),M(s,{class:"p-datatable-sm",tableStyle:"min-width: 100%",scrollable:"",scrollHeight:"62vh",sortMode:"single",sortField:"description",sortOrder:1,value:N.value,rowGroupMode:"subheader",groupRowsBy:"deliveryNoteNumber"},{header:y(()=>[ve(e.$slots,"header")]),groupheader:y(a=>[e.canDelete&&a.data.deliveryNoteNumber!=="Sense albarà"?(_(),S("i",{key:0,class:J([m(F).TIMES,"grid_delete_column_button"]),onClick:n=>r(n,a.data)},null,10,tt)):$("",!0),V("   "),i("span",at,g(a.data.deliveryNoteNumber),1)]),default:y(()=>[l(t,{header:"Albarà",field:"deliveryNoteNumber",style:{width:"5%"}}),l(t,{header:"",field:"",style:{width:"2%"}}),l(t,{header:"Quantitat",field:"quantity",style:{width:"10%"}}),l(t,{header:"Referència",style:{width:"15%"}},{body:y(a=>[a.data.deliveryNoteDetail?(_(),S("span",it,[l(ke,{id:a.data.deliveryNoteDetail.referenceId},null,8,["id"])])):(_(),S("span",ot,"--"))]),_:1}),l(t,{header:"Descripció",sortable:"",field:"description",style:{width:"40%"}}),l(t,{header:"Preu unitat",style:{width:"10%"}},{body:y(a=>[V(g(m(L)(a.data.unitPrice)),1)]),_:1}),l(t,{header:"Impost",style:{width:"10%"}},{body:y(a=>[V(g(h(a.data.taxId)),1)]),_:1}),l(t,{header:"Total",field:"totalCost",style:{width:"10%"}},{body:y(a=>[V(g(m(L)(a.data.amount)),1)]),_:1}),l(t,{style:{width:"10%"}},{body:y(a=>[!a.data.deliveryNoteDetailId&&e.canDelete?(_(),S("i",{key:0,class:J([m(F).TIMES,"grid_delete_column_button"]),onClick:n=>v(n,a.data)},null,10,lt)):$("",!0)]),_:1})]),_:3},8,["value"])}}}),nt={key:0},rt={class:"two-columns-7525"},ct={class:"mt-2"},dt={class:"mt-2"},ut=i("label",{class:"block text-900 mb-2"},"Impost",-1),mt={class:"three-columns"},vt={class:"mt-2"},pt={class:"mt-2"},yt={class:"mt-2"},ft=T({__name:"FormSalesInvoiceDetail",props:{invoiceDetail:{}},emits:["submit","cancel"],setup(D,{emit:w}){const c=D,f=P(),d=G(),u=()=>{const e=c.invoiceDetail;e.quantity&&e.quantity>0&&e.unitPrice&&e.unitPrice>0&&(c.invoiceDetail.unitCost=e.unitPrice,c.invoiceDetail.amount=ye.round(e.quantity*e.unitPrice,2),c.invoiceDetail.totalCost=c.invoiceDetail.amount)},N=W().shape({quantity:H().min(1).required("La quantitat ha de ser superior a 1"),unitPrice:H().min(.01).required("El preu unitat és obligatori")}),h=k({result:!1,errors:{}}),v=()=>{const e=new ee(N);h.value=e.validate(c.invoiceDetail)},r=async()=>{if(v(),h.value.result)w("submit",c.invoiceDetail);else{let e="";Object.entries(h.value.errors).forEach(o=>{e+=`${o[1].map(t=>t)}.   `}),f.add({severity:"warn",summary:"Formulari inválid",detail:e,life:5e3})}};return(e,o)=>{const t=b("Dropdown"),s=b("Button");return e.invoiceDetail?(_(),S("form",nt,[i("section",rt,[i("div",ct,[l(A,{label:"Descripció",modelValue:e.invoiceDetail.description,"onUpdate:modelValue":o[0]||(o[0]=a=>e.invoiceDetail.description=a)},null,8,["modelValue"])]),i("div",dt,[ut,l(t,{modelValue:e.invoiceDetail.taxId,"onUpdate:modelValue":o[1]||(o[1]=a=>e.invoiceDetail.taxId=a),editable:"",options:m(d).taxes,optionValue:"id",optionLabel:"name",class:"w-full"},null,8,["modelValue","options"])])]),i("section",mt,[i("div",vt,[l(A,{type:m(z).NUMERIC,label:"Quantitat",modelValue:e.invoiceDetail.quantity,"onUpdate:modelValue":[o[2]||(o[2]=a=>e.invoiceDetail.quantity=a),u]},null,8,["type","modelValue"])]),i("div",pt,[l(A,{type:m(z).CURRENCY,label:"Preu Unitat","model-value":e.invoiceDetail.unitPrice,"onUpdate:modelValue":[o[3]||(o[3]=a=>e.invoiceDetail.unitPrice=a),u]},null,8,["type","model-value"])]),i("div",yt,[l(A,{type:m(z).CURRENCY,label:"Total","model-value":e.invoiceDetail.amount,"onUpdate:modelValue":o[4]||(o[4]=a=>e.invoiceDetail.amount=a),disabled:""},null,8,["type","model-value"])])]),l(s,{label:"Crear",onClick:r,style:{float:"right"},size:"small",class:"mt-2"})])):$("",!0)}}}),bt={key:0},_t={class:"mt-2"},Dt=T({__name:"FormRectificativeInvoice",props:{rectificativeInvoice:{},maximumQuantity:{}},emits:["submit","cancel"],setup(D,{emit:w}){const c=D,f=P(),d=W().shape({quantity:H().min(1,"La quantitat ha de ser superior a 1").required("La quanitat és obligatoria")}),u=k({result:!1,errors:{}}),N=()=>{const v=new ee(d);u.value=v.validate(c.rectificativeInvoice)},h=async()=>{if(N(),u.value.result){if(c.rectificativeInvoice.quantity>c.maximumQuantity){f.add({severity:"warn",summary:"Formulari invàlid",detail:"La quanitat introduïda no pot ser superior a la quantitat de la factura",life:5e3});return}w("submit",c.rectificativeInvoice)}else{let v="";Object.entries(u.value.errors).forEach(r=>{v+=`${r[1].map(e=>e)}.   `}),f.add({severity:"warn",summary:"Formulari invàlid",detail:v,life:5e3})}};return(v,r)=>{const e=b("Button");return v.rectificativeInvoice?(_(),S("form",bt,[i("section",null,[i("div",_t,[l(A,{label:"Import a facturar sense IVA",modelValue:v.rectificativeInvoice.quantity,"onUpdate:modelValue":r[0]||(r[0]=o=>v.rectificativeInvoice.quantity=o),decimals:2,type:m(z).CURRENCY},null,8,["modelValue","type"])])]),l(e,{label:"Crear",onClick:h,style:{float:"right"},size:"small",class:"mt-2"})])):$("",!0)}}}),ht=D=>(fe("data-v-1516f95e"),D=D(),be(),D),Nt={class:"selector-filter"},It={class:"selector-filter-field"},wt=ht(()=>i("label",{for:""},"Buscar",-1)),gt={class:"selector-filter-button"},St={class:"flex align-items-center gap-2"},$t=T({__name:"SelectorDeliveryNotes",props:{deliveryNotes:{},headerVisible:{type:Boolean}},emits:["selected"],setup(D,{emit:w}){const c=D;Y(()=>{f.fetchOneByName("DeliveryNote")});const f=Q(),d=k([]),u=k(""),N=K(()=>{var r=[];return c.deliveryNotes&&(r=c.deliveryNotes.filter(e=>e.number.toString().includes(u.value))),r}),h=r=>{var o;const e=(o=f.lifecycle)==null?void 0:o.statuses.find(t=>t.id===r);return e?e.name:""},v=()=>{d.value.length!==0&&w("selected",d.value)};return(r,e)=>{const o=b("InputText"),t=b("Button"),s=b("Column"),a=b("DataTable");return _(),M(a,{class:"small-datatable",tableStyle:"min-width: 100%",scrollable:"",scrollHeight:"75vh",metaKeySelection:!1,value:N.value,selectionMode:"multiple",selection:d.value,"onUpdate:selection":e[1]||(e[1]=n=>d.value=n)},{header:y(()=>[i("header",Nt,[i("div",It,[wt,V("   "),l(o,{style:{width:"150px",height:"35px"},modelValue:u.value,"onUpdate:modelValue":e[0]||(e[0]=n=>u.value=n),size:"small"},null,8,["modelValue"])]),i("div",gt,[l(t,{onClick:v,size:"small",icon:m(F).CHECK_SQUARE},null,8,["icon"])])])]),groupheader:y(n=>[i("div",St,[i("b",null,"Albarà d'entrega "+g(n.data.salesOrderNumber)+" - "+g(m(E)(n.data.salesOrderDate)),1)])]),default:y(()=>[l(s,{header:"Número",field:"number",style:{width:"10%"}}),l(s,{header:"Estat",field:"status",style:{width:"10%"}},{body:y(n=>[V(g(h(n.data.statusId)),1)]),_:1}),l(s,{header:"Data Entrega",field:"deliveryDate",style:{width:"10%"}},{body:y(n=>[V(g(n.data.deliveryDate?m(E)(n.data.deliveryDate):""),1)]),_:1})]),_:1},8,["value","selection"])}}});const Ct=_e($t,[["__scopeId","data-v-1516f95e"]]),Vt={key:0},kt={class:"flex flex-wrap align-items-center justify-content-between gap-2"},Rt=i("span",{class:"text-xl text-900 font-bold"},"Detall de la factura",-1),zt=T({__name:"SalesInvoice",setup(D){const w=[{label:"Descarregar",icon:F.FILE_WORD,command:()=>ae()},{label:"Rectificativa",icon:F.FILE_IMPORT,command:()=>ce()}],c=De(),f=he(),d=Ne(),u=P(),N=G(),h=Ve(),v=Q(),r=Ce(),e=Re(),o=Be(),{invoice:t}=Ie(r),s={Free:0,FromDeliveryNote:1,Rectificative:2},a=k(0),n=X({visible:!1,title:"",closable:!0,position:"center",modal:!0}),B=k("");Y(async()=>{B.value=c.params.id,N.fetchMasterData(),h.fetchCustomers(),await o.fetchReferencesByModule("sales"),await x(),d.setMenuItem({icon:F.WALLET,title:`Factura de venta ${t.value.invoiceNumber} - ${t.value.customerComercialName}`,backButtonVisible:!0})});const x=async()=>{v.fetchOneByName("SalesInvoice"),await r.GetById(B.value),await e.GetByInvoiceId(B.value),t.value&&(t.value.invoiceDate=E(t.value.invoiceDate))},q=K(()=>t.value!==void 0&&t.value.parentSalesInvoiceId===null),te=async()=>{t.value&&(t.value.invoiceDate=$e(t.value.invoiceDate),await r.Update(t.value)&&f.back())},ae=async()=>{var I;const p=await qe.SalesInvoice.GetReportDataById(t.value.id);if(p){const C=`Factura_${(I=t.value)==null?void 0:I.invoiceNumber}.docx`,O=await new Ee().Download(p,Fe.Invoice,C);O?we(C,O):u.add({severity:"warn",summary:"Error",detail:"No s'ha pugut generar fulla de la comanda"})}},ie=async()=>{t.value&&(await e.GetToInvoice(t.value.customerId),a.value=s.FromDeliveryNote,n.title="Selector d'albarans d'entrega",n.visible=!0)},oe=async p=>{for(let I=0;I<p.length;I++){const C=p[I];await r.AddDeliveryNote(t.value.id,C)}n.visible=!1,x()},le=async p=>{await r.RemoveDeliveryNote(t.value.id,p),x()},R=X({}),se=()=>{var p;if(a.value=s.Free,t.value){R.salesInvoiceId=t.value.id,R.quantity=1,R.description="",R.totalCost=0;const I=(p=N.taxes)==null?void 0:p.find(C=>C.percentatge===21);I&&(R.taxId=I.id),n.title="Introducció de línea lliure",n.visible=!0}},ne=async()=>{await r.CreateInvoiceDetail(R),n.visible=!1},re=async p=>{await r.DeleteInvoiceDetail(p),r.invoice.invoiceDate=E(r.invoice.invoiceDate)},U=k(void 0),ce=()=>{U.value={id:t.value.id,quantity:0},n.visible=!0,n.title="Crear factura rectificativa",a.value=s.Rectificative},de=async()=>{if(U.value){const p=await r.CreateRectificative(U.value);p&&p.result&&p.content?(u.add({summary:"Factura rectificativa",detail:`Creada correctament amb el número ${p.content.invoiceNumber}`,severity:"success",life:1e4}),f.back()):u.add({summary:"Factura rectificativa",detail:"Error en la creació de la factura",severity:"error",life:1e4})}};return(p,I)=>{const C=b("SplitButton"),j=b("Button"),O=b("Dialog");return _(),S(Se,null,[l(C,{label:"Guardar",onClick:te,model:w,size:"small",class:"grid_add_row_button"}),m(t)?(_(),S("main",Vt,[l(et,{class:"mt-3 mr-3",invoice:m(t)},null,8,["invoice"]),l(st,{class:"mt-3",canDelete:q.value,details:m(t).salesInvoiceDetails,deliveryNotes:m(e).deliveryNotes,onDeleteDeliveryNote:le,onDelete:re},{header:y(()=>[i("div",kt,[Rt,i("div",null,[l(j,{size:"small",label:"Afegir albarà",onClick:ie,disabled:!q.value},null,8,["disabled"]),V("    "),l(j,{size:"small",label:"Afegir linia lliure",onClick:se,disabled:!q.value},null,8,["disabled"])])])]),_:1},8,["canDelete","details","deliveryNotes"])])):$("",!0),l(O,{visible:n.visible,"onUpdate:visible":I[0]||(I[0]=ue=>n.visible=ue),header:n.title,closable:n.closable,modal:n.modal,style:ge({width:a.value===s.Rectificative?"20vw":a.value===s.Free?"50vw":"60vw"}),maximizable:a.value===s.FromDeliveryNote},{default:y(()=>[a.value===s.Free?(_(),M(ft,{key:0,invoiceDetail:R,onSubmit:ne},null,8,["invoiceDetail"])):$("",!0),a.value===s.FromDeliveryNote?(_(),M(Ct,{key:1,headerVisible:!0,deliveryNotes:m(e).invoiceableDeliveryNotes,onSelected:oe},{header:y(()=>[]),_:1},8,["deliveryNotes"])):$("",!0),m(t)&&a.value===s.Rectificative&&U.value?(_(),M(Dt,{key:2,"rectificative-invoice":U.value,"maximum-quantity":m(t).baseAmount,onSubmit:de},null,8,["rectificative-invoice","maximum-quantity"])):$("",!0)]),_:1},8,["visible","header","closable","modal","style","maximizable"])],64)}}});export{zt as default};
