import{d as A,E as Y,j,C as H,r as g,h as w,k as r,a as C,c as $,e as n,i as a,s as P,z as U,n as z,l as Q,D as De,p as we,b as Ie,f as Z,g as ee,v as te,X as ae,o as se,S as oe,m as le,w as y,Q as Re,H as x,G as k,I as O,R as J,P as q,u as Se,x as ge,K as Ve,F as T,Y as Ce,J as K}from"./index-40c5ef33.js";import{u as G}from"./order-0974908f.js";import{u as re}from"./suppliers-5bbc9516.js";import{_ as ie}from"./DropdownLifecycle.vue_vue_type_script_setup_true_lang-7206f397.js";import{c as ne,a as L,F as de,d as Ee}from"./form-validator-dd91bd90.js";import{L as xe}from"./LinkReference-3223c329.js";import{u as ce}from"./reference-00b1433c.js";import{_ as Oe}from"./DropdownReference.vue_vue_type_script_setup_true_lang-4bba6c39.js";import{E as ue}from"./index-5e1e719e.js";import{R as ke}from"./index-7cbe1881.js";import{u as Te}from"./lifecycle-d45e6b06.js";import{u as $e}from"./referenceType-69377b31.js";import{a as Fe,b as Be}from"./report.service-fa355f8a.js";import"./suppliers.service-3db6483c.js";const W=D=>(we("data-v-aed0ba68"),D=D(),Ie(),D),Ne={key:0},Pe={class:"three-columns"},Ue={class:"mt-1"},qe={class:"mt-1"},Le=W(()=>n("label",{class:"block text-900 mb-2"},"Exercici",-1)),Ae={class:"mt-1"},Qe=W(()=>n("label",{class:"block text-900 mb-2"},"Data Comanda",-1)),Me={class:"three-columns"},ze={class:"mt-1"},je={class:"mt-1"},Ge=W(()=>n("label",{class:"block text-900 mb-2"},"Proveïdor",-1)),We=A({__name:"FormOrder",emits:["submit","cancel"],setup(D,{expose:I,emit:p}){const V=G(),R=re(),_=Y(),b=j(),{order:m}=H(V),v=ne().shape({supplierId:L().required("El client es obligatori"),statusId:L().required("L'estat es obligatori"),exerciseId:L().required("L'exercici es obligatori")}),f=g({result:!1,errors:{}}),S=()=>{const e=new de(v);f.value=e.validate(m.value)};return I({submitForm:async()=>{if(S(),f.value.result)m.value.date=De(m.value.date),p("submit",m.value);else{let e="";Object.entries(f.value.errors).forEach(c=>{e+=`${c[1].map(i=>i)}.   `}),b.add({severity:"warn",summary:"Formulari inválid",detail:e,life:5e3})}}}),(e,c)=>{const i=w("Dropdown"),s=w("Calendar");return r(m)?(C(),$("form",Ne,[n("section",Pe,[n("div",Ue,[a(U,{type:r(P).TEXT,label:"Número",id:"number",modelValue:r(m).number,"onUpdate:modelValue":c[0]||(c[0]=o=>r(m).number=o),disabled:""},null,8,["type","modelValue"])]),n("div",qe,[Le,a(i,{modelValue:r(m).exerciseId,"onUpdate:modelValue":c[1]||(c[1]=o=>r(m).exerciseId=o),editable:"",options:r(_).exercises,optionValue:"id",optionLabel:"name",class:z(["w-full",{"p-invalid":f.value.errors.exerciseId}])},null,8,["modelValue","options","class"])]),n("div",Ae,[Qe,a(s,{modelValue:r(m).date,"onUpdate:modelValue":c[2]||(c[2]=o=>r(m).date=o),dateFormat:"dd/mm/yy"},null,8,["modelValue"])])]),n("section",Me,[n("div",ze,[a(ie,{label:"Estat",name:"PurchaseOrder",modelValue:r(m).statusId,"onUpdate:modelValue":c[3]||(c[3]=o=>r(m).statusId=o)},null,8,["modelValue"])]),n("div",je,[Ge,a(i,{modelValue:r(m).supplierId,"onUpdate:modelValue":c[4]||(c[4]=o=>r(m).supplierId=o),editable:"",options:r(R).suppliers,optionValue:"id",optionLabel:"comercialName",class:z(["w-full",{"p-invalid":f.value.errors.customerId}])},null,8,["modelValue","options","class"])])])])):Q("",!0)}}});const Xe=Z(We,[["__scopeId","data-v-aed0ba68"]]),Je=["onClick"],Ke={class:"expanded-details"},Ye=["onClick"],He=A({__name:"TableOrderDetails",props:{details:{}},emits:["edit","delete"],setup(D,{emit:I}){const p=D,V=ee(),R=te(),_=G(),b=g(void 0),m=g({}),v=g([]);ce(),ae(()=>{var i;return(i=p.details)==null?void 0:i.length},async i=>{i&&await f()}),se(async()=>{await _.getReceptions(R.params.id),_.receptions&&(await f(),b.value=await oe.Lifecycle.getByName("PurchaseOrderDetail"))});const f=async()=>{var i;v.value=((i=p.details)==null?void 0:i.map(s=>{var o;return{...s,receptions:(o=_.receptions)==null?void 0:o.filter(E=>E.purchaseOrderDetailId===s.id)}}))||[]},S=i=>{if(!b.value)return"";const s=b.value.statuses.find(o=>o.id===i);return s?s.name:""},t=i=>{try{i.originalEvent.target.className.includes("grid_delete_column_button")||I("edit",i.data)}catch{}},e=(i,s)=>{I("delete",s)},c=i=>{const s=`/receipts/${i}`;V.push(s)};return(i,s)=>{const o=w("Column"),E=w("DataTable");return C(),le(E,{onRowClick:t,value:v.value,tableStyle:"min-width: 100%",class:"p-datatable-sm","sort-mode":"single","sort-field":"reference.code","sort-order":1,dataKey:"id",expandedRows:m.value,"onUpdate:expandedRows":s[0]||(s[0]=l=>m.value=l)},{header:y(()=>[Re(i.$slots,"header",{},void 0,!0)]),expansion:y(({data:l})=>[n("div",Ke,[a(E,{value:l.receptions},{default:y(()=>[a(o,{field:"receiptDetail.receipt.number",header:"Albarà"},{body:y(({data:h})=>[n("span",{class:"link",onClick:F=>c(h.receiptDetail.receipt.id)},x(h.receiptDetail.receipt.number),9,Ye)]),_:2},1024),a(o,{field:"quantity",header:"Quantitat"}),a(o,{field:"createdOn",header:"Data"},{body:y(({data:h})=>[k(x(r(O)(h.createdOn)),1)]),_:2},1024),a(o,{field:"user",header:"Usuari"})]),_:2},1032,["value"])])]),default:y(()=>[a(o,{expander:"",style:{width:"2%"}}),a(o,{field:"quantity",header:"Quantitat",style:{width:"5%"}}),a(o,{field:"receivedQuantity",header:"Q. Rebuda",style:{width:"6%"}}),a(o,{field:"reference.code",sortable:"",header:"Referència",style:{width:"20%"}},{body:y(({data:l})=>[a(xe,{id:l.referenceId,category:l.reference.categoryName,fullName:!0},null,8,["id","category"])]),_:1}),a(o,{field:"description",header:"Descripció",style:{width:"25%"}}),a(o,{field:"statusId",header:"Estat",style:{width:"7.5%"}},{body:y(({data:l})=>[k(x(S(l.statusId)),1)]),_:1}),a(o,{field:"expectedReceiptDate",header:"Data Recepció",style:{width:"7.5%"}},{body:y(({data:l})=>[k(x(r(O)(l.expectedReceiptDate)),1)]),_:1}),a(o,{field:"unitPrice",header:"Preu Un.",style:{width:"5%"}},{body:y(({data:l})=>[k(x(r(J)(l.unitPrice)),1)]),_:1}),a(o,{field:"amount",header:"Preu",style:{width:"5%"}},{body:y(({data:l})=>[k(x(r(J)(l.amount)),1)]),_:1}),a(o,{style:{width:"5%"}},{body:y(({data:l})=>[l.receivedQuantity===0?(C(),$("i",{key:0,class:z([r(q).TIMES,"grid_delete_column_button"]),onClick:h=>e(h,l)},null,10,Je)):Q("",!0)]),_:1})]),_:3},8,["value","expandedRows"])}}});const Ze=Z(He,[["__scopeId","data-v-ce42cd3d"]]),et={key:0},tt={class:"three-columns"},at=n("label",{class:"block text-900 mb-2"},"Data prevista",-1),st={class:"three-columns mt-2"},ot=A({__name:"FormOrderDetail",props:{detail:{},order:{}},emits:["submit","cancel"],setup(D,{emit:I}){const p=D,V=j(),R=ne().shape({quantity:Ee().min(1).required("La quantitat ha de ser superior a 1"),referenceId:L().required("La referencia és obligatoria")}),_=g({result:!1,errors:{}}),b=()=>{const t=new de(R);_.value=t.validate(p.detail)};ae(()=>p.detail.quantity,async t=>{t&&f()});const m=async t=>{if(!(t==null||p.order.supplierId=="")){var e=await ue.Supplier.getSupplierReferenceBySupplierIdAndReferenceId(p.order.supplierId,t);if(e)p.detail.unitPrice=e.supplierPrice,p.detail.expectedReceiptDate=v(e.supplyDays),p.detail.description=e.supplierDescription;else{const c=await oe.Reference.getById(t);c&&(p.detail.unitPrice=c.price,p.detail.description=c.description)}f()}};function v(t){let e=new Date;return e.setDate(e.getDate()+t),e}const f=()=>{p.detail.amount=p.detail.quantity*p.detail.unitPrice},S=async()=>{if(b(),_.value.result)I("submit",p.detail);else{let t="";Object.entries(_.value.errors).forEach(e=>{t+=`${e[1].map(c=>c)}.   `}),V.add({severity:"warn",summary:"Formulari inválid",detail:t,life:5e3})}};return(t,e)=>{const c=w("Calendar"),i=w("Button");return t.detail?(C(),$("form",et,[n("section",tt,[n("div",null,[a(Oe,{label:"Referència de compra",modelValue:t.detail.referenceId,"onUpdate:modelValue":[e[0]||(e[0]=s=>t.detail.referenceId=s),m],fullName:!0,disabled:t.detail.receivedQuantity>0},null,8,["modelValue","disabled"])]),n("div",null,[a(ie,{label:"Estat",name:"PurchaseOrderDetail",modelValue:t.detail.statusId,"onUpdate:modelValue":e[1]||(e[1]=s=>t.detail.statusId=s)},null,8,["modelValue"])]),n("div",null,[at,a(c,{label:"Data prevista",modelValue:t.detail.expectedReceiptDate,"onUpdate:modelValue":e[2]||(e[2]=s=>t.detail.expectedReceiptDate=s),dateFormat:"dd/mm/yy"},null,8,["modelValue"])])]),n("section",null,[n("div",null,[a(U,{type:r(P).TEXT,label:"Descripció",id:"description",modelValue:t.detail.description,"onUpdate:modelValue":e[3]||(e[3]=s=>t.detail.description=s)},null,8,["type","modelValue"])])]),n("section",st,[n("div",null,[a(U,{disabled:t.detail.receivedQuantity>0,type:r(P).NUMERIC,label:"Quantitat",modelValue:t.detail.quantity,"onUpdate:modelValue":e[4]||(e[4]=s=>t.detail.quantity=s),onInput:f},null,8,["disabled","type","modelValue"])]),n("div",null,[a(U,{type:r(P).CURRENCY,label:"Preu",modelValue:t.detail.amount,"onUpdate:modelValue":e[5]||(e[5]=s=>t.detail.amount=s),disabled:t.detail.receivedQuantity>0},null,8,["type","modelValue","disabled"])])]),a(i,{label:"Crear",onClick:S,style:{float:"right"},size:"small",class:"mt-2"})])):Q("",!0)}}}),lt={key:0},rt=n("br",null,null,-1),it={class:"flex flex-wrap align-items-center justify-content-between gap-2"},nt=n("span",{class:"text-xl text-900 font-bold"},"Detall de la comanda",-1),dt={key:1},St=A({__name:"Order",setup(D){const I=ee(),p=te(),V=Se(),R=g(),_=ge(),b=ce(),m=$e(),v=G(),f=re(),S=Y(),t=Te(),{order:e}=H(v),c=[{label:"Descarregar",icon:q.FILE_WORD,command:()=>_e()}],i=async()=>{var d;await v.fetchOne(p.params.id),t.lifecycle||t.fetchOneByName("PurchaseOrder"),S.exercises||S.fetchActive(),f.suppliers||f.fetchSuppliers(),m.referenceTypes||m.fetchActive(),(!b.references||b.module!=="purchase")&&b.fetchReferencesByModule("purchase"),e.value&&(e.value.date=O(e.value.date)),V.setMenuItem({icon:q.BUILDING,title:`Comanda de compra ${(d=e.value)==null?void 0:d.number}`,backButtonVisible:!0})};se(async()=>{await i()});const s=j(),o=async()=>{var u;if(!((u=e.value)!=null&&u.date))return s.add({severity:"error",summary:"Error al crear la comanda ",detail:"La data no pot estar buida",life:5e3}),!1;R.value.submitForm()},E=async()=>{let d=!1,u="";e.value&&(d=await v.update(e.value.id,e.value),u="Comanda actualizada correctament",d&&(s.add({severity:"success",summary:u,life:5e3}),I.back()))},l=Ve({visible:!1,title:"Linea",closable:!0,position:"center",modal:!0}),h=g(T.CREATE),F=g({}),me=()=>{h.value=T.CREATE,F.value={id:K(),purchaseOrderId:e.value.id,amount:0,unitPrice:0,quantity:0,receivedQuantity:0,referenceId:"",statusId:"",expectedReceiptDate:null,workOrderPhaseId:null,disabled:!1},l.title="Crear línia",l.visible=!0},pe=d=>{h.value=T.EDIT,F.value=d,b.setNewReference(K(),ke.MATERIAL),l.title="Modificar línia",l.visible=!0},fe=async d=>{var u;h.value===T.CREATE?await ve(d):h.value===T.EDIT&&await ye(d),l.visible=!1,await v.fetchOne(p.params.id),console.log((u=e.value)==null?void 0:u.details)},ve=async d=>{const u=await v.createDetail(d);e.value.date=O(e.value.date),u.result||M(u)},ye=async d=>{const u=await v.updateDetail(d.id,d);e.value.date=O(e.value.date),u.result||M(u)},be=async d=>{_.require({message:"Está segur que vols la línia?",icon:"pi pi-question-circle",acceptIcon:"pi pi-check",rejectIcon:"pi pi-times",accept:async()=>{const u=await v.deleteDetail(d.id,d);console.log(u),e.value.date=O(e.value.date),u.result||M(u)}})},M=d=>{s.add({severity:"error",summary:d.errors[0],life:1e4,closable:!0})},_e=async()=>{var u;const d=await ue.Order.GetReportDataById(e.value.id);if(d){const B=`ComandaCompra_${(u=e.value)==null?void 0:u.number}.docx`,N=await new Be().Download(d,Fe.PurchaseOrder,B);N?Ce(B,N):s.add({severity:"warn",summary:"Error",detail:"No s'ha pugut generar fulla de la comanda"})}};return(d,u)=>{const B=w("SplitButton"),X=w("Button"),N=w("Dialog");return r(e)?(C(),$("main",lt,[a(B,{label:"Guardar",onClick:o,model:c,size:"small",class:"grid_add_row_button"}),a(Xe,{class:"pt-3",ref_key:"orderForm",ref:R,onSubmit:E},null,512),rt,r(e).details?(C(),le(Ze,{key:0,details:r(e).details,onEdit:pe,onDelete:be},{header:y(()=>[n("div",it,[nt,n("div",null,[a(X,{size:"small",icon:r(q).PLUS,rounded:"",onClick:me},null,8,["icon"])])])]),_:1},8,["details"])):Q("",!0),a(N,{visible:l.visible,"onUpdate:visible":u[0]||(u[0]=he=>l.visible=he),header:l.title,closable:l.closable,modal:l.modal},{default:y(()=>[a(ot,{detail:F.value,order:r(e),onSubmit:fe},null,8,["detail","order"])]),_:1},8,["visible","header","closable","modal"])])):(C(),$("main",dt,"Carregant comanda ..."))}}});export{St as default};
