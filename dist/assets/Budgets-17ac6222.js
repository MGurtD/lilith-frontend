import{_ as z}from"./ExerciseDatePicker.vue_vue_type_script_setup_true_lang-85651d01.js";import{_ as J}from"./FormCreateOrderOrInvoice.vue_vue_type_script_setup_true_lang-08d8d214.js";import{_ as K}from"./DropdownCustomers.vue_vue_type_script_setup_true_lang-f727f1c5.js";import{_ as Q}from"./DropdownLifecycle.vue_vue_type_script_setup_true_lang-fe833678.js";import{d as W,g as X,j as Z,x as ee,u as te,$ as se,E as ae,r as k,K as ie,o as re,P as p,a0 as oe,O as F,h as b,c as E,i as a,w as d,k as l,L as ce,a as N,e as n,G as g,H as y,I as R,n as le,l as de,J as ne}from"./index-eea64e26.js";import{u as ue}from"./reference-0201b480.js";import{u as me}from"./customers-6978df67.js";import{u as fe}from"./lifecycle-f4be269e.js";import{u as pe}from"./budget-0789f6f5.js";import"./form-validator-9374e474.js";import"./index-3deb466b.js";const ve={class:"flex flex-wrap align-items-center justify-content-between gap-2"},_e={class:"datatable-filter-3"},be={class:"filter-field"},ge={class:"filter-field"},ye=n("label",{class:"block text-900"},"Client",-1),xe={class:"filter-field"},he=n("label",{class:"block text-900"},"Estat",-1),Ie={class:"datatable-buttons"},we=["onClick"],Ue=W({__name:"Budgets",setup(ke){const S=X(),x=Z(),V=ee(),c=te(),C=se(),h=ae(),u=pe(),T=ue(),D=me(),I=fe(),i=k({customerId:void 0,statusId:void 0}),m=ie({visible:!1,title:"Crear pressupost",closable:!0,position:"center",modal:!0}),v=k(void 0);re(async()=>{I.fetchOneByName("Budget"),T.fetchReferences(),D.fetchCustomers(),await h.fetchActive(),P(),U(),await f(),c.setMenuItem({icon:p.APPLE,title:"Pressupostos"})}),oe(()=>{const e={statusId:i.value.statusId,customerId:i.value.customerId,exercisePicker:c.exercisePicker};C.addFilter("Budgets","",e)});const U=()=>{const e=C.getFilter("Budgets","");e&&(i.value.statusId=e.statusId,i.value.customerId=e.customerId,e.exercisePicker&&(c.exercisePicker.exercise=e.exercisePicker.exercise,c.exercisePicker.dates=[new Date(e.exercisePicker.dates[0]),new Date(e.exercisePicker.dates[1])]))},P=()=>{var t;const e=new Date().getFullYear().toString();v.value=(t=h.exercises)==null?void 0:t.find(r=>r.name===e),v.value&&(c.exercisePicker.exercise=v.value,c.exercisePicker.dates=[new Date(c.exercisePicker.exercise.startDate),new Date(c.exercisePicker.exercise.endDate)])},$=()=>{i.value.customerId=void 0,i.value.statusId=void 0,P(),f()},_=k({}),q=()=>{var e;return{id:ne(),customerId:"",exerciseId:((e=v.value)==null?void 0:e.id)||"",date:new Date}},L=()=>{_.value=q(),m.visible=!0},f=async()=>{if(c.exercisePicker.dates){const e=F(c.exercisePicker.dates[0]),t=F(c.exercisePicker.dates[1]);await u.GetFiltered(e,t,i.value.customerId,i.value.statusId)}else x.add({severity:"info",summary:"Filtre invàlid",detail:"Seleccioni un període",life:5e3})},O=e=>{var r,o;const t=(o=(r=I.lifecycle)==null?void 0:r.statuses)==null?void 0:o.find(w=>w.id===e);return t?t.name:""},A=e=>{var r;const t=(r=D.customers)==null?void 0:r.find(o=>o.id===e);return t?t.comercialName:""},j=async()=>{m.visible=!1,await u.Create(_.value)&&S.push({path:`/budget/${_.value.id}`})},G=e=>{e.originalEvent.target.className.includes("grid_delete_column_button")||S.push({path:`/budget/${e.data.id}`})},H=async(e,t)=>{if(await u.GetAssociatedSalesOrders(t.id),u.order){x.add({severity:"warn",summary:"No es pot eliminar",detail:`El pressupost té la comanda ${u.order.number} associada`,life:5e3});return}V.require({message:"Està segur que vol eliminar el pressupost?",icon:"pi pi-question-circle",acceptIcon:"pi pi-check",rejectIcon:"pi pi-times",accept:async()=>{await u.Delete(t.id)&&(x.add({severity:"success",summary:"Eliminada",life:3e3}),await f())}})};return(e,t)=>{const r=b("Button"),o=b("Column"),w=b("DataTable"),M=b("Dialog");return N(),E(ce,null,[a(w,{value:l(u).budgets,class:"small-datatable",tableStyle:"min-width: 100%","sort-field":"salesOrderNumber","sort-mode":"single","sort-order":1,scrollable:"",scrollHeight:"80vh",paginator:"",rows:12,onRowClick:G},{header:d(()=>[n("div",ve,[n("div",_e,[n("div",be,[a(z,{exercises:l(h).exercises,onRangeSelected:f},null,8,["exercises"])]),n("div",ge,[ye,a(K,{label:"",modelValue:i.value.customerId,"onUpdate:modelValue":t[0]||(t[0]=s=>i.value.customerId=s)},null,8,["modelValue"])]),n("div",xe,[he,a(Q,{label:"",name:"Budget",modelValue:i.value.statusId,"onUpdate:modelValue":t[1]||(t[1]=s=>i.value.statusId=s)},null,8,["modelValue"])])]),n("div",Ie,[a(r,{class:"datatable-button mr-2",icon:l(p).FILTER,rounded:"",raised:"",onClick:f},null,8,["icon"]),a(r,{class:"datatable-button mr-2",icon:l(p).FILTER_SLASH,rounded:"",raised:"",onClick:$},null,8,["icon"]),a(r,{icon:l(p).PLUS,rounded:"",raised:"",onClick:L},null,8,["icon"])])])]),default:d(()=>[a(o,{field:"number",header:"Número",style:{width:"10%"}}),a(o,{field:"date",header:"Data",style:{width:"15%"},sortable:""},{body:d(s=>[g(y(l(R)(s.data.date)),1)]),_:1}),a(o,{header:"Client",style:{width:"20%"}},{body:d(s=>[g(y(A(s.data.customerId)),1)]),_:1}),a(o,{header:"Estat",style:{width:"20%"}},{body:d(s=>[g(y(O(s.data.statusId)),1)]),_:1}),a(o,{field:"acceptanceDate",header:"Data d'acceptació",style:{width:"15%"}},{body:d(s=>[g(y(s.data.acceptanceDate?l(R)(s.data.acceptanceDate):""),1)]),_:1}),a(o,{field:"deliveryDays",header:"Dies d'entrega",style:{width:"10%"}}),a(o,{style:{width:"5%"}},{body:d(s=>{var B;return[s.data.statusId===((B=l(I).lifecycle)==null?void 0:B.initialStatusId)?(N(),E("i",{key:0,class:le([l(p).TIMES,"grid_delete_column_button"]),onClick:Y=>H(Y,s.data)},null,10,we)):de("",!0)]}),_:1})]),_:1},8,["value"]),a(M,{visible:m.visible,"onUpdate:visible":t[2]||(t[2]=s=>m.visible=s),header:m.title,closable:m.closable,modal:m.modal},{default:d(()=>[a(J,{"create-request":_.value,onSubmit:j},null,8,["create-request"])]),_:1},8,["visible","header","closable","modal"])],64)}}});export{Ue as default};
