import{d as P,j as W,C as ie,o as J,r as E,h as g,a as N,c as A,i as e,k as o,e as n,s as I,z as S,n as Q,l as j,D as ge,p as oe,b as ne,f as re,m as X,w as p,Q as we,G as $,H as F,R as Ve,P as Y,u as de,T as ue,I as M,J as L,x as Re,v as Ie,K as se,F as B,V as Se}from"./index-d6370003.js";import{u as Z}from"./receipt-46c5631f.js";import{u as Ce}from"./suppliers-e4e00d13.js";import{u as ce}from"./lifecycle-17b09274.js";import{c as me,a as z,F as pe,d as De}from"./form-validator-76860c5e.js";import{u as Te}from"./masterData-695403e4.js";import{L as ke}from"./LinkReference-043355b9.js";import{_ as Ee}from"./DropdownReference.vue_vue_type_script_setup_true_lang-aecf6c90.js";import{u as ee}from"./reference-350638b3.js";import{_ as Ne}from"./FormMaterial.vue_vue_type_script_setup_true_lang-3e081322.js";import{R as H}from"./index-7cbe1881.js";import{u as Ue}from"./order-ad7ba801.js";import{u as xe}from"./referenceType-a20938e8.js";import"./index-922047d1.js";import"./suppliers.service-e0a4aeb3.js";import"./DropdownReferenceType.vue_vue_type_script_setup_true_lang-fe181237.js";import"./tax-fc3b08e2.js";import"./plantmodel-07cd1012.js";import"./index-882a7cd4.js";const q=h=>(oe("data-v-70931d13"),h=h(),ne(),h),Fe=q(()=>n("br",null,null,-1)),$e={key:0},Ae={class:"three-columns"},Oe={class:"mt-1"},Be={class:"mt-1"},Me=q(()=>n("label",{class:"block text-900 mb-2"},"Exercici",-1)),Le={class:"mt-1"},Pe=q(()=>n("label",{class:"block text-900 mb-2"},"Data Albarà",-1)),qe={class:"three-columns"},Qe={class:"mt-1"},ze=q(()=>n("label",{class:"block text-900 mb-2"},"Estat",-1)),We={class:"mt-1"},je=q(()=>n("label",{class:"block text-900 mb-2"},"Proveïdor",-1)),Ge={class:"mt-1"},Ke=P({__name:"FormReceipt",emits:["submit","cancel"],setup(h,{expose:C,emit:f}){const D=Z(),v=Ce(),_=Te(),c=ce(),m=W(),{receipt:r}=ie(D);J(async()=>{await _.fetchMasterData(),await v.fetchSuppliers(),await c.fetchOneByName("Receipts")});const s=me().shape({supplierId:z().required("El client es obligatori"),statusId:z().required("L'estat es obligatori"),exerciseId:z().required("L'exercici es obligatori")}),b=E({result:!1,errors:{}}),x=()=>{const l=new pe(s);b.value=l.validate(r.value)},t=async()=>{if(x(),b.value.result)r.value.date=ge(r.value.date),f("submit",r.value);else{let l="";Object.entries(b.value.errors).forEach(i=>{l+=`${i[1].map(a=>a)}.   `}),m.add({severity:"warn",summary:"Formulari inválid",detail:l,life:5e3})}};return C({submitForm:t}),(l,i)=>{var k;const a=g("Button"),w=g("Dropdown"),V=g("Calendar");return N(),A("div",null,[e(a,{label:"Guardar",size:"small",class:"grid_add_row_button",onClick:t}),Fe,o(r)?(N(),A("form",$e,[n("section",Ae,[n("div",Oe,[e(S,{type:o(I).TEXT,label:"Número",id:"number",modelValue:o(r).number,"onUpdate:modelValue":i[0]||(i[0]=y=>o(r).number=y),disabled:""},null,8,["type","modelValue"])]),n("div",Be,[Me,e(w,{modelValue:o(r).exerciseId,"onUpdate:modelValue":i[1]||(i[1]=y=>o(r).exerciseId=y),editable:"",options:o(_).exercises,optionValue:"id",optionLabel:"name",class:Q(["w-full",{"p-invalid":b.value.errors.exerciseId}])},null,8,["modelValue","options","class"])]),n("div",Le,[Pe,e(V,{modelValue:o(r).date,"onUpdate:modelValue":i[2]||(i[2]=y=>o(r).date=y),dateFormat:"dd/mm/yy"},null,8,["modelValue"])])]),n("section",qe,[n("div",Qe,[ze,e(w,{modelValue:o(r).statusId,"onUpdate:modelValue":i[3]||(i[3]=y=>o(r).statusId=y),editable:"",options:(k=o(c).lifecycle)==null?void 0:k.statuses,optionValue:"id",optionLabel:"name",class:Q(["w-full",{"p-invalid":b.value.errors.statusId}])},null,8,["modelValue","options","class"])]),n("div",We,[je,e(w,{modelValue:o(r).supplierId,"onUpdate:modelValue":i[4]||(i[4]=y=>o(r).supplierId=y),editable:"",options:o(v).suppliers,optionValue:"id",optionLabel:"comercialName",class:Q(["w-full",{"p-invalid":b.value.errors.customerId}])},null,8,["modelValue","options","class"])]),n("div",Ge,[e(S,{type:o(I).TEXT,label:"Número Albarà",id:"supplierNumber",modelValue:o(r).supplierNumber,"onUpdate:modelValue":i[5]||(i[5]=y=>o(r).supplierNumber=y)},null,8,["type","modelValue"])])])])):j("",!0)])}}});const He=re(Ke,[["__scopeId","data-v-70931d13"]]),Je=["onClick"],Xe=P({__name:"TableReceiptDetails",props:{details:{}},emits:["edit","delete"],setup(h,{emit:C}){const f=h,D=_=>{_.originalEvent.target.className.includes("grid_delete_column_button")||C("edit",_.data)},v=(_,c)=>{C("delete",c)};return(_,c)=>{const m=g("Column"),r=g("DataTable");return N(),X(r,{onRowClick:D,value:f.details,tableStyle:"min-width: 100%",class:"p-datatable-sm","sort-mode":"single","sort-field":"reference.code","sort-order":1},{header:p(()=>[we(_.$slots,"header")]),default:p(()=>[e(m,{field:"quantity",header:"Quantitat",style:{width:"7.5%"}}),e(m,{sortable:"",header:"Material",field:"reference.code",style:{width:"25%"}},{body:p(({data:s})=>[e(ke,{id:s.referenceId,"full-name":!0},null,8,["id"])]),_:1}),e(m,{field:"width",header:"Amplada",style:{width:"7.5%"}}),e(m,{field:"height",header:"Alçada",style:{width:"7.5%"}}),e(m,{field:"lenght",header:"Longitud",style:{width:"7.5%"}}),e(m,{field:"thickness",header:"Gruix",style:{width:"7.5%"}}),e(m,{field:"diameter",header:"Diàmetre",style:{width:"7.5%"}}),e(m,{field:"totalWeight",header:"Pes",style:{width:"7.5%"}},{body:p(s=>[$(F(s.data.totalWeight)+" KG",1)]),_:1}),e(m,{field:"amount",header:"Preu",style:{width:"7.5%"}},{body:p(s=>[$(F(o(Ve)(s.data.amount)),1)]),_:1}),e(m,{style:{width:"5%"}},{body:p(s=>[s.data.stockMovementId===null?(N(),A("i",{key:0,class:Q([o(Y).TIMES,"grid_delete_column_button"]),onClick:b=>v(b,s.data)},null,10,Je)):j("",!0)]),_:1})]),_:3},8,["value"])}}}),Ye={key:0},Ze={class:"two-columns-7525"},et={class:"three-columns mt-2"},tt={class:"three-columns mt-2"},lt={class:"two-columns mt-2"},at=P({__name:"FormReceiptDetail",props:{detail:{},receipt:{}},emits:["submit","cancel"],setup(h,{emit:C}){const f=h,D=W(),v=Z(),_=ee(),c=async t=>{if(t==null||f.receipt.supplierId=="")return;const l=await _.getPrice(t,f.receipt.supplierId);f.detail.kilogramPrice=l},m=async()=>{const t=await v.calculateDetailWeightAndPrice(f.detail);t.result?(f.detail.unitWeight=t.content.unitWeight,f.detail.totalWeight=t.content.totalWeight,f.detail.unitPrice=t.content.unitPrice,f.detail.amount=t.content.amount):D.add({summary:"Calculadora de pes/preu",detail:t.errors[0],severity:"warn",life:6e3})},r=me().shape({quantity:De().min(1).required("La quantitat ha de ser superior a 1"),referenceId:z().required("La referencia és obligatoria")}),s=E({result:!1,errors:{}}),b=()=>{const t=new pe(r);s.value=t.validate(f.detail)},x=async()=>{if(b(),s.value.result)C("submit",f.detail);else{let t="";Object.entries(s.value.errors).forEach(l=>{t+=`${l[1].map(i=>i)}.   `}),D.add({severity:"warn",summary:"Formulari inválid",detail:t,life:5e3})}};return(t,l)=>{const i=g("Button");return t.detail?(N(),A("form",Ye,[n("section",Ze,[n("div",null,[e(Ee,{label:"Material",modelValue:t.detail.referenceId,"onUpdate:modelValue":[l[0]||(l[0]=a=>t.detail.referenceId=a),c],fullName:!0},null,8,["modelValue"])]),n("div",null,[e(S,{type:o(I).CURRENCY,label:"Preu / Kilo",highlightOnFocus:"",modelValue:t.detail.kilogramPrice,"onUpdate:modelValue":l[1]||(l[1]=a=>t.detail.kilogramPrice=a)},null,8,["type","modelValue"])])]),n("section",et,[n("div",null,[e(S,{type:o(I).NUMERIC,highlightOnFocus:"",label:"Amplada (mm)",decimals:2,modelValue:t.detail.width,"onUpdate:modelValue":l[2]||(l[2]=a=>t.detail.width=a)},null,8,["type","modelValue"])]),n("div",null,[e(S,{type:o(I).NUMERIC,decimals:2,label:"Alçada (mm)",highlightOnFocus:"",modelValue:t.detail.height,"onUpdate:modelValue":l[3]||(l[3]=a=>t.detail.height=a)},null,8,["type","modelValue"])]),n("div",null,[e(S,{type:o(I).NUMERIC,decimals:2,label:"Longitud (mm)",highlightOnFocus:"",modelValue:t.detail.lenght,"onUpdate:modelValue":l[4]||(l[4]=a=>t.detail.lenght=a)},null,8,["type","modelValue"])])]),n("section",tt,[n("div",null,[e(S,{type:o(I).NUMERIC,decimals:2,label:"Diàmetre (mm)",highlightOnFocus:"",modelValue:t.detail.diameter,"onUpdate:modelValue":l[5]||(l[5]=a=>t.detail.diameter=a)},null,8,["type","modelValue"])]),n("div",null,[e(S,{type:o(I).NUMERIC,decimals:2,label:"Gruix (mm)",highlightOnFocus:"",modelValue:t.detail.thickness,"onUpdate:modelValue":l[6]||(l[6]=a=>t.detail.thickness=a)},null,8,["type","modelValue"])]),n("div",null,[e(S,{type:o(I).NUMERIC,decimals:2,label:"Pes (kg)",modelValue:t.detail.totalWeight,"onUpdate:modelValue":l[7]||(l[7]=a=>t.detail.totalWeight=a)},null,8,["type","modelValue"])])]),n("section",lt,[n("div",null,[e(S,{type:o(I).NUMERIC,label:"Quantitat",highlightOnFocus:"",modelValue:t.detail.quantity,"onUpdate:modelValue":l[8]||(l[8]=a=>t.detail.quantity=a)},null,8,["type","modelValue"])]),n("div",null,[e(S,{type:o(I).CURRENCY,label:"Preu",modelValue:t.detail.amount,"onUpdate:modelValue":l[9]||(l[9]=a=>t.detail.amount=a)},null,8,["type","modelValue"])])]),e(i,{label:"Crear",onClick:x,style:{float:"right"},size:"small",class:"mt-2"}),e(i,{label:"Calcular",onClick:m,style:{float:"right"},size:"small",class:"mt-2 mr-2"})])):j("",!0)}}}),st=h=>(oe("data-v-23245ad9"),h=h(),ne(),h),it={class:"selector-filter"},ot={class:"selector-filter-field"},nt=st(()=>n("label",{for:""},"Buscar",-1)),rt=P({__name:"SelectorOrdersDetailsToReceipt",props:{receipt:{},orders:{}},emits:["selected"],setup(h,{emit:C}){const f=h,D=W(),v=de(),_=ee(),c=E([]),m=E({}),r=E(""),s=E([]),b=ue(()=>{var l=[];return c.value&&(l=c.value.filter(i=>i.details.some(a=>_.getFullNameById(a.referenceId).includes(r.value.toLowerCase())))),l}),x=()=>{m.value=c.value.reduce((l,i)=>(l[i.id]=!0,l),{})};J(()=>{if(!f.orders){console.error("No orders to show");return}c.value=f.orders.map(l=>({...l,details:l.details.map(i=>({...i,pendingQuantity:i.quantity-i.receivedQuantity}))})),x()});const t=()=>{if(s.value.length===0){D.add({severity:"warn",summary:"Selecció inválida",detail:"Selecciona alguna línia per afegir-la a l'albarà",life:6e3});return}const l={receiptId:f.receipt.id,receptions:s.value.map(i=>{var a;return{receiptDetailId:L(),purchaseOrderDetailId:i.id,quantity:i.pendingQuantity,user:(a=v.user)==null?void 0:a.username}})};C("selected",l)};return(l,i)=>{const a=g("InputText"),w=g("Button"),V=g("Column"),k=g("InputNumber"),y=g("DataTable");return N(),X(y,{class:"p-datatable-sm",tableStyle:"min-width: 100%",scrollable:"",scrollHeight:"75vh",dataKey:"id",expandedRows:m.value,"onUpdate:expandedRows":i[2]||(i[2]=T=>m.value=T),value:b.value},{header:p(()=>[n("header",it,[n("div",ot,[nt,$("   "),e(a,{style:{width:"150px",height:"35px"},modelValue:r.value,"onUpdate:modelValue":i[0]||(i[0]=T=>r.value=T),size:"small"},null,8,["modelValue"])]),n("div",null,[n("div",null,[e(w,{onClick:t,size:"small",icon:o(Y).CHECK_SQUARE,label:"Afegir"},null,8,["icon"])])])])]),expansion:p(T=>[e(y,{class:"p-datatable-sm",value:T.data.details,selection:s.value,"onUpdate:selection":i[1]||(i[1]=R=>s.value=R)},{default:p(()=>[e(V,{selectionMode:"multiple",headerStyle:"width: 2rem"}),e(V,{header:"Referència",headerStyle:"width: 50%"},{body:p(({data:R})=>[$(F(o(_).getFullNameById(R.reference.id)),1)]),_:1}),e(V,{header:"Qtt. total",headerStyle:"width: 20%"},{body:p(({data:R})=>[$(F(R.quantity),1)]),_:1}),e(V,{header:"Qtt. rebuda",headerStyle:"width: 20%"},{body:p(({data:R})=>[$(F(R.receivedQuantity),1)]),_:1}),e(V,{header:"A recepcionar",headerStyle:"width: 20%"},{body:p(({data:R})=>[e(k,{size:"small",modelValue:R.pendingQuantity,"onUpdate:modelValue":G=>R.pendingQuantity=G,min:0,max:R.pendingQuantity},null,8,["modelValue","onUpdate:modelValue","max"])]),_:1})]),_:2},1032,["value","selection"])]),default:p(()=>[e(V,{expander:"",style:{width:"5%"}}),e(V,{header:"",field:"number",style:{width:"80%"}},{body:p(T=>[n("b",null,"Comanda "+F(T.data.number)+" | Data prevista "+F(o(M)(T.data.date)),1)]),_:1})]),_:1},8,["expandedRows","value"])}}});const dt=re(rt,[["__scopeId","data-v-23245ad9"]]),ut={key:0},ct=n("br",null,null,-1),mt={class:"flex flex-wrap align-items-center justify-content-between gap-2"},pt=n("span",{class:"text-xl text-900 font-bold"},"Detall de l'albarà",-1),ft={class:"flex flex-wrap align-items-center justify-content-between gap-2"},vt={key:1},$t=P({__name:"Receipt",setup(h){const C=Re(),f=Ie(),D=de(),v=ee(),_=xe(),c=Z(),m=Ue(),r=ce(),{receipt:s}=ie(c),b=E(0),x=async()=>{var d;await c.fetchReceipt(f.params.id),r.fetchOneByName("Receipts"),v.fetchReferencesByModule("purchase"),_.fetchActive(),s.value&&(s.value.date=M(s.value.date)),D.setMenuItem({icon:Y.BUILDING,title:`Albarà de recepció ${(d=s.value)==null?void 0:d.number}`,backButtonVisible:!0})};J(async()=>{await x()});const t=W(),l=ue(()=>{var u;if(!r.lifecycle)return!1;const d=r.lifecycle.statuses.find(U=>U.name==="Recepcionat");return d?((u=s.value)==null?void 0:u.statusId)===d.id:!1}),i=async()=>{let d=!1,u="";s.value&&(d=await c.updateReceipt(s.value.id,s.value),u="Albarà actualizat correctament",d&&(t.add({severity:"success",summary:u,life:5e3}),Se.back()))},a=se({visible:!1,title:"Linea",closable:!0,position:"center",modal:!0}),w=se({visible:!1,title:"Selecció de comandes",closable:!0,position:"center",modal:!0}),V=E(B.CREATE),k=E({}),y=()=>{V.value=B.CREATE,k.value={id:L(),receiptId:s.value.id,amount:0,diameter:0,height:0,kilogramPrice:0,lenght:0,quantity:1,thickness:0,totalWeight:0,unitPrice:0,unitWeight:0,width:0,disabled:!1},v.setNewReference(L(),H.MATERIAL),a.title="Crear línia",a.visible=!0},T=d=>{V.value=B.EDIT,k.value=d,v.setNewReference(L(),H.MATERIAL),a.title="Modificar línia",a.visible=!0},R=d=>{V.value===B.CREATE?G(d):V.value===B.EDIT&&fe(d),a.visible=!1},G=async d=>{const u=await c.createReceiptDetail(d);s.value.date=M(s.value.date),u.result||K(u)},fe=async d=>{const u=await c.updateReceiptDetail(d.id,d);s.value.date=M(s.value.date),u.result||K(u)},ve=async d=>{C.require({message:"Está segur que vols la línia?",icon:"pi pi-question-circle",acceptIcon:"pi pi-check",rejectIcon:"pi pi-times",accept:async()=>{const u=await c.deleteReceiptDetail(d.id);s.value.date=M(s.value.date),u.result||K(u)}})},K=d=>{t.add({severity:"error",summary:d.errors[0],life:1e4,closable:!0})},be=async d=>{let u=!1,U="";u=await v.createReference(d),u?U="Referència creada correctament":U="La referència + versió introduïda ja existeix",t.add({severity:u?"success":"warn",summary:U,life:5e3}),u&&(k.value.referenceId=d.id,b.value=0,v.setNewReference(L(),H.MATERIAL))},ye=async()=>{await m.fetchOrdersToReceiptBySupplier(s.value.supplierId),w.visible=!0},he=async d=>{w.visible=!1;const u=await c.addReceptions(d);u.result?(t.add({severity:"success",summary:"Recepcions afegides correctament",life:5e3}),c.fetchReceipt(d.receiptId)):t.add({severity:"error",summary:u.errors[0],life:1e4,closable:!0})};return(d,u)=>{var ae;const U=g("Button"),te=g("Dialog"),le=g("TabPanel"),_e=g("TabView");return o(s)?(N(),A("main",ut,[e(He,{onSubmit:i}),ct,e(Xe,{details:(ae=o(s))==null?void 0:ae.details,onEdit:T,onDelete:ve},{header:p(()=>[n("div",mt,[pt,n("div",ft,[n("div",null,[e(U,{size:"small",label:"Afegir de comanda",disabled:l.value,onClick:ye},null,8,["disabled"])]),n("div",null,[e(U,{size:"small",label:"Afegir línia",disabled:l.value,onClick:y},null,8,["disabled"])])])])]),_:1},8,["details"]),e(te,{visible:w.visible,"onUpdate:visible":u[0]||(u[0]=O=>w.visible=O),header:w.title,closable:w.closable,modal:w.modal,style:{width:"50vw"}},{default:p(()=>[e(dt,{receipt:o(s),orders:o(m).ordersToReceipt,onSelected:he},null,8,["receipt","orders"])]),_:1},8,["visible","header","closable","modal"]),e(te,{visible:a.visible,"onUpdate:visible":u[2]||(u[2]=O=>a.visible=O),header:a.title,closable:a.closable,modal:a.modal},{default:p(()=>[e(_e,{activeIndex:b.value,"onUpdate:activeIndex":u[1]||(u[1]=O=>b.value=O)},{default:p(()=>[e(le,{header:"Línea"},{default:p(()=>[e(at,{detail:k.value,receipt:o(s),onSubmit:R},null,8,["detail","receipt"])]),_:1}),e(le,{header:"Referencia"},{default:p(()=>[o(v).reference?(N(),X(Ne,{key:0,reference:o(v).reference,onSubmit:be},null,8,["reference"])):j("",!0)]),_:1})]),_:1},8,["activeIndex"])]),_:1},8,["visible","header","closable","modal"])])):(N(),A("main",vt,"Carregant albarà ..."))}}});export{$t as default};
