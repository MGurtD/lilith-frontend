import{_ as ue}from"./ExerciseDatePicker.vue_vue_type_script_setup_true_lang-a2ee1cfd.js";import{d as X,j as Z,r as U,h as b,a as A,c as z,e as o,i as s,k as i,n as G,s as R,y as j,l as ee,g as ce,u as pe,x as me,E as fe,o as ve,P as S,K as V,w as f,G as we,C as w,D as v}from"./index-d7d79c10.js";import{a as K,e as $,f as ke,_ as J,g as be}from"./functions-e7c8fc70.js";import{u as he}from"./exercise-446c7c8d.js";import{u as ye}from"./productionpart-bf2977a5.js";import{u as te}from"./plantmodel-8210c603.js";import{u as re}from"./workorder-65922bb4.js";import{c as Pe,a as E,d as Q,F as Ce}from"./form-validator-f8953ae6.js";import"./_commonjsHelpers-725317a4.js";import"./v4-a960c1f4.js";import"./index-f5d7f8d3.js";import"./base.service-fd6835a1.js";import"./reference.service-9f0aa22c.js";import"./index-eb566870.js";const Ie={key:0},_e={class:"three-columns mt-2"},Oe=o("label",{class:"block text-900 mb-2"},"Operari",-1),Ve=o("label",{class:"block text-900 mb-2"},"Màquina",-1),ge=o("label",{class:"block text-900 mb-2"},"Data Tíquet",-1),Te={class:"mt-2"},qe=o("label",{class:"block text-900 mb-2"},"Ordre Fabricació | Fase | Activitat",-1),De={class:"three-columns mt-2"},Se=o("br",null,null,-1),$e={class:"flex-right"},Ee=X({__name:"FormProductionPart",props:{productionPart:{},avoidWorkOrderRefresh:{type:Boolean}},emits:["submit","cancel"],setup(Y,{emit:M}){const u=Y,F=Z(),c=te(),I=re(),d=U(void 0),g=()=>{d.value.value&&(u.productionPart.workOrderId=d.value.value.workOrderId,u.productionPart.workOrderPhaseId=d.value.value.workOrderPhaseId,u.productionPart.workOrderPhaseDetailId=d.value.value.workOrderPhaseDetailId)},W=Pe().shape({operatorId:E().required("Escull un operari"),workcenterId:E().required("Escull una màquina"),workOrderId:E().required("Escull una ordre de fabricació"),workOrderPhaseId:E().required("Escull una fase"),workOrderPhaseDetailId:E().required("Escull una activitat"),quantity:Q().required("Has d'introduir una quantitat entera (pot ser 0)").integer(),workcenterTime:Q().required("Has d'introduir el temps i ha de ser major que 0").integer(),operatorTime:Q().required("Has d'introduir el temps i ha de ser major que 0").integer()}),h=U({result:!1,errors:{}}),p=()=>{const a=new Ce(W);h.value=a.validate(u.productionPart)},_=async a=>{u.avoidWorkOrderRefresh||(d.value=void 0,await I.fetchByWorkcenterId(a))},B=async()=>{if(p(),h.value.result)M("submit",u.productionPart);else{let a="";Object.entries(h.value.errors).forEach(l=>{a+=`${l[1].map(y=>y)}.   `}),F.add({severity:"warn",summary:"Formulari inválid",detail:a,life:5e3})}};return(a,l)=>{var T,q,O;const y=b("Dropdown"),N=b("Calendar"),H=b("Button");return a.productionPart?(A(),z("form",Ie,[o("section",_e,[o("div",null,[Oe,s(y,{modelValue:a.productionPart.operatorId,"onUpdate:modelValue":l[0]||(l[0]=r=>a.productionPart.operatorId=r),editable:"",filter:!0,options:(T=i(c).operators)==null?void 0:T.sort((r,P)=>r.surname.localeCompare(P.surname)).map(r=>({value:r.id,label:r.name+" "+r.surname})),optionValue:"value",optionLabel:"label",class:G(["w-full",{"p-invalid":h.value.errors.operatorid}])},null,8,["modelValue","options","class"])]),o("div",null,[Ve,s(y,{modelValue:a.productionPart.workcenterId,"onUpdate:modelValue":l[1]||(l[1]=r=>a.productionPart.workcenterId=r),editable:"",filter:!0,options:(q=i(c).workcenters)==null?void 0:q.sort((r,P)=>r.description.localeCompare(P.description)),optionValue:"id",optionLabel:"description",class:"w-full",onChange:l[2]||(l[2]=r=>_(a.productionPart.workcenterId))},null,8,["modelValue","options"])]),o("div",null,[ge,s(N,{modelValue:a.productionPart.date,"onUpdate:modelValue":l[3]||(l[3]=r=>a.productionPart.date=r),dateFormat:"dd/mm/yy"},null,8,["modelValue"])])]),o("section",Te,[o("div",null,[qe,s(y,{modelValue:d.value,"onUpdate:modelValue":l[4]||(l[4]=r=>d.value=r),editable:"",filter:!0,options:(O=i(I).detailedWorkOrders)==null?void 0:O.sort((r,P)=>r.workOrderCode.localeCompare(P.workOrderCode)).map(r=>({label:r.workOrderCode+"  ("+r.referenceDescription+") - "+r.workOrderPhaseCode+"  ("+r.workOrderPhaseDescription+") | "+r.machineStatusDescription,value:r})),optionLabel:"label",class:G(["w-full",{"p-invalid":h.value.errors.workOrderId}]),onChange:g},null,8,["modelValue","options","class"])])]),o("section",De,[o("div",null,[s(j,{type:i(R).NUMERIC,label:"Quantitat",id:"quantity",modelValue:a.productionPart.quantity,"onUpdate:modelValue":l[5]||(l[5]=r=>a.productionPart.quantity=r)},null,8,["type","modelValue"])]),o("div",null,[s(j,{type:i(R).NUMERIC,label:"Temps operari (minuts)",id:"time",modelValue:a.productionPart.operatorTime,"onUpdate:modelValue":l[6]||(l[6]=r=>a.productionPart.operatorTime=r)},null,8,["type","modelValue"])]),o("div",null,[s(j,{type:i(R).NUMERIC,label:"Temps centre de treball (minuts)",id:"time",modelValue:a.productionPart.workcenterTime,"onUpdate:modelValue":l[7]||(l[7]=r=>a.productionPart.workcenterTime=r)},null,8,["type","modelValue"])])]),Se,o("div",$e,[s(H,{label:"Guardar",size:"small",onClick:B})])])):ee("",!0)}}}),Fe={class:"flex flex-wrap align-items-center justify-content-between gap-2"},xe={class:"datatable-filter-5"},Ue={class:"filter-field"},Me={class:"filter-field"},We=o("label",null,"Operari",-1),Be={class:"filter-field"},Ne=o("label",null,"Màquina",-1),He={class:"filter-field"},Le=o("label",null,"OF",-1),Re=["onClick"],je={key:0,class:"flex-right"},Qe=o("br",null,null,-1),Ae=o("br",null,null,-1),it=X({__name:"ProductionParts",setup(Y){const M=ce(),u=pe(),F=Z(),c=ye(),I=he(),d=te(),g=re(),W=me(),h=()=>{var C;const e=new Date().getFullYear().toString(),t=(C=I.exercises)==null?void 0:C.find(D=>D.name===e);t&&(u.exercisePicker.exercise=t,u.exercisePicker.dates=[new Date(u.exercisePicker.exercise.startDate),new Date(u.exercisePicker.exercise.endDate)])},p=U({operatorId:"",workcenterId:"",workorderId:""}),_=async()=>{if(u.exercisePicker.dates){const e=K(u.exercisePicker.dates[0]),t=K(u.exercisePicker.dates[1]);await c.fetchFiltered(e,t,p.value.workcenterId,p.value.operatorId,p.value.workorderId),await g.fetchFiltered(e,t)}else F.add({severity:"info",summary:"Filtre invàlid",detail:"Seleccioni un període",life:5e3});console.log("store: ",c.productionParts)},B=()=>{u.cleanExercisePicker(),p.value.workcenterId="",p.value.operatorId=""},a=fe({visible:!1,title:"Crear tíquet de producció",closable:!0,position:"center",modal:!0});ve(async()=>{u.setMenuItem({icon:S.CLOUD,title:"Tíquets de producció"}),d.fetchWorkcenters(),d.fetchOperators(),d.fetchOperatorTypes(),d.fetchMachineStatuses(),await d.fetchWorkcenterCosts(),await I.fetchActive(),h(),_(),g.detailedWorkOrders=void 0});const l=V(()=>{if(c.productionParts)return c.productionParts.map(e=>({...e,personalCost:ae(e),workcenterCost:oe(e)}))}),y=V(()=>{if(c.productionParts)return c.productionParts.reduce((e,t)=>e+t.operatorTime,0)}),N=V(()=>{if(c.productionParts)return c.productionParts.reduce((e,t)=>e+t.workcenterTime,0)}),H=V(()=>{if(c.productionParts)return c.productionParts.reduce((e,t)=>e+t.quantity,0)}),T=V(()=>{if(l.value&&l.value.length>0)return l.value.reduce((e,t)=>e+(t.personalCost?t.personalCost:0),0)}),q=V(()=>{if(l.value&&l.value.length>0)return l.value.reduce((e,t)=>e+(t.workcenterCost?t.workcenterCost:0),0)}),O=U({}),r=()=>({id:be(),operatorId:"",workcenterId:"",workOrderId:"",workOrderPhaseId:"",workOrderPhaseDetailId:"",operatorHourCost:0,machineHourCost:0,operatorTime:0,workcenterTime:0,quantity:0,date:new Date}),P=e=>{if(e.workOrder&&e.workOrderPhase&&e.workOrderPhaseDetail){const t=d.getMachineStatusNameById(e.workOrderPhaseDetail.machineStatusId);return`${e.workOrder.code} - ${e.workOrderPhase.code} (${e.workOrderPhase.description}) - ${t}`}},oe=e=>{const t=e.machineHourCost*e.workcenterTime/60;return J.round(t,2)},ae=e=>{const t=e.operatorHourCost*e.operatorTime/60;return J.round(t,2)},le=()=>{O.value=r(),a.visible=!0},se=async()=>{a.visible=!1,await c.create(O.value)&&(M.push({path:"/productionpart"}),_())},ie=(e,t)=>{W.require({target:e.currentTarget,message:"Està segur que vol eliminar el tíquet de producció?",icon:"pi pi-question-circle",acceptIcon:"pi pi-check",rejectIcon:"pi pi-times",accept:async()=>{await c.delete(t.id)&&(F.add({severity:"success",summary:"Eliminat",life:3e3}),await _())}})};return(e,t)=>{const C=b("Dropdown"),D=b("Button"),k=b("Column"),ne=b("DataTable"),de=b("Dialog");return A(),z(we,null,[s(ne,{value:l.value,class:"p-datatable-sm small-datatable",tableStyle:"min-width: 100%",scrollable:"",scrollHeight:"79vh","sort-order":1,"sort-field":"date",paginator:"",rows:25},{header:f(()=>{var n,x;return[o("div",Fe,[o("div",xe,[o("div",Ue,[s(ue,{exercises:i(I).exercises},null,8,["exercises"])]),o("div",Me,[We,s(C,{modelValue:p.value.operatorId,"onUpdate:modelValue":t[0]||(t[0]=m=>p.value.operatorId=m),editable:"",filter:!0,options:(n=i(d).operators)==null?void 0:n.sort((m,L)=>m.surname.localeCompare(L.surname)).map(m=>({value:m.id,label:m.surname+", "+m.name})),optionValue:"value",optionLabel:"label",class:"w-full"},null,8,["modelValue","options"])]),o("div",Be,[Ne,s(C,{modelValue:p.value.workcenterId,"onUpdate:modelValue":t[1]||(t[1]=m=>p.value.workcenterId=m),editable:"",filter:!0,options:(x=i(d).workcenters)==null?void 0:x.sort((m,L)=>m.description.localeCompare(L.description)),optionValue:"id",optionLabel:"description",class:"w-full"},null,8,["modelValue","options"])]),o("div",He,[Le,s(C,{modelValue:p.value.workorderId,"onUpdate:modelValue":t[2]||(t[2]=m=>p.value.workorderId=m),editable:"",filter:!0,options:i(g).workorders,optionValue:"id",optionLabel:"code",class:"w-full"},null,8,["modelValue","options"])]),o("div",null,[s(D,{class:"datatable-button mr-2",icon:i(S).FILTER,rounded:"",raised:"",onClick:_},null,8,["icon"]),s(D,{class:"datatable-button mr-2",icon:i(S).FILTER_SLASH,rounded:"",raised:"",onClick:B},null,8,["icon"]),s(D,{icon:i(S).PLUS,rounded:"",raised:"",onClick:le},null,8,["icon"])])])])]}),empty:f(()=>[w(" No s'han trobat tiquets. ")]),loading:f(()=>[w(" Carregant tiquets. Si us plau espera. ")]),footer:f(()=>[l.value&&l.value.length>0?(A(),z("div",je,[o("span",null,[w(" Quantitat: "+v(H.value)+" unitats ",1),Qe,w(" Temps màquina: "+v(N.value)+" / Temps operari : "+v(y.value)+" ",1),Ae,w(" Cost màquina: "+v(i($)(q.value))+" / Cost operari: "+v(i($)(T.value))+" = "+v(i($)(T.value+q.value)),1)])])):ee("",!0)]),default:f(()=>[s(k,{field:"operatorId",header:"Operari",style:{width:"15%"}},{body:f(n=>[w(v(i(d).getOperatorNameById(n.data.operatorId)),1)]),_:1}),s(k,{field:"workcenterId",header:"Màquina",style:{width:"15%"}},{body:f(n=>[w(v(i(d).getWorkcenterNameById(n.data.workcenterId)),1)]),_:1}),s(k,{field:"workOrderId",header:"OF",style:{width:"20%"}},{body:f(n=>[w(v(P(n.data)),1)]),_:1}),s(k,{field:"date",header:"Data",style:{width:"10%"},sortable:""},{body:f(n=>[w(v(i(ke)(n.data.date)),1)]),_:1}),s(k,{field:"quantity",header:"Quantitat",style:{width:"5%"}}),s(k,{field:"operatorTime",header:"Temps Oper.",style:{width:"10%"}}),s(k,{field:"workcenterTime",header:"Temps Maq.",style:{width:"10%"}}),s(k,{header:"Cost Operari",style:{width:"10%"},field:"operatorHourCost"},{body:f(n=>[w(v(i($)(n.data.operatorHourCost/60*n.data.operatorTime)),1)]),_:1}),s(k,{header:"Cost Màquina",style:{width:"10%"},field:"machineHourCost"},{body:f(n=>[w(v(i($)(n.data.machineHourCost/60*n.data.workcenterTime)),1)]),_:1}),s(k,{style:{width:"5%"}},{body:f(n=>[o("i",{class:G([i(S).TIMES,"grid_delete_column_button"]),onClick:x=>ie(x,n.data)},null,10,Re)]),_:1})]),_:1},8,["value"]),s(de,{visible:a.visible,"onUpdate:visible":t[3]||(t[3]=n=>a.visible=n),header:a.title,closable:a.closable,modal:a.modal},{default:f(()=>[s(Ee,{productionPart:O.value,"avoid-work-order-refresh":!1,onSubmit:se},null,8,["productionPart"])]),_:1},8,["visible","header","closable","modal"])],64)}}});export{it as default};
