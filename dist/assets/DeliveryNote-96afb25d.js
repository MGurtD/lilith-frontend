import{d as U,r as V,R as C,h as N,a as I,m as E,w as _,e as a,G as B,i as r,k as f,P as F,H as w,I as R,p as K,b as W,f as J,j as X,c as M,z as A,n as z,l as L,D as re,s as ae,x as ie,Q as ne,$ as q,F as Q,v as de,g as ue,u as ce,C as me,W as ve,o as pe,L as fe}from"./index-0165ef2a.js";import{u as Y}from"./customers-7ea2bdbb.js";import{u as Z}from"./lifecycle-491d1308.js";import{u as ye}from"./masterData-6d455d54.js";import{c as _e,a as x,F as be}from"./form-validator-29ed56b4.js";import{L as he}from"./LinkReference-ea1e455d.js";import{u as Ne}from"./reference-3a204a36.js";import{u as De}from"./plantmodel-b6f0255e.js";import{u as Se}from"./deliveryNote-3f465a07.js";import{u as ge}from"./order-33dbdef2.js";import{S as we}from"./index-cc513c2f.js";import{a as Ie,b as Oe}from"./report.service-5554abfa.js";import"./index-836a0692.js";const Ve=y=>(K("data-v-8f6728d6"),y=y(),W(),y),Ce={class:"selector-filter"},Te={class:"selector-filter-field"},Be=Ve(()=>a("label",{for:""},"Buscar",-1)),ke={class:"selector-filter-button"},$e={class:"flex align-items-center gap-2"},xe=U({__name:"SelectorOrders",props:{orders:{},headerVisible:{type:Boolean}},emits:["selected"],setup(y,{emit:g}){const m=y,d=V([]),h=V(""),O=C(()=>{if(h.value==="")return m.orders||[];var o=[];return m.orders&&(o=m.orders.filter(s=>s.number.includes(h.value)||s.customerNumber.includes(h.value))),o}),b=()=>{if(d.value.length===0)return;const o=d.value;g("selected",o)};return(o,s)=>{const e=N("InputText"),u=N("Button"),l=N("Column"),i=N("DataTable");return I(),E(i,{class:"small-datatable",tableStyle:"min-width: 100%",scrollable:"",scrollHeight:"75vh",metaKeySelection:!1,value:O.value,selectionMode:"multiple",selection:d.value,"onUpdate:selection":s[1]||(s[1]=t=>d.value=t)},{header:_(()=>[a("header",Ce,[a("div",Te,[Be,B("   "),r(e,{style:{width:"150px",height:"35px"},modelValue:h.value,"onUpdate:modelValue":s[0]||(s[0]=t=>h.value=t),size:"small"},null,8,["modelValue"])]),a("div",ke,[r(u,{onClick:b,size:"small",icon:f(F).CHECK_SQUARE},null,8,["icon"])])])]),groupheader:_(t=>[a("div",$e,[a("b",null,"Comanda "+w(t.data.number)+" - "+w(f(R)(t.data.date)),1)])]),default:_(()=>[r(l,{selectionMode:"multiple",style:{width:"3%"}}),r(l,{header:"Número",field:"number",style:{width:"10%"}}),r(l,{header:"Número client",field:"customerNumber",style:{width:"20%"}}),r(l,{header:"Data",field:"date",style:{width:"10%"}},{body:_(t=>[B(w(f(R)(t.data.date)),1)]),_:1})]),_:1},8,["value","selection"])}}});const Ee=J(xe,[["__scopeId","data-v-8f6728d6"]]),G=y=>(K("data-v-f0037178"),y=y(),W(),y),Fe={key:0},Re={class:"three-columns"},Me={class:"mt-1"},Le={class:"mt-1"},Ue=G(()=>a("label",{class:"block text-900 mb-2"},"Client",-1)),Ae={class:"mt-2"},qe={class:"three-columns"},ze={class:"mt-2"},Ge=G(()=>a("label",{class:"block text-900 mb-2"},"Estat",-1)),je={class:"mt-2"},He=G(()=>a("label",{class:"block text-900 mb-2"},"Data Entrega",-1)),Pe={class:"mt-2"},Qe=U({__name:"FormDeliveryNote",props:{deliveryNote:{}},emits:["submit","cancel"],setup(y,{expose:g,emit:m}){const d=y,h=Y();ye();const O=Z(),b=X(),o=C(()=>d.deliveryNote&&d.deliveryNote.salesInvoice?d.deliveryNote.salesInvoice.invoiceNumber:""),s=C(()=>d.deliveryNote&&d.deliveryNote.createdOn?R(d.deliveryNote.createdOn):""),e=_e().shape({siteId:x().required("L'origen es obligatori"),customerId:x().required("El client es obligatori"),statusId:x().required("L'estat es obligatori"),exerciseId:x().required("L'exercici es obligatori")}),u=V({result:!1,errors:{}}),l=()=>{const t=new be(e);u.value=t.validate(d.deliveryNote)};return g({submitForm:async()=>{if(l(),u.value.result)d.deliveryNote.deliveryDate&&(d.deliveryNote.deliveryDate=re(d.deliveryNote.deliveryDate)),m("submit",d.deliveryNote);else{let t="";Object.entries(u.value.errors).forEach(v=>{t+=`${v[1].map(D=>D)}.   `}),b.add({severity:"warn",summary:"Formulari inválid",detail:t,life:5e3})}}}),(t,v)=>{var T;const D=N("Dropdown"),k=N("Calendar");return I(),M("div",null,[t.deliveryNote?(I(),M("form",Fe,[a("section",Re,[a("div",Me,[r(A,{type:f(ae).TEXT,label:"Número Albarà",id:"salesOrderNumber",modelValue:t.deliveryNote.number,"onUpdate:modelValue":v[0]||(v[0]=p=>t.deliveryNote.number=p),disabled:""},null,8,["type","modelValue"])]),a("div",Le,[Ue,r(D,{modelValue:t.deliveryNote.customerId,"onUpdate:modelValue":v[1]||(v[1]=p=>t.deliveryNote.customerId=p),editable:"",options:f(h).customers,optionValue:"id",optionLabel:"comercialName",class:z(["w-full",{"p-invalid":u.value.errors.customerId}])},null,8,["modelValue","options","class"])]),a("div",Ae,[r(A,{modelValue:s.value,"onUpdate:modelValue":v[2]||(v[2]=p=>s.value=p),label:"Data Creació",disabled:!0},null,8,["modelValue"])])]),a("section",qe,[a("div",ze,[Ge,r(D,{modelValue:t.deliveryNote.statusId,"onUpdate:modelValue":v[3]||(v[3]=p=>t.deliveryNote.statusId=p),editable:"",options:(T=f(O).lifecycle)==null?void 0:T.statuses,optionValue:"id",optionLabel:"name",class:z(["w-full",{"p-invalid":u.value.errors.statusId}])},null,8,["modelValue","options","class"])]),a("div",je,[He,r(k,{modelValue:t.deliveryNote.deliveryDate,"onUpdate:modelValue":v[4]||(v[4]=p=>t.deliveryNote.deliveryDate=p),dateFormat:"dd/mm/yy",class:"mt-2"},null,8,["modelValue"])]),a("div",Pe,[r(A,{modelValue:o.value,"onUpdate:modelValue":v[5]||(v[5]=p=>o.value=p),label:"Número de factura",disabled:!0},null,8,["modelValue"])])])])):L("",!0)])}}});const Ke=J(Qe,[["__scopeId","data-v-f0037178"]]),We=["onClick"],Je={class:"vertical-align-middle ml-2 font-bold line-height-3"},Xe={class:"flex-right"},Ye=U({__name:"TableDeliveryNoteDetails",props:{orders:{},canDelete:{type:Boolean}},emits:["delete"],setup(y,{emit:g}){const m=y,d=C(()=>{if(!m.orders)return[];let o=[];for(let s=0;s<m.orders.length;s++){if(!m.orders[s].salesOrderDetails)continue;const e=m.orders[s];e.salesOrderDetails.forEach(u=>{o.push({salesOrderId:e.id,salesOrderNumber:e.number,salesOrderDate:e.date,customerNumber:e.customerNumber,...u})})}return o}),h=ie(),O=(o,s)=>{var u;if(!m.orders)return;const e=(u=m.orders)==null?void 0:u.find(l=>l.id===s.salesOrderId);e&&h.require({target:o.currentTarget,message:`Está segur que vol desassignar la comanda ${e.number}?`,icon:"pi pi-question-circle",acceptIcon:"pi pi-check",rejectIcon:"pi pi-times",accept:()=>{g("delete",e)}})},b=C(()=>m.orders?m.orders.reduce((o,s)=>s.salesOrderDetails?o+s.salesOrderDetails.reduce((e,u)=>e+u.amount,0):o,0):0);return(o,s)=>{const e=N("Column"),u=N("DataTable");return I(),E(u,{value:d.value,tableStyle:"min-width: 100%",class:"p-datatable-sm",rowGroupMode:"subheader",groupRowsBy:"salesOrderNumber",sortMode:"multiple",sortOrder:1,scrollable:"",scrollHeight:"60vh"},{header:_(()=>[ne(o.$slots,"header")]),groupheader:_(l=>[o.canDelete?(I(),M("i",{key:0,class:z([f(F).TIMES,"grid_delete_column_button"]),onClick:i=>O(i,l.data)},null,10,We)):L("",!0),B("   "),a("span",Je,"Comanda "+w(l.data.salesOrderNumber)+" (Núm. Client: "+w(l.data.customerNumber)+")",1)]),footer:_(()=>[a("div",Xe,[a("span",null," Total: "+w(f(q)(b.value)),1)])]),default:_(()=>[r(e,{field:"salesOrderNumber",header:"Comanda",style:{width:"5%"}}),r(e,{field:"",header:"",style:{width:"2%"}}),r(e,{field:"quantity",header:"Quantitat",style:{width:"5%"}}),r(e,{header:"Referència",field:"reference.code",sortable:"",style:{width:"15%"}},{body:_(l=>[r(he,{id:l.data.referenceId},null,8,["id"])]),_:1}),r(e,{field:"description",header:"Descripció",style:{width:"30%"}}),r(e,{field:"unitPrice",header:"Preu un.",style:{width:"10%"}},{body:_(l=>[B(w(f(q)(l.data.unitPrice)),1)]),_:1}),r(e,{field:"amount",header:"Total",style:{width:"10%"}},{body:_(l=>[B(w(f(q)(l.data.amount)),1)]),_:1})]),_:3},8,["value"])}}}),Ze={class:"flex flex-wrap align-items-center justify-content-between gap-2"},et=a("span",{class:"text-l text-900 font-bold"},"Linies de l'albarà",-1),tt="Selector de comandes",ft=U({__name:"DeliveryNote",setup(y){const g=V(),m=V(Q.EDIT),d=de(),h=ue(),O=ce(),b=Se(),o=ge(),s=Y(),e=De(),u=Ne(),l=Z(),{deliveryNote:i}=me(b),t=[{label:"Descarregar",icon:F.FILE_WORD,command:()=>v()}],v=async()=>{var n;const c=await we.DeliveryNote.GetReportDataById(i.value.id);if(c){const S=`AlbaraEntrega_${(n=i.value)==null?void 0:n.number}.docx`,$=await new Oe().Download(c,Ie.DeliveryNote,S);$?ve(S,$):j.add({severity:"warn",summary:"Error",detail:"No s'ha pugut generar fulla de la comanda"})}},D=V(!1),k=V(""),T=C(()=>{if(!l.lifecycle||!l.lifecycle.statuses||i.value&&i.value.salesInvoiceId&&i.value.salesInvoiceId!==null)return!1;const c=l.lifecycle.statuses.find(n=>n.name==="Entregat");return c?c.id!==k.value:!1}),p=async()=>{const c=d.params.id;await b.GetById(c),k.value=b.deliveryNote.statusId,await o.GetByDeliveryNote(c),u.fetchReferencesByModule("sales"),e.fetchSites(),s.customers||s.fetchCustomers(),l.lifecycle||l.fetchOneByName("DeliveryNote");let n="";i.value&&(m.value=Q.EDIT,n=`Albarà d'entrega ${i.value.number}`,i.value.deliveryDate&&(i.value.deliveryDate=R(i.value.deliveryDate))),O.setMenuItem({icon:F.BUILDING,backButtonVisible:!0,title:n})};pe(async()=>{await p()});const ee=()=>{g.value.submitForm()},j=X(),te=async c=>{let n=!1,S="";n=await b.Update(c.id,c),S=n?"Albarà actualitzat":"Error al actualitzar l'albarà",j.add({life:5e3,severity:n?"success":"error",summary:S}),n&&h.back()},oe=async()=>{i.value&&await o.GetToDeliver(i.value.customerId),D.value=!0},se=async c=>{for(let n=0;n<c.length;n++){const S=c[n];await b.AddOrder(i.value.id,S)}D.value=!1,p()},le=async c=>{await b.DeleteOrder(i.value.id,c),p()};return(c,n)=>{const S=N("SplitButton"),H=N("Button"),$=N("Dialog");return I(),M(fe,null,[r(S,{label:"Guardar",onClick:ee,model:t,size:"small",class:"grid_add_row_button"}),f(i)?(I(),E(Ke,{key:0,class:"mt-3 mb-3",ref_key:"deliveryNoteForm",ref:g,deliveryNote:f(i),onSubmit:te},null,8,["deliveryNote"])):L("",!0),f(i)?(I(),E(Ye,{key:1,orders:f(o).salesOrders,canDelete:T.value,onDelete:le},{header:_(()=>[a("div",Ze,[et,a("div",null,[r(H,{disabled:!T.value,size:"small",label:"Afegir comanda",onClick:n[0]||(n[0]=P=>oe())},null,8,["disabled"])])])]),_:1},8,["orders","canDelete"])):L("",!0),r($,{closable:!0,visible:D.value,"onUpdate:visible":n[1]||(n[1]=P=>D.value=P),header:tt,modal:!0,style:{width:"50rem"},breakpoints:{"1199px":"75vw","575px":"90vw"}},{default:_(()=>[r(Ee,{orders:f(o).salesOrdersToDeliver,onSelected:se},null,8,["orders"])]),_:1},8,["visible"])],64)}}});export{ft as default};
