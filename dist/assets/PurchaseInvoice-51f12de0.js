import{d as K,z as oe,o as Z,r as $,j as te,h as _,a as R,c as J,k as o,e as n,i as l,y as z,n as L,s as Y,D as P,l as G,p as ce,b as de,f as me,H as ae,F as f,m as H,w as I,P as ee,C as O,v as pe,g as ve,u as Ie,G as be}from"./index-53820b8d.js";import{a as se,u as Q}from"./purchaseInvoices-5d1ccbbc.js";import{c as ne,l as W,g as le,f as fe}from"./functions-4d7ada1d.js";import{F as _e}from"./FileEntityPicker-ced8a212.js";import{c as re,a as X,F as ie,d as he}from"./form-validator-f8953ae6.js";import{u as ue}from"./lifecycle-3c6f7322.js";import"./index-6d4d46b9.js";import"./base.service-80f81d45.js";import"./reference.service-f83d13c3.js";import"./index-c96e9700.js";import"./suppliers.service-f3160156.js";import"./_commonjsHelpers-725317a4.js";import"./v4-a960c1f4.js";import"./file.service-a28e4e6a.js";const S=w=>(ce("data-v-fc8bd4da"),w=w(),de(),w),Ae={key:0},ye={class:"four-columns"},xe=S(()=>n("label",{class:"block text-900 mb-2"},"Exercici",-1)),Ve=S(()=>n("label",{class:"block text-900 mb-2"},"Sèrie",-1)),De=S(()=>n("label",{class:"block text-900 mb-2"},"Estat",-1)),ge={class:"four-columns"},Te={class:"mt-1"},we=S(()=>n("label",{class:"block text-900 mb-2"},"Proveïdor",-1)),Ee={class:"mt-1"},Fe={class:"mt-1"},Ce=S(()=>n("label",{class:"block text-900 mb-2"},"Data Factura",-1)),Pe={class:"mt-1"},Se=S(()=>n("label",{class:"block text-900 mb-2"},"Forma de pagament",-1)),ke={class:"four-columns"},Ue={class:"mt-1"},Ne={class:"mt-1"},Re={class:"mt-1"},Be={class:"four-columns"},Me={class:"mt-1"},$e=S(()=>n("label",{class:"block text-900 mb-2"},"Base",-1)),Le={class:"summary-field"},Oe={class:"mt-1"},Ye=S(()=>n("label",{class:"block text-900 mb-2"},"Impostos",-1)),je={class:"summary-field"},qe={class:"mt-1"},ze=S(()=>n("label",{class:"block text-900 mb-2"},"Total",-1)),Ge={class:"summary-field"},He=K({__name:"FormPurchaseInvoice",emits:["submit","cancel"],setup(w,{expose:x,emit:p}){const y=se(),B=ue(),V=Q(),{purchaseInvoice:e}=oe(y);Z(()=>{setTimeout(()=>{e.value&&e.value.purchaseInvoiceImports.length>0&&(e.value.taxAmount=j())},500)});const k=re().shape({exerciceId:X().required("L'exercici es obligatori"),supplierId:X().required("El proveïdor es obligatori"),statusId:X().required("L'estat és obligatori")}),r=$({result:!1,errors:{}}),u=()=>{const m=new ie(k);r.value=m.validate(e.value)},h=()=>{var m;return((m=e.value)==null?void 0:m.purchaseInvoiceImports.length)===0?(i.add({severity:"warn",summary:"Formulari inválid",detail:"Ha d'introduir els imports de factura",life:5e3}),!1):!0};let s=!1;Z(()=>{setTimeout(()=>{s=!0},500)});const i=te(),d=async()=>{if(u(),r.value.result){if(!h())return;p("submit",e.value)}else{let m="";Object.entries(r.value.errors).forEach(a=>{m+=`${a[1].map(v=>v)}.   `}),i.add({severity:"warn",summary:"Formulari inválid",detail:m,life:5e3})}},E=()=>{var a;const m=(a=V.masterData.suppliers)==null?void 0:a.find(v=>{var T;return v.id===((T=e.value)==null?void 0:T.supplierId)});m&&(e.value.paymentMethodId=m.paymentMethodId,D())},D=async()=>{if(s){if(e.value){let m=0,a=0,v=0,T=0,U=0,t=0,c=0,b=0,g=0,F=0;m=A(),T=j(),e.value.transportAmount&&(a=parseFloat(e.value.transportAmount.toFixed(2))),e.value.discountPercentage&&(c=parseFloat(e.value.discountPercentage.toFixed(2))),e.value.extraTaxPercentatge&&(g=e.value.extraTaxPercentatge),v=(m+a)*1,F=v*(g/100),b=v+T*1-F*1,t=b*(1*c)/100,U=parseFloat((b-t).toFixed(2)),e.value.baseAmount=m,e.value.transportAmount=a,e.value.subtotal=v,e.value.taxAmount=T,e.value.grossAmount=b,e.value.netAmount=U,e.value.discountPercentage=c,e.value.discountAmount=t,e.value.extraTaxPercentatge=g,e.value.extraTaxAmount=F;const N=Object.assign({},e.value);N.purchaseInvoiceDate=ne(N.purchaseInvoiceDate),e.value.purchaseInvoiceDueDates=await y.GetDueDates(N)}console.log("calcAmounts",e.value)}},A=()=>{let m=0;return e.value&&e.value.purchaseInvoiceImports.forEach(a=>m+=a.baseAmount),m},j=()=>{let m=0;return e.value&&e.value.purchaseInvoiceImports.forEach(a=>m+=a.taxAmount),m};return x({submitForm:d,calcAmounts:D}),(m,a)=>{var U;const v=_("Dropdown"),T=_("Calendar");return R(),J("div",null,[o(e)?(R(),J("form",Ae,[n("section",ye,[l(z,{label:"Num. Fra. Intern",id:"number",modelValue:o(e).number,"onUpdate:modelValue":a[0]||(a[0]=t=>o(e).number=t),disabled:""},null,8,["modelValue"]),n("div",null,[xe,l(v,{modelValue:o(e).exerciceId,"onUpdate:modelValue":a[1]||(a[1]=t=>o(e).exerciceId=t),editable:"",options:o(V).masterData.exercises,optionValue:"id",optionLabel:"name",class:L(["w-full",{"p-invalid":r.value.errors.exerciseId}])},null,8,["modelValue","options","class"])]),n("div",null,[Ve,l(v,{modelValue:o(e).purchaseInvoiceSerieId,"onUpdate:modelValue":a[2]||(a[2]=t=>o(e).purchaseInvoiceSerieId=t),editable:"",options:o(V).masterData.series,optionValue:"id",optionLabel:"name",class:L(["w-full",{"p-invalid":r.value.errors.purchaseInvoiceSerieId}])},null,8,["modelValue","options","class"])]),n("div",null,[De,l(v,{modelValue:o(e).statusId,"onUpdate:modelValue":a[3]||(a[3]=t=>o(e).statusId=t),editable:"",options:(U=o(B).lifecycle)==null?void 0:U.statuses,optionValue:"id",optionLabel:"name",class:L(["w-full",{"p-invalid":r.value.errors.statusId}])},null,8,["modelValue","options","class"])])]),n("section",ge,[n("div",Te,[we,l(v,{modelValue:o(e).supplierId,"onUpdate:modelValue":a[4]||(a[4]=t=>o(e).supplierId=t),editable:"",options:o(V).masterData.suppliers,optionValue:"id",optionLabel:"comercialName",onChange:E,class:L(["w-full",{"p-invalid":r.value.errors.supplierId}])},null,8,["modelValue","options","class"])]),n("div",Ee,[l(z,{label:"Num. Fra. Proveïdor",id:"supplierNumber",modelValue:o(e).supplierNumber,"onUpdate:modelValue":a[5]||(a[5]=t=>o(e).supplierNumber=t)},null,8,["modelValue"])]),n("div",Fe,[Ce,l(T,{id:"purchaseInvoiceDate",modelValue:o(e).purchaseInvoiceDate,"onUpdate:modelValue":a[6]||(a[6]=t=>o(e).purchaseInvoiceDate=t),onDateSelect:a[7]||(a[7]=t=>D())},null,8,["modelValue"])]),n("div",Pe,[Se,l(v,{modelValue:o(e).paymentMethodId,"onUpdate:modelValue":[a[8]||(a[8]=t=>o(e).paymentMethodId=t),a[9]||(a[9]=t=>D())],editable:"",options:o(V).masterData.paymentMethods,optionValue:"id",optionLabel:"name",class:L(["w-full",{"p-invalid":r.value.errors.paymentmethod}])},null,8,["modelValue","options","class"])])]),n("section",ke,[n("div",Ue,[l(z,{type:o(Y).CURRENCY,label:"Ports",id:"transportAmount",modelValue:o(e).transportAmount,"onUpdate:modelValue":[a[10]||(a[10]=t=>o(e).transportAmount=t),a[11]||(a[11]=t=>D())]},null,8,["type","modelValue"])]),n("div",Ne,[l(z,{type:o(Y).NUMERIC,label:"% IRPF",id:"extraTaxPercentatge",modelValue:o(e).extraTaxPercentatge,"onUpdate:modelValue":[a[12]||(a[12]=t=>o(e).extraTaxPercentatge=t),a[13]||(a[13]=t=>D())]},null,8,["type","modelValue"])]),n("div",Re,[l(z,{type:o(Y).NUMERIC,label:"% Dto.",id:"discountPercentage",modelValue:o(e).discountPercentage,"onUpdate:modelValue":[a[14]||(a[14]=t=>o(e).discountPercentage=t),a[15]||(a[15]=t=>D())]},null,8,["type","modelValue"])])]),n("section",Be,[n("div",Me,[$e,n("span",Le,P(o(e).baseAmount)+" €",1)]),n("div",Oe,[Ye,n("span",je,P(o(e).taxAmount)+" €",1)]),n("div",qe,[ze,n("span",Ge,P(o(e).netAmount)+" €",1)])])])):G("",!0)])}}});const Je=me(He,[["__scopeId","data-v-fc8bd4da"]]),Ke={key:0},Qe={class:"two-columns"},We=n("label",{class:"block text-900 mb-2"},"IVA",-1),Xe={class:"two-columns"},Ze=K({__name:"FormPurchaseInvoiceImport",props:{formAction:{},invoiceImport:{}},emits:["submit"],setup(w,{emit:x}){const p=w,y=Q(),B=te(),V=ae(()=>p.formAction===f.CREATE?"Afegir":"Modificar"),e=()=>{const s=y.masterData.taxes.find(i=>i.id===p.invoiceImport.taxId);if(s&&W.isNumber(p.invoiceImport.baseAmount)){const i=p.invoiceImport.baseAmount,d=i/100*s.percentatge,E=i+d;p.invoiceImport.baseAmount=i,p.invoiceImport.taxAmount=W.round(d,2),p.invoiceImport.netAmount=W.round(E,2)}},k=re().shape({baseAmount:he().required("L'import base és obligatori")}),r=$({result:!1,errors:{}}),u=()=>{const s=new ie(k);r.value=s.validate(p.invoiceImport)},h=async()=>{if(u(),r.value.result)x("submit",p.invoiceImport);else{let s="";Object.entries(r.value.errors).forEach(i=>{s+=`${i[1].map(d=>d)}.   `}),B.add({severity:"warn",summary:"Formulari inválid",detail:s,life:5e3})}};return(s,i)=>{const d=_("BaseInput"),E=_("Dropdown"),D=_("Button");return s.invoiceImport?(R(),J("form",Ke,[n("section",Qe,[l(d,{class:L(["mb-2",{"p-invalid":r.value.errors.baseAmount}]),label:"Import Base",modelValue:s.invoiceImport.baseAmount,"onUpdate:modelValue":[i[0]||(i[0]=A=>s.invoiceImport.baseAmount=A),i[1]||(i[1]=A=>e())],type:o(Y).CURRENCY},null,8,["modelValue","type","class"]),n("div",null,[We,l(E,{modelValue:s.invoiceImport.taxId,"onUpdate:modelValue":[i[2]||(i[2]=A=>s.invoiceImport.taxId=A),i[3]||(i[3]=A=>e())],editable:"",options:o(y).masterData.taxes,optionValue:"id",optionLabel:"name"},null,8,["modelValue","options"])])]),n("section",Xe,[l(d,{class:"mb-2",label:"Import Impost",modelValue:s.invoiceImport.taxAmount,"onUpdate:modelValue":i[4]||(i[4]=A=>s.invoiceImport.taxAmount=A),type:o(Y).CURRENCY,disabled:""},null,8,["modelValue","type"]),l(d,{class:"mb-2",label:"Total",modelValue:s.invoiceImport.netAmount,"onUpdate:modelValue":i[5]||(i[5]=A=>s.invoiceImport.netAmount=A),type:o(Y).CURRENCY,disabled:""},null,8,["modelValue","type"])]),l(D,{label:V.value,onClick:h,style:{float:"right"}},null,8,["label"])])):G("",!0)}}}),et=["onClick"],tt=K({__name:"TablePurchaseInvoiceImports",props:{purchaseInvoiceImports:{}},emits:["add","edit","delete"],setup(w,{emit:x}){const p=w,y=Q(),B=r=>{var h;const u=(h=y.masterData.taxes)==null?void 0:h.find(s=>s.id===r);if(u)return u.percentatge},V=()=>{var h;const r=(h=y.masterData.taxes)==null?void 0:h.find(s=>s.name.includes("21")),u={id:le(),baseAmount:null,taxId:r?r.id:"",taxAmount:0,netAmount:0,purchaseInvoiceId:""};x("add",u)},e=r=>{r.originalEvent.target.className.includes("grid_delete_column_button")||x("edit",r.data)},k=(r,u)=>{x("delete",u)};return(r,u)=>{const h=_("Button"),s=_("Column"),i=_("DataTable");return R(),H(i,{onRowClick:e,value:p.purchaseInvoiceImports,tableStyle:"min-width: 100%"},{default:I(()=>[l(h,{onClick:V,rounded:"",icon:o(ee).PLUS,class:"grid_add_row_button",style:{"margin-right":"1.5rem"}},null,8,["icon"]),l(s,{field:"baseAmount",header:"Base",style:{width:"25%"}},{body:I(d=>[O(P(d.data.baseAmount)+" € ",1)]),_:1}),l(s,{field:"taxId",header:"% IVA",style:{width:"25%"}},{body:I(d=>[O(P(B(d.data.taxId)),1)]),_:1}),l(s,{field:"taxAmount",header:"Cuota IVA",style:{width:"25%"}},{body:I(d=>[O(P(d.data.taxAmount)+" € ",1)]),_:1}),l(s,{field:"netAmount",header:"Total",style:{width:"25%"}},{body:I(d=>[O(P(d.data.netAmount)+" € ",1)]),_:1}),l(s,{style:{width:"10%"}},{body:I(d=>[n("i",{class:L([o(ee).TIMES,"grid_delete_column_button"]),onClick:E=>k(E,d.data)},null,10,et)]),_:1})]),_:1},8,["value"])}}}),bt=K({__name:"PurchaseInvoice",setup(w){const x=$(),p=$(f.EDIT),y=pe(),B=ve(),V=Ie(),e=ue(),k=Q(),r=se(),{purchaseInvoice:u}=oe(r),h=ae(()=>i.value===f.CREATE?"Introducció import":"Modificació import"),s=$(!1),i=$(f.EDIT),d=$(void 0),E=async()=>{let t="";await r.GetById(y.params.id),u.value?(p.value=f.EDIT,t=`Factura de compra: ${u.value.number}`,u.value.purchaseInvoiceDate=new Date(u.value.purchaseInvoiceDate)):(p.value=f.CREATE,r.setNewPurchaseInvoice(y.params.id),t="Alta de factures de compra",D()),V.setMenuItem({icon:ee.POUND,backButtonVisible:!0,title:t})},D=()=>{var t,c,b,g;if(u.value){const F=(t=k.masterData.exercises)==null?void 0:t.find(M=>M.name===new Date().getFullYear().toString());F&&(u.value.exerciceId=F.id);const N=(c=k.masterData.series)==null?void 0:c.find(M=>M.name==="Nacional");N&&(u.value.purchaseInvoiceSerieId=N.id);const q=(g=(b=e.lifecycle)==null?void 0:b.statuses)==null?void 0:g.find(M=>M.name==="Nova");q&&(u.value.statusId=q.id)}};Z(async()=>{await E()});const A=()=>{x.value.submitForm()},j=(t,c)=>{t===f.CREATE&&(c.id=le()),c.purchaseInvoiceId=u.value.id,d.value=c,i.value=t,s.value=!0},m=te(),a=async t=>{let c=!1,b="";t.purchaseInvoiceDate=ne(t.purchaseInvoiceDate),p.value===f.CREATE?(c=await r.Create(t),b=c?"Factura creada":"Error al crear la factura"):(c=await r.Update(t),b=c?"Factura actualizada":"Error al actualizar la factura"),m.add({life:5e3,severity:c?"success":"error",summary:b}),c&&B.back()},v=async t=>{var c;i.value===f.CREATE?(p.value===f.EDIT&&await r.CreateInvoiceImport(t),(c=u.value)==null||c.purchaseInvoiceImports.push(t)):i.value===f.EDIT&&p.value===f.EDIT&&await r.UpdateInvoiceImport(t),U()},T=async t=>{p.value===f.EDIT&&await r.DeleteInvoiceImport(t);const c=u.value.purchaseInvoiceImports.filter(b=>b.id!==t.id);u.value.purchaseInvoiceImports=c,U()},U=()=>{x.value.calcAmounts(),s.value=!1};return(t,c)=>{const b=_("Button"),g=_("TabPanel"),F=_("Column"),N=_("DataTable"),q=_("TabView"),M=_("Dialog");return R(),J(be,null,[l(b,{label:"Guardar",class:"grid_add_row_button",onClick:A}),l(q,null,{default:I(()=>[o(u)?(R(),H(g,{key:0,header:"Factura"},{default:I(()=>[l(Je,{ref_key:"purchaseInvoiceForm",ref:x,purchaseInvoice:o(u),onSubmit:a},null,8,["purchaseInvoice"]),l(q,null,{default:I(()=>[l(g,{header:"Imports"},{default:I(()=>[l(tt,{"purchase-invoice-imports":o(u).purchaseInvoiceImports,onAdd:c[0]||(c[0]=C=>j(o(f).CREATE,C)),onEdit:c[1]||(c[1]=C=>j(o(f).EDIT,C)),onDelete:T},null,8,["purchase-invoice-imports"])]),_:1}),l(g,{header:"Venciments"},{default:I(()=>[l(N,{value:o(u).purchaseInvoiceDueDates,tableStyle:"min-width: 100%",scrollable:"",scrollHeight:"40vh",sortField:"dueDate",sortOrder:1},{default:I(()=>[l(F,{field:"dueDate",header:"Venciment",style:{width:"50%"},sortable:""},{body:I(C=>[O(P(o(fe)(C.data.dueDate)),1)]),_:1}),l(F,{field:"amount",header:"Import",style:{width:"50%"}},{body:I(C=>[O(P(C.data.amount)+" € ",1)]),_:1})]),_:1},8,["value"])]),_:1})]),_:1})]),_:1})):G("",!0),l(g,{header:"Fitxers"},{default:I(()=>[o(u)?(R(),H(_e,{key:0,title:"Factures",entity:"PurchaseInvoice",id:o(y).params.id},null,8,["id"])):G("",!0)]),_:1})]),_:1}),d.value?(R(),H(M,{key:0,closable:!0,visible:s.value,"onUpdate:visible":c[2]||(c[2]=C=>s.value=C),header:h.value,position:"bottom"},{default:I(()=>[l(Ze,{formAction:i.value,invoiceImport:d.value,onSubmit:v},null,8,["formAction","invoiceImport"])]),_:1},8,["visible","header"])):G("",!0)],64)}}});export{bt as default};
