import{d as j,j as A,o as P,r as S,h as p,c as q,e as s,i as a,n as B,z as C,k as r,l as U,L as z,a as _,s as T,F as y,v as K,g as Z,u as ee,x as te,C as ae,m as N,w as d,P as x,G as k,H as R,$ as I,J as se}from"./index-abfce291.js";import{c as oe,a as E,d as L,F as re}from"./form-validator-012be6a9.js";import{_ as le}from"./DropdownCustomers.vue_vue_type_script_setup_true_lang-4ee5aa2e.js";import{u as W}from"./tax-aa602bc0.js";import{F as ie}from"./FileEntityPicker-6ef7449d.js";import{u as ne}from"./reference-cfffd00c.js";import{u as de}from"./workmaster-6913f10d.js";import"./customers-82526395.js";import"./index-0d9d6b22.js";const ce=s("br",null,null,-1),ue={key:0},me={class:"four-columns"},fe={class:"mt-1"},pe={class:"mt-1"},be={class:"mt-1"},ve={class:"mt-1"},Ce={class:"five-columns"},ye={class:"mt-1"},_e={class:"mt-1"},we={class:"mt-1"},he={class:"mt-1"},Ve=s("label",{class:"block text-900 mb-2"},"Impost",-1),ke={class:"mt-1"},Re=s("label",{class:"block text-900 mb-2"},"Servei",-1),Ie=j({__name:"FormReference",props:{reference:{},defaultCustomerId:{}},emits:["submit","cancel"],setup(M,{emit:b}){const u=M,w=A(),$=W();P(()=>{u.defaultCustomerId&&u.reference&&(u.reference.customerId=u.defaultCustomerId)});const D=oe().shape({code:E().required("El codi és obligatori").max(50,"El codi no pot superar els 50 carácters"),description:E().required("La descripció és obligatori").max(250,"La descripció pot superar els 250 carácters"),version:E().required("La versió és obligatoria").max(20,"La versió pot superar els 20 carácters"),cost:L().required("El cost es obligatori"),price:L().required("El preu es obligatori"),taxId:E().required("El tipus d'iva es obligatori")}),n=S({result:!1,errors:{}}),c=()=>{const e=new re(D);n.value=e.validate(u.reference)},F=async()=>{if(c(),n.value.result)b("submit",u.reference);else{let e="";Object.entries(n.value.errors).forEach(t=>{e+=`${t[1].map(h=>h)}.   `}),w.add({severity:"warn",summary:"Formulari inválid",detail:e,life:5e3})}};return(e,t)=>{const h=p("Button"),g=p("Dropdown"),V=p("Checkbox");return _(),q(z,null,[s("div",null,[a(h,{label:"Guardar",class:"grid_add_row_button",size:"small",onClick:F}),ce]),e.reference?(_(),q("form",ue,[s("section",me,[s("div",fe,[a(C,{class:B(["mb-2",{"p-invalid":n.value.errors.code}]),label:"Codi",id:"code",modelValue:e.reference.code,"onUpdate:modelValue":t[0]||(t[0]=o=>e.reference.code=o)},null,8,["modelValue","class"])]),s("div",pe,[a(C,{class:B(["mb-2",{"p-invalid":n.value.errors.description}]),label:"Descripció",id:"description",modelValue:e.reference.description,"onUpdate:modelValue":t[1]||(t[1]=o=>e.reference.description=o)},null,8,["modelValue","class"])]),s("div",be,[a(C,{type:r(T).TEXT,label:"Versió",id:"version",modelValue:e.reference.version,"onUpdate:modelValue":t[2]||(t[2]=o=>e.reference.version=o)},null,8,["type","modelValue"])]),s("div",ve,[a(le,{label:"Client",modelValue:e.reference.customerId,"onUpdate:modelValue":t[3]||(t[3]=o=>e.reference.customerId=o)},null,8,["modelValue"])])]),s("section",Ce,[s("div",ye,[a(C,{type:r(T).CURRENCY,label:"Cost Teóric Fabricació",id:"workMasterCost",modelValue:e.reference.workMasterCost,"onUpdate:modelValue":t[4]||(t[4]=o=>e.reference.workMasterCost=o),disabled:""},null,8,["type","modelValue"])]),s("div",_e,[a(C,{type:r(T).CURRENCY,label:"Cost Última Fabricació",id:"lastCost",modelValue:e.reference.lastCost,"onUpdate:modelValue":t[5]||(t[5]=o=>e.reference.lastCost=o),disabled:""},null,8,["type","modelValue"])]),s("div",we,[a(C,{type:r(T).CURRENCY,label:"Preu",id:"price",modelValue:e.reference.price,"onUpdate:modelValue":t[6]||(t[6]=o=>e.reference.price=o)},null,8,["type","modelValue"])]),s("div",he,[Ve,a(g,{modelValue:e.reference.taxId,"onUpdate:modelValue":t[7]||(t[7]=o=>e.reference.taxId=o),editable:"",options:r($).taxes,optionValue:"id",optionLabel:"name",class:B(["w-full",{"p-invalid":n.value.errors.taxid}])},null,8,["modelValue","options","class"])]),s("div",ke,[Re,a(V,{modelValue:e.reference.isService,"onUpdate:modelValue":t[8]||(t[8]=o=>e.reference.isService=o),class:"w-full",binary:!0},null,8,["modelValue"])])])])):U("",!0)],64)}}}),ge={class:"flex flex-wrap align-items-center justify-content-between gap-2"},Te=s("div",null,[s("label",{class:"block text-900"},"Rutes de fabricació")],-1),Ee={class:"datatable-buttons"},Se=["onClick"],Le=j({__name:"Reference",setup(M){const b=S(y.EDIT),u=K(),w=Z(),$=ee(),D=W(),n=ne(),c=de(),F=te(),{reference:e}=ae(n),t=S(""),h=S(""),g=async()=>{D.fetchAll(),c.fetchByReferenceId(t.value),await n.fetchReference(t.value);let l="";e.value?(b.value=y.EDIT,l=`Referència ${e.value.code} - ${e.value.description}`):(b.value=y.CREATE,n.setNewReference(t.value),l="Alta de referència"),$.setMenuItem({icon:x.BUILDING,backButtonVisible:!0,title:l})};P(async()=>{t.value=u.params.id,h.value=u.params.module,await g()});const V=A(),o=async()=>{const l=e.value;let m=!1,f="";b.value===y.CREATE?(m=await n.createReference(l),m?f="Referència creada correctament":f="La referència + versió introduïda ja existeix"):(m=await n.updateReference(l.id,l),f="Referència actualizada correctament"),V.add({severity:m?"success":"warn",summary:f,life:5e3}),m&&(b.value===y.EDIT?w.back():g())},G=async()=>{if(e.value){const l=se();c.setNew(l,e.value.id),c.workmaster&&await c.create(c.workmaster)&&w.push({path:`/workmaster/${l}`})}},Y=l=>{w.push({path:`/workmaster/${l.data.id}`})},H=async(l,m)=>{l.stopPropagation(),F.require({target:l.currentTarget,message:"Está segur que vol eliminar la ruta seleccionada?",icon:"pi pi-question-circle",acceptIcon:"pi pi-check",rejectIcon:"pi pi-times",accept:async()=>{await c.delete(m.id)?(V.add({severity:"success",summary:"Ruta eliminada correctament",life:5e3}),await c.fetchByReferenceId(e.value.id)):V.add({severity:"warn",summary:"No s'ha pogut eliminar la ruta",life:5e3})}})};return(l,m)=>{const f=p("TabPanel"),Q=p("Button"),v=p("Column"),J=p("DataTable"),O=p("TabView");return _(),q(z,null,[r(e)?(_(),N(Ie,{key:0,reference:r(e),onSubmit:o},null,8,["reference"])):U("",!0),r(e)?(_(),N(O,{key:1},{default:d(()=>[a(f,{header:"Documentació"},{default:d(()=>[a(ie,{title:"Documentació",entity:"referenceMaps",id:r(e).id},null,8,["id"])]),_:1}),b.value===r(y).EDIT?(_(),N(f,{key:0,header:"Rutes de fabricació"},{default:d(()=>[a(J,{value:r(c).workmasters,tableStyle:"min-width: 100%",scrollable:"",scrollHeight:"80vh","sort-field":"reference.code","sort-order":1,onRowClick:Y},{header:d(()=>[s("div",ge,[Te,s("div",Ee,[a(Q,{icon:r(x).PLUS,rounded:"",raised:"",onClick:G},null,8,["icon"])])])]),default:d(()=>[a(v,{field:"baseQuantity",header:"Quantitat Base",style:{width:"10%"}}),a(v,{field:"machineCost",header:"Cost màquina",style:{width:"10%"}},{body:d(i=>[k(R(r(I)(i.data.machineCost)),1)]),_:1}),a(v,{field:"operatorCost",header:"Cost operari",style:{width:"10%"}},{body:d(i=>[k(R(r(I)(i.data.operatorCost)),1)]),_:1}),a(v,{field:"materialCost",header:"Cost material",style:{width:"10%"}},{body:d(i=>[k(R(r(I)(i.data.materialCost)),1)]),_:1}),a(v,{field:"externalCost",header:"Cost extern",style:{width:"10%"}},{body:d(i=>[k(R(r(I)(i.data.externalCost)),1)]),_:1}),a(v,{header:"Cost total",style:{width:"10%"}},{body:d(i=>[k(R(r(I)(i.data.machineCost+i.data.operatorCost+i.data.materialCost+i.data.externalCost)),1)]),_:1}),a(v,null,{body:d(i=>[s("i",{class:B([r(x).TIMES,"grid_delete_column_button"]),onClick:X=>H(X,i.data)},null,10,Se)]),_:1})]),_:1},8,["value"])]),_:1})):U("",!0)]),_:1})):U("",!0)],64)}}});export{Le as default};
