import{d as P,j,o as A,r as S,h as p,c as q,e as s,i as a,n as U,z as C,k as r,l as B,L as z,a as _,s as T,F as y,v as K,g as Z,u as ee,x as te,C as ae,m as N,w as c,P as x,G as k,H as R,R as I,J as se}from"./index-77e4d88f.js";import{c as oe,a as E,d as L,F as re}from"./form-validator-7d52d458.js";import{_ as le}from"./DropdownCustomers.vue_vue_type_script_setup_true_lang-e9f3ddc9.js";import{u as W}from"./tax-1efc6736.js";import{F as ie}from"./FileEntityPicker-61729a96.js";import{u as ne}from"./reference-62579076.js";import{u as ce}from"./workmaster-1cbdd076.js";import{R as de}from"./index-7cbe1881.js";import"./customers-5603f6e7.js";import"./index-fc95771f.js";const ue=s("br",null,null,-1),me={key:0},fe={class:"four-columns"},pe={class:"mt-1"},be={class:"mt-1"},ve={class:"mt-1"},Ce={class:"mt-1"},ye={class:"five-columns"},_e={class:"mt-1"},we={class:"mt-1"},he={class:"mt-1"},Ve={class:"mt-1"},ke=s("label",{class:"block text-900 mb-2"},"Impost",-1),Re={class:"mt-1"},Ie=s("label",{class:"block text-900 mb-2"},"Servei",-1),ge=P({__name:"FormReference",props:{reference:{},defaultCustomerId:{}},emits:["submit","cancel"],setup(M,{emit:b}){const u=M,w=j(),D=W();A(()=>{u.defaultCustomerId&&u.reference&&(u.reference.customerId=u.defaultCustomerId)});const $=oe().shape({code:E().required("El codi és obligatori").max(50,"El codi no pot superar els 50 carácters"),description:E().required("La descripció és obligatori").max(250,"La descripció pot superar els 250 carácters"),version:E().required("La versió és obligatoria").max(20,"La versió pot superar els 20 carácters"),cost:L().required("El cost es obligatori"),price:L().required("El preu es obligatori"),taxId:E().required("El tipus d'iva es obligatori")}),n=S({result:!1,errors:{}}),d=()=>{const e=new re($);n.value=e.validate(u.reference)},F=async()=>{if(d(),n.value.result)b("submit",u.reference);else{let e="";Object.entries(n.value.errors).forEach(t=>{e+=`${t[1].map(h=>h)}.   `}),w.add({severity:"warn",summary:"Formulari inválid",detail:e,life:5e3})}};return(e,t)=>{const h=p("Button"),g=p("Dropdown"),V=p("Checkbox");return _(),q(z,null,[s("div",null,[a(h,{label:"Guardar",class:"grid_add_row_button",size:"small",onClick:F}),ue]),e.reference?(_(),q("form",me,[s("section",fe,[s("div",pe,[a(C,{class:U(["mb-2",{"p-invalid":n.value.errors.code}]),label:"Codi",id:"code",modelValue:e.reference.code,"onUpdate:modelValue":t[0]||(t[0]=o=>e.reference.code=o)},null,8,["modelValue","class"])]),s("div",be,[a(C,{class:U(["mb-2",{"p-invalid":n.value.errors.description}]),label:"Descripció",id:"description",modelValue:e.reference.description,"onUpdate:modelValue":t[1]||(t[1]=o=>e.reference.description=o)},null,8,["modelValue","class"])]),s("div",ve,[a(C,{type:r(T).TEXT,label:"Versió",id:"version",modelValue:e.reference.version,"onUpdate:modelValue":t[2]||(t[2]=o=>e.reference.version=o)},null,8,["type","modelValue"])]),s("div",Ce,[a(le,{label:"Client",modelValue:e.reference.customerId,"onUpdate:modelValue":t[3]||(t[3]=o=>e.reference.customerId=o)},null,8,["modelValue"])])]),s("section",ye,[s("div",_e,[a(C,{type:r(T).CURRENCY,label:"Cost Teóric Fabricació",id:"workMasterCost",modelValue:e.reference.workMasterCost,"onUpdate:modelValue":t[4]||(t[4]=o=>e.reference.workMasterCost=o),disabled:""},null,8,["type","modelValue"])]),s("div",we,[a(C,{type:r(T).CURRENCY,label:"Cost Última Fabricació",id:"lastCost",modelValue:e.reference.lastCost,"onUpdate:modelValue":t[5]||(t[5]=o=>e.reference.lastCost=o),disabled:""},null,8,["type","modelValue"])]),s("div",he,[a(C,{type:r(T).CURRENCY,label:"Preu unitari",id:"price",modelValue:e.reference.price,"onUpdate:modelValue":t[6]||(t[6]=o=>e.reference.price=o)},null,8,["type","modelValue"])]),s("div",Ve,[ke,a(g,{modelValue:e.reference.taxId,"onUpdate:modelValue":t[7]||(t[7]=o=>e.reference.taxId=o),editable:"",options:r(D).taxes,optionValue:"id",optionLabel:"name",class:U(["w-full",{"p-invalid":n.value.errors.taxid}])},null,8,["modelValue","options","class"])]),s("div",Re,[Ie,a(V,{modelValue:e.reference.isService,"onUpdate:modelValue":t[8]||(t[8]=o=>e.reference.isService=o),class:"w-full",binary:!0},null,8,["modelValue"])])])])):B("",!0)],64)}}}),Te={class:"flex flex-wrap align-items-center justify-content-between gap-2"},Ee=s("div",null,[s("label",{class:"block text-900"},"Rutes de fabricació")],-1),Se={class:"datatable-buttons"},Ue=["onClick"],je=P({__name:"Reference",setup(M){const b=S(y.EDIT),u=K(),w=Z(),D=ee(),$=W(),n=ne(),d=ce(),F=te(),{reference:e}=ae(n),t=S(""),h=S(""),g=async()=>{$.fetchAll(),d.fetchByReferenceId(t.value),await n.fetchReference(t.value);let l="";e.value?(b.value=y.EDIT,l=`Referència ${e.value.code} - ${e.value.description}`):(b.value=y.CREATE,n.setNewReference(t.value,de.PRODUCT),l="Alta de referència"),D.setMenuItem({icon:x.BUILDING,backButtonVisible:!0,title:l})};A(async()=>{t.value=u.params.id,h.value=u.params.module,await g()});const V=j(),o=async()=>{const l=e.value;let m=!1,f="";b.value===y.CREATE?(m=await n.createReference(l),m?f="Referència creada correctament":f="La referència + versió introduïda ja existeix"):(m=await n.updateReference(l.id,l),f="Referència actualizada correctament"),V.add({severity:m?"success":"warn",summary:f,life:5e3}),m&&(b.value===y.EDIT?w.back():g())},G=async()=>{if(e.value){const l=se();d.setNew(l,e.value.id),d.workmaster&&await d.create(d.workmaster)&&w.push({path:`/workmaster/${l}`})}},Y=l=>{w.push({path:`/workmaster/${l.data.id}`})},H=async(l,m)=>{l.stopPropagation(),F.require({target:l.currentTarget,message:"Está segur que vol eliminar la ruta seleccionada?",icon:"pi pi-question-circle",acceptIcon:"pi pi-check",rejectIcon:"pi pi-times",accept:async()=>{await d.delete(m.id)?(V.add({severity:"success",summary:"Ruta eliminada correctament",life:5e3}),await d.fetchByReferenceId(e.value.id)):V.add({severity:"warn",summary:"No s'ha pogut eliminar la ruta",life:5e3})}})};return(l,m)=>{const f=p("TabPanel"),O=p("Button"),v=p("Column"),Q=p("DataTable"),J=p("TabView");return _(),q(z,null,[r(e)?(_(),N(ge,{key:0,reference:r(e),onSubmit:o},null,8,["reference"])):B("",!0),r(e)?(_(),N(J,{key:1},{default:c(()=>[a(f,{header:"Documentació"},{default:c(()=>[a(ie,{title:"Documentació",entity:"referenceMaps",id:r(e).id},null,8,["id"])]),_:1}),b.value===r(y).EDIT?(_(),N(f,{key:0,header:"Rutes de fabricació"},{default:c(()=>[a(Q,{value:r(d).workmasters,tableStyle:"min-width: 100%",scrollable:"",scrollHeight:"80vh","sort-field":"reference.code","sort-order":1,onRowClick:Y},{header:c(()=>[s("div",Te,[Ee,s("div",Se,[a(O,{icon:r(x).PLUS,rounded:"",raised:"",onClick:G},null,8,["icon"])])])]),default:c(()=>[a(v,{field:"baseQuantity",header:"Quantitat Base",style:{width:"10%"}}),a(v,{field:"machineCost",header:"Cost màquina",style:{width:"10%"}},{body:c(i=>[k(R(r(I)(i.data.machineCost)),1)]),_:1}),a(v,{field:"operatorCost",header:"Cost operari",style:{width:"10%"}},{body:c(i=>[k(R(r(I)(i.data.operatorCost)),1)]),_:1}),a(v,{field:"materialCost",header:"Cost material",style:{width:"10%"}},{body:c(i=>[k(R(r(I)(i.data.materialCost)),1)]),_:1}),a(v,{field:"externalCost",header:"Cost extern",style:{width:"10%"}},{body:c(i=>[k(R(r(I)(i.data.externalCost)),1)]),_:1}),a(v,{header:"Cost total",style:{width:"10%"}},{body:c(i=>[k(R(r(I)(i.data.machineCost+i.data.operatorCost+i.data.materialCost+i.data.externalCost)),1)]),_:1}),a(v,null,{body:c(i=>[s("i",{class:U([r(x).TIMES,"grid_delete_column_button"]),onClick:X=>H(X,i.data)},null,10,Ue)]),_:1})]),_:1},8,["value"])]),_:1})):B("",!0)]),_:1})):B("",!0)],64)}}});export{je as default};
