import{d as P,j as G,z as X,o as Y,r as N,h as V,a as D,c as S,i as t,k as s,e as o,s as h,y,n as A,l as O,p as ne,b as re,f as de,m as H,w as _,J as ue,C as z,D as $,P as j,v as ce,u as me,K as pe,E as fe,F as U,L as be}from"./index-e365f3be.js";import{u as K}from"./receipt-458fe97f.js";import{u as ve}from"./suppliers-d98682e7.js";import{u as Z}from"./lifecycle-5aa2399a.js";import{c as ee,a as L,F as te,d as he}from"./form-validator-f8953ae6.js";import{c as ye,f as B,g as M}from"./functions-e7c8fc70.js";import{u as _e}from"./masterData-afc35dba.js";import{_ as Ve}from"./DropdownReference.vue_vue_type_script_setup_true_lang-1a748adf.js";import{_ as ge}from"./FormMaterial.vue_vue_type_script_setup_true_lang-8c5b05f2.js";import{u as we}from"./reference-3f326116.js";import{u as Re}from"./referenceType-7d28114b.js";import"./index-c2ef66bf.js";import"./base.service-8e7a55c1.js";import"./suppliers.service-2eb9b197.js";import"./index-42d34089.js";import"./reference.service-33e64e53.js";import"./_commonjsHelpers-725317a4.js";import"./v4-a960c1f4.js";import"./tax-cf527e8f.js";import"./DropdownReferenceType.vue_vue_type_script_setup_true_lang-84a333ff.js";const T=g=>(ne("data-v-70931d13"),g=g(),re(),g),Ie=T(()=>o("br",null,null,-1)),Ce={key:0},De={class:"three-columns"},ke={class:"mt-1"},Se={class:"mt-1"},Ee=T(()=>o("label",{class:"block text-900 mb-2"},"Exercici",-1)),Ue={class:"mt-1"},Ne=T(()=>o("label",{class:"block text-900 mb-2"},"Data Albarà",-1)),Te={class:"three-columns"},Fe={class:"mt-1"},$e=T(()=>o("label",{class:"block text-900 mb-2"},"Estat",-1)),Be={class:"mt-1"},Me=T(()=>o("label",{class:"block text-900 mb-2"},"Proveïdor",-1)),Ae={class:"mt-1"},Le=P({__name:"FormReceipt",emits:["submit","cancel"],setup(g,{expose:R,emit:f}){const p=K(),I=ve(),c=_e(),v=Z(),l=G(),{receipt:r}=X(p);Y(async()=>{await c.fetchMasterData(),await I.fetchSuppliers(),await v.fetchOneByName("Receipts")});const m=ee().shape({supplierId:L().required("El client es obligatori"),statusId:L().required("L'estat es obligatori"),exerciseId:L().required("L'exercici es obligatori")}),e=N({result:!1,errors:{}}),i=()=>{const a=new te(m);e.value=a.validate(r.value)},w=async()=>{if(i(),e.value.result)r.value.date=ye(r.value.date),f("submit",r.value);else{let a="";Object.entries(e.value.errors).forEach(u=>{a+=`${u[1].map(C=>C)}.   `}),l.add({severity:"warn",summary:"Formulari inválid",detail:a,life:5e3})}};return R({submitForm:w}),(a,u)=>{var F;const C=V("Button"),E=V("Dropdown"),x=V("Calendar");return D(),S("div",null,[t(C,{label:"Guardar",size:"small",class:"grid_add_row_button",onClick:w}),Ie,s(r)?(D(),S("form",Ce,[o("section",De,[o("div",ke,[t(y,{type:s(h).TEXT,label:"Número",id:"number",modelValue:s(r).number,"onUpdate:modelValue":u[0]||(u[0]=b=>s(r).number=b),disabled:""},null,8,["type","modelValue"])]),o("div",Se,[Ee,t(E,{modelValue:s(r).exerciseId,"onUpdate:modelValue":u[1]||(u[1]=b=>s(r).exerciseId=b),editable:"",options:s(c).exercises,optionValue:"id",optionLabel:"name",class:A(["w-full",{"p-invalid":e.value.errors.exerciseId}])},null,8,["modelValue","options","class"])]),o("div",Ue,[Ne,t(x,{modelValue:s(r).date,"onUpdate:modelValue":u[2]||(u[2]=b=>s(r).date=b),dateFormat:"dd/mm/yy"},null,8,["modelValue"])])]),o("section",Te,[o("div",Fe,[$e,t(E,{modelValue:s(r).statusId,"onUpdate:modelValue":u[3]||(u[3]=b=>s(r).statusId=b),editable:"",options:(F=s(v).lifecycle)==null?void 0:F.statuses,optionValue:"id",optionLabel:"name",class:A(["w-full",{"p-invalid":e.value.errors.statusId}])},null,8,["modelValue","options","class"])]),o("div",Be,[Me,t(E,{modelValue:s(r).supplierId,"onUpdate:modelValue":u[4]||(u[4]=b=>s(r).supplierId=b),editable:"",options:s(I).suppliers,optionValue:"id",optionLabel:"comercialName",class:A(["w-full",{"p-invalid":e.value.errors.customerId}])},null,8,["modelValue","options","class"])]),o("div",Ae,[t(y,{type:s(h).TEXT,label:"Número Albarà",id:"supplierNumber",modelValue:s(r).supplierNumber,"onUpdate:modelValue":u[5]||(u[5]=b=>s(r).supplierNumber=b)},null,8,["type","modelValue"])])])])):O("",!0)])}}});const Pe=de(Le,[["__scopeId","data-v-70931d13"]]),Oe=["onClick"],xe=P({__name:"TableReceiptDetails",props:{details:{}},emits:["edit","delete"],setup(g,{emit:R}){const f=g,p=c=>{c.originalEvent.target.className.includes("grid_delete_column_button")||R("edit",c.data)},I=(c,v)=>{R("delete",v)};return(c,v)=>{const l=V("Column"),r=V("DataTable");return D(),H(r,{onRowClick:p,value:f.details,tableStyle:"min-width: 100%",class:"p-datatable-sm"},{header:_(()=>[ue(c.$slots,"header")]),default:_(()=>[t(l,{field:"quantity",header:"Quantitat",style:{width:"7.5%"}}),t(l,{header:"Material",style:{width:"25%"}},{body:_(m=>[z($(m.data.reference.code)+" - "+$(m.data.reference.description),1)]),_:1}),t(l,{field:"width",header:"Amplada",style:{width:"7.5%"}}),t(l,{field:"height",header:"Alçada",style:{width:"7.5%"}}),t(l,{field:"lenght",header:"Longitud",style:{width:"7.5%"}}),t(l,{field:"thickness",header:"Gruix",style:{width:"7.5%"}}),t(l,{field:"diameter",header:"Diàmetre",style:{width:"7.5%"}}),t(l,{field:"totalWeight",header:"Pes",style:{width:"7.5%"}},{body:_(m=>[z($(m.data.amount)+" KG",1)]),_:1}),t(l,{field:"amount",header:"Preu",style:{width:"7.5%"}},{body:_(m=>[z($(m.data.amount)+" €",1)]),_:1}),t(l,{style:{width:"5%"}},{body:_(m=>[m.data.stockMovementId===null?(D(),S("i",{key:0,class:A([s(j).TIMES,"grid_delete_column_button"]),onClick:e=>I(e,m.data)},null,10,Oe)):O("",!0)]),_:1})]),_:3},8,["value"])}}}),qe={key:0},We={class:"two-columns-7525"},ze={class:"three-columns mt-2"},je={class:"three-columns mt-2"},Ge={class:"two-columns mt-2"},Ke=P({__name:"FormReceiptDetail",props:{detail:{}},emits:["submit","cancel"],setup(g,{emit:R}){const f=g,p=G(),I=K(),c=async()=>{const e=await I.calculateDetailWeightAndPrice(f.detail);e.result?(f.detail.unitWeight=e.content.unitWeight,f.detail.totalWeight=e.content.totalWeight,f.detail.unitPrice=e.content.unitPrice,f.detail.amount=e.content.amount):p.add({summary:"Calculadora de pes/preu",detail:e.errors[0],severity:"warn",life:6e3})},v=ee().shape({quantity:he().min(1).required("La quantitat ha de ser superior a 1"),referenceId:L().required("La referencia és obligatoria")}),l=N({result:!1,errors:{}}),r=()=>{const e=new te(v);l.value=e.validate(f.detail)},m=async()=>{if(r(),l.value.result)R("submit",f.detail);else{let e="";Object.entries(l.value.errors).forEach(i=>{e+=`${i[1].map(w=>w)}.   `}),p.add({severity:"warn",summary:"Formulari inválid",detail:e,life:5e3})}};return(e,i)=>{const w=V("Button");return e.detail?(D(),S("form",qe,[o("section",We,[o("div",null,[t(Ve,{label:"Material",modelValue:e.detail.referenceId,"onUpdate:modelValue":i[0]||(i[0]=a=>e.detail.referenceId=a),fullName:!0},null,8,["modelValue"])]),o("div",null,[t(y,{type:s(h).CURRENCY,label:"Preu / Kilo",highlightOnFocus:"",modelValue:e.detail.kilogramPrice,"onUpdate:modelValue":i[1]||(i[1]=a=>e.detail.kilogramPrice=a)},null,8,["type","modelValue"])])]),o("section",ze,[o("div",null,[t(y,{type:s(h).NUMERIC,highlightOnFocus:"",label:"Amplada (mm)",decimals:2,modelValue:e.detail.width,"onUpdate:modelValue":i[2]||(i[2]=a=>e.detail.width=a)},null,8,["type","modelValue"])]),o("div",null,[t(y,{type:s(h).NUMERIC,decimals:2,label:"Alçada (mm)",highlightOnFocus:"",modelValue:e.detail.height,"onUpdate:modelValue":i[3]||(i[3]=a=>e.detail.height=a)},null,8,["type","modelValue"])]),o("div",null,[t(y,{type:s(h).NUMERIC,decimals:2,label:"Longitud (mm)",highlightOnFocus:"",modelValue:e.detail.lenght,"onUpdate:modelValue":i[4]||(i[4]=a=>e.detail.lenght=a)},null,8,["type","modelValue"])])]),o("section",je,[o("div",null,[t(y,{type:s(h).NUMERIC,decimals:2,label:"Diàmetre (mm)",highlightOnFocus:"",modelValue:e.detail.diameter,"onUpdate:modelValue":i[5]||(i[5]=a=>e.detail.diameter=a)},null,8,["type","modelValue"])]),o("div",null,[t(y,{type:s(h).NUMERIC,decimals:2,label:"Gruix (mm)",highlightOnFocus:"",modelValue:e.detail.thickness,"onUpdate:modelValue":i[6]||(i[6]=a=>e.detail.thickness=a)},null,8,["type","modelValue"])]),o("div",null,[t(y,{type:s(h).NUMERIC,decimals:2,label:"Pes (kg)",modelValue:e.detail.totalWeight,"onUpdate:modelValue":i[7]||(i[7]=a=>e.detail.totalWeight=a)},null,8,["type","modelValue"])])]),o("section",Ge,[o("div",null,[t(y,{type:s(h).NUMERIC,label:"Quantitat",highlightOnFocus:"",modelValue:e.detail.quantity,"onUpdate:modelValue":i[8]||(i[8]=a=>e.detail.quantity=a)},null,8,["type","modelValue"])]),o("div",null,[t(y,{type:s(h).CURRENCY,label:"Preu",modelValue:e.detail.amount,"onUpdate:modelValue":i[9]||(i[9]=a=>e.detail.amount=a)},null,8,["type","modelValue"])])]),t(w,{label:"Crear",onClick:m,style:{float:"right"},size:"small",class:"mt-2"}),t(w,{label:"Calcular",onClick:c,style:{float:"right"},size:"small",class:"mt-2 mr-2"})])):O("",!0)}}}),Je={key:0},Qe=o("br",null,null,-1),Xe={class:"flex flex-wrap align-items-center justify-content-between gap-2"},Ye=o("span",{class:"text-xl text-900 font-bold"},"Detall de l'albarà",-1),He={key:1},_t=P({__name:"Receipt",setup(g){const R=ce(),f=me(),p=we(),I=Re(),c=K(),v=Z(),{receipt:l}=X(c),r=N(0),m=async()=>{var n;await c.fetchReceipt(R.params.id),v.fetchOneByName("Receipts"),p.fetchReferencesByModule("purchase"),I.fetchActive(),l.value&&(l.value.date=B(l.value.date)),f.setMenuItem({icon:j.BUILDING,title:`Albarà de recepció ${(n=l.value)==null?void 0:n.number}`,backButtonVisible:!0})};Y(async()=>{await m()});const e=G(),i=pe(()=>{var d;if(!v.lifecycle)return!1;const n=v.lifecycle.statuses.find(k=>k.name==="Recepcionat");return n?((d=l.value)==null?void 0:d.statusId)===n.id:!1}),w=async()=>{let n=!1,d="";l.value&&(n=await c.updateReceipt(l.value.id,l.value),d="Albarà actualizat correctament",n&&(e.add({severity:"success",summary:d,life:5e3}),be.back()))},a=fe({visible:!1,title:"Linea",closable:!0,position:"center",modal:!0}),u=N(U.CREATE),C=N({}),E=()=>{u.value=U.CREATE,C.value={id:M(),receiptId:l.value.id,amount:0,diameter:0,height:0,kilogramPrice:0,lenght:0,quantity:1,thickness:0,totalWeight:0,unitPrice:0,unitWeight:0,width:0,disabled:!1},p.setNewReference(M()),a.title="Crear línia",a.visible=!0},x=n=>{u.value=U.EDIT,C.value=n,p.setNewReference(M()),a.title="Modificar línia",a.visible=!0},F=n=>{u.value===U.CREATE?b(n):u.value===U.EDIT&&ae(n),a.visible=!1},b=async n=>{const d=await c.createReceiptDetail(n);l.value.date=B(l.value.date),d.result||q(d)},ae=async n=>{const d=await c.updateReceiptDetail(n.id,n);l.value.date=B(l.value.date),d.result||q(d)},le=async n=>{const d=await c.deleteReceiptDetail(n.id);l.value.date=B(l.value.date),d.result||q(d)},q=n=>{e.add({severity:"error",summary:n.errors[0],life:1e4,closable:!0})},se=async n=>{let d=!1,k="";d=await p.createReference(n),d?k="Referència creada correctament":k="La referència + versió introduïda ja existeix",e.add({severity:d?"success":"warn",summary:k,life:5e3}),d&&(C.value.referenceId=n.id,r.value=0,p.setNewReference(M()))};return(n,d)=>{var Q;const k=V("Button"),J=V("TabPanel"),oe=V("TabView"),ie=V("Dialog");return s(l)?(D(),S("main",Je,[t(Pe,{onSubmit:w}),Qe,t(xe,{details:(Q=s(l))==null?void 0:Q.details,onEdit:x,onDelete:le},{header:_(()=>[o("div",Xe,[Ye,o("div",null,[t(k,{size:"small",icon:s(j).PLUS,rounded:"",disabled:i.value,onClick:E},null,8,["icon","disabled"])])])]),_:1},8,["details"]),t(ie,{visible:a.visible,"onUpdate:visible":d[1]||(d[1]=W=>a.visible=W),header:a.title,closable:a.closable,modal:a.modal},{default:_(()=>[t(oe,{activeIndex:r.value,"onUpdate:activeIndex":d[0]||(d[0]=W=>r.value=W)},{default:_(()=>[t(J,{header:"Línea"},{default:_(()=>[t(Ke,{detail:C.value,onSubmit:F},null,8,["detail"])]),_:1}),t(J,{header:"Referencia"},{default:_(()=>[s(p).reference?(D(),H(ge,{key:0,reference:s(p).reference,onSubmit:se},null,8,["reference"])):O("",!0)]),_:1})]),_:1},8,["activeIndex"])]),_:1},8,["visible","header","closable","modal"])])):(D(),S("main",He,"Carregant albarà ..."))}}});export{_t as default};
