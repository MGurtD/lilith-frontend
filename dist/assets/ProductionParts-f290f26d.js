import{_ as de}from"./ExerciseDatePicker.vue_vue_type_script_setup_true_lang-c69170ed.js";import{d as ee,j as te,r as W,h as I,a as z,c as G,e as a,i as s,k as i,n as Y,s as H,y as A,l as re,g as ue,u as ce,x as pe,E as me,o as fe,P as T,K as S,w as k,G as ke,C as h,D as b}from"./index-8f350042.js";import{a as J,d as $,h as ve,_ as X,g as we}from"./functions-2e154ea4.js";import{u as be}from"./exercise-5a29a40b.js";import{u as he}from"./productionpart-79d9e4a0.js";import{u as oe}from"./plantmodel-ce1cde64.js";import{u as ae}from"./workorder-5d65746d.js";import{c as Ie,a as E,d as Z,F as ye}from"./form-validator-f8953ae6.js";import"./_commonjsHelpers-725317a4.js";import"./v4-a960c1f4.js";import"./index-9bb1cbdb.js";import"./base.service-642755fa.js";import"./reference.service-7e50bcf5.js";import"./index-d6682b3e.js";const Pe={key:0},Ce={class:"three-columns mt-2"},_e=a("label",{class:"block text-900 mb-2"},"Operari",-1),Oe=a("label",{class:"block text-900 mb-2"},"Màquina",-1),Ve=a("label",{class:"block text-900 mb-2"},"Data Tíquet",-1),ge={class:"mt-2"},De=a("label",{class:"block text-900 mb-2"},"Ordre Fabricació | Fase | Activitat",-1),qe={class:"three-columns mt-2"},Te=a("br",null,null,-1),Se={class:"flex-right"},$e=ee({__name:"FormProductionPart",props:{productionPart:{},avoidWorkOrderRefresh:{type:Boolean}},emits:["submit","cancel"],setup(K,{emit:N}){const u=K,F=te(),c=oe(),_=ae(),n=W(void 0),g=()=>{n.value.value&&(u.productionPart.workOrderId=n.value.value.workOrderId,u.productionPart.workOrderPhaseId=n.value.value.workOrderPhaseId,u.productionPart.workOrderPhaseDetailId=n.value.value.workOrderPhaseDetailId)},L=Ie().shape({operatorId:E().required("Escull un operari"),workcenterId:E().required("Escull una màquina"),workOrderId:E().required("Escull una ordre de fabricació"),workOrderPhaseId:E().required("Escull una fase"),workOrderPhaseDetailId:E().required("Escull una activitat"),quantity:Z().required("Has d'introduir una quantitat entera (pot ser 0)").integer(),workcenterTime:Z().required("Has d'introduir el temps de màquina i ha de ser major que 0").moreThan(0)}),y=W({result:!1,errors:{}}),p=()=>{const o=new ye(L);y.value=o.validate(u.productionPart)},O=async o=>{u.avoidWorkOrderRefresh||(n.value=void 0,await _.fetchByWorkcenterId(o))},R=async()=>{if(p(),y.value.result)N("submit",u.productionPart);else{let o="";Object.entries(y.value.errors).forEach(l=>{o+=`${l[1].map(P=>P)}.   `}),F.add({severity:"warn",summary:"Formulari inválid",detail:o,life:5e3})}};return(o,l)=>{var D,V,U;const P=I("Dropdown"),j=I("Calendar"),x=I("Button");return o.productionPart?(z(),G("form",Pe,[a("section",Ce,[a("div",null,[_e,s(P,{modelValue:o.productionPart.operatorId,"onUpdate:modelValue":l[0]||(l[0]=r=>o.productionPart.operatorId=r),editable:"",filter:!0,options:(D=i(c).operators)==null?void 0:D.sort((r,C)=>r.surname.localeCompare(C.surname)).map(r=>({value:r.id,label:r.name+" "+r.surname})),optionValue:"value",optionLabel:"label",class:Y(["w-full",{"p-invalid":y.value.errors.operatorid}])},null,8,["modelValue","options","class"])]),a("div",null,[Oe,s(P,{modelValue:o.productionPart.workcenterId,"onUpdate:modelValue":l[1]||(l[1]=r=>o.productionPart.workcenterId=r),editable:"",filter:!0,options:(V=i(c).workcenters)==null?void 0:V.sort((r,C)=>r.description.localeCompare(C.description)),optionValue:"id",optionLabel:"description",class:"w-full",onChange:l[2]||(l[2]=r=>O(o.productionPart.workcenterId))},null,8,["modelValue","options"])]),a("div",null,[Ve,s(j,{modelValue:o.productionPart.date,"onUpdate:modelValue":l[3]||(l[3]=r=>o.productionPart.date=r),dateFormat:"dd/mm/yy"},null,8,["modelValue"])])]),a("section",ge,[a("div",null,[De,s(P,{modelValue:n.value,"onUpdate:modelValue":l[4]||(l[4]=r=>n.value=r),editable:"",filter:!0,options:(U=i(_).detailedWorkOrders)==null?void 0:U.sort((r,C)=>r.workOrderCode.localeCompare(C.workOrderCode)).map(r=>({label:r.workOrderCode+"  ("+r.referenceDescription+") - "+r.workOrderPhaseCode+"  ("+r.workOrderPhaseDescription+") | "+r.machineStatusDescription,value:r})),optionLabel:"label",class:Y(["w-full",{"p-invalid":y.value.errors.workOrderId}]),onChange:g},null,8,["modelValue","options","class"])])]),a("section",qe,[a("div",null,[s(A,{type:i(H).NUMERIC,label:"Quantitat",id:"quantity",modelValue:o.productionPart.quantity,"onUpdate:modelValue":l[5]||(l[5]=r=>o.productionPart.quantity=r)},null,8,["type","modelValue"])]),a("div",null,[s(A,{type:i(H).NUMERIC,label:"Temps total operari (minuts)",id:"time",modelValue:o.productionPart.operatorTime,"onUpdate:modelValue":l[6]||(l[6]=r=>o.productionPart.operatorTime=r)},null,8,["type","modelValue"])]),a("div",null,[s(A,{type:i(H).NUMERIC,label:"Temps total centre de treball (minuts)",id:"time",modelValue:o.productionPart.workcenterTime,"onUpdate:modelValue":l[7]||(l[7]=r=>o.productionPart.workcenterTime=r)},null,8,["type","modelValue"])])]),Te,a("div",Se,[s(x,{label:"Guardar",size:"small",onClick:R})])])):re("",!0)}}}),Ee={class:"flex flex-wrap align-items-center justify-content-between gap-2"},Fe={class:"datatable-filter-5"},xe={class:"filter-field"},Ue={class:"filter-field"},Be=a("label",null,"Operari",-1),Me={class:"filter-field"},We=a("label",null,"Màquina",-1),Ne={class:"filter-field"},Le=a("label",null,"OF",-1),Re=["onClick"],je={key:0,class:"flex-right"},Qe=a("br",null,null,-1),lt=ee({__name:"ProductionParts",setup(K){const N=ue(),u=ce(),F=te(),c=he(),_=be(),n=oe(),g=ae(),L=pe(),y=()=>{var m;const e=new Date().getFullYear().toString(),t=(m=_.exercises)==null?void 0:m.find(v=>v.name===e);t&&(u.exercisePicker.exercise=t,u.exercisePicker.dates=[new Date(u.exercisePicker.exercise.startDate),new Date(u.exercisePicker.exercise.endDate)])},p=W({operatorId:"",workcenterId:"",workorderId:""}),O=async()=>{if(u.exercisePicker.dates){const e=J(u.exercisePicker.dates[0]),t=J(u.exercisePicker.dates[1]);await c.fetchFiltered(e,t,p.value.workcenterId,p.value.operatorId,p.value.workorderId),await g.fetchFiltered(e,t)}else F.add({severity:"info",summary:"Filtre invàlid",detail:"Seleccioni un període",life:5e3});console.log("store: ",c.productionParts)},R=()=>{u.cleanExercisePicker(),p.value.workcenterId="",p.value.operatorId=""},o=me({visible:!1,title:"Crear tíquet de producció",closable:!0,position:"center",modal:!0});fe(async()=>{u.setMenuItem({icon:T.CLOUD,title:"Tíquets de producció"}),n.fetchWorkcenters(),n.fetchOperators(),n.fetchOperatorTypes(),n.fetchMachineStatuses(),await n.fetchWorkcenterCosts(),await _.fetchActive(),y(),O(),g.detailedWorkOrders=void 0});const l=S(()=>{if(c.productionParts)return c.productionParts.map(e=>({...e,personalCost:le(e),workcenterCost:C(e)}))}),P=S(()=>{if(c.productionParts)return c.productionParts.reduce((e,t)=>e+t.workcenterTime,0)}),j=S(()=>{if(c.productionParts)return c.productionParts.reduce((e,t)=>e+t.quantity,0)}),x=S(()=>{if(l.value&&l.value.length>0)return l.value.reduce((e,t)=>e+(t.personalCost?t.personalCost:0),0)}),D=S(()=>{if(l.value&&l.value.length>0)return l.value.reduce((e,t)=>e+(t.workcenterCost?t.workcenterCost:0),0)}),V=W({}),U=()=>({id:we(),operatorId:"",workcenterId:"",workOrderId:"",workOrderPhaseId:"",workOrderPhaseDetailId:"",quantity:0,operatorTime:0,workcenterTime:0,date:new Date}),r=e=>{if(e.workOrder&&e.workOrderPhase&&e.workOrderPhaseDetail){const t=n.getMachineStatusNameById(e.workOrderPhaseDetail.machineStatusId);return`${e.workOrder.code} - ${e.workOrderPhase.code} (${e.workOrderPhase.description}) - ${t}`}},C=e=>{var m;if(!e.workOrderPhaseDetail)return 0;console.log(e);let t=(m=n.workcentercosts)==null?void 0:m.find(v=>v.workcenterId===e.workcenterId&&v.machineStatusId===e.workOrderPhaseDetail.machineStatusId);if(t){const v=t.cost*e.workcenterTime/60;return X.round(v,2)}return 0},le=e=>{var w,B;if(!e||e.operatorTime==0)return 0;let t=(w=n.operators)==null?void 0:w.find(q=>q.id===e.operatorId);if(!t)return 0;let m=(B=n.operatorTypes)==null?void 0:B.find(q=>q.id===(t==null?void 0:t.operatorTypeId));if(!m)return 0;const v=m.cost*e.operatorTime/60;return X.round(v,2)},se=()=>{V.value=U(),o.visible=!0},ie=async()=>{o.visible=!1,await c.create(V.value)&&(N.push({path:"/productionpart"}),O())},ne=(e,t)=>{L.require({target:e.currentTarget,message:"Està segur que vol eliminar el tíquet de producció?",icon:"pi pi-question-circle",acceptIcon:"pi pi-check",rejectIcon:"pi pi-times",accept:async()=>{await c.delete(t.id)&&(F.add({severity:"success",summary:"Eliminat",life:3e3}),await O())}})};return(e,t)=>{const m=I("Dropdown"),v=I("Button"),w=I("Column"),B=I("DataTable"),q=I("Dialog");return z(),G(ke,null,[s(B,{value:l.value,class:"p-datatable-sm small-datatable",tableStyle:"min-width: 100%",scrollable:"",scrollHeight:"80vh","sort-order":1,"sort-field":"date",paginator:"",rows:25},{header:k(()=>{var d,M;return[a("div",Ee,[a("div",Fe,[a("div",xe,[s(de,{exercises:i(_).exercises},null,8,["exercises"])]),a("div",Ue,[Be,s(m,{modelValue:p.value.operatorId,"onUpdate:modelValue":t[0]||(t[0]=f=>p.value.operatorId=f),editable:"",filter:!0,options:(d=i(n).operators)==null?void 0:d.sort((f,Q)=>f.surname.localeCompare(Q.surname)).map(f=>({value:f.id,label:f.surname+", "+f.name})),optionValue:"value",optionLabel:"label",class:"w-full"},null,8,["modelValue","options"])]),a("div",Me,[We,s(m,{modelValue:p.value.workcenterId,"onUpdate:modelValue":t[1]||(t[1]=f=>p.value.workcenterId=f),editable:"",filter:!0,options:(M=i(n).workcenters)==null?void 0:M.sort((f,Q)=>f.description.localeCompare(Q.description)),optionValue:"id",optionLabel:"description",class:"w-full"},null,8,["modelValue","options"])]),a("div",Ne,[Le,s(m,{modelValue:p.value.workorderId,"onUpdate:modelValue":t[2]||(t[2]=f=>p.value.workorderId=f),editable:"",filter:!0,options:i(g).workorders,optionValue:"id",optionLabel:"code",class:"w-full"},null,8,["modelValue","options"])]),a("div",null,[s(v,{class:"datatable-button mr-2",icon:i(T).FILTER,rounded:"",raised:"",onClick:O},null,8,["icon"]),s(v,{class:"datatable-button mr-2",icon:i(T).FILTER_SLASH,rounded:"",raised:"",onClick:R},null,8,["icon"]),s(v,{icon:i(T).PLUS,rounded:"",raised:"",onClick:se},null,8,["icon"])])])])]}),empty:k(()=>[h(" No s'han trobat tiquets. ")]),loading:k(()=>[h(" Carregant tiquets. Si us plau espera. ")]),footer:k(()=>[l.value&&l.value.length>0?(z(),G("div",je,[a("span",null,[h(" Temps: "+b(P.value)+" minuts / Quantitat: "+b(j.value)+" unitats ",1),Qe,h(" Cost operari: "+b(i($)(x.value))+" / Cost màquina: "+b(i($)(D.value))+" = "+b(i($)(x.value+D.value)),1)])])):re("",!0)]),default:k(()=>[s(w,{field:"operatorId",header:"Operari",style:{width:"15%"}},{body:k(d=>[h(b(i(n).getOperatorNameById(d.data.operatorId)),1)]),_:1}),s(w,{field:"workcenterId",header:"Màquina",style:{width:"15%"}},{body:k(d=>[h(b(i(n).getWorkcenterNameById(d.data.workcenterId)),1)]),_:1}),s(w,{field:"workOrderId",header:"OF",style:{width:"20%"}},{body:k(d=>[h(b(r(d.data)),1)]),_:1}),s(w,{field:"date",header:"Data",style:{width:"15%"},sortable:""},{body:k(d=>[h(b(i(ve)(d.data.date)),1)]),_:1}),s(w,{field:"quantity",header:"Quantitat",style:{width:"5%"}}),s(w,{field:"time",header:"Temps (min)",style:{width:"10%"}}),s(w,{header:"Cost Operari",style:{width:"10%"},field:"personalCost"},{body:k(d=>[h(b(i($)(d.data.personalCost)),1)]),_:1}),s(w,{header:"Cost Màquina",style:{width:"10%"},field:"workcenterCost"},{body:k(d=>[h(b(i($)(d.data.workcenterCost)),1)]),_:1}),s(w,{style:{width:"5%"}},{body:k(d=>[a("i",{class:Y([i(T).TIMES,"grid_delete_column_button"]),onClick:M=>ne(M,d.data)},null,10,Re)]),_:1})]),_:1},8,["value"]),s(q,{visible:o.visible,"onUpdate:visible":t[3]||(t[3]=d=>o.visible=d),header:o.title,closable:o.closable,modal:o.modal},{default:k(()=>[s($e,{productionPart:V.value,"avoid-work-order-refresh":!1,onSubmit:ie},null,8,["productionPart"])]),_:1},8,["visible","header","closable","modal"])],64)}}});export{lt as default};
