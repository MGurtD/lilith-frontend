import{d as Q,g as j,u as A,j as G,$ as W,r as u,o as Y,P as S,a0 as $,h as p,m as q,w as m,k as h,a as z,e as n,i,G as K,H as J,O as C}from"./index-aa781fed.js";import{u as X}from"./workorder-f2c6ca40.js";import{S as Z}from"./suppliers.service-ff88bd8a.js";import{u as ee}from"./reference-4f638e26.js";import{u as re}from"./masterData-35870077.js";import{u as se}from"./order-95142003.js";import{_ as ae}from"./ExerciseDatePicker.vue_vue_type_script_setup_true_lang-e6a08d4c.js";import"./index-97a3f172.js";import"./index-14004411.js";const te={class:"flex flex-wrap align-items-center justify-content-between gap-2"},oe=n("span",{class:"text-xl text-900 font-bold"},"Seleccionar fases",-1),ie={class:"datatable-filter-3"},ne={class:"filter-field"},ce={class:"datatable-buttons"},de=n("div",{class:"flex flex-wrap align-items-center justify-content-between gap-2"},[n("div")],-1),ke=Q({__name:"PhaseToPurchaseOrder",setup(le){const T=j(),o=A(),v=G(),c=X(),y=new Z("/supplier"),g=ee(),x=re(),B=se(),b=W(),l=u([]),w=u({}),D=u({}),P=u([]),F=(e,r)=>{v.add({severity:"info",summary:e,detail:r,life:5e3})},E=()=>{if(o.exercisePicker.dates){const e=C(o.exercisePicker.dates[0]),r=C(o.exercisePicker.dates[1]);return[e,r]}return["",""]},f=u({}),N=(e,r)=>{V(e.id,r),r?l.value.push(e):l.value=l.value.filter((s,t)=>s.id!==e.id)},V=(e,r)=>{var t;(((t=c.workorderPhases)==null?void 0:t.findIndex(a=>a.id===e))!==-1||P.value.find(k=>k.phaseId===e))&&(f.value[e]=r)},O=async()=>{if(!o.exercisePicker.dates){F("Filtre Invàlid","Seleccioni un perióde");return}const[e,r]=E();r!=""&&(await c.fetchExternalPhases(e,r),await H())};Y(async()=>{o.setMenuItem({icon:S.SHOPPING_CART,title:"Generació de comandes de compra"}),await x.fetchMasterData(),await g.fetchReferences(),I(),U()});const H=async()=>{const e=await y.getAll();if(c.workorderPhases&&c.workorderPhases.length>0){for(const r of c.workorderPhases)if(r&&r.serviceReferenceId!=null){const s=await y.getSuppliersReferenceById(r.serviceReferenceId);s===null?e&&(w.value[r.id]=e):w.value[r.id]=s}}};$(()=>{const e={exercisePicker:o.exercisePicker};b.addFilter("ExternalPhasesToPurhcaseOrders","",e)});const U=()=>{const e=b.getFilter("ExternalPhasesToPurhcaseOrders","");e&&e.exercisePicker&&(o.exercisePicker.exercise=e.exercisePicker.exercise,o.exercisePicker.dates=[new Date(e.exercisePicker.dates[0]),new Date(e.exercisePicker.dates[1])])},I=()=>{var s;const e=new Date().getFullYear().toString(),r=(s=x.exercises)==null?void 0:s.find(t=>t.name===e);r&&(o.exercisePicker.exercise=r,o.exercisePicker.dates=[new Date(o.exercisePicker.exercise.startDate),new Date(o.exercisePicker.exercise.endDate)])},L=()=>{I()},R=e=>g.getFullNameById(e)||"Desconeguda",M=async()=>{var r,s,t;if(l.value.length==0){F("OFs no seleccionades","Has de seleccionar una OF com a mínim");return}for(const a of l.value)console.log((r=a.workOrder)==null?void 0:r.id," - ",f.value[a.id]),P.value.push({workorderId:((s=a.workOrder)==null?void 0:s.id)||"",workorderDescription:a.description||"",phaseId:a.id,phaseDescription:a.description,serviceReferenceId:a.serviceReferenceId||"",serviceReferenceName:R(a.serviceReferenceId||""),supplierId:f.value[a.id],quantity:((t=a.workOrder)==null?void 0:t.plannedQuantity)||0});(await B.createFromWo(P.value)).result?(v.add({severity:"success",summary:"Creació comandes",detail:"Comandes creades correctament",life:5e3}),T.push("/purchase-orders")):v.add({severity:"error",summary:"Error creació",detail:"Error al crear la comanda",life:5e3})};return(e,r)=>{const s=p("Button"),t=p("Column"),a=p("Dropdown"),k=p("DataTable");return z(),q(k,{value:h(c).workorderPhases,class:"p-datatable-sm small-datatable",tableStyle:"min-width: 100%",scrollable:"",scrollHeight:"79vh","sort-order":1,"sort-field":"date",paginator:"",rows:25,dataKey:"id"},{header:m(()=>[n("div",te,[oe,n("div",ie,[n("div",ne,[i(ae,{exercises:h(x).exercises,onRangeSelected:O},null,8,["exercises"])])]),n("div",ce,[i(s,{class:"datatable-button mr-2",icon:h(S).FILTER,rounded:"",raised:"",onClick:O},null,8,["icon"]),i(s,{class:"datatable-button mr-2",icon:h(S).FILTER_SLASH,rounded:"",raised:"",onClick:L},null,8,["icon"]),i(s,{size:"small",label:"Crear comandes",rounded:"",onClick:M})])]),de]),default:m(()=>[i(t,{field:"workOrder.code",header:"Ordre de fabricació"}),i(t,{field:"description",header:"Fase",style:{width:"15%"}}),i(t,{header:"Referència"},{body:m(d=>[K(J(R(d.data.serviceReferenceId)),1)]),_:1}),i(t,{field:"workOrder.plannedQuantity",header:"Quantitat planificada"}),i(t,{header:"Proveïdor"},{body:m(d=>[i(a,{modelValue:D.value[d.data.id],"onUpdate:modelValue":_=>D.value[d.data.id]=_,options:w.value[d.data.id],placeholder:"Selecciona...",optionValue:"id",optionLabel:"comercialName",onChange:_=>N(d.data,_.value),showClear:""},null,8,["modelValue","onUpdate:modelValue","options","onChange"])]),_:1})]),_:1},8,["value"])}}});export{ke as default};
