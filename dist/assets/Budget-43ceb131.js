import{d as z,x as de,h as f,a as b,m as P,w as p,Q as ue,i as s,G as C,H as h,k as e,R,c as x,n as j,P as U,l as I,j as K,C as Q,r as k,e as c,s as N,D as H,p as ce,b as me,f as pe,F as _,v as fe,g as be,u as ve,E as _e,o as ye,Y as ge,L as De,J as we}from"./index-aa781fed.js";import{u as Se}from"./reference-4f638e26.js";import{u as Y}from"./customers-cddcd1f1.js";import{u as Ce}from"./plantmodel-6c89097d.js";import{u as Z}from"./lifecycle-727a59bd.js";import{u as he}from"./tax-1191b2c1.js";import{a as Ie,b as Te}from"./report.service-25608734.js";import{S as Ee}from"./index-c39ba2d8.js";import{u as Ve}from"./workmaster-bce9482c.js";import{u as X}from"./budget-684c5c31.js";import{L as Be}from"./LinkReference-f90d29bf.js";import{c as ke,a as G,F as xe}from"./form-validator-ef8c3cb9.js";import{_ as Fe}from"./FormBudgetOrderDetail.vue_vue_type_script_setup_true_lang-a3dc8ce5.js";import{u as Re}from"./order-a76e83a2.js";import"./index-97a3f172.js";import"./DropdownReference.vue_vue_type_script_setup_true_lang-27729c3c.js";const Ae=["onClick"],Le=z({__name:"TableBudgetDetails",props:{budget:{},details:{}},emits:["edit","delete"],setup(T,{emit:D}){const E=de(),V=X(),B=d=>{d.originalEvent.target.className.includes("grid_delete_column_button")||D("edit",d.data)},F=(d,t)=>{E.require({target:d.currentTarget,message:"Está segur que vol eliminar la línea?",icon:"pi pi-question-circle",acceptIcon:"pi pi-check",rejectIcon:"pi pi-times",accept:()=>{D("delete",t)}})};return(d,t)=>{const m=f("Column"),v=f("DataTable");return b(),P(v,{onRowClick:B,value:d.details,tableStyle:"min-width: 100%",class:"p-datatable-sm",sortMode:"single",sortField:"reference.code",selectionMode:"single",dataKey:"id",sortOrder:1},{header:p(()=>[ue(d.$slots,"header")]),default:p(()=>[s(m,{field:"quantity",header:"Un.",style:{width:"3%"}}),s(m,{header:"Referencia",field:"reference.code",sortable:"",style:{width:"15%"}},{body:p(l=>[s(Be,{id:l.data.referenceId},null,8,["id"])]),_:1}),s(m,{field:"description",header:"Descripció",style:{width:"25%"}}),s(m,{header:"Cost intern",style:{width:"10%"}},{body:p(l=>[C(h(e(R)(l.data.totalCost-l.data.serviceCost-l.data.transportCost)),1)]),_:1}),s(m,{header:"Cost extern",style:{width:"10%"}},{body:p(l=>[C(h(e(R)(l.data.serviceCost+l.data.transportCost)),1)]),_:1}),s(m,{field:"totalCost",header:"Cost total",style:{width:"10%"}},{body:p(l=>[C(h(e(R)(l.data.totalCost)),1)]),_:1}),s(m,{field:"profit",header:"Benefici",style:{width:"10%"}},{body:p(l=>[C(h(l.data.profit)+" % ",1)]),_:1}),s(m,{field:"discount",header:"Descompte",style:{width:"10%"}},{body:p(l=>[C(h(l.data.discount)+" % ",1)]),_:1}),s(m,{field:"unitPrice",header:"Preu un.",style:{width:"10%"}},{body:p(l=>[C(h(e(R)(l.data.unitPrice)),1)]),_:1}),s(m,{field:"amount",header:"Total",style:{width:"10%"}},{body:p(l=>[C(h(e(R)(l.data.amount)),1)]),_:1}),s(m,{style:{width:"5%"}},{body:p(l=>[e(V).order===void 0?(b(),x("i",{key:0,class:j([e(U).TIMES,"grid_delete_column_button"]),onClick:A=>F(A,l.data)},null,10,Ae)):I("",!0)]),_:1})]),_:3},8,["value"])}}}),O=T=>(ce("data-v-b9221a78"),T=T(),me(),T),$e={key:0},Me={class:"four-columns mt-2"},Ne=O(()=>c("label",{class:"block text-900 mb-2"},"Data Alta",-1)),Pe=O(()=>c("label",{class:"block text-900 mb-2"},"Data Acceptació",-1)),Ue={class:"three-columns mt-2"},Oe=O(()=>c("label",{class:"block text-900 mb-2"},"Estat",-1)),qe=O(()=>c("label",{class:"block text-900 mb-2"},"Client",-1)),Ge={key:0,class:"mt-2"},je=z({__name:"FormBudget",emits:["submit","cancel"],setup(T,{expose:D,emit:E}){const V=X(),B=Y(),F=Z(),d=K(),{budget:t}=Q(V),m=ke().shape({customerId:G().required("El client es obligatori"),statusId:G().required("L'estat es obligatori"),exerciseId:G().required("L'exercici es obligatori")}),v=k({result:!1,errors:{}}),l=()=>{const w=new xe(m);v.value=w.validate(t.value)};D({submitForm:async()=>{if(l(),v.value.result)q(),E("submit",t.value);else{let w="";Object.entries(v.value.errors).forEach(n=>{w+=`${n[1].map(y=>y)}.   `}),d.add({severity:"warn",summary:"Formulari inválid",detail:w,life:5e3})}}});const q=()=>{t.value&&(t.value.date=H(t.value.date),t.value.acceptanceDate&&(t.value.acceptanceDate=H(t.value.acceptanceDate)))};return(w,n)=>{var g,S;const y=f("BaseInput"),r=f("Calendar"),L=f("Dropdown");return b(),x("div",null,[e(t)?(b(),x("form",$e,[c("section",Me,[c("div",null,[s(y,{type:e(N).TEXT,label:"Pressupost",id:"number",modelValue:e(t).number,"onUpdate:modelValue":n[0]||(n[0]=i=>e(t).number=i),disabled:""},null,8,["type","modelValue"])]),c("div",null,[Ne,s(r,{modelValue:e(t).date,"onUpdate:modelValue":n[1]||(n[1]=i=>e(t).date=i),dateFormat:"dd/mm/yy"},null,8,["modelValue"])]),c("div",null,[Pe,s(r,{modelValue:e(t).acceptanceDate,"onUpdate:modelValue":n[2]||(n[2]=i=>e(t).acceptanceDate=i),dateFormat:"dd/mm/yy"},null,8,["modelValue"])]),c("div",null,[s(y,{type:e(N).TEXT,disabled:!0,label:"Comanda",value:(g=e(V).order)==null?void 0:g.number},null,8,["type","value"])])]),c("section",Ue,[c("div",null,[Oe,s(L,{modelValue:e(t).statusId,"onUpdate:modelValue":n[3]||(n[3]=i=>e(t).statusId=i),editable:"",options:(S=e(F).lifecycle)==null?void 0:S.statuses,optionValue:"id",optionLabel:"name",class:j(["w-full",{"p-invalid":v.value.errors.statusId}])},null,8,["modelValue","options","class"])]),c("div",null,[qe,s(L,{modelValue:e(t).customerId,"onUpdate:modelValue":n[4]||(n[4]=i=>e(t).customerId=i),editable:"",options:e(B).customers,optionValue:"id",optionLabel:"comercialName",class:j(["w-full",{"p-invalid":v.value.errors.customerId}])},null,8,["modelValue","options","class"])]),c("div",null,[s(y,{type:e(N).NUMERIC,label:"Dies entrega",id:"deliveryDays",modelValue:e(t).deliveryDays,"onUpdate:modelValue":n[5]||(n[5]=i=>e(t).deliveryDays=i)},null,8,["type","modelValue"])])]),e(t).notes&&e(t).notes.length>0?(b(),x("section",Ge,[c("div",null,[s(y,{type:e(N).TEXT,label:"Notes",id:"notes",modelValue:e(t).notes,"onUpdate:modelValue":n[6]||(n[6]=i=>e(t).notes=i),disabled:""},null,8,["type","modelValue"])])])):I("",!0)])):I("",!0)])}}});const ze=pe(je,[["__scopeId","data-v-b9221a78"]]),Xe={class:"flex flex-wrap align-items-center justify-content-between gap-2"},Je=c("span",{class:"text-l text-900 font-bold"},"Linies del pressupost",-1),We={key:0},He="Línia del pressupost",mt=z({__name:"Budget",setup(T){const D=k(_.EDIT),E=k(),V=fe(),B=be(),F=ve(),d=K(),t=X(),m=Y(),v=Ce(),l=_e(),A=Z(),q=Se(),w=Ve(),n=he(),y=Re(),{budget:r}=Q(t),L=[{label:"Descarregar",icon:U.FILE_WORD,command:()=>re()},{label:"Crear comanda",icon:U.FLAG_FILL,command:()=>le()}],g=k(!1),S=k(_.EDIT),i=k(void 0),ee=async()=>{const o=V.params.id;await t.GetById(o),await t.GetAssociatedSalesOrders(o),q.fetchReferencesByModule("sales"),w.fetchAllActives(),A.fetchOneByName("Budget"),v.fetchSites(),l.fetchAll(),m.fetchCustomers(),n.fetchAll();let a="";r.value&&(D.value=_.EDIT,a=`Pressupost ${r.value.number}`),F.setMenuItem({icon:U.BUILDING,backButtonVisible:!0,title:a})};ye(async()=>{await ee()});const te=()=>{var a;if(!((a=r.value)!=null&&a.date))return d.add({severity:"error",summary:"Error al crear la comanda ",detail:"La data no pot estar buida",life:5e3}),!1;E.value.submitForm()},J=(o,a)=>{o===_.CREATE&&(a={id:we(),referenceId:"",workMasterId:null,profit:0,productionProfit:0,materialProfit:25,externalProfit:25,discount:0,quantity:1,unitCost:0,productionCost:0,materialCost:0,unitPrice:0,serviceCost:0,transportCost:0,totalCost:0,amount:0,budgetId:r.value.id,description:""}),i.value=Object.assign({},a),S.value=o,g.value=!0},ae=async o=>{let a=!1,u="";a=await t.Update(o.id,o),u=a?"Pressupost actualitzat correctament":"Error a l'actualitzar el pressupost",d.add({life:5e3,severity:a?"success":"error",summary:u}),a&&B.back()},oe=async o=>{if(o=o,S.value===_.CREATE)await t.CreateDetail(o);else if(S.value===_.EDIT){await t.UpdateDetail(o);const a=r.value.details.findIndex(u=>u.id===o.id);r.value.details[a]=o}g.value=!1},se=async o=>{D.value===_.EDIT&&await t.DeleteDetail(o);const a=r.value.details.filter(u=>u.id!==o.id);r.value.details=a,g.value=!1},le=async()=>{var o,a;if(t.order){d.add({severity:"warn",summary:"Aquest pressupost ja té una comanda associada",life:5e3});return}if(r.value){const u=await y.CreateFromBudget(r.value);u.result?(d.add({severity:"success",summary:`Comanda ${(o=u.content)==null?void 0:o.number} creada correctament`,life:5e3}),B.push(`/salesorder/${(a=u.content)==null?void 0:a.id}`)):d.add({severity:"error",summary:"Error al crear la comanda ",detail:u.errors[0],life:5e3})}},re=async()=>{var a;const o=await Ee.Budget.GetReportDataById(r.value.id);if(o){const u=`Pressupost_${(a=r.value)==null?void 0:a.number}.docx`,$=await new Te().Download(o,Ie.Budget,u);$?ge(u,$):d.add({severity:"warn",summary:"Error",detail:"No s'ha pugut generar fulla del pressupost"})}};return(o,a)=>{const u=f("SplitButton"),W=f("Button"),$=f("TabPanel"),ne=f("TabView"),ie=f("Dialog");return b(),x(De,null,[s(u,{label:"Guardar",onClick:te,model:L,size:"small",class:"grid_add_row_button"}),s(ze,{class:"mt-3 mb-3",ref_key:"budgetForm",ref:E,onSubmit:ae},null,512),s(ne,null,{default:p(()=>[s($,{header:"Detall"},{default:p(()=>[e(r)&&e(r).details?(b(),P(Le,{key:0,budget:e(r),details:e(r).details,onEdit:a[1]||(a[1]=M=>J(e(_).EDIT,M)),onDelete:se},{header:p(()=>[c("div",Xe,[Je,e(t).order?I("",!0):(b(),x("section",We,[s(W,{size:"small",label:"Afegir línea",onClick:a[0]||(a[0]=M=>J(e(_).CREATE,{})),class:"mr-2"})]))])]),_:1},8,["budget","details"])):I("",!0)]),_:1})]),_:1}),e(r)?(b(),P(ie,{key:0,closable:!0,style:{width:"100%"},maximizable:!0,visible:g.value,"onUpdate:visible":a[2]||(a[2]=M=>g.value=M),header:He,modal:!0},{default:p(()=>[e(r)&&i.value?(b(),P(Fe,{key:0,formAction:S.value,header:e(r),detail:i.value,readonly:!1,onSubmit:oe},null,8,["formAction","header","detail"])):I("",!0)]),_:1},8,["visible"])):I("",!0)],64)}}});export{mt as default};
