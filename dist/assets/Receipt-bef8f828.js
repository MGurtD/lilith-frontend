import{d as q,j as W,C as se,o as J,r as N,h as w,a as U,c as A,i as e,k as s,e as a,s as S,z as C,n as Q,l as j,D as ge,p as oe,b as ie,f as ne,m as X,w as f,Q as we,G as $,H as F,R as Ve,P as Y,u as re,T as de,I as M,J as L,x as Re,v as Ie,K as ae,F as B,V as Se}from"./index-797fdaef.js";import{u as Z}from"./receipt-6bce3d6d.js";import{u as Ce}from"./suppliers-67f9982a.js";import{u as ue}from"./lifecycle-eb1cb5ae.js";import{c as ce,a as z,F as me,d as De}from"./form-validator-7fd5796d.js";import{u as Te}from"./masterData-bde952f2.js";import{L as ke}from"./LinkReference-c23d7b15.js";import{_ as Ee}from"./DropdownReference.vue_vue_type_script_setup_true_lang-ade55987.js";import{_ as Ne}from"./FormMaterial.vue_vue_type_script_setup_true_lang-6d0fa852.js";import{u as pe}from"./reference-0fda136f.js";import{R as H}from"./index-7cbe1881.js";import{u as Ue}from"./order-47fd53d7.js";import{u as xe}from"./referenceType-03dfac3b.js";import"./index-d23a55e8.js";import"./suppliers.service-1de8564a.js";import"./DropdownReferenceType.vue_vue_type_script_setup_true_lang-13cc6075.js";import"./tax-493df904.js";const P=y=>(oe("data-v-70931d13"),y=y(),ie(),y),Fe=P(()=>a("br",null,null,-1)),$e={key:0},Ae={class:"three-columns"},Oe={class:"mt-1"},Be={class:"mt-1"},Me=P(()=>a("label",{class:"block text-900 mb-2"},"Exercici",-1)),Le={class:"mt-1"},qe=P(()=>a("label",{class:"block text-900 mb-2"},"Data Albarà",-1)),Pe={class:"three-columns"},Qe={class:"mt-1"},ze=P(()=>a("label",{class:"block text-900 mb-2"},"Estat",-1)),We={class:"mt-1"},je=P(()=>a("label",{class:"block text-900 mb-2"},"Proveïdor",-1)),Ge={class:"mt-1"},Ke=q({__name:"FormReceipt",emits:["submit","cancel"],setup(y,{expose:D,emit:v}){const T=Z(),b=Ce(),_=Te(),m=ue(),c=W(),{receipt:n}=se(T);J(async()=>{await _.fetchMasterData(),await b.fetchSuppliers(),await m.fetchOneByName("Receipts")});const o=ce().shape({supplierId:z().required("El client es obligatori"),statusId:z().required("L'estat es obligatori"),exerciseId:z().required("L'exercici es obligatori")}),t=N({result:!1,errors:{}}),u=()=>{const l=new me(o);t.value=l.validate(n.value)},g=async()=>{if(u(),t.value.result)n.value.date=ge(n.value.date),v("submit",n.value);else{let l="";Object.entries(t.value.errors).forEach(i=>{l+=`${i[1].map(p=>p)}.   `}),c.add({severity:"warn",summary:"Formulari inválid",detail:l,life:5e3})}};return D({submitForm:g}),(l,i)=>{var E;const p=w("Button"),V=w("Dropdown"),R=w("Calendar");return U(),A("div",null,[e(p,{label:"Guardar",size:"small",class:"grid_add_row_button",onClick:g}),Fe,s(n)?(U(),A("form",$e,[a("section",Ae,[a("div",Oe,[e(C,{type:s(S).TEXT,label:"Número",id:"number",modelValue:s(n).number,"onUpdate:modelValue":i[0]||(i[0]=h=>s(n).number=h),disabled:""},null,8,["type","modelValue"])]),a("div",Be,[Me,e(V,{modelValue:s(n).exerciseId,"onUpdate:modelValue":i[1]||(i[1]=h=>s(n).exerciseId=h),editable:"",options:s(_).exercises,optionValue:"id",optionLabel:"name",class:Q(["w-full",{"p-invalid":t.value.errors.exerciseId}])},null,8,["modelValue","options","class"])]),a("div",Le,[qe,e(R,{modelValue:s(n).date,"onUpdate:modelValue":i[2]||(i[2]=h=>s(n).date=h),dateFormat:"dd/mm/yy"},null,8,["modelValue"])])]),a("section",Pe,[a("div",Qe,[ze,e(V,{modelValue:s(n).statusId,"onUpdate:modelValue":i[3]||(i[3]=h=>s(n).statusId=h),editable:"",options:(E=s(m).lifecycle)==null?void 0:E.statuses,optionValue:"id",optionLabel:"name",class:Q(["w-full",{"p-invalid":t.value.errors.statusId}])},null,8,["modelValue","options","class"])]),a("div",We,[je,e(V,{modelValue:s(n).supplierId,"onUpdate:modelValue":i[4]||(i[4]=h=>s(n).supplierId=h),editable:"",options:s(b).suppliers,optionValue:"id",optionLabel:"comercialName",class:Q(["w-full",{"p-invalid":t.value.errors.customerId}])},null,8,["modelValue","options","class"])]),a("div",Ge,[e(C,{type:s(S).TEXT,label:"Número Albarà",id:"supplierNumber",modelValue:s(n).supplierNumber,"onUpdate:modelValue":i[5]||(i[5]=h=>s(n).supplierNumber=h)},null,8,["type","modelValue"])])])])):j("",!0)])}}});const He=ne(Ke,[["__scopeId","data-v-70931d13"]]),Je=["onClick"],Xe=q({__name:"TableReceiptDetails",props:{details:{}},emits:["edit","delete"],setup(y,{emit:D}){const v=y,T=_=>{_.originalEvent.target.className.includes("grid_delete_column_button")||D("edit",_.data)},b=(_,m)=>{D("delete",m)};return(_,m)=>{const c=w("Column"),n=w("DataTable");return U(),X(n,{onRowClick:T,value:v.details,tableStyle:"min-width: 100%",class:"p-datatable-sm","sort-mode":"single","sort-field":"reference.code","sort-order":1},{header:f(()=>[we(_.$slots,"header")]),default:f(()=>[e(c,{field:"quantity",header:"Quantitat",style:{width:"7.5%"}}),e(c,{sortable:"",header:"Material",field:"reference.code",style:{width:"25%"}},{body:f(({data:o})=>[e(ke,{id:o.referenceId,"full-name":!0},null,8,["id"])]),_:1}),e(c,{field:"width",header:"Amplada",style:{width:"7.5%"}}),e(c,{field:"height",header:"Alçada",style:{width:"7.5%"}}),e(c,{field:"lenght",header:"Longitud",style:{width:"7.5%"}}),e(c,{field:"thickness",header:"Gruix",style:{width:"7.5%"}}),e(c,{field:"diameter",header:"Diàmetre",style:{width:"7.5%"}}),e(c,{field:"totalWeight",header:"Pes",style:{width:"7.5%"}},{body:f(o=>[$(F(o.data.totalWeight)+" KG",1)]),_:1}),e(c,{field:"amount",header:"Preu",style:{width:"7.5%"}},{body:f(o=>[$(F(s(Ve)(o.data.amount)),1)]),_:1}),e(c,{style:{width:"5%"}},{body:f(o=>[o.data.stockMovementId===null?(U(),A("i",{key:0,class:Q([s(Y).TIMES,"grid_delete_column_button"]),onClick:t=>b(t,o.data)},null,10,Je)):j("",!0)]),_:1})]),_:3},8,["value"])}}}),Ye={key:0},Ze={class:"two-columns-7525"},et={class:"three-columns mt-2"},tt={class:"three-columns mt-2"},lt={class:"two-columns mt-2"},at=q({__name:"FormReceiptDetail",props:{detail:{}},emits:["submit","cancel"],setup(y,{emit:D}){const v=y,T=W(),b=Z(),_=async()=>{const t=await b.calculateDetailWeightAndPrice(v.detail);t.result?(v.detail.unitWeight=t.content.unitWeight,v.detail.totalWeight=t.content.totalWeight,v.detail.unitPrice=t.content.unitPrice,v.detail.amount=t.content.amount):T.add({summary:"Calculadora de pes/preu",detail:t.errors[0],severity:"warn",life:6e3})},m=ce().shape({quantity:De().min(1).required("La quantitat ha de ser superior a 1"),referenceId:z().required("La referencia és obligatoria")}),c=N({result:!1,errors:{}}),n=()=>{const t=new me(m);c.value=t.validate(v.detail)},o=async()=>{if(n(),c.value.result)D("submit",v.detail);else{let t="";Object.entries(c.value.errors).forEach(u=>{t+=`${u[1].map(g=>g)}.   `}),T.add({severity:"warn",summary:"Formulari inválid",detail:t,life:5e3})}};return(t,u)=>{const g=w("Button");return t.detail?(U(),A("form",Ye,[a("section",Ze,[a("div",null,[e(Ee,{label:"Material",modelValue:t.detail.referenceId,"onUpdate:modelValue":u[0]||(u[0]=l=>t.detail.referenceId=l),fullName:!0},null,8,["modelValue"])]),a("div",null,[e(C,{type:s(S).CURRENCY,label:"Preu / Kilo",highlightOnFocus:"",modelValue:t.detail.kilogramPrice,"onUpdate:modelValue":u[1]||(u[1]=l=>t.detail.kilogramPrice=l)},null,8,["type","modelValue"])])]),a("section",et,[a("div",null,[e(C,{type:s(S).NUMERIC,highlightOnFocus:"",label:"Amplada (mm)",decimals:2,modelValue:t.detail.width,"onUpdate:modelValue":u[2]||(u[2]=l=>t.detail.width=l)},null,8,["type","modelValue"])]),a("div",null,[e(C,{type:s(S).NUMERIC,decimals:2,label:"Alçada (mm)",highlightOnFocus:"",modelValue:t.detail.height,"onUpdate:modelValue":u[3]||(u[3]=l=>t.detail.height=l)},null,8,["type","modelValue"])]),a("div",null,[e(C,{type:s(S).NUMERIC,decimals:2,label:"Longitud (mm)",highlightOnFocus:"",modelValue:t.detail.lenght,"onUpdate:modelValue":u[4]||(u[4]=l=>t.detail.lenght=l)},null,8,["type","modelValue"])])]),a("section",tt,[a("div",null,[e(C,{type:s(S).NUMERIC,decimals:2,label:"Diàmetre (mm)",highlightOnFocus:"",modelValue:t.detail.diameter,"onUpdate:modelValue":u[5]||(u[5]=l=>t.detail.diameter=l)},null,8,["type","modelValue"])]),a("div",null,[e(C,{type:s(S).NUMERIC,decimals:2,label:"Gruix (mm)",highlightOnFocus:"",modelValue:t.detail.thickness,"onUpdate:modelValue":u[6]||(u[6]=l=>t.detail.thickness=l)},null,8,["type","modelValue"])]),a("div",null,[e(C,{type:s(S).NUMERIC,decimals:2,label:"Pes (kg)",modelValue:t.detail.totalWeight,"onUpdate:modelValue":u[7]||(u[7]=l=>t.detail.totalWeight=l)},null,8,["type","modelValue"])])]),a("section",lt,[a("div",null,[e(C,{type:s(S).NUMERIC,label:"Quantitat",highlightOnFocus:"",modelValue:t.detail.quantity,"onUpdate:modelValue":u[8]||(u[8]=l=>t.detail.quantity=l)},null,8,["type","modelValue"])]),a("div",null,[e(C,{type:s(S).CURRENCY,label:"Preu",modelValue:t.detail.amount,"onUpdate:modelValue":u[9]||(u[9]=l=>t.detail.amount=l)},null,8,["type","modelValue"])])]),e(g,{label:"Crear",onClick:o,style:{float:"right"},size:"small",class:"mt-2"}),e(g,{label:"Calcular",onClick:_,style:{float:"right"},size:"small",class:"mt-2 mr-2"})])):j("",!0)}}}),st=y=>(oe("data-v-23245ad9"),y=y(),ie(),y),ot={class:"selector-filter"},it={class:"selector-filter-field"},nt=st(()=>a("label",{for:""},"Buscar",-1)),rt=q({__name:"SelectorOrdersDetailsToReceipt",props:{receipt:{},orders:{}},emits:["selected"],setup(y,{emit:D}){const v=y,T=W(),b=re(),_=pe(),m=N([]),c=N({}),n=N(""),o=N([]),t=de(()=>{var l=[];return m.value&&(l=m.value.filter(i=>i.details.some(p=>_.getFullNameById(p.referenceId).includes(n.value.toLowerCase())))),l}),u=()=>{c.value=m.value.reduce((l,i)=>(l[i.id]=!0,l),{})};J(()=>{if(!v.orders){console.error("No orders to show");return}m.value=v.orders.map(l=>({...l,details:l.details.map(i=>({...i,pendingQuantity:i.quantity-i.receivedQuantity}))})),u()});const g=()=>{if(o.value.length===0){T.add({severity:"warn",summary:"Selecció inválida",detail:"Selecciona alguna línia per afegir-la a l'albarà",life:6e3});return}const l={receiptId:v.receipt.id,receptions:o.value.map(i=>{var p;return{receiptDetailId:L(),purchaseOrderDetailId:i.id,quantity:i.pendingQuantity,user:(p=b.user)==null?void 0:p.username}})};D("selected",l)};return(l,i)=>{const p=w("InputText"),V=w("Button"),R=w("Column"),E=w("InputNumber"),h=w("DataTable");return U(),X(h,{class:"p-datatable-sm",tableStyle:"min-width: 100%",scrollable:"",scrollHeight:"75vh",dataKey:"id",expandedRows:c.value,"onUpdate:expandedRows":i[2]||(i[2]=k=>c.value=k),value:t.value},{header:f(()=>[a("header",ot,[a("div",it,[nt,$("   "),e(p,{style:{width:"150px",height:"35px"},modelValue:n.value,"onUpdate:modelValue":i[0]||(i[0]=k=>n.value=k),size:"small"},null,8,["modelValue"])]),a("div",null,[a("div",null,[e(V,{onClick:g,size:"small",icon:s(Y).CHECK_SQUARE,label:"Afegir"},null,8,["icon"])])])])]),expansion:f(k=>[e(h,{class:"p-datatable-sm",value:k.data.details,selection:o.value,"onUpdate:selection":i[1]||(i[1]=I=>o.value=I)},{default:f(()=>[e(R,{selectionMode:"multiple",headerStyle:"width: 2rem"}),e(R,{header:"Referència",headerStyle:"width: 50%"},{body:f(({data:I})=>[$(F(s(_).getFullNameById(I.reference.id)),1)]),_:1}),e(R,{header:"Qtt. total",headerStyle:"width: 20%"},{body:f(({data:I})=>[$(F(I.quantity),1)]),_:1}),e(R,{header:"Qtt. rebuda",headerStyle:"width: 20%"},{body:f(({data:I})=>[$(F(I.receivedQuantity),1)]),_:1}),e(R,{header:"A recepcionar",headerStyle:"width: 20%"},{body:f(({data:I})=>[e(E,{size:"small",modelValue:I.pendingQuantity,"onUpdate:modelValue":G=>I.pendingQuantity=G,min:0,max:I.pendingQuantity},null,8,["modelValue","onUpdate:modelValue","max"])]),_:1})]),_:2},1032,["value","selection"])]),default:f(()=>[e(R,{expander:"",style:{width:"5%"}}),e(R,{header:"",field:"number",style:{width:"80%"}},{body:f(k=>[a("b",null,"Comanda "+F(k.data.number)+" | Data prevista "+F(s(M)(k.data.date)),1)]),_:1})]),_:1},8,["expandedRows","value"])}}});const dt=ne(rt,[["__scopeId","data-v-23245ad9"]]),ut={key:0},ct=a("br",null,null,-1),mt={class:"flex flex-wrap align-items-center justify-content-between gap-2"},pt=a("span",{class:"text-xl text-900 font-bold"},"Detall de l'albarà",-1),ft={class:"flex flex-wrap align-items-center justify-content-between gap-2"},vt={key:1},xt=q({__name:"Receipt",setup(y){const D=Re(),v=Ie(),T=re(),b=pe(),_=xe(),m=Z(),c=Ue(),n=ue(),{receipt:o}=se(m),t=N(0),u=async()=>{var r;await m.fetchReceipt(v.params.id),n.fetchOneByName("Receipts"),b.fetchReferencesByModule("purchase"),_.fetchActive(),o.value&&(o.value.date=M(o.value.date)),T.setMenuItem({icon:Y.BUILDING,title:`Albarà de recepció ${(r=o.value)==null?void 0:r.number}`,backButtonVisible:!0})};J(async()=>{await u()});const g=W(),l=de(()=>{var d;if(!n.lifecycle)return!1;const r=n.lifecycle.statuses.find(x=>x.name==="Recepcionat");return r?((d=o.value)==null?void 0:d.statusId)===r.id:!1}),i=async()=>{let r=!1,d="";o.value&&(r=await m.updateReceipt(o.value.id,o.value),d="Albarà actualizat correctament",r&&(g.add({severity:"success",summary:d,life:5e3}),Se.back()))},p=ae({visible:!1,title:"Linea",closable:!0,position:"center",modal:!0}),V=ae({visible:!1,title:"Selecció de comandes",closable:!0,position:"center",modal:!0}),R=N(B.CREATE),E=N({}),h=()=>{R.value=B.CREATE,E.value={id:L(),receiptId:o.value.id,amount:0,diameter:0,height:0,kilogramPrice:0,lenght:0,quantity:1,thickness:0,totalWeight:0,unitPrice:0,unitWeight:0,width:0,disabled:!1},b.setNewReference(L(),H.MATERIAL),p.title="Crear línia",p.visible=!0},k=r=>{R.value=B.EDIT,E.value=r,b.setNewReference(L(),H.MATERIAL),p.title="Modificar línia",p.visible=!0},I=r=>{R.value===B.CREATE?G(r):R.value===B.EDIT&&fe(r),p.visible=!1},G=async r=>{const d=await m.createReceiptDetail(r);o.value.date=M(o.value.date),d.result||K(d)},fe=async r=>{const d=await m.updateReceiptDetail(r.id,r);o.value.date=M(o.value.date),d.result||K(d)},ve=async r=>{D.require({message:"Está segur que vols la línia?",icon:"pi pi-question-circle",acceptIcon:"pi pi-check",rejectIcon:"pi pi-times",accept:async()=>{const d=await m.deleteReceiptDetail(r.id);o.value.date=M(o.value.date),d.result||K(d)}})},K=r=>{g.add({severity:"error",summary:r.errors[0],life:1e4,closable:!0})},be=async r=>{let d=!1,x="";d=await b.createReference(r),d?x="Referència creada correctament":x="La referència + versió introduïda ja existeix",g.add({severity:d?"success":"warn",summary:x,life:5e3}),d&&(E.value.referenceId=r.id,t.value=0,b.setNewReference(L(),H.MATERIAL))},he=async()=>{await c.fetchOrdersToReceiptBySupplier(o.value.supplierId),V.visible=!0},ye=async r=>{V.visible=!1;const d=await m.addReceptions(r);d.result?(g.add({severity:"success",summary:"Recepcions afegides correctament",life:5e3}),m.fetchReceipt(r.receiptId)):g.add({severity:"error",summary:d.errors[0],life:1e4,closable:!0})};return(r,d)=>{var le;const x=w("Button"),ee=w("Dialog"),te=w("TabPanel"),_e=w("TabView");return s(o)?(U(),A("main",ut,[e(He,{onSubmit:i}),ct,e(Xe,{details:(le=s(o))==null?void 0:le.details,onEdit:k,onDelete:ve},{header:f(()=>[a("div",mt,[pt,a("div",ft,[a("div",null,[e(x,{size:"small",label:"Afegir de comanda",disabled:l.value,onClick:he},null,8,["disabled"])]),a("div",null,[e(x,{size:"small",label:"Afegir línia",disabled:l.value,onClick:h},null,8,["disabled"])])])])]),_:1},8,["details"]),e(ee,{visible:V.visible,"onUpdate:visible":d[0]||(d[0]=O=>V.visible=O),header:V.title,closable:V.closable,modal:V.modal,style:{width:"50vw"}},{default:f(()=>[e(dt,{receipt:s(o),orders:s(c).ordersToReceipt,onSelected:ye},null,8,["receipt","orders"])]),_:1},8,["visible","header","closable","modal"]),e(ee,{visible:p.visible,"onUpdate:visible":d[2]||(d[2]=O=>p.visible=O),header:p.title,closable:p.closable,modal:p.modal},{default:f(()=>[e(_e,{activeIndex:t.value,"onUpdate:activeIndex":d[1]||(d[1]=O=>t.value=O)},{default:f(()=>[e(te,{header:"Línea"},{default:f(()=>[e(at,{detail:E.value,onSubmit:I},null,8,["detail"])]),_:1}),e(te,{header:"Referencia"},{default:f(()=>[s(b).reference?(U(),X(Ne,{key:0,reference:s(b).reference,onSubmit:be},null,8,["reference"])):j("",!0)]),_:1})]),_:1},8,["activeIndex"])]),_:1},8,["visible","header","closable","modal"])])):(U(),A("main",vt,"Carregant albarà ..."))}}});export{xt as default};
