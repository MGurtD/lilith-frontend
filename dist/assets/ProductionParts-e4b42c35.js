import{_ as ne}from"./ExerciseDatePicker.vue_vue_type_script_setup_true_lang-628d83b2.js";import{d as X,j as Z,r as W,h as I,a as Q,c as H,e as r,i as l,k as n,n as A,s as G,y as Y,l as ee,g as de,u as ue,x as ce,E as pe,o as me,P as S,K as T,w as v,G as fe,C as b,D as h}from"./index-64fee6e6.js";import{a as K,d as $,h as ve,_ as we,g as ke}from"./functions-2e154ea4.js";import{u as he}from"./exercise-c26f1feb.js";import{u as be}from"./productionpart-8ec49755.js";import{u as te}from"./plantmodel-13c630e1.js";import{u as oe}from"./workorder-c497cf68.js";import{c as Ie,a as x,d as J,F as ye}from"./form-validator-f8953ae6.js";import"./_commonjsHelpers-725317a4.js";import"./v4-a960c1f4.js";import"./index-93e66ee5.js";import"./base.service-0fa5a61f.js";import"./reference.service-10b4f35b.js";import"./index-af0e943c.js";const Pe={key:0},Ce={class:"three-columns mt-2"},_e=r("label",{class:"block text-900 mb-2"},"Operari",-1),Oe=r("label",{class:"block text-900 mb-2"},"Màquina",-1),ge=r("label",{class:"block text-900 mb-2"},"Data Tíquet",-1),Ve={class:"mt-2"},De=r("label",{class:"block text-900 mb-2"},"Ordre Fabricació | Fase | Activitat",-1),qe={class:"two-columns mt-2"},Se=r("br",null,null,-1),Te={class:"flex-right"},$e=X({__name:"FormProductionPart",props:{productionPart:{},avoidWorkOrderRefresh:{type:Boolean}},emits:["submit","cancel"],setup(z,{emit:M}){const u=z,F=Z(),w=te(),_=oe(),i=W(void 0),V=()=>{i.value.value&&(u.productionPart.workOrderId=i.value.value.workOrderId,u.productionPart.workOrderPhaseId=i.value.value.workOrderPhaseId,u.productionPart.workOrderPhaseDetailId=i.value.value.workOrderPhaseDetailId)},N=Ie().shape({operatorId:x().required("Escull un operari"),workcenterId:x().required("Escull una màquina"),workOrderId:x().required("Escull una ordre de fabricació"),workOrderPhaseId:x().required("Escull una fase"),workOrderPhaseDetailId:x().required("Escull una activitat"),quantity:J().required("Has d'introduir una quantitat entera (pot ser 0)").integer(),time:J().required("Has d'introduir el temps i ha de ser major que 0").moreThan(0)}),y=W({result:!1,errors:{}}),c=()=>{const a=new ye(N);y.value=a.validate(u.productionPart)},O=async a=>{u.avoidWorkOrderRefresh||(i.value=void 0,await _.fetchByWorkcenterId(a))},L=async()=>{if(c(),y.value.result)M("submit",u.productionPart);else{let a="";Object.entries(y.value.errors).forEach(s=>{a+=`${s[1].map(P=>P)}.   `}),F.add({severity:"warn",summary:"Formulari inválid",detail:a,life:5e3})}};return(a,s)=>{var D,g,B;const P=I("Dropdown"),R=I("Calendar"),E=I("Button");return a.productionPart?(Q(),H("form",Pe,[r("section",Ce,[r("div",null,[_e,l(P,{modelValue:a.productionPart.operatorId,"onUpdate:modelValue":s[0]||(s[0]=o=>a.productionPart.operatorId=o),editable:"",filter:!0,options:(D=n(w).operators)==null?void 0:D.sort((o,C)=>o.surname.localeCompare(C.surname)).map(o=>({value:o.id,label:o.name+" "+o.surname})),optionValue:"value",optionLabel:"label",class:A(["w-full",{"p-invalid":y.value.errors.operatorid}])},null,8,["modelValue","options","class"])]),r("div",null,[Oe,l(P,{modelValue:a.productionPart.workcenterId,"onUpdate:modelValue":s[1]||(s[1]=o=>a.productionPart.workcenterId=o),editable:"",filter:!0,options:(g=n(w).workcenters)==null?void 0:g.sort((o,C)=>o.description.localeCompare(C.description)),optionValue:"id",optionLabel:"description",class:"w-full",onChange:s[2]||(s[2]=o=>O(a.productionPart.workcenterId))},null,8,["modelValue","options"])]),r("div",null,[ge,l(R,{modelValue:a.productionPart.date,"onUpdate:modelValue":s[3]||(s[3]=o=>a.productionPart.date=o),dateFormat:"dd/mm/yy"},null,8,["modelValue"])])]),r("section",Ve,[r("div",null,[De,l(P,{modelValue:i.value,"onUpdate:modelValue":s[4]||(s[4]=o=>i.value=o),editable:"",filter:!0,options:(B=n(_).detailedWorkOrders)==null?void 0:B.sort((o,C)=>o.workOrderCode.localeCompare(C.workOrderCode)).map(o=>({label:o.workOrderCode+"  ("+o.referenceDescription+") - "+o.workOrderPhaseCode+"  ("+o.workOrderPhaseDescription+") | "+o.machineStatusDescription,value:o})),optionLabel:"label",class:A(["w-full",{"p-invalid":y.value.errors.workOrderId}]),onChange:V},null,8,["modelValue","options","class"])])]),r("section",qe,[r("div",null,[l(Y,{type:n(G).NUMERIC,label:"Quantitat",id:"quantity",modelValue:a.productionPart.quantity,"onUpdate:modelValue":s[5]||(s[5]=o=>a.productionPart.quantity=o)},null,8,["type","modelValue"])]),r("div",null,[l(Y,{type:n(G).NUMERIC,label:"Temps total (minuts)",id:"time",modelValue:a.productionPart.time,"onUpdate:modelValue":s[6]||(s[6]=o=>a.productionPart.time=o)},null,8,["type","modelValue"])])]),Se,r("div",Te,[l(E,{label:"Guardar",size:"small",onClick:L})])])):ee("",!0)}}}),xe={class:"flex flex-wrap align-items-center justify-content-between gap-2"},Fe={class:"datatable-filter-5"},Ee={class:"filter-field"},Be={class:"filter-field"},Ue=r("label",null,"Operari",-1),We={class:"filter-field"},Me=r("label",null,"Màquina",-1),Ne={class:"filter-field"},Le=r("label",null,"OF",-1),Re=["onClick"],je={key:0,class:"flex-right"},Qe=r("br",null,null,-1),st=X({__name:"ProductionParts",setup(z){const M=de(),u=ue(),F=Z(),w=be(),_=he(),i=te(),V=oe(),N=ce(),y=()=>{var p;const e=new Date().getFullYear().toString(),t=(p=_.exercises)==null?void 0:p.find(m=>m.name===e);t&&(u.exercisePicker.exercise=t,u.exercisePicker.dates=[new Date(u.exercisePicker.exercise.startDate),new Date(u.exercisePicker.exercise.endDate)])},c=W({operatorId:"",workcenterId:"",workorderId:""}),O=async()=>{if(u.exercisePicker.dates){const e=K(u.exercisePicker.dates[0]),t=K(u.exercisePicker.dates[1]);await w.fetchFiltered(e,t,c.value.workcenterId,c.value.operatorId,c.value.workorderId),await V.fetchFiltered(e,t)}else F.add({severity:"info",summary:"Filtre invàlid",detail:"Seleccioni un període",life:5e3})},L=()=>{u.cleanExercisePicker(),c.value.workcenterId="",c.value.operatorId=""},a=pe({visible:!1,title:"Crear tíquet de producció",closable:!0,position:"center",modal:!0});me(async()=>{u.setMenuItem({icon:S.CLOUD,title:"Tíquets de producció"}),i.fetchWorkcenters(),i.fetchOperators(),i.fetchOperatorTypes(),i.fetchMachineStatuses(),await i.fetchWorkcenterCosts(),await _.fetchActive(),y(),O(),V.detailedWorkOrders=void 0});const s=T(()=>{if(w.productionParts)return w.productionParts.map(e=>({...e,personalCost:re(e),workcenterCost:C(e)}))}),P=T(()=>{if(w.productionParts)return w.productionParts.reduce((e,t)=>e+t.time,0)}),R=T(()=>{if(w.productionParts)return w.productionParts.reduce((e,t)=>e+t.quantity,0)}),E=T(()=>{if(s.value&&s.value.length>0)return s.value.reduce((e,t)=>e+(t.personalCost?t.personalCost:0),0)}),D=T(()=>{if(s.value&&s.value.length>0)return s.value.reduce((e,t)=>e+(t.workcenterCost?t.workcenterCost:0),0)}),g=W({}),B=()=>({id:ke(),operatorId:"",workcenterId:"",workOrderId:"",workOrderPhaseId:"",workOrderPhaseDetailId:"",time:0,quantity:0,date:new Date}),o=e=>{if(e.workOrder&&e.workOrderPhase&&e.workOrderPhaseDetail){const t=i.getMachineStatusNameById(e.workOrderPhaseDetail.machineStatusId);return`${e.workOrder.code} - ${e.workOrderPhase.code} (${e.workOrderPhase.description}) - ${t}`}},C=e=>{var p;if(!e.workOrderPhaseDetail)return 0;console.log(e);let t=(p=i.workcentercosts)==null?void 0:p.find(m=>m.workcenterId===e.workcenterId&&m.machineStatusId===e.workOrderPhaseDetail.machineStatusId);if(t){const m=t.cost*e.time/60;return we.round(m,2)}return 0},re=e=>{var m,k;let t=(m=i.operators)==null?void 0:m.find(q=>q.id===e.operatorId),p=(k=i.operatorTypes)==null?void 0:k.find(q=>q.id===(t==null?void 0:t.operatorTypeId));return p?p.cost*e.time/60:0},ae=()=>{g.value=B(),a.visible=!0},se=async()=>{a.visible=!1,await w.create(g.value)&&(M.push({path:"/productionpart"}),O())},le=(e,t)=>{N.require({target:e.currentTarget,message:"Està segur que vol eliminar el tíquet de producció?",icon:"pi pi-question-circle",acceptIcon:"pi pi-check",rejectIcon:"pi pi-times",accept:async()=>{await w.delete(t.id)&&(F.add({severity:"success",summary:"Eliminat",life:3e3}),await O())}})};return(e,t)=>{const p=I("Dropdown"),m=I("Button"),k=I("Column"),q=I("DataTable"),ie=I("Dialog");return Q(),H(fe,null,[l(q,{value:s.value,class:"p-datatable-sm small-datatable",tableStyle:"min-width: 100%",scrollable:"",scrollHeight:"80vh","sort-order":1,"sort-field":"date",paginator:"",rows:25},{header:v(()=>{var d,U;return[r("div",xe,[r("div",Fe,[r("div",Ee,[l(ne,{exercises:n(_).exercises},null,8,["exercises"])]),r("div",Be,[Ue,l(p,{modelValue:c.value.operatorId,"onUpdate:modelValue":t[0]||(t[0]=f=>c.value.operatorId=f),editable:"",filter:!0,options:(d=n(i).operators)==null?void 0:d.sort((f,j)=>f.surname.localeCompare(j.surname)).map(f=>({value:f.id,label:f.surname+", "+f.name})),optionValue:"value",optionLabel:"label",class:"w-full"},null,8,["modelValue","options"])]),r("div",We,[Me,l(p,{modelValue:c.value.workcenterId,"onUpdate:modelValue":t[1]||(t[1]=f=>c.value.workcenterId=f),editable:"",filter:!0,options:(U=n(i).workcenters)==null?void 0:U.sort((f,j)=>f.description.localeCompare(j.description)),optionValue:"id",optionLabel:"description",class:"w-full"},null,8,["modelValue","options"])]),r("div",Ne,[Le,l(p,{modelValue:c.value.workorderId,"onUpdate:modelValue":t[2]||(t[2]=f=>c.value.workorderId=f),editable:"",filter:!0,options:n(V).workorders,optionValue:"id",optionLabel:"code",class:"w-full"},null,8,["modelValue","options"])]),r("div",null,[l(m,{class:"datatable-button mr-2",icon:n(S).FILTER,rounded:"",raised:"",onClick:O},null,8,["icon"]),l(m,{class:"datatable-button mr-2",icon:n(S).FILTER_SLASH,rounded:"",raised:"",onClick:L},null,8,["icon"]),l(m,{icon:n(S).PLUS,rounded:"",raised:"",onClick:ae},null,8,["icon"])])])])]}),empty:v(()=>[b(" No s'han trobat tiquets. ")]),loading:v(()=>[b(" Carregant tiquets. Si us plau espera. ")]),footer:v(()=>[s.value&&s.value.length>0?(Q(),H("div",je,[r("span",null,[b(" Temps: "+h(P.value)+" minuts / Quantitat: "+h(R.value)+" unitats ",1),Qe,b(" Cost operari: "+h(n($)(E.value))+" / Cost màquina: "+h(n($)(D.value))+" = "+h(n($)(E.value+D.value)),1)])])):ee("",!0)]),default:v(()=>[l(k,{field:"operatorId",header:"Operari",style:{width:"15%"}},{body:v(d=>[b(h(n(i).getOperatorNameById(d.data.operatorId)),1)]),_:1}),l(k,{field:"workcenterId",header:"Màquina",style:{width:"15%"}},{body:v(d=>[b(h(n(i).getWorkcenterNameById(d.data.workcenterId)),1)]),_:1}),l(k,{field:"workOrderId",header:"OF",style:{width:"20%"}},{body:v(d=>[b(h(o(d.data)),1)]),_:1}),l(k,{field:"date",header:"Data",style:{width:"15%"},sortable:""},{body:v(d=>[b(h(n(ve)(d.data.date)),1)]),_:1}),l(k,{field:"quantity",header:"Quantitat",style:{width:"5%"}}),l(k,{field:"time",header:"Temps (min)",style:{width:"10%"}}),l(k,{header:"Cost Operari",style:{width:"10%"},field:"personalCost"},{body:v(d=>[b(h(n($)(d.data.personalCost)),1)]),_:1}),l(k,{header:"Cost Màquina",style:{width:"10%"},field:"workcenterCost"},{body:v(d=>[b(h(n($)(d.data.workcenterCost)),1)]),_:1}),l(k,{style:{width:"5%"}},{body:v(d=>[r("i",{class:A([n(S).TIMES,"grid_delete_column_button"]),onClick:U=>le(U,d.data)},null,10,Re)]),_:1})]),_:1},8,["value"]),l(ie,{visible:a.visible,"onUpdate:visible":t[3]||(t[3]=d=>a.visible=d),header:a.title,closable:a.closable,modal:a.modal},{default:v(()=>[l($e,{productionPart:g.value,"avoid-work-order-refresh":!1,onSubmit:se},null,8,["productionPart"])]),_:1},8,["visible","header","closable","modal"])],64)}}});export{st as default};
