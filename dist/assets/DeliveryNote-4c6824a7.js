import{d as U,r as V,V as C,h as N,a as I,m as E,w as b,e as d,G as B,i,k as f,P as F,H as g,I as R,p as K,b as J,f as W,j as X,c as L,z as G,n as z,l as M,D as se,s as le,x as ie,Q as de,R as q,F as Q,v as ne,g as ue,u as ce,C as me,Y as ve,o as fe,L as pe}from"./index-31e65974.js";import{u as Y}from"./customers-d0b6aeb7.js";import{u as Z}from"./lifecycle-8b24f7fb.js";import{u as ye}from"./masterData-9718928b.js";import{c as be,a as x,F as _e}from"./form-validator-98408db2.js";import{L as he}from"./LinkReference-60929ab3.js";import{u as Ne}from"./reference-043713ab.js";import{u as De}from"./plantmodel-0a75363b.js";import{u as Se}from"./deliveryNote-41d155fd.js";import{u as we}from"./order-cdc691dc.js";import{S as ge}from"./index-142a8147.js";import{a as Ie,b as Oe}from"./report.service-7ab56341.js";import"./index-f118885c.js";const Ve=p=>(K("data-v-8f6728d6"),p=p(),J(),p),Ce={class:"selector-filter"},Te={class:"selector-filter-field"},Be=Ve(()=>d("label",{for:""},"Buscar",-1)),ke={class:"selector-filter-button"},$e={class:"flex align-items-center gap-2"},xe=U({__name:"SelectorOrders",props:{orders:{},headerVisible:{type:Boolean}},emits:["selected"],setup(p,{emit:w}){const m=p,n=V([]),h=V(""),O=C(()=>{if(h.value==="")return m.orders||[];var e=[];return m.orders&&(e=m.orders.filter(a=>a.number.includes(h.value)||a.customerNumber.includes(h.value))),e}),_=()=>{if(n.value.length===0)return;const e=n.value;w("selected",e)};return(e,a)=>{const t=N("InputText"),u=N("Button"),s=N("Column"),o=N("DataTable");return I(),E(o,{class:"small-datatable",tableStyle:"min-width: 100%",scrollable:"",scrollHeight:"75vh",metaKeySelection:!1,value:O.value,selectionMode:"multiple",selection:n.value,"onUpdate:selection":a[1]||(a[1]=r=>n.value=r)},{header:b(()=>[d("header",Ce,[d("div",Te,[Be,B("   "),i(t,{style:{width:"150px",height:"35px"},modelValue:h.value,"onUpdate:modelValue":a[0]||(a[0]=r=>h.value=r),size:"small"},null,8,["modelValue"])]),d("div",ke,[i(u,{onClick:_,size:"small",icon:f(F).CHECK_SQUARE},null,8,["icon"])])])]),groupheader:b(r=>[d("div",$e,[d("b",null,"Comanda "+g(r.data.number)+" - "+g(f(R)(r.data.date)),1)])]),default:b(()=>[i(s,{selectionMode:"multiple",style:{width:"3%"}}),i(s,{header:"Número",field:"number",style:{width:"10%"}}),i(s,{header:"Número client",field:"customerNumber",style:{width:"20%"}}),i(s,{header:"Data",field:"date",style:{width:"10%"}},{body:b(r=>[B(g(f(R)(r.data.date)),1)]),_:1})]),_:1},8,["value","selection"])}}});const Ee=W(xe,[["__scopeId","data-v-8f6728d6"]]),j=p=>(K("data-v-f0037178"),p=p(),J(),p),Fe={key:0},Re={class:"three-columns"},Le={class:"mt-1"},Me={class:"mt-1"},Ue=j(()=>d("label",{class:"block text-900 mb-2"},"Client",-1)),Ae={class:"mt-2"},Ge={class:"three-columns"},qe={class:"mt-2"},ze=j(()=>d("label",{class:"block text-900 mb-2"},"Estat",-1)),je={class:"mt-2"},He=j(()=>d("label",{class:"block text-900 mb-2"},"Data Entrega",-1)),Pe={class:"mt-2"},Qe=U({__name:"FormDeliveryNote",props:{deliveryNote:{}},emits:["submit","cancel"],setup(p,{expose:w,emit:m}){const n=p,h=Y();ye();const O=Z(),_=X(),e=C(()=>n.deliveryNote&&n.deliveryNote.salesInvoice?n.deliveryNote.salesInvoice.invoiceNumber:""),a=C(()=>n.deliveryNote&&n.deliveryNote.createdOn?R(n.deliveryNote.createdOn):""),t=be().shape({siteId:x().required("L'origen es obligatori"),customerId:x().required("El client es obligatori"),statusId:x().required("L'estat es obligatori"),exerciseId:x().required("L'exercici es obligatori")}),u=V({result:!1,errors:{}}),s=()=>{const r=new _e(t);u.value=r.validate(n.deliveryNote)};return w({submitForm:async()=>{if(s(),u.value.result)n.deliveryNote.deliveryDate&&(n.deliveryNote.deliveryDate=se(n.deliveryNote.deliveryDate)),m("submit",n.deliveryNote);else{let r="";Object.entries(u.value.errors).forEach(v=>{r+=`${v[1].map(D=>D)}.   `}),_.add({severity:"warn",summary:"Formulari inválid",detail:r,life:5e3})}}}),(r,v)=>{var T;const D=N("Dropdown"),k=N("Calendar");return I(),L("div",null,[r.deliveryNote?(I(),L("form",Fe,[d("section",Re,[d("div",Le,[i(G,{type:f(le).TEXT,label:"Número Albarà",id:"salesOrderNumber",modelValue:r.deliveryNote.number,"onUpdate:modelValue":v[0]||(v[0]=y=>r.deliveryNote.number=y),disabled:""},null,8,["type","modelValue"])]),d("div",Me,[Ue,i(D,{modelValue:r.deliveryNote.customerId,"onUpdate:modelValue":v[1]||(v[1]=y=>r.deliveryNote.customerId=y),editable:"",options:f(h).customers,optionValue:"id",optionLabel:"comercialName",class:z(["w-full",{"p-invalid":u.value.errors.customerId}])},null,8,["modelValue","options","class"])]),d("div",Ae,[i(G,{modelValue:a.value,"onUpdate:modelValue":v[2]||(v[2]=y=>a.value=y),label:"Data Creació",disabled:!0},null,8,["modelValue"])])]),d("section",Ge,[d("div",qe,[ze,i(D,{modelValue:r.deliveryNote.statusId,"onUpdate:modelValue":v[3]||(v[3]=y=>r.deliveryNote.statusId=y),editable:"",options:(T=f(O).lifecycle)==null?void 0:T.statuses,optionValue:"id",optionLabel:"name",class:z(["w-full",{"p-invalid":u.value.errors.statusId}])},null,8,["modelValue","options","class"])]),d("div",je,[He,i(k,{modelValue:r.deliveryNote.deliveryDate,"onUpdate:modelValue":v[4]||(v[4]=y=>r.deliveryNote.deliveryDate=y),dateFormat:"dd/mm/yy",class:"mt-2"},null,8,["modelValue"])]),d("div",Pe,[i(G,{modelValue:e.value,"onUpdate:modelValue":v[5]||(v[5]=y=>e.value=y),label:"Número de factura",disabled:!0},null,8,["modelValue"])])])])):M("",!0)])}}});const Ke=W(Qe,[["__scopeId","data-v-f0037178"]]),Je=["onClick"],We={class:"vertical-align-middle ml-2 font-bold line-height-3"},Xe={class:"flex-right"},Ye=U({__name:"TableDeliveryNoteDetails",props:{orders:{},canDelete:{type:Boolean}},emits:["delete"],setup(p,{emit:w}){const m=p,n=C(()=>{if(!m.orders)return[];let e=[];for(let a=0;a<m.orders.length;a++){if(!m.orders[a].salesOrderDetails)continue;const t=m.orders[a];t.salesOrderDetails.forEach(u=>{e.push({salesOrderId:t.id,salesOrderNumber:t.number,salesOrderDate:t.date,customerNumber:t.customerNumber,...u})})}return e}),h=ie(),O=(e,a)=>{var u;if(!m.orders)return;const t=(u=m.orders)==null?void 0:u.find(s=>s.id===a.salesOrderId);t&&h.require({target:e.currentTarget,message:`Está segur que vol desassignar la comanda ${t.number}?`,icon:"pi pi-question-circle",acceptIcon:"pi pi-check",rejectIcon:"pi pi-times",accept:()=>{w("delete",t)}})},_=C(()=>m.orders?m.orders.reduce((e,a)=>a.salesOrderDetails?e+a.salesOrderDetails.reduce((t,u)=>t+u.amount,0):e,0):0);return(e,a)=>{const t=N("Column"),u=N("DataTable");return I(),E(u,{value:n.value,tableStyle:"min-width: 100%",class:"p-datatable-sm",rowGroupMode:"subheader",groupRowsBy:"salesOrderNumber",sortMode:"multiple",sortOrder:1,scrollable:"",scrollHeight:"60vh"},{header:b(()=>[de(e.$slots,"header")]),groupheader:b(s=>[e.canDelete?(I(),L("i",{key:0,class:z([f(F).TIMES,"grid_delete_column_button"]),onClick:o=>O(o,s.data)},null,10,Je)):M("",!0),B("   "),d("span",We,"Comanda "+g(s.data.salesOrderNumber)+" (Núm. Client: "+g(s.data.customerNumber)+")",1)]),footer:b(()=>[d("div",Xe,[d("span",null," Total: "+g(f(q)(_.value)),1)])]),default:b(()=>[i(t,{field:"salesOrderNumber",header:"Comanda",style:{width:"5%"}}),i(t,{field:"",header:"",style:{width:"2%"}}),i(t,{field:"quantity",header:"Quantitat",style:{width:"5%"}}),i(t,{header:"Referència",field:"reference.code",sortable:"",style:{width:"15%"}},{body:b(s=>[i(he,{id:s.data.referenceId},null,8,["id"])]),_:1}),i(t,{field:"description",header:"Descripció",style:{width:"30%"}}),i(t,{field:"unitPrice",header:"Preu un.",style:{width:"10%"}},{body:b(s=>[B(g(f(q)(s.data.unitPrice)),1)]),_:1}),i(t,{field:"amount",header:"Total",style:{width:"10%"}},{body:b(s=>[B(g(f(q)(s.data.amount)),1)]),_:1})]),_:3},8,["value"])}}}),Ze={class:"flex flex-wrap align-items-center justify-content-between gap-2"},et=d("span",{class:"text-l text-900 font-bold"},"Linies de l'albarà",-1),tt="Selector de comandes",pt=U({__name:"DeliveryNote",setup(p){const w=V(),m=V(Q.EDIT),n=ne(),h=ue(),O=ce(),_=Se(),e=we(),a=Y(),t=De(),u=Ne(),s=Z(),{deliveryNote:o}=me(_),r=[{label:"Descarregar",icon:F.FILE_WORD,command:()=>v()}],v=async()=>{var l;const c=await ge.DeliveryNote.GetReportDataById(o.value.id);if(c){const S=`AlbaraEntrega_${(l=o.value)==null?void 0:l.number}.docx`,$=await new Oe().Download(c,Ie.DeliveryNote,S);$?ve(S,$):A.add({severity:"warn",summary:"Error",detail:"No s'ha pugut generar fulla de la comanda"})}},D=V(!1),k=V(""),T=C(()=>{if(!s.lifecycle||!s.lifecycle.statuses||o.value&&o.value.salesInvoiceId&&o.value.salesInvoiceId!==null)return!1;const c=s.lifecycle.statuses.find(l=>l.name==="Entregat");return c?c.id!==k.value:!1}),y=async()=>{const c=n.params.id;await _.GetById(c),k.value=_.deliveryNote.statusId,await e.GetByDeliveryNote(c),u.fetchReferencesByModule("sales"),t.fetchSites(),a.customers||a.fetchCustomers(),s.lifecycle||s.fetchOneByName("DeliveryNote");let l="";o.value&&(m.value=Q.EDIT,l=`Albarà d'entrega ${o.value.number}`,o.value.deliveryDate&&(o.value.deliveryDate=R(o.value.deliveryDate))),O.setMenuItem({icon:F.BUILDING,backButtonVisible:!0,title:l})};fe(async()=>{await y()});const ee=()=>{var l;if(!((l=o.value)!=null&&l.createdOn))return A.add({severity:"error",summary:"Error al crear la comanda ",detail:"La data no pot estar buida",life:5e3}),!1;w.value.submitForm()},A=X(),te=async c=>{let l=!1,S="";l=await _.Update(c.id,c),S=l?"Albarà actualitzat":"Error al actualitzar l'albarà",A.add({life:5e3,severity:l?"success":"error",summary:S}),l&&h.back()},oe=async()=>{o.value&&await e.GetToDeliver(o.value.customerId),D.value=!0},re=async c=>{for(let l=0;l<c.length;l++){const S=c[l];await _.AddOrder(o.value.id,S)}await e.GetByDeliveryNote(o.value.id),D.value=!1},ae=async c=>{await _.DeleteOrder(o.value.id,c),await e.GetByDeliveryNote(o.value.id)};return(c,l)=>{const S=N("SplitButton"),H=N("Button"),$=N("Dialog");return I(),L(pe,null,[i(S,{label:"Guardar",onClick:ee,model:r,size:"small",class:"grid_add_row_button"}),f(o)?(I(),E(Ke,{key:0,class:"mt-3 mb-3",ref_key:"deliveryNoteForm",ref:w,deliveryNote:f(o),onSubmit:te},null,8,["deliveryNote"])):M("",!0),f(o)?(I(),E(Ye,{key:1,orders:f(e).salesOrders,canDelete:T.value,onDelete:ae},{header:b(()=>[d("div",Ze,[et,d("div",null,[i(H,{disabled:!T.value,size:"small",label:"Afegir comanda",onClick:l[0]||(l[0]=P=>oe())},null,8,["disabled"])])])]),_:1},8,["orders","canDelete"])):M("",!0),i($,{closable:!0,visible:D.value,"onUpdate:visible":l[1]||(l[1]=P=>D.value=P),header:tt,modal:!0,style:{width:"50rem"},breakpoints:{"1199px":"75vw","575px":"90vw"}},{default:b(()=>[i(Ee,{orders:f(e).salesOrdersToDeliver,onSelected:re},null,8,["orders"])]),_:1},8,["visible"])],64)}}});export{pt as default};
