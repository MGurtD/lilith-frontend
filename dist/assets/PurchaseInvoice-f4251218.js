import{d as q,z as ue,o as le,r as k,j as ne,h as I,a as E,c as te,k as t,e as l,i as a,y as X,n as U,s as j,D as R,l as H,p as ce,b as de,f as me,K as ie,F as g,m as z,w as f,P as Y,C as N,J as he,v as ye,g as Ae,u as xe,G as De}from"./index-3b4220ae.js";import{a as pe,u as oe}from"./purchaseInvoices-4148da55.js";import{c as ve,l as ae,g as be,f as re}from"./functions-2e154ea4.js";import{F as ge}from"./FileEntityPicker-d803f167.js";import{c as fe,a as se,F as Ie,d as we}from"./form-validator-f8953ae6.js";import{u as _e}from"./lifecycle-9bae179f.js";import{u as Ve}from"./receipt-112879b9.js";import"./index-4435bf5b.js";import"./base.service-44647e51.js";import"./reference.service-f49a3be3.js";import"./index-c6b01c28.js";import"./suppliers.service-5b462eb7.js";import"./_commonjsHelpers-725317a4.js";import"./v4-a960c1f4.js";import"./file.service-78707ff8.js";const B=h=>(ce("data-v-fc8bd4da"),h=h(),de(),h),Te={key:0},Ce={class:"four-columns"},Se=B(()=>l("label",{class:"block text-900 mb-2"},"Exercici",-1)),Ee=B(()=>l("label",{class:"block text-900 mb-2"},"Sèrie",-1)),Re=B(()=>l("label",{class:"block text-900 mb-2"},"Estat",-1)),Fe={class:"four-columns"},Pe={class:"mt-1"},ke=B(()=>l("label",{class:"block text-900 mb-2"},"Proveïdor",-1)),Ne={class:"mt-1"},Be={class:"mt-1"},$e=B(()=>l("label",{class:"block text-900 mb-2"},"Data Factura",-1)),Ue={class:"mt-1"},Me=B(()=>l("label",{class:"block text-900 mb-2"},"Forma de pagament",-1)),Le={class:"four-columns"},ze={class:"mt-1"},Oe={class:"mt-1"},He={class:"mt-1"},je={class:"four-columns"},Ye={class:"mt-1"},qe=B(()=>l("label",{class:"block text-900 mb-2"},"Base",-1)),Ge={class:"summary-field"},Ke={class:"mt-1"},Je=B(()=>l("label",{class:"block text-900 mb-2"},"Impostos",-1)),Qe={class:"summary-field"},We={class:"mt-1"},Xe=B(()=>l("label",{class:"block text-900 mb-2"},"Total",-1)),Ze={class:"summary-field"},et=q({__name:"FormPurchaseInvoice",emits:["submit","cancel"],setup(h,{expose:y,emit:v}){const _=pe(),w=_e(),x=oe(),{purchaseInvoice:e}=ue(_);le(()=>{setTimeout(()=>{e.value&&e.value.purchaseInvoiceImports.length>0&&(e.value.taxAmount=Z())},500)});const D=fe().shape({exerciceId:se().required("L'exercici es obligatori"),supplierId:se().required("El proveïdor es obligatori"),statusId:se().required("L'estat és obligatori")}),s=k({result:!1,errors:{}}),p=()=>{const b=new Ie(D);s.value=b.validate(e.value)},i=()=>{var b;return((b=e.value)==null?void 0:b.purchaseInvoiceImports.length)===0?(r.add({severity:"warn",summary:"Formulari inválid",detail:"Ha d'introduir els imports de factura",life:5e3}),!1):!0};let n=!1;le(()=>{setTimeout(()=>{n=!0},500)});const r=ne(),d=async()=>{if(p(),s.value.result){if(!i())return;v("submit",e.value)}else{let b="";Object.entries(s.value.errors).forEach(o=>{b+=`${o[1].map(A=>A)}.   `}),r.add({severity:"warn",summary:"Formulari inválid",detail:b,life:5e3})}},C=()=>{var o;const b=(o=x.masterData.suppliers)==null?void 0:o.find(A=>{var F;return A.id===((F=e.value)==null?void 0:F.supplierId)});b&&(e.value.paymentMethodId=b.paymentMethodId,S())},S=async()=>{if(n){if(e.value){let b=0,o=0,A=0,F=0,M=0,c=0,G=0,O=0,K=0,J=0;b=T(),F=Z(),e.value.transportAmount&&(o=parseFloat(e.value.transportAmount.toFixed(2))),e.value.discountPercentage&&(G=parseFloat(e.value.discountPercentage.toFixed(2))),e.value.extraTaxPercentatge&&(K=e.value.extraTaxPercentatge),A=(b+o)*1,J=A*(K/100),O=A+F*1-J*1,c=O*(1*G)/100,M=parseFloat((O-c).toFixed(2)),e.value.baseAmount=b,e.value.transportAmount=o,e.value.subtotal=A,e.value.taxAmount=F,e.value.grossAmount=O,e.value.netAmount=M,e.value.discountPercentage=G,e.value.discountAmount=c,e.value.extraTaxPercentatge=K,e.value.extraTaxAmount=J;const u=Object.assign({},e.value);u.purchaseInvoiceDate=ve(u.purchaseInvoiceDate),e.value.purchaseInvoiceDueDates=await _.GetDueDates(u)}console.log("calcAmounts",e.value)}},T=()=>{let b=0;return e.value&&e.value.purchaseInvoiceImports.forEach(o=>b+=o.baseAmount),b},Z=()=>{let b=0;return e.value&&e.value.purchaseInvoiceImports.forEach(o=>b+=o.taxAmount),b};return y({submitForm:d,calcAmounts:S}),(b,o)=>{var M;const A=I("Dropdown"),F=I("Calendar");return E(),te("div",null,[t(e)?(E(),te("form",Te,[l("section",Ce,[a(X,{label:"Num. Fra. Intern",id:"number",modelValue:t(e).number,"onUpdate:modelValue":o[0]||(o[0]=c=>t(e).number=c),disabled:""},null,8,["modelValue"]),l("div",null,[Se,a(A,{modelValue:t(e).exerciceId,"onUpdate:modelValue":o[1]||(o[1]=c=>t(e).exerciceId=c),editable:"",options:t(x).masterData.exercises,optionValue:"id",optionLabel:"name",class:U(["w-full",{"p-invalid":s.value.errors.exerciseId}])},null,8,["modelValue","options","class"])]),l("div",null,[Ee,a(A,{modelValue:t(e).purchaseInvoiceSerieId,"onUpdate:modelValue":o[2]||(o[2]=c=>t(e).purchaseInvoiceSerieId=c),editable:"",options:t(x).masterData.series,optionValue:"id",optionLabel:"name",class:U(["w-full",{"p-invalid":s.value.errors.purchaseInvoiceSerieId}])},null,8,["modelValue","options","class"])]),l("div",null,[Re,a(A,{modelValue:t(e).statusId,"onUpdate:modelValue":o[3]||(o[3]=c=>t(e).statusId=c),editable:"",options:(M=t(w).lifecycle)==null?void 0:M.statuses,optionValue:"id",optionLabel:"name",class:U(["w-full",{"p-invalid":s.value.errors.statusId}])},null,8,["modelValue","options","class"])])]),l("section",Fe,[l("div",Pe,[ke,a(A,{modelValue:t(e).supplierId,"onUpdate:modelValue":o[4]||(o[4]=c=>t(e).supplierId=c),editable:"",options:t(x).masterData.suppliers,optionValue:"id",optionLabel:"comercialName",onChange:C,class:U(["w-full",{"p-invalid":s.value.errors.supplierId}])},null,8,["modelValue","options","class"])]),l("div",Ne,[a(X,{label:"Num. Fra. Proveïdor",id:"supplierNumber",modelValue:t(e).supplierNumber,"onUpdate:modelValue":o[5]||(o[5]=c=>t(e).supplierNumber=c)},null,8,["modelValue"])]),l("div",Be,[$e,a(F,{id:"purchaseInvoiceDate",modelValue:t(e).purchaseInvoiceDate,"onUpdate:modelValue":o[6]||(o[6]=c=>t(e).purchaseInvoiceDate=c),onDateSelect:o[7]||(o[7]=c=>S())},null,8,["modelValue"])]),l("div",Ue,[Me,a(A,{modelValue:t(e).paymentMethodId,"onUpdate:modelValue":[o[8]||(o[8]=c=>t(e).paymentMethodId=c),o[9]||(o[9]=c=>S())],editable:"",options:t(x).masterData.paymentMethods,optionValue:"id",optionLabel:"name",class:U(["w-full",{"p-invalid":s.value.errors.paymentmethod}])},null,8,["modelValue","options","class"])])]),l("section",Le,[l("div",ze,[a(X,{type:t(j).CURRENCY,label:"Ports",id:"transportAmount",modelValue:t(e).transportAmount,"onUpdate:modelValue":[o[10]||(o[10]=c=>t(e).transportAmount=c),o[11]||(o[11]=c=>S())]},null,8,["type","modelValue"])]),l("div",Oe,[a(X,{type:t(j).NUMERIC,label:"% IRPF",id:"extraTaxPercentatge",modelValue:t(e).extraTaxPercentatge,"onUpdate:modelValue":[o[12]||(o[12]=c=>t(e).extraTaxPercentatge=c),o[13]||(o[13]=c=>S())]},null,8,["type","modelValue"])]),l("div",He,[a(X,{type:t(j).NUMERIC,label:"% Dto.",id:"discountPercentage",modelValue:t(e).discountPercentage,"onUpdate:modelValue":[o[14]||(o[14]=c=>t(e).discountPercentage=c),o[15]||(o[15]=c=>S())]},null,8,["type","modelValue"])])]),l("section",je,[l("div",Ye,[qe,l("span",Ge,R(t(e).baseAmount)+" €",1)]),l("div",Ke,[Je,l("span",Qe,R(t(e).taxAmount)+" €",1)]),l("div",We,[Xe,l("span",Ze,R(t(e).netAmount)+" €",1)])])])):H("",!0)])}}});const tt=me(et,[["__scopeId","data-v-fc8bd4da"]]),ot={key:0},at={class:"two-columns"},st=l("label",{class:"block text-900 mb-2"},"IVA",-1),lt={class:"two-columns"},nt=q({__name:"FormPurchaseInvoiceImport",props:{formAction:{},invoiceImport:{}},emits:["submit"],setup(h,{emit:y}){const v=h,_=oe(),w=ne(),x=ie(()=>v.formAction===g.CREATE?"Afegir":"Modificar"),e=()=>{const n=_.masterData.taxes.find(r=>r.id===v.invoiceImport.taxId);if(n&&ae.isNumber(v.invoiceImport.baseAmount)){const r=v.invoiceImport.baseAmount,d=r/100*n.percentatge,C=r+d;v.invoiceImport.baseAmount=r,v.invoiceImport.taxAmount=ae.round(d,2),v.invoiceImport.netAmount=ae.round(C,2)}},D=fe().shape({baseAmount:we().required("L'import base és obligatori")}),s=k({result:!1,errors:{}}),p=()=>{const n=new Ie(D);s.value=n.validate(v.invoiceImport)},i=async()=>{if(p(),s.value.result)y("submit",v.invoiceImport);else{let n="";Object.entries(s.value.errors).forEach(r=>{n+=`${r[1].map(d=>d)}.   `}),w.add({severity:"warn",summary:"Formulari inválid",detail:n,life:5e3})}};return(n,r)=>{const d=I("BaseInput"),C=I("Dropdown"),S=I("Button");return n.invoiceImport?(E(),te("form",ot,[l("section",at,[a(d,{class:U(["mb-2",{"p-invalid":s.value.errors.baseAmount}]),label:"Import Base",modelValue:n.invoiceImport.baseAmount,"onUpdate:modelValue":[r[0]||(r[0]=T=>n.invoiceImport.baseAmount=T),r[1]||(r[1]=T=>e())],type:t(j).CURRENCY},null,8,["modelValue","type","class"]),l("div",null,[st,a(C,{modelValue:n.invoiceImport.taxId,"onUpdate:modelValue":[r[2]||(r[2]=T=>n.invoiceImport.taxId=T),r[3]||(r[3]=T=>e())],editable:"",options:t(_).masterData.taxes,optionValue:"id",optionLabel:"name"},null,8,["modelValue","options"])])]),l("section",lt,[a(d,{class:"mb-2",label:"Import Impost",modelValue:n.invoiceImport.taxAmount,"onUpdate:modelValue":r[4]||(r[4]=T=>n.invoiceImport.taxAmount=T),type:t(j).CURRENCY,disabled:""},null,8,["modelValue","type"]),a(d,{class:"mb-2",label:"Total",modelValue:n.invoiceImport.netAmount,"onUpdate:modelValue":r[5]||(r[5]=T=>n.invoiceImport.netAmount=T),type:t(j).CURRENCY,disabled:""},null,8,["modelValue","type"])]),a(S,{label:x.value,onClick:i,style:{float:"right"}},null,8,["label"])])):H("",!0)}}}),it=["onClick"],rt=q({__name:"TablePurchaseInvoiceImports",props:{purchaseInvoiceImports:{}},emits:["add","edit","delete"],setup(h,{emit:y}){const v=h,_=oe(),w=s=>{var i;const p=(i=_.masterData.taxes)==null?void 0:i.find(n=>n.id===s);if(p)return p.percentatge},x=()=>{var i;const s=(i=_.masterData.taxes)==null?void 0:i.find(n=>n.name.includes("21")),p={id:be(),baseAmount:null,taxId:s?s.id:"",taxAmount:0,netAmount:0,purchaseInvoiceId:""};y("add",p)},e=s=>{s.originalEvent.target.className.includes("grid_delete_column_button")||y("edit",s.data)},D=(s,p)=>{y("delete",p)};return(s,p)=>{const i=I("Button"),n=I("Column"),r=I("DataTable");return E(),z(r,{onRowClick:e,value:v.purchaseInvoiceImports,tableStyle:"min-width: 100%"},{default:f(()=>[a(i,{onClick:x,rounded:"",icon:t(Y).PLUS,class:"grid_add_row_button",style:{"margin-right":"1.5rem"}},null,8,["icon"]),a(n,{field:"baseAmount",header:"Base",style:{width:"25%"}},{body:f(d=>[N(R(d.data.baseAmount)+" € ",1)]),_:1}),a(n,{field:"taxId",header:"% IVA",style:{width:"25%"}},{body:f(d=>[N(R(w(d.data.taxId)),1)]),_:1}),a(n,{field:"taxAmount",header:"Cuota IVA",style:{width:"25%"}},{body:f(d=>[N(R(d.data.taxAmount)+" € ",1)]),_:1}),a(n,{field:"netAmount",header:"Total",style:{width:"25%"}},{body:f(d=>[N(R(d.data.netAmount)+" € ",1)]),_:1}),a(n,{style:{width:"10%"}},{body:f(d=>[l("i",{class:U([t(Y).TIMES,"grid_delete_column_button"]),onClick:C=>D(C,d.data)},null,10,it)]),_:1})]),_:1},8,["value"])}}}),ut={class:"flex flex-wrap align-items-center justify-content-between gap-2"},ct=l("span",{class:"text-l text-900 font-bold"},"Albarans associats",-1),dt=["onClick"],mt=q({__name:"TableReceipts",props:{receipts:{}},emits:["add","edit","delete"],setup(h,{emit:y}){const v=h,_=()=>{y("add")},w=e=>{e.originalEvent.target.className.includes("grid_delete_column_button")||y("edit",e.data)},x=(e,D)=>{y("delete",D)};return(e,D)=>{const s=I("Button"),p=I("Column"),i=I("DataTable");return E(),z(i,{onRowClick:w,value:v.receipts,tableStyle:"min-width: 100%",class:"p-datatable-sm"},{header:f(()=>[he(e.$slots,"header",{},()=>[l("div",ut,[ct,l("div",null,[a(s,{size:"small",icon:t(Y).PLUS,rounded:"",onClick:_},null,8,["icon"])])])])]),default:f(()=>[a(p,{field:"number",header:"Número Albarà",style:{width:"15%"}}),a(p,{field:"supplierNumber",header:"Número Proveïdor",style:{width:"15%"}}),a(p,{field:"date",header:"Data",style:{width:"15%"}},{body:f(n=>[N(R(t(re)(n.data.date)),1)]),_:1}),a(p,{style:{width:"10%"}},{body:f(n=>[l("i",{class:U([t(Y).TIMES,"grid_delete_column_button"]),onClick:r=>x(r,n.data)},null,10,dt)]),_:1})]),_:3},8,["value"])}}}),pt=h=>(ce("data-v-4e1eb53f"),h=h(),de(),h),vt={class:"selector-filter"},bt={class:"selector-filter-field"},ft=pt(()=>l("label",{for:""},"Buscar",-1)),It={class:"selector-filter-button"},_t=q({__name:"SelectorReceipts",props:{receipts:{}},emits:["selected"],setup(h,{emit:y}){const v=h,_=k([]),w=k(""),x=ie(()=>{var D=[];return v.receipts&&(D=v.receipts.filter(s=>s.number.toString().includes(w.value)||s.supplierNumber.includes(w.value))),D}),e=()=>{console.log("onSelectedClick",_.value),_.value.length!==0&&y("selected",_.value)};return(D,s)=>{const p=I("InputText"),i=I("Button"),n=I("Column"),r=I("DataTable");return E(),z(r,{class:"small-datatable",tableStyle:"min-width: 100%",scrollable:"",scrollHeight:"75vh",dataKey:"id",value:x.value,selection:_.value,"onUpdate:selection":s[1]||(s[1]=d=>_.value=d)},{header:f(()=>[l("header",vt,[l("div",bt,[ft,N("   "),a(p,{style:{width:"150px",height:"35px"},modelValue:w.value,"onUpdate:modelValue":s[0]||(s[0]=d=>w.value=d),size:"small"},null,8,["modelValue"])]),l("div",It,[a(i,{onClick:e,size:"small",icon:t(Y).CHECK_SQUARE},null,8,["icon"])])])]),default:f(()=>[a(n,{selectionMode:"multiple",headerStyle:"width: 3rem"}),a(n,{header:"Número",field:"number",style:{width:"30%"}}),a(n,{header:"Número proveïdor",field:"supplierNumber",style:{width:"30%"}}),a(n,{header:"Data",field:"date",style:{width:"30%"}},{body:f(d=>[N(R(t(re)(d.data.date)),1)]),_:1})]),_:1},8,["value","selection"])}}});const ht=me(_t,[["__scopeId","data-v-4e1eb53f"]]),Nt=q({__name:"PurchaseInvoice",setup(h){const y=k(),v=k(g.EDIT),_=ye(),w=Ae(),x=xe(),e=_e(),D=oe(),s=pe(),p=Ve(),{purchaseInvoice:i}=ue(s),n=ie(()=>p.selectorReceipts?"Selecció albarans":d.value===g.CREATE?"Introducció import":"Modificació import"),r=k(!1),d=k(g.EDIT),C=k(void 0),S=async()=>{const u=_.params.id;let m="";await s.GetById(u),i.value?(v.value=g.EDIT,m=`Factura de compra: ${i.value.number}`,i.value.purchaseInvoiceDate=new Date(i.value.purchaseInvoiceDate)):(v.value=g.CREATE,s.setNewPurchaseInvoice(u),m="Alta de factures de compra",T()),p.fetchByInvoice(u),x.setMenuItem({icon:Y.POUND,backButtonVisible:!0,title:m})},T=()=>{var u,m,V,$;if(i.value){const Q=(u=D.masterData.exercises)==null?void 0:u.find(L=>L.name===new Date().getFullYear().toString());Q&&(i.value.exerciceId=Q.id);const ee=(m=D.masterData.series)==null?void 0:m.find(L=>L.name==="Nacional");ee&&(i.value.purchaseInvoiceSerieId=ee.id);const W=($=(V=e.lifecycle)==null?void 0:V.statuses)==null?void 0:$.find(L=>L.name==="Nova");W&&(i.value.statusId=W.id)}};le(async()=>{await S()});const Z=()=>{y.value.submitForm()},b=(u,m)=>{u===g.CREATE&&(m.id=be()),m.purchaseInvoiceId=i.value.id,C.value=m,d.value=u,r.value=!0},o=ne(),A=async u=>{let m=!1,V="";u.purchaseInvoiceDate=ve(u.purchaseInvoiceDate),v.value===g.CREATE?(m=await s.Create(u),V=m?"Factura creada":"Error al crear la factura"):(m=await s.Update(u),V=m?"Factura actualizada":"Error al actualizar la factura"),o.add({life:5e3,severity:m?"success":"error",summary:V}),m&&w.back()},F=async u=>{var m;d.value===g.CREATE?(v.value===g.EDIT&&await s.CreateInvoiceImport(u),(m=i.value)==null||m.purchaseInvoiceImports.push(u)):d.value===g.EDIT&&v.value===g.EDIT&&await s.UpdateInvoiceImport(u),c()},M=async u=>{v.value===g.EDIT&&await s.DeleteInvoiceImport(u);const m=i.value.purchaseInvoiceImports.filter(V=>V.id!==u.id);i.value.purchaseInvoiceImports=m,c()},c=()=>{y.value.calcAmounts(),r.value=!1},G=async()=>{i.value&&(await p.fetchInvoiceableBySupplier(i.value.supplierId),r.value=!0)},O=()=>{C.value=void 0,p.selectorReceipts=void 0},K=async u=>{console.log("onReceiptsSelected",u);const m=[];for(let V=0;V<u.length;V++)m.push(p.associateInvoice(u[V],i.value.id));await Promise.all(m),await p.fetchByInvoice(i.value.id),r.value=!1,p.selectorReceipts=void 0},J=async u=>{u.purchaseInvoiceId=null,await p.unassociateInvoice(u,i.value.id),await p.fetchByInvoice(i.value.id)};return(u,m)=>{const V=I("Button"),$=I("TabPanel"),Q=I("Column"),ee=I("DataTable"),W=I("TabView"),L=I("Dialog");return E(),te(De,null,[a(V,{label:"Guardar",class:"grid_add_row_button",onClick:Z}),a(W,null,{default:f(()=>[t(i)?(E(),z($,{key:0,header:"Factura"},{default:f(()=>[a(tt,{ref_key:"purchaseInvoiceForm",ref:y,purchaseInvoice:t(i),onSubmit:A},null,8,["purchaseInvoice"]),a(W,null,{default:f(()=>[a($,{header:"Imports"},{default:f(()=>[a(rt,{"purchase-invoice-imports":t(i).purchaseInvoiceImports,onAdd:m[0]||(m[0]=P=>b(t(g).CREATE,P)),onEdit:m[1]||(m[1]=P=>b(t(g).EDIT,P)),onDelete:M},null,8,["purchase-invoice-imports"])]),_:1}),a($,{header:"Venciments"},{default:f(()=>[a(ee,{value:t(i).purchaseInvoiceDueDates,tableStyle:"min-width: 100%",scrollable:"",scrollHeight:"40vh",sortField:"dueDate",sortOrder:1},{default:f(()=>[a(Q,{field:"dueDate",header:"Venciment",style:{width:"50%"},sortable:""},{body:f(P=>[N(R(t(re)(P.data.dueDate)),1)]),_:1}),a(Q,{field:"amount",header:"Import",style:{width:"50%"}},{body:f(P=>[N(R(P.data.amount)+" € ",1)]),_:1})]),_:1},8,["value"])]),_:1}),a($,{header:"Albarans"},{default:f(()=>[a(mt,{receipts:t(p).receipts,onAdd:G,onDelete:J},null,8,["receipts"])]),_:1})]),_:1})]),_:1})):H("",!0),a($,{header:"Fitxers"},{default:f(()=>[t(i)?(E(),z(ge,{key:0,title:"Factures",entity:"PurchaseInvoice",id:t(_).params.id},null,8,["id"])):H("",!0)]),_:1})]),_:1}),a(L,{closable:!0,visible:r.value,"onUpdate:visible":m[2]||(m[2]=P=>r.value=P),header:n.value,position:"bottom",style:{width:"40rem"},breakpoints:{"1199px":"75vw","575px":"90vw"},onAfterHide:O},{default:f(()=>[C.value?(E(),z(nt,{key:0,formAction:d.value,invoiceImport:C.value,onSubmit:F},null,8,["formAction","invoiceImport"])):H("",!0),t(p).selectorReceipts?(E(),z(ht,{key:1,receipts:t(p).selectorReceipts,onSelected:K},null,8,["receipts"])):H("",!0)]),_:1},8,["visible","header"])],64)}}});export{Nt as default};
