import{d as H,j as ee,z as te,K as ae,r as g,h as y,a as p,c as x,k as t,e as n,i as r,s as z,n as Q,l as T,p as ke,b as we,f as re,x as Se,w as u,J as Ie,D as $,P as X,C as U,m as G,G as oe,F as C,v as Ce,g as ge,u as he,o as Ne}from"./index-e365f3be.js";import{c as Z,e as P,h as Te,b as xe,f as L,g as Ee}from"./functions-e7c8fc70.js";import{u as le}from"./order-4ca6d58b.js";import{u as se}from"./reference-3f326116.js";import{u as de}from"./customers-f17ddf3b.js";import{u as Ve}from"./exercise-2e16c97e.js";import{u as Be}from"./plantmodel-193b9447.js";import{u as ie}from"./lifecycle-5aa2399a.js";import{u as Fe}from"./tax-cf527e8f.js";import{c as $e,a as j,F as Me}from"./form-validator-f8953ae6.js";import{u as ne}from"./deliveryNote-312d95f7.js";import{u as ue}from"./budget-a65ee9cd.js";import{_ as Re}from"./FormBudgetOrderDetail.vue_vue_type_script_setup_true_lang-450a6218.js";import{L as We}from"./LinkReference-b53b20c5.js";import{_ as Ae}from"./FormCreateWorkorder.vue_vue_type_script_setup_true_lang-d8a2332f.js";import{u as ce}from"./workmaster-74cfbd05.js";import{u as me}from"./workorder-40545675.js";import{F as Ue}from"./FileEntityPicker-50e9fec8.js";import{a as Le,b as Ge}from"./report.service-45e6858b.js";import{S as qe}from"./index-dc8700c2.js";import"./_commonjsHelpers-725317a4.js";import"./v4-a960c1f4.js";import"./reference.service-33e64e53.js";import"./base.service-8e7a55c1.js";import"./index-42d34089.js";import"./index-d8fe7816.js";import"./DropdownReference.vue_vue_type_script_setup_true_lang-1a748adf.js";import"./index-348057aa.js";const Y=E=>(ke("data-v-9ef3c9d3"),E=E(),we(),E),ze={key:0},Pe={class:"four-columns mt-2"},je=Y(()=>n("label",{class:"block text-900 mb-2"},"Client",-1)),Xe=Y(()=>n("label",{class:"block text-900 mb-2"},"Estat",-1)),Ye={class:"four-columns mt-2"},Qe=Y(()=>n("label",{class:"block text-900 mb-2"},"Data Alta",-1)),He=Y(()=>n("label",{class:"block text-900 mb-2"},"Data Entrega",-1)),Je=H({__name:"FormSalesOrder",emits:["submit","cancel"],setup(E,{expose:k,emit:D}){const M=le(),V=de(),F=ie(),w=ne(),f=ue(),_=ee(),{salesOrder:a}=te(M),b=ae(()=>w.deliveryNote?w.deliveryNote.number:""),R=$e().shape({siteId:j().required("L'origen es obligatori"),customerId:j().required("El client es obligatori"),statusId:j().required("L'estat es obligatori"),exerciseId:j().required("L'exercici es obligatori")}),S=g({result:!1,errors:{}}),h=()=>{const i=new Me(R);S.value=i.validate(a.value)};k({submitForm:async()=>{if(h(),S.value.result)d(),D("submit",a.value);else{let i="";Object.entries(S.value.errors).forEach(e=>{i+=`${e[1].map(m=>m)}.   `}),_.add({severity:"warn",summary:"Formulari inválid",detail:i,life:5e3})}}});const B=()=>{var e;const i=(e=V.customers)==null?void 0:e.find(m=>{var v;return m.id===((v=a.value)==null?void 0:v.customerId)});i&&a.value&&(a.value.customerCode=i.code,a.value.customerComercialName=i.comercialName,a.value.customerTaxName=i.taxName,a.value.customerVatNumber=i.vatNumber,a.value.customerAccountNumber=i.accountNumber)},d=()=>{a.value&&(a.value.date=Z(a.value.date),a.value.expectedDate&&(a.value.expectedDate=Z(a.value.expectedDate)))};return(i,e)=>{var o,N;const m=y("BaseInput"),v=y("Dropdown"),I=y("Calendar");return p(),x("div",null,[t(a)?(p(),x("form",ze,[n("section",Pe,[n("div",null,[r(m,{type:t(z).TEXT,label:"Num. Comanda",id:"salesOrderNumber",modelValue:t(a).number,"onUpdate:modelValue":e[0]||(e[0]=c=>t(a).number=c),disabled:""},null,8,["type","modelValue"])]),n("div",null,[je,r(v,{modelValue:t(a).customerId,"onUpdate:modelValue":[e[1]||(e[1]=c=>t(a).customerId=c),e[2]||(e[2]=c=>B())],editable:"",options:t(V).customers,optionValue:"id",optionLabel:"comercialName",class:Q(["w-full",{"p-invalid":S.value.errors.customerId}])},null,8,["modelValue","options","class"])]),n("div",null,[r(m,{type:t(z).TEXT,label:"Comanda Client",id:"customerSalesOrderNumber",modelValue:t(a).customerNumber,"onUpdate:modelValue":e[3]||(e[3]=c=>t(a).customerNumber=c)},null,8,["type","modelValue"])]),n("div",null,[Xe,r(v,{modelValue:t(a).statusId,"onUpdate:modelValue":e[4]||(e[4]=c=>t(a).statusId=c),editable:"",options:(o=t(F).lifecycle)==null?void 0:o.statuses,optionValue:"id",optionLabel:"name",class:Q(["w-full",{"p-invalid":S.value.errors.statusId}])},null,8,["modelValue","options","class"])])]),n("section",Ye,[n("div",null,[Qe,r(I,{modelValue:t(a).date,"onUpdate:modelValue":e[5]||(e[5]=c=>t(a).date=c),dateFormat:"dd/mm/yy"},null,8,["modelValue"])]),n("div",null,[He,r(I,{modelValue:t(a).expectedDate,"onUpdate:modelValue":e[6]||(e[6]=c=>t(a).expectedDate=c),dateFormat:"dd/mm/yy"},null,8,["modelValue"])]),n("div",null,[r(m,{type:t(z).TEXT,label:"Num. Pressupost",id:"budgetNumber",disabled:"",value:(N=t(f).budget)==null?void 0:N.number},null,8,["type","value"])]),n("div",null,[r(m,{type:t(z).TEXT,disabled:!0,label:"Albarà Entrega",id:"deliveryNote",modelValue:b.value,"onUpdate:modelValue":e[7]||(e[7]=c=>b.value=c)},null,8,["type","modelValue"])])])])):T("",!0)])}}});const Ke=re(Je,[["__scopeId","data-v-9ef3c9d3"]]),Ze={key:0},et={key:1},tt=["onClick"],at={class:"total"},rt={class:"total-text"},ot=H({__name:"TableSalesOrderDetails",props:{salesOrder:{},salesOrderDetails:{}},emits:["edit","delete","createWorkOrder","openWorkOrder"],setup(E,{emit:k}){const D=E,M=Se();se();const V=ce(),F=me(),w=ae(()=>D.salesOrderDetails?D.salesOrderDetails.reduce((d,i)=>d+i.amount,0):0);var f=void 0;const _=g({closable:!0,modal:!0,title:"Generar ordre de fabricació",visible:!1}),a=g([]),b=g({workMasterId:"",plannedDate:"",plannedQuantity:0,comment:""}),R=d=>{D.salesOrder.deliveryNoteId||d.originalEvent.target.className.includes("grid_delete_column_button")||k("edit",d.data)},S=(d,i)=>{M.require({target:d.currentTarget,message:"Está segur que vol eliminar la referència?",icon:"pi pi-question-circle",acceptIcon:"pi pi-check",rejectIcon:"pi pi-times",accept:()=>{k("delete",i)}})},h=d=>{a.value=V.getByReferenceId(d.referenceId),b.value.workMasterId="",a.value.length>0&&(b.value.workMasterId=a.value[0].id),b.value.plannedQuantity=d.quantity,b.value.plannedDate=D.salesOrder.expectedDate?Te(D.salesOrder.expectedDate):"",b.value.comment="",f=d,_.value.visible=!0},W=d=>{console.log(d),k("openWorkOrder",d)},B=()=>{const d={workOrderDto:b.value,orderDetail:f};_.value.visible=!1,k("createWorkOrder",d)};return(d,i)=>{const e=y("Column"),m=y("Button"),v=y("DataTable"),I=y("Dialog");return p(),x(oe,null,[r(v,{onRowClick:R,value:d.salesOrderDetails,tableStyle:"min-width: 100%",class:"p-datatable-sm",selectionMode:"single",dataKey:"id",sortMode:"single",sortField:"reference.code",sortOrder:1},{header:u(()=>[Ie(d.$slots,"header",{},void 0,!0)]),footer:u(()=>[n("div",at,[n("span",rt,"Total "+$(t(P)(w.value)),1)])]),default:u(()=>[r(e,{field:"quantity",header:"Quantitat",style:{width:"7.5%"}}),r(e,{header:"Referencia",field:"reference.code",sortable:"",style:{width:"15%"}},{body:u(o=>[r(We,{id:o.data.referenceId},null,8,["id"])]),_:1}),r(e,{field:"description",header:"Descripció",style:{width:"25%"}}),r(e,{field:"workOrderId",header:"Ordre fabr.",style:{width:"10%"}},{body:u(o=>[t(F).getWorkOrderCodeById(o.data.workOrderId)?(p(),x("div",Ze,[r(m,{size:"small",severity:"success",label:t(F).getWorkOrderCodeById(o.data.workOrderId),onClick:N=>W(o.data.workOrderId)},null,8,["label","onClick"])])):(p(),x("div",et,[r(m,{disabled:d.salesOrder.deliveryNoteId!==null,size:"small",icon:t(X).PLUS_CIRCLE,value:"Generar OF",onClick:N=>h(o.data)},null,8,["disabled","icon","onClick"])]))]),_:1}),r(e,{field:"unitCost",header:"Cost un.",style:{width:"8%"}},{body:u(o=>[U($(t(P)(o.data.unitCost)),1)]),_:1}),r(e,{field:"totalCost",header:"Cost total",style:{width:"8%"}},{body:u(o=>[U($(t(P)(o.data.totalCost)),1)]),_:1}),r(e,{field:"profit",header:"Benefici",style:{width:"8%"}},{body:u(o=>[U($(o.data.profit)+" % ",1)]),_:1}),r(e,{field:"profit",header:"Descompte",style:{width:"8%"}},{body:u(o=>[U($(o.data.discount)+" % ",1)]),_:1}),r(e,{field:"amount",header:"Total",style:{width:"8%"}},{body:u(o=>[U($(t(P)(o.data.amount)),1)]),_:1}),d.salesOrder.deliveryNoteId?T("",!0):(p(),G(e,{key:0,style:{width:"5%"}},{body:u(o=>[o.data.isDelivered?T("",!0):(p(),x("i",{key:0,class:Q([t(X).TIMES,"grid_delete_column_button"]),onClick:N=>S(N,o.data)},null,10,tt))]),_:1}))]),_:3},8,["value"]),r(I,{closable:_.value.closable,visible:_.value.visible,"onUpdate:visible":i[0]||(i[0]=o=>_.value.visible=o),header:_.value.title,modal:_.value.modal,style:{width:"50vw"}},{default:u(()=>[r(Ae,{createWorkOrderDto:b.value,"filtered-work-masters":a.value,onSubmit:B},null,8,["createWorkOrderDto","filtered-work-masters"])]),_:1},8,["closable","visible","header","modal"])],64)}}});const lt=re(ot,[["__scopeId","data-v-0915e612"]]),st={class:"flex flex-wrap align-items-center justify-content-between gap-2"},dt=n("span",{class:"text-l text-900 font-bold"},"Linies de la comanda",-1),it={key:0},nt="Línia de comanda",Wt=H({__name:"SalesOrder",setup(E){const k=g(),D=g(C.EDIT),M=Ce(),V=ge(),F=he(),w=ee(),f=le(),_=de(),a=Be(),b=Ve(),R=ie(),S=se(),h=ne(),W=ce(),B=me(),d=Fe(),i=ue(),{salesOrder:e}=te(f),m=[{label:"Descarregar",icon:X.FILE_WORD,command:()=>_e()}],v=g(!1),I=g(C.EDIT),o=g(void 0),N=async()=>{const l=M.params.id;await f.GetById(l),S.fetchReferencesByModule("sales"),R.fetchOneByName("SalesOrder"),a.fetchSites(),b.fetchAll(),_.fetchCustomers(),d.fetchAll(),B.fetchBySalesOrder(l),W.workmasters||W.fetchAllActives();let s="";e.value&&(D.value=C.EDIT,s=`Comanda ${e.value.number}`,e.value.date=L(e.value.date),e.value.expectedDate&&(e.value.expectedDate=L(e.value.expectedDate)),e.value.deliveryNoteId?h.GetById(e.value.deliveryNoteId):h.deliveryNote&&(h.deliveryNote=void 0),e.value.budgetId?await i.GetById(e.value.budgetId):i.budget=void 0),F.setMenuItem({icon:X.BUILDING,backButtonVisible:!0,title:s})};Ne(async()=>{await N()});const c=()=>{k.value.submitForm()},J=(l,s)=>{l===C.CREATE&&(s={id:Ee(),referenceId:"",quantity:1,profit:0,discount:0,unitCost:0,unitPrice:0,totalCost:0,amount:0,salesOrderHeaderId:"",lastCost:0,workMasterCost:0,description:"",estimatedDeliveryDate:new Date,isDelivered:!1,isInvoiced:!1,workMasterId:null,workOrderId:null}),s.salesOrderHeaderId=e.value.id,o.value=s,I.value=l,v.value=!0},ve=async l=>{let s=!1,O="";s=await f.Update(l.id,l),O=s?"Comanda actualitzada":"Error a l'actualitzar la comanda",w.add({life:5e3,severity:s?"success":"error",summary:O}),s&&V.back()},pe=async l=>{l=l,I.value===C.CREATE?await f.CreateDetail(l):I.value===C.EDIT&&await f.UpdateDetail(l),v.value=!1,e.value&&(e.value.date=L(e.value.date),e.value.expectedDate&&(e.value.expectedDate=L(e.value.expectedDate)))},fe=async l=>{D.value===C.EDIT&&await f.DeleteDetail(l);const s=e.value.salesOrderDetails.filter(O=>O.id!==l.id);e.value.salesOrderDetails=s,v.value=!1,e.value.date=L(e.value.date)},be=async l=>{const s=await B.create(l.workOrderDto);s.result?(l.orderDetail.workOrderId=s.content.id,await f.UpdateDetail(l.orderDetail)&&(w.add({severity:"success",summary:"Generació OF",detail:`Ordre de fabricació ${s.content.code} generada`,life:5e3}),B.fetchBySalesOrder(e.value.id))):w.add({severity:"error",summary:"Generació OF",detail:"Error al generar la ordre de fabricació",life:5e3})},ye=l=>{V.push({path:`/workorder/${l}`})},_e=async()=>{var s;const l=await qe.SalesOrder.GetReportDataById(e.value.id);if(l){const O=`Comanda_${(s=e.value)==null?void 0:s.number}.docx`,A=await new Ge().Download(l,Le.Order,O);A?xe(O,A):w.add({severity:"warn",summary:"Error",detail:"No s'ha pugut generar fulla de la comanda"})}};return(l,s)=>{const O=y("SplitButton"),K=y("Button"),A=y("TabPanel"),De=y("TabView"),Oe=y("Dialog");return p(),x(oe,null,[r(O,{label:"Guardar",onClick:c,model:m,size:"small",class:"grid_add_row_button"}),r(Ke,{class:"mt-3 mb-3",ref_key:"salesOrderForm",ref:k,salesOrder:"salesOrder",onSubmit:ve},null,512),r(De,null,{default:u(()=>[r(A,{header:"Detall"},{default:u(()=>[t(e)?(p(),G(lt,{key:0,salesOrder:t(e),salesOrderDetails:t(e).salesOrderDetails,onEdit:s[1]||(s[1]=q=>J(t(C).EDIT,q)),onDelete:fe,onCreateWorkOrder:be,onOpenWorkOrder:ye},{header:u(()=>[n("div",st,[dt,t(h).deliveryNote?T("",!0):(p(),x("section",it,[r(K,{size:"small",label:"Afegir línea",onClick:s[0]||(s[0]=q=>J(t(C).CREATE,{})),class:"mr-2"})]))])]),_:1},8,["salesOrder","salesOrderDetails"])):T("",!0)]),_:1}),r(A,{header:"Fitxers"},{default:u(()=>[t(e)?(p(),G(Ue,{key:0,entity:"SalesOrder",id:t(e).id,title:""},null,8,["id"])):T("",!0)]),_:1})]),_:1}),t(e)?(p(),G(Oe,{key:0,closable:!0,visible:v.value,"onUpdate:visible":s[2]||(s[2]=q=>v.value=q),header:nt,modal:!0},{default:u(()=>[o.value?(p(),G(Re,{key:0,formAction:I.value,header:t(e),detail:o.value,onSubmit:pe},null,8,["formAction","header","detail"])):T("",!0)]),_:1},8,["visible"])):T("",!0)],64)}}});export{Wt as default};
