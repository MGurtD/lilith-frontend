import{d as A,k as j,o as z,r as y,h as p,c as M,e as r,i as o,n as $,D as w,l as s,m as T,N as ee,a as C,v as S,x as ae,g as te,z as re,u as oe,F as h,E as se,a5 as le,q as B,w as u,P as x,I as R,t as E,W as I,K as ie}from"./index-f6af8c81.js";import{c as ne,a as D,d as W,F as de}from"./form-validator-ec7c2535.js";import{_ as ce}from"./DropdownCustomers.vue_vue_type_script_setup_true_lang-0951f83c.js";import{u as Y}from"./tax-320212e0.js";import{F as ue}from"./FileEntityPicker-6ebb7fcb.js";import{u as me}from"./reference-75fb097d.js";import{u as fe}from"./workmaster-93e285b1.js";import{R as pe}from"./index-7cbe1881.js";import"./customers-bf96fe43.js";import"./index-5443ddc0.js";const ve=r("br",null,null,-1),be={key:0},ye={class:"four-columns"},Ce={class:"mt-1"},_e={class:"mt-1"},we={class:"mt-1"},he={class:"mt-1"},ke={class:"five-columns"},Ve={class:"mt-1"},ge={class:"mt-1"},Re={class:"mt-1"},Ee={class:"mt-1"},Ie=r("label",{class:"block text-900 mb-2"},"Impost",-1),Te={class:"mt-1"},Ue=r("label",{class:"block text-900 mb-2"},"Servei",-1),Se=A({__name:"FormReference",props:{reference:{},defaultCustomerId:{}},emits:["submit","cancel"],setup(L,{emit:U}){const m=L,F=j(),N=Y();z(()=>{m.defaultCustomerId&&m.reference&&(m.reference.customerId=m.defaultCustomerId)});const q=ne().shape({code:D().required("El codi és obligatori").max(50,"El codi no pot superar els 50 carácters"),description:D().required("La descripció és obligatori").max(250,"La descripció pot superar els 250 carácters"),version:D().required("La versió és obligatoria").max(20,"La versió pot superar els 20 carácters"),cost:W().required("El cost es obligatori"),price:W().required("El preu es obligatori"),taxId:D().required("El tipus d'iva es obligatori")}),n=y({result:!1,errors:{}}),c=()=>{const e=new de(q);n.value=e.validate(m.reference)},v=async()=>{if(c(),n.value.result)U("submit",m.reference);else{let e="";Object.entries(n.value.errors).forEach(a=>{e+=`${a[1].map(k=>k)}.   `}),F.add({severity:"warn",summary:"Formulari inválid",detail:e,life:5e3})}};return(e,a)=>{const k=p("Button"),V=p("Dropdown"),g=p("Checkbox");return C(),M(ee,null,[r("div",null,[o(k,{label:"Guardar",class:"grid_add_row_button",size:"small",onClick:v}),ve]),e.reference?(C(),M("form",be,[r("section",ye,[r("div",Ce,[o(w,{class:$(["mb-2",{"p-invalid":n.value.errors.code}]),label:"Codi",id:"code",modelValue:e.reference.code,"onUpdate:modelValue":a[0]||(a[0]=t=>e.reference.code=t)},null,8,["modelValue","class"])]),r("div",_e,[o(w,{class:$(["mb-2",{"p-invalid":n.value.errors.description}]),label:"Descripció",id:"description",modelValue:e.reference.description,"onUpdate:modelValue":a[1]||(a[1]=t=>e.reference.description=t)},null,8,["modelValue","class"])]),r("div",we,[o(w,{type:s(S).TEXT,label:"Versió",id:"version",modelValue:e.reference.version,"onUpdate:modelValue":a[2]||(a[2]=t=>e.reference.version=t)},null,8,["type","modelValue"])]),r("div",he,[o(ce,{label:"Client",modelValue:e.reference.customerId,"onUpdate:modelValue":a[3]||(a[3]=t=>e.reference.customerId=t)},null,8,["modelValue"])])]),r("section",ke,[r("div",Ve,[o(w,{type:s(S).CURRENCY,label:"Cost Teóric Fabricació",id:"workMasterCost",modelValue:e.reference.workMasterCost,"onUpdate:modelValue":a[4]||(a[4]=t=>e.reference.workMasterCost=t),disabled:""},null,8,["type","modelValue"])]),r("div",ge,[o(w,{type:s(S).CURRENCY,label:"Cost Última Fabricació",id:"lastCost",modelValue:e.reference.lastCost,"onUpdate:modelValue":a[5]||(a[5]=t=>e.reference.lastCost=t),disabled:""},null,8,["type","modelValue"])]),r("div",Re,[o(w,{type:s(S).CURRENCY,label:"Preu unitari",id:"price",modelValue:e.reference.price,"onUpdate:modelValue":a[6]||(a[6]=t=>e.reference.price=t)},null,8,["type","modelValue"])]),r("div",Ee,[Ie,o(V,{modelValue:e.reference.taxId,"onUpdate:modelValue":a[7]||(a[7]=t=>e.reference.taxId=t),editable:"",options:s(N).taxes,optionValue:"id",optionLabel:"name",class:$(["w-full",{"p-invalid":n.value.errors.taxid}])},null,8,["modelValue","options","class"])]),r("div",Te,[Ue,o(g,{modelValue:e.reference.isService,"onUpdate:modelValue":a[8]||(a[8]=t=>e.reference.isService=t),class:"w-full",binary:!0},null,8,["modelValue"])])])])):T("",!0)],64)}}}),Be={key:0},De={class:"flex flex-wrap align-items-center justify-content-between gap-2"},$e=r("div",null,[r("label",{class:"block text-900"},"Rutes de fabricació")],-1),Fe={class:"datatable-buttons"},Ne=["onClick"],Ge=A({__name:"Reference",setup(L){const U=ae(),m=te(),F=re(),N=oe(),q=Y(),n=me(),c=fe(),v=y(h.EDIT),{reference:e}=se(n),a=y(""),k=y(""),V=y(!1),g=y(!1),t=y(!1),P=async()=>{V.value=!0;try{const l=[q.fetchAll(),n.fetchReference(a.value)];await Promise.all(l);let d="";if(!e.value)v.value=h.CREATE,n.setNewReference(a.value,pe.PRODUCT),d="Alta de referència";else{v.value=h.EDIT,d=`Referència ${e.value.code} - ${e.value.description}`,g.value=!0;try{await c.fetchByReferenceId(e.value.id)}finally{g.value=!1}}N.setMenuItem({icon:x.BUILDING,backButtonVisible:!0,title:d})}catch(l){console.error("Error loading view:",l),_.add({severity:"error",summary:"Error al carregar la vista",life:5e3})}finally{V.value=!1}};z(async()=>{a.value=U.params.id,k.value=U.params.module,await P()}),le(()=>{n.reference=void 0,c.workmasters=void 0});const _=j(),G=async()=>{const l=e.value;let d=!1,f="";v.value===h.CREATE?(d=await n.createReference(l),d?f="Referència creada correctament":f="La referència + versió introduïda ja existeix"):(d=await n.updateReference(l.id,l),f="Referència actualizada correctament"),_.add({severity:d?"success":"warn",summary:f,life:5e3}),d&&(v.value===h.EDIT?m.back():await P())},O=async()=>{if(e.value){t.value=!0;try{const l=ie();c.setNew(l,e.value.id),c.workmaster&&(await c.create(c.workmaster)?m.push({path:`/workmaster/${l}`}):_.add({severity:"error",summary:"Error al crear la ruta de fabricació",life:5e3}))}catch(l){console.error("Error creating workmaster:",l),_.add({severity:"error",summary:"Error al crear la ruta de fabricació",life:5e3})}finally{t.value=!1}}},Q=l=>{m.push({path:`/workmaster/${l.data.id}`})},H=async(l,d)=>{l.stopPropagation(),F.require({target:l.currentTarget,message:"Está segur que vol eliminar la ruta seleccionada?",icon:"pi pi-question-circle",acceptIcon:"pi pi-check",rejectIcon:"pi pi-times",accept:async()=>{await c.delete(d.id)?(_.add({severity:"success",summary:"Ruta eliminada correctament",life:5e3}),await c.fetchByReferenceId(e.value.id)):_.add({severity:"warn",summary:"No s'ha pogut eliminar la ruta",life:5e3})}})};return(l,d)=>{const f=p("TabPanel"),K=p("Button"),b=p("Column"),X=p("DataTable"),J=p("TabView");return V.value?T("",!0):(C(),M("div",Be,[s(e)?(C(),B(Se,{key:0,reference:s(e),onSubmit:G},null,8,["reference"])):T("",!0),s(e)?(C(),B(J,{key:1},{default:u(()=>[o(f,{header:"Documentació"},{default:u(()=>[(C(),B(ue,{title:"Documentació",entity:"referenceMaps",id:s(e).id,key:s(e).id},null,8,["id"]))]),_:1}),v.value===s(h).EDIT?(C(),B(f,{key:0,header:"Rutes de fabricació"},{default:u(()=>[o(X,{value:s(c).workmasters,tableStyle:"min-width: 100%",scrollable:"",scrollHeight:"80vh","sort-field":"reference.code","sort-order":1,onRowClick:Q,loading:g.value},{header:u(()=>[r("div",De,[$e,r("div",Fe,[o(K,{icon:s(x).PLUS,rounded:"",raised:"",loading:t.value,onClick:O},null,8,["icon","loading"])])])]),default:u(()=>[o(b,{field:"baseQuantity",header:"Quantitat Base",style:{width:"10%"}}),o(b,{field:"machineCost",header:"Cost màquina",style:{width:"10%"}},{body:u(i=>[R(E(s(I)(i.data.machineCost)),1)]),_:1}),o(b,{field:"operatorCost",header:"Cost operari",style:{width:"10%"}},{body:u(i=>[R(E(s(I)(i.data.operatorCost)),1)]),_:1}),o(b,{field:"materialCost",header:"Cost material",style:{width:"10%"}},{body:u(i=>[R(E(s(I)(i.data.materialCost)),1)]),_:1}),o(b,{field:"externalCost",header:"Cost extern",style:{width:"10%"}},{body:u(i=>[R(E(s(I)(i.data.externalCost)),1)]),_:1}),o(b,{header:"Cost total",style:{width:"10%"}},{body:u(i=>[R(E(s(I)(i.data.machineCost+i.data.operatorCost+i.data.materialCost+i.data.externalCost)),1)]),_:1}),o(b,null,{body:u(i=>[r("i",{class:$([s(x).TIMES,"grid_delete_column_button"]),onClick:Z=>H(Z,i.data)},null,10,Ne)]),_:1})]),_:1},8,["value","loading"])]),_:1})):T("",!0)]),_:1})):T("",!0)]))}}});export{Ge as default};
