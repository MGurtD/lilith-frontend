import{Q as F,d as D,k as S,r as M,h as w,a as _,c as P,e as s,i as a,n as q,l as u,v as h,D as c,m as A,u as O,o as z,P as U,C as W,w as V,N as j,K as C}from"./index-f6af8c81.js";import{u as x}from"./stock-62765346.js";import{u as L}from"./reference-75fb097d.js";import{u as G}from"./stockMovement-ea18222e.js";import{_ as H}from"./DropdownReference.vue_vue_type_script_setup_true_lang-b6b545e0.js";import{c as K,d as X,a as J,F as Y}from"./form-validator-ec7c2535.js";import{u as Z}from"./warehouse-48423be3.js";const ee=F({id:"inventory",state:()=>({inventory:void 0,inventories:void 0}),getters:{},actions:{setNewInventory(y){this.inventory={id:y,stockId:"",movementType:"",locationId:"",referenceId:"",oldQuantity:0,newQuantity:0,width:0,length:0,height:0,diameter:0,thickness:0,movementDate:new Date}}}}),te={key:0},ne={class:"three-columns"},ae={class:"three-columns"},oe={class:"mt-2"},le={class:"mt-2"},ie={class:"mt-2"},se=D({__name:"FormInventoryNewMovements",props:{newMovement:{}},emits:["submit","cancel"],setup(y,{emit:N}){const p=y,g=S();L();const I=K().shape({newQuantity:X().min(1).required("La quantitat ha de ser superior a 1"),referenceId:J().required("La referencia és obligatoria")}),r=M({result:!1,errors:{}}),k=()=>{const t=new Y(I);r.value=t.validate(p.newMovement)},b=async()=>{if(k(),r.value.result)N("submit",p.newMovement);else{let t="";Object.entries(r.value.errors).forEach(l=>{t+=`${l[1].map(f=>f)}.   `}),g.add({severity:"warn",summary:"Formulari inválid",detail:t,life:5e3})}};return(t,l)=>{const f=w("Button");return t.newMovement?(_(),P("form",te,[s("div",null,[a(H,{label:"Material",fullName:!0,modelValue:t.newMovement.referenceId,"onUpdate:modelValue":l[0]||(l[0]=i=>t.newMovement.referenceId=i),class:q({"p-invalid":r.value.errors.referenceId})},null,8,["modelValue","class"])]),s("section",ne,[s("div",null,[a(c,{type:u(h).NUMERIC,label:"Quantitat",modelValue:t.newMovement.newQuantity,"onUpdate:modelValue":l[1]||(l[1]=i=>t.newMovement.newQuantity=i)},null,8,["type","modelValue"])]),s("div",null,[a(c,{type:u(h).NUMERIC,label:"Amplada (mm)",decimals:2,modelValue:t.newMovement.width,"onUpdate:modelValue":l[2]||(l[2]=i=>t.newMovement.width=i)},null,8,["type","modelValue"])]),s("div",null,[a(c,{type:u(h).NUMERIC,decimals:2,label:"Alçada (mm)",modelValue:t.newMovement.height,"onUpdate:modelValue":l[3]||(l[3]=i=>t.newMovement.height=i)},null,8,["type","modelValue"])])]),s("section",ae,[s("div",oe,[a(c,{type:u(h).NUMERIC,decimals:2,label:"Longitud (mm)",modelValue:t.newMovement.length,"onUpdate:modelValue":l[4]||(l[4]=i=>t.newMovement.length=i)},null,8,["type","modelValue"])]),s("div",le,[a(c,{type:u(h).NUMERIC,decimals:2,label:"Diàmetre (mm)",modelValue:t.newMovement.diameter,"onUpdate:modelValue":l[5]||(l[5]=i=>t.newMovement.diameter=i)},null,8,["type","modelValue"])]),s("div",ie,[a(c,{type:u(h).NUMERIC,decimals:2,label:"Gruix (mm)",modelValue:t.newMovement.thickness,"onUpdate:modelValue":l[6]||(l[6]=i=>t.newMovement.thickness=i)},null,8,["type","modelValue"])])]),a(f,{label:"Crear",onClick:b,style:{float:"right"},size:"small",class:"mt-2"})])):A("",!0)}}}),re={class:"flex flex-wrap align-items-center justify-content-between gap-2"},de={class:"datatable-filter flex flex-wrap gap-4 flex-1"},me={class:"filter-field flex gap-4"},ue=s("label",null,"Referencia",-1),ce={class:"filter-field flex gap-4"},ve=s("label",null,"Ubicació",-1),fe={class:"flex gap-2 flex-shrink-0"},Ve=D({__name:"Inventory",setup(y){const N=O(),p=S(),g=x(),I=L(),r=ee(),k=G(),b=Z(),t=M({referenceName:"",locationName:""});z(async()=>{N.setMenuItem({icon:U.BOX,title:"Inventari"}),await l()});const l=async()=>{var d;await b.fetchWarehousesWithLocations(),await I.fetchReferences(),await g.fetchStocks(),r.inventories=[],(d=g.stocks)==null||d.forEach(n=>{var o;let m={id:W(),stockId:n.id,movementType:"bal",locationId:n.locationId,locationName:b.getLocationName(n.locationId),referenceId:n.referenceId,referenceName:I.getFullNameById(n.referenceId),oldQuantity:n.quantity,newQuantity:n.quantity,width:n.width,length:n.length,height:n.height,diameter:n.diameter,thickness:n.thickness,movementDate:new Date};(o=r.inventories)==null||o.push(m)})},f=()=>{var d,n;t.value.referenceName&&(r.inventories=(d=r.inventories)==null?void 0:d.filter(m=>{var o;return(o=m.referenceName)==null?void 0:o.toLowerCase().includes(t.value.referenceName.toLowerCase())})),t.value.locationName&&(r.inventories=(n=r.inventories)==null?void 0:n.filter(m=>{var o;return(o=m.locationName)==null?void 0:o.toLowerCase().includes(t.value.locationName.toLowerCase())}))},i=M(!1),Q=M({}),T=d=>{var n;(n=r.inventories)==null||n.push(d),i.value=!1},R=()=>{i.value=!0,Q.value={id:C(),stockId:C(),movementType:"",locationId:"3fa85f64-5717-4562-b3fc-2c963f66afa6",referenceId:"",oldQuantity:0,newQuantity:0,width:0,length:0,height:0,diameter:0,thickness:0,movementDate:new Date}},E=async()=>{var o;let d={id:"",stockId:"",movementType:"",locationId:"",referenceId:"",quantity:0,width:0,length:0,height:0,diameter:0,thickness:0,movementDate:new Date,description:""},n=[];(o=r.inventories)==null||o.filter(e=>e.newQuantity!=e.oldQuantity).forEach(async e=>{e.newQuantity<e.oldQuantity?d={id:e.id,stockId:e.stockId,movementType:"OUTPUT",locationId:e.locationId,referenceId:e.referenceId,quantity:e.newQuantity-e.oldQuantity,width:e.width,length:e.length,height:e.height,diameter:e.diameter,thickness:e.thickness,movementDate:e.movementDate,description:"Sortida per inventari"}:e.newQuantity>e.oldQuantity&&(d={id:e.id,stockId:e.stockId,movementType:"INPUT",locationId:e.locationId,referenceId:e.referenceId,quantity:e.newQuantity-e.oldQuantity,width:e.width,length:e.length,height:e.height,diameter:e.diameter,thickness:e.thickness,movementDate:e.movementDate,description:"Entrada per inventari"}),n.push(k.create(d))}),(await Promise.all(n)).filter(e=>e===!0).length===n.length?(p.add({severity:"success",summary:"Inventari creat correctament",life:5e3}),l()):p.add({severity:"error",summary:"Error al crear el moviment d'inventari",life:5e3})};return(d,n)=>{const m=w("Button"),o=w("Column"),e=w("DataTable"),$=w("Dialog");return _(),P(j,null,[a(e,{value:u(r).inventories,tableStyle:"min-width: 100%",scrollable:"",scrollHeight:"75vh",paginator:"",rows:10,rowsPerPageOptions:[10,20,50],paginatorTemplate:"RowsPerPageDropdown FirstPageLink PrevPageLink CurrentPageReport NextPageLink LastPageLink",currentPageReportTemplate:"{first} a {last} de {totalRecords} entrades"},{header:V(()=>[s("div",re,[s("div",de,[s("div",me,[ue,a(c,{class:"mb-2",label:"",modelValue:t.value.referenceName,"onUpdate:modelValue":[n[0]||(n[0]=v=>t.value.referenceName=v),f]},null,8,["modelValue"])]),s("div",ce,[ve,a(c,{class:"mb-2",label:"",modelValue:t.value.locationName,"onUpdate:modelValue":[n[1]||(n[1]=v=>t.value.locationName=v),f]},null,8,["modelValue"])])]),s("div",fe,[a(m,{icon:u(U).PLUS,rounded:"",raised:"",onClick:R},null,8,["icon"]),a(m,{icon:u(U).SAVE,rounded:"",raised:"",onClick:E},null,8,["icon"])])])]),default:V(()=>[a(o,{field:"referenceName",header:"Producte",style:{width:"28%"}}),a(o,{field:"locationName",header:"Ubicació"}),a(o,{field:"oldQuantity",header:"Uds."}),a(o,{header:"Recompte",style:{width:"12%"}},{body:V(v=>[a(c,{class:"mb-2",label:"",id:"newQuantity",modelValue:v.data.newQuantity,"onUpdate:modelValue":B=>v.data.newQuantity=B},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),a(o,{field:"width",header:"Ample (x) mm"}),a(o,{field:"length",header:"Llarg (y) mm"}),a(o,{field:"height",header:"Alt (z) mm"}),a(o,{field:"diameter",header:"Diàmetre mm"}),a(o,{field:"thickness",header:"Gruix mm"})]),_:1},8,["value"]),a($,{closable:!0,visible:i.value,"onUpdate:visible":n[2]||(n[2]=v=>i.value=v),modal:!0},{default:V(()=>[a(se,{newMovement:Q.value,onSubmit:T},null,8,["newMovement"])]),_:1},8,["visible"])],64)}}});export{Ve as default};
