import{_ as Y}from"./ExerciseDatePicker.vue_vue_type_script_setup_true_lang-71eec8fe.js";import{_ as J}from"./FormCreateOrderOrInvoice.vue_vue_type_script_setup_true_lang-749b01fd.js";import{_ as K}from"./DropdownCustomers.vue_vue_type_script_setup_true_lang-0951f83c.js";import{_ as Q}from"./DropdownLifecycle.vue_vue_type_script_setup_true_lang-cafb5829.js";import{d as W,g as X,k as Z,z as ee,u as te,a4 as se,H as ae,r as k,M as ie,o as re,P as v,a5 as oe,T as F,h as b,c as N,i as a,w as n,l,N as ce,a as E,e as u,I as g,t as y,J as R,n as le,m as de,K as ne}from"./index-f6af8c81.js";import{u as ue}from"./reference-75fb097d.js";import{u as me}from"./customers-bf96fe43.js";import{u as fe}from"./lifecycle-b04b6c31.js";import{u as ve}from"./budget-ec909643.js";import"./form-validator-ec7c2535.js";import"./index-a7d21bd0.js";const pe={class:"flex flex-wrap align-items-center justify-content-between gap-2"},_e={class:"datatable-filter-3"},be={class:"filter-field"},ge={class:"filter-field"},ye=u("label",{class:"block text-900"},"Client",-1),xe={class:"filter-field"},he=u("label",{class:"block text-900"},"Estat",-1),Ie={class:"datatable-buttons"},we=["onClick"],Ue=W({__name:"Budgets",setup(ke){const S=X(),x=Z(),T=ee(),c=te(),C=se(),h=ae(),d=ve(),V=ue(),D=me(),I=fe(),i=k({customerId:void 0,statusId:void 0}),m=ie({visible:!1,title:"Crear pressupost",closable:!0,position:"center",modal:!0}),p=k(void 0);re(async()=>{I.fetchOneByName("Budget"),V.fetchReferences(),D.fetchCustomers(),await h.fetchActive(),P(),U(),await f(),c.setMenuItem({icon:v.APPLE,title:"Pressupostos"})}),oe(()=>{const e={statusId:i.value.statusId,customerId:i.value.customerId,exercisePicker:c.exercisePicker};C.addFilter("Budgets","",e),d.budgets=void 0});const U=()=>{const e=C.getFilter("Budgets","");e&&(i.value.statusId=e.statusId,i.value.customerId=e.customerId,e.exercisePicker&&(c.exercisePicker.exercise=e.exercisePicker.exercise,c.exercisePicker.dates=[new Date(e.exercisePicker.dates[0]),new Date(e.exercisePicker.dates[1])]))},P=()=>{var t;const e=new Date().getFullYear().toString();p.value=(t=h.exercises)==null?void 0:t.find(r=>r.name===e),p.value&&(c.exercisePicker.exercise=p.value,c.exercisePicker.dates=[new Date(c.exercisePicker.exercise.startDate),new Date(c.exercisePicker.exercise.endDate)])},q=()=>{i.value.customerId=void 0,i.value.statusId=void 0,P(),f()},_=k({}),$=()=>{var e;return{id:ne(),customerId:"",exerciseId:((e=p.value)==null?void 0:e.id)||"",date:new Date}},L=()=>{_.value=$(),m.visible=!0},f=async()=>{if(c.exercisePicker.dates){const e=F(c.exercisePicker.dates[0]),t=F(c.exercisePicker.dates[1]);await d.GetFiltered(e,t,i.value.customerId,i.value.statusId)}else x.add({severity:"info",summary:"Filtre invàlid",detail:"Seleccioni un període",life:5e3})},O=e=>{var r,o;const t=(o=(r=I.lifecycle)==null?void 0:r.statuses)==null?void 0:o.find(w=>w.id===e);return t?t.name:""},A=e=>{var r;const t=(r=D.customers)==null?void 0:r.find(o=>o.id===e);return t?t.comercialName:""},M=async()=>{m.visible=!1,await d.Create(_.value)&&S.push({path:`/budget/${_.value.id}`})},H=e=>{e.originalEvent.target.className.includes("grid_delete_column_button")||S.push({path:`/budget/${e.data.id}`})},j=async(e,t)=>{if(await d.GetAssociatedSalesOrders(t.id),d.order){x.add({severity:"warn",summary:"No es pot eliminar",detail:`El pressupost té la comanda ${d.order.number} associada`,life:5e3});return}T.require({message:"Està segur que vol eliminar el pressupost?",icon:"pi pi-question-circle",acceptIcon:"pi pi-check",rejectIcon:"pi pi-times",accept:async()=>{await d.Delete(t.id)&&(x.add({severity:"success",summary:"Eliminada",life:3e3}),await f())}})};return(e,t)=>{const r=b("Button"),o=b("Column"),w=b("DataTable"),z=b("Dialog");return E(),N(ce,null,[a(w,{value:l(d).budgets,class:"small-datatable",tableStyle:"min-width: 100%","sort-field":"salesOrderNumber","sort-mode":"single","sort-order":1,scrollable:"",scrollHeight:"80vh",paginator:"",rows:12,onRowClick:H},{header:n(()=>[u("div",pe,[u("div",_e,[u("div",be,[a(Y,{exercises:l(h).exercises,onRangeSelected:f},null,8,["exercises"])]),u("div",ge,[ye,a(K,{label:"",modelValue:i.value.customerId,"onUpdate:modelValue":t[0]||(t[0]=s=>i.value.customerId=s)},null,8,["modelValue"])]),u("div",xe,[he,a(Q,{label:"",name:"Budget",modelValue:i.value.statusId,"onUpdate:modelValue":t[1]||(t[1]=s=>i.value.statusId=s)},null,8,["modelValue"])])]),u("div",Ie,[a(r,{class:"datatable-button mr-2",icon:l(v).FILTER,rounded:"",raised:"",onClick:f},null,8,["icon"]),a(r,{class:"datatable-button mr-2",icon:l(v).FILTER_SLASH,rounded:"",raised:"",onClick:q},null,8,["icon"]),a(r,{icon:l(v).PLUS,rounded:"",raised:"",onClick:L},null,8,["icon"])])])]),default:n(()=>[a(o,{field:"number",header:"Número",style:{width:"10%"}}),a(o,{field:"date",header:"Data",style:{width:"15%"},sortable:""},{body:n(s=>[g(y(l(R)(s.data.date)),1)]),_:1}),a(o,{header:"Client",style:{width:"20%"}},{body:n(s=>[g(y(A(s.data.customerId)),1)]),_:1}),a(o,{header:"Estat",style:{width:"20%"}},{body:n(s=>[g(y(O(s.data.statusId)),1)]),_:1}),a(o,{field:"acceptanceDate",header:"Data d'acceptació",style:{width:"15%"}},{body:n(s=>[g(y(s.data.acceptanceDate?l(R)(s.data.acceptanceDate):""),1)]),_:1}),a(o,{field:"deliveryDays",header:"Dies d'entrega",style:{width:"10%"}}),a(o,{style:{width:"5%"}},{body:n(s=>{var B;return[s.data.statusId===((B=l(I).lifecycle)==null?void 0:B.initialStatusId)?(E(),N("i",{key:0,class:le([l(v).TIMES,"grid_delete_column_button"]),onClick:G=>j(G,s.data)},null,10,we)):de("",!0)]}),_:1})]),_:1},8,["value"]),a(z,{visible:m.visible,"onUpdate:visible":t[2]||(t[2]=s=>m.visible=s),header:m.title,closable:m.closable,modal:m.modal},{default:n(()=>[a(J,{"create-request":_.value,onSubmit:M},null,8,["create-request"])]),_:1},8,["visible","header","closable","modal"])],64)}}});export{Ue as default};
