import{af as Q,ag as W,d as q,u as K,H as U,j as X,k as Z,r as g,o as ee,P as F,T as V,W as _,Y as D,$ as te,h as x,c as ae,e as l,i,l as r,t as u,n as P,w as k,N as se,a as oe,I as ne,J as le,f as re}from"./index-f6af8c81.js";import{_ as ce}from"./ExerciseDatePicker.vue_vue_type_script_setup_true_lang-71eec8fe.js";import{E as ie}from"./index-d3847f4f.js";import"./suppliers.service-f3c59018.js";class de extends Q{async GetBetweenDates(p,w){const C=`${this.resource}/consolidated?startTime=${p}&endTime=${w}`,n=await W.get(C);if(n.status===200)return n.data}}const ue={class:"dashboard-filter"},pe={class:"dashboard-filter-left"},me={class:"dashboard-filter-field"},he={class:"dashboard-kpis"},fe={class:"kpi-card"},_e={class:"kpi-label"},ve={class:"kpi-value text-green-500"},ye={class:"kpi-card"},be={class:"kpi-label"},ge={class:"kpi-value text-pink-500"},xe={class:"kpi-card"},ke={class:"kpi-label"},De={class:"kpi-card"},we={class:"kpi-label"},Se={class:"dashboard-container"},Ce={class:"chart-area"},Ee=q({__name:"IncomesAndExpensesDashboard",setup(O){const p=K(),w=U(),C=new de("/income"),{t:n}=X(),G=Z(),L=g({dates:void 0,consolidatedBy:void 0}),Y=()=>{p.cleanExercisePicker(),L.value.consolidatedBy="",$()},v=g([]),y=g([]);ee(async()=>{p.setMenuItem({icon:F.MONEY_BILL,title:"Dashboard comparatiu flux de caixa"}),await w.fetchActive(),p.exercisePicker.exercise||p.setCurrentYear(),$()});let E;const j=()=>{E&&window.clearTimeout(E),E=window.setTimeout(()=>{$()},300)},$=async()=>{if(S.value=[],p.exercisePicker.dates){const s=V(p.exercisePicker.dates[0]),e=V(p.exercisePicker.dates[1]);let c,d;try{const[t,o]=await Promise.all([C.GetBetweenDates(s,e),ie.Expense.getConsolidated(s,e,"","")]);c=t,d=o}catch(t){console.error("Error loading dashboard data:",t),G.add({severity:"error",summary:n("common.error"),detail:n("analytics.cashflow.messages.loadError")||"Error loading dashboard data",life:5e3});return}c&&(v.value=c),d&&(y.value=d),T.value=I(),B.value=H()}},T=g(),B=g(),S=g([]),I=()=>{const s={},e={};v.value.forEach(a=>{const h=`${a.year}-${String(a.month).padStart(2,"0")}`;s[h]=(s[h]||0)+a.amount,S.value.push({date:a.date,type:a.type,detail:a.typeDetail,description:a.description,total:a.amount,source:"income"})}),y.value.forEach(a=>{const h=`${a.yearPaymentDate}-${String(a.monthPaymentDate).padStart(2,"0")}`;e[h]=(e[h]||0)+a.amount,S.value.push({date:a.paymentDate,type:a.type,detail:a.typeDetail,description:a.description,total:a.amount,source:"expense"})});const c=Object.keys(s).concat(Object.keys(e)).filter((a,h,J)=>J.indexOf(a)===h).sort(),d={type:"line",label:n("analytics.cashflow.series.incomes")||"Ingressos",borderColor:"#B3FFBA",backgroundColor:"#B3FFBA",data:c.map(a=>s[a]||0),fill:!1,tension:.3,pointRadius:3},t={type:"line",label:n("analytics.cashflow.series.expenses")||"Despeses",borderColor:"#ff336f",backgroundColor:"#ff336f",data:c.map(a=>e[a]||0),fill:!1,tension:.3,pointRadius:3},o=[];let f=0;for(const a of c){const h=(s[a]||0)-(e[a]||0);f+=h,o.push(f)}const m=[{type:"line",label:n("analytics.cashflow.series.balance")||"Saldo acumulat",borderColor:"#8a8a8a",backgroundColor:"rgba(138, 138, 138, 0.15)",data:o,fill:!0,borderDash:[],tension:.25,pointRadius:0,order:0},t,d];return{labels:c,datasets:m}},H=()=>{const s=getComputedStyle(document.documentElement),e=s.getPropertyValue("--p-text-color"),c=s.getPropertyValue("--p-text-muted-color"),d=s.getPropertyValue("--p-content-border-color");return{maintainAspectRatio:!1,aspectRatio:.8,plugins:{datalabels:{},tooltips:{mode:"index",intersect:!1,callbacks:{label:function(t,o){const f=t.yLabel||0;return`${o.datasets[t.datasetIndex].label||""}: ${_(Number(f))}`}}},tooltip:{mode:"index",intersect:!1,callbacks:{label:t=>{var b,m;const o=((b=t.dataset)==null?void 0:b.label)||"",f=((m=t.parsed)==null?void 0:m.y)??t.raw??0;return`${o}: ${_(Number(f))}`}}},legend:{labels:{color:e}}},scales:{x:{ticks:{color:c},grid:{color:d}},y:{ticks:{color:c,callback:t=>_(Number(t))},grid:{color:d}}}}},N=D(()=>v.value.reduce((s,e)=>s+((e==null?void 0:e.amount)||0),0)),M=D(()=>y.value.reduce((s,e)=>s+((e==null?void 0:e.amount)||0),0)),R=D(()=>N.value-M.value),z=D(()=>{const s=new Set;return v.value.forEach(e=>s.add(`${e.year}-${String(e.month).padStart(2,"0")}`)),y.value.forEach(e=>s.add(`${e.yearPaymentDate}-${String(e.monthPaymentDate).padStart(2,"0")}`)),Array.from(s).sort()}),A=D(()=>{const s=z.value;if(!s.length)return 0;const e={},c={};return v.value.forEach(t=>{const o=`${t.year}-${String(t.month).padStart(2,"0")}`;e[o]=(e[o]||0)+t.amount}),y.value.forEach(t=>{const o=`${t.yearPaymentDate}-${String(t.monthPaymentDate).padStart(2,"0")}`;c[o]=(c[o]||0)+t.amount}),s.reduce((t,o)=>t+((e[o]||0)-(c[o]||0)),0)/s.length});return te([v,y],()=>{T.value=I()}),(s,e)=>{const c=x("Button"),d=x("Chart"),t=x("TabPanel"),o=x("Column"),f=x("DataTable"),b=x("TabView");return oe(),ae(se,null,[l("div",ue,[l("div",pe,[l("div",me,[i(ce,{exercises:r(w).exercises,onRangeSelected:j},null,8,["exercises"])]),i(c,{class:"grid_add_row_button",icon:r(F).FILTER_SLASH,onClick:Y},null,8,["icon"])]),l("div",he,[l("div",fe,[l("div",_e,u(r(n)("analytics.cashflow.kpi.incomes")||"Ingressos"),1),l("div",ve,u(r(_)(N.value)),1)]),l("div",ye,[l("div",be,u(r(n)("analytics.cashflow.kpi.expenses")||"Despeses"),1),l("div",ge,u(r(_)(M.value)),1)]),l("div",xe,[l("div",ke,u(r(n)("analytics.cashflow.kpi.net")||"Nete"),1),l("div",{class:P(["kpi-value",R.value>=0?"text-green-600":"text-red-500"])},u(r(_)(R.value)),3)]),l("div",De,[l("div",we,u(r(n)("analytics.cashflow.kpi.avgMonthlyNet")||"Mitjana mensual neta"),1),l("div",{class:P(["kpi-value",A.value>=0?"text-green-600":"text-red-500"])},u(r(_)(A.value)),3)])])]),i(b,null,{default:k(()=>[i(t,{header:r(n)("analytics.cashflow.tabs.chart")||"Gràfics"},{default:k(()=>[l("div",Se,[l("div",Ce,[i(d,{type:"line",data:T.value,options:B.value,class:"w-full",style:{height:"100%"}},null,8,["data","options"])])])]),_:1},8,["header"]),i(t,{header:r(n)("analytics.cashflow.tabs.data")||"Dades"},{default:k(()=>[i(f,{value:S.value,class:"small-datatable",tableStyle:"min-width: 100%",scrollable:"",scrollHeight:"calc(100vh - var(--top-panel-height) - 10rem)",paginator:"",sortField:"date",sortOrder:1,rows:12},{default:k(()=>[i(o,{field:"date",header:r(n)("common.date")||"Data",style:{width:"15%"},sortable:""},{body:k(m=>[ne(u(r(le)(m.data.date)),1)]),_:1},8,["header"]),i(o,{header:r(n)("common.type")||"Tipus",field:"type"},null,8,["header"]),i(o,{header:r(n)("common.detail")||"Detall",field:"detail"},null,8,["header"]),i(o,{header:r(n)("common.description")||"Descripció",field:"description"},null,8,["header"]),i(o,{header:r(n)("common.total")||"Total",field:"total"},{body:k(m=>[l("span",{class:P(m.data.source==="income"?"text-green-600 font-semibold":"text-red-500 font-semibold")},u(r(_)(m.data.total)),3)]),_:1},8,["header"])]),_:1},8,["value","scrollHeight"])]),_:1},8,["header"])]),_:1})],64)}}});const Ie=re(Ee,[["__scopeId","data-v-f11fa129"]]);export{Ie as default};
