import{d as J,k as ee,E as te,Y as re,r as T,h as _,a as f,c as V,l as r,e as u,i as o,v as P,n as H,m as E,G as Q,p as we,b as Ie,f as ae,z as Se,o as oe,w as n,V as Ce,t as h,W as $,P as j,I as x,q as G,N as se,al as ge,F as N,x as he,g as Ne,u as Te,H as xe,a5 as Ee,a0 as Ve,a1 as Be,J as Z,a2 as Fe,K as We}from"./index-f6af8c81.js";import{u as le}from"./order-476e20f8.js";import{u as de}from"./reference-75fb097d.js";import{u as ie}from"./customers-bf96fe43.js";import{u as $e}from"./plantmodel-2dcc063a.js";import{u as ne}from"./lifecycle-b04b6c31.js";import{u as Re}from"./tax-320212e0.js";import{c as Me,a as Y,F as Le}from"./form-validator-ec7c2535.js";import{u as ue}from"./deliveryNote-744866f1.js";import{u as ce}from"./budget-ec909643.js";import{_ as Ue}from"./FormBudgetOrderDetail.vue_vue_type_script_setup_true_lang-e8074e39.js";import{L as Ae}from"./LinkReference-0160ecf2.js";import{_ as qe}from"./FormCreateWorkorder.vue_vue_type_script_setup_true_lang-9116edd5.js";import{u as me}from"./workmaster-93e285b1.js";import{u as ve}from"./workorder-ba859771.js";import{F as Ge}from"./FileEntityPicker-6ebb7fcb.js";import{S as ze}from"./index-a7d21bd0.js";import"./index-5443ddc0.js";import"./DropdownReference.vue_vue_type_script_setup_true_lang-b6b545e0.js";const X=B=>(we("data-v-9ef3c9d3"),B=B(),Ie(),B),Pe={key:0},Ye={class:"four-columns mt-2"},je=X(()=>u("label",{class:"block text-900 mb-2"},"Client",-1)),Xe=X(()=>u("label",{class:"block text-900 mb-2"},"Estat",-1)),He={class:"four-columns mt-2"},Je=X(()=>u("label",{class:"block text-900 mb-2"},"Data Alta",-1)),Ke=X(()=>u("label",{class:"block text-900 mb-2"},"Data Entrega",-1)),Qe=J({__name:"FormSalesOrder",emits:["submit","cancel"],setup(B,{expose:I,emit:p}){const L=le(),F=ie(),k=ne(),D=ue(),m=ce(),O=ee(),{salesOrder:a}=te(L),y=re(()=>D.deliveryNote?D.deliveryNote.number:""),W=Me().shape({siteId:Y().required("L'origen es obligatori"),customerId:Y().required("El client es obligatori"),statusId:Y().required("L'estat es obligatori"),exerciseId:Y().required("L'exercici es obligatori")}),S=T({result:!1,errors:{}}),C=()=>{const c=new Le(W);S.value=c.validate(a.value)};I({submitForm:async()=>{if(C(),S.value.result)A(),p("submit",a.value);else{let c="";Object.entries(S.value.errors).forEach(e=>{c+=`${e[1].map(i=>i)}.   `}),O.add({severity:"warn",summary:"Formulari inválid",detail:c,life:5e3})}}});const g=()=>{var e;const c=(e=F.customers)==null?void 0:e.find(i=>{var d;return i.id===((d=a.value)==null?void 0:d.customerId)});c&&a.value&&(a.value.customerCode=c.code,a.value.customerComercialName=c.comercialName,a.value.customerTaxName=c.taxName,a.value.customerVatNumber=c.vatNumber,a.value.customerAccountNumber=c.accountNumber)},A=()=>{a.value&&(a.value.date=Q(a.value.date),a.value.expectedDate&&(a.value.expectedDate=Q(a.value.expectedDate)))};return(c,e)=>{var w,R;const i=_("BaseInput"),d=_("Dropdown"),v=_("Calendar");return f(),V("div",null,[r(a)?(f(),V("form",Pe,[u("section",Ye,[u("div",null,[o(i,{type:r(P).TEXT,label:"Num. Comanda",id:"salesOrderNumber",modelValue:r(a).number,"onUpdate:modelValue":e[0]||(e[0]=t=>r(a).number=t),disabled:""},null,8,["type","modelValue"])]),u("div",null,[je,o(d,{modelValue:r(a).customerId,"onUpdate:modelValue":[e[1]||(e[1]=t=>r(a).customerId=t),e[2]||(e[2]=t=>g())],editable:"",options:r(F).customers,optionValue:"id",optionLabel:"comercialName",class:H(["w-full",{"p-invalid":S.value.errors.customerId}])},null,8,["modelValue","options","class"])]),u("div",null,[o(i,{type:r(P).TEXT,label:"Comanda Client",id:"customerSalesOrderNumber",modelValue:r(a).customerNumber,"onUpdate:modelValue":e[3]||(e[3]=t=>r(a).customerNumber=t)},null,8,["type","modelValue"])]),u("div",null,[Xe,o(d,{modelValue:r(a).statusId,"onUpdate:modelValue":e[4]||(e[4]=t=>r(a).statusId=t),editable:"",options:(w=r(k).lifecycle)==null?void 0:w.statuses,optionValue:"id",optionLabel:"name",class:H(["w-full",{"p-invalid":S.value.errors.statusId}])},null,8,["modelValue","options","class"])])]),u("section",He,[u("div",null,[Je,o(v,{modelValue:r(a).date,"onUpdate:modelValue":e[5]||(e[5]=t=>r(a).date=t),dateFormat:"dd/mm/yy"},null,8,["modelValue"])]),u("div",null,[Ke,o(v,{modelValue:r(a).expectedDate,"onUpdate:modelValue":e[6]||(e[6]=t=>r(a).expectedDate=t),dateFormat:"dd/mm/yy"},null,8,["modelValue"])]),u("div",null,[o(i,{type:r(P).TEXT,label:"Num. Pressupost",id:"budgetNumber",disabled:"",value:(R=r(m).budget)==null?void 0:R.number},null,8,["type","value"])]),u("div",null,[o(i,{type:r(P).TEXT,disabled:!0,label:"Albarà Entrega",id:"deliveryNote",modelValue:y.value,"onUpdate:modelValue":e[7]||(e[7]=t=>y.value=t)},null,8,["type","modelValue"])])])])):E("",!0)])}}});const Ze=ae(Qe,[["__scopeId","data-v-9ef3c9d3"]]),et={key:0},tt={key:1},rt=["onClick"],at={class:"total"},ot={class:"total-text"},st=J({__name:"TableSalesOrderDetails",props:{salesOrder:{},salesOrderDetails:{},secondaryLifecycle:{},workorders:{}},emits:["edit","delete","createWorkOrder","openWorkOrder"],setup(B,{emit:I}){const p=B,L=Se();de();const F=me(),k=ve(),D=re(()=>p.salesOrderDetails?p.salesOrderDetails.reduce((e,i)=>e+i.amount,0):0);oe(async()=>{k.fetchBySalesOrder(p.salesOrder.id)});var m=void 0;const O=T({closable:!0,modal:!0,title:"Generar ordre de fabricació",visible:!1}),a=T([]),y=T({workMasterId:"",plannedDate:"",plannedQuantity:0,comment:""}),W=e=>{p.salesOrder.deliveryNoteId||e.originalEvent.target.className.includes("grid_delete_column_button")||I("edit",e.data)},S=(e,i)=>{L.require({target:e.currentTarget,message:"Está segur que vol eliminar la referència?",icon:"pi pi-question-circle",acceptIcon:"pi pi-check",rejectIcon:"pi pi-times",accept:()=>{I("delete",i)}})},C=e=>{if(!e.workOrderId)return 0;const i=k.getWorkOrderCost(e.workOrderId);return i===0?0:i/e.quantity},U=e=>{a.value=F.getByReferenceId(e.referenceId),y.value.workMasterId="",a.value.length>0&&(y.value.workMasterId=a.value[0].id),y.value.plannedQuantity=e.quantity,y.value.plannedDate=p.salesOrder.expectedDate?ge(p.salesOrder.expectedDate):"",y.value.comment="",m=e,O.value.visible=!0},g=e=>{var d;if(!e)return"contrast";const i=k.getWorkOrderStatusById(e);if(i){const v=(d=p.secondaryLifecycle)==null?void 0:d.statuses.find(w=>w.id===i);if(v)return v.color}return"contrast"},A=e=>{I("openWorkOrder",e)},c=()=>{const e={workOrderDto:y.value,orderDetail:m};O.value.visible=!1,I("createWorkOrder",e)};return(e,i)=>{const d=_("Column"),v=_("Button"),w=_("DataTable"),R=_("Dialog");return f(),V(se,null,[o(w,{onRowClick:W,value:e.salesOrderDetails,tableStyle:"min-width: 100%",class:"p-datatable-sm",selectionMode:"single",dataKey:"id",sortMode:"single",sortField:"reference.code",sortOrder:1},{header:n(()=>[Ce(e.$slots,"header",{},void 0,!0)]),footer:n(()=>[u("div",at,[u("span",ot,"Total "+h(r($)(D.value)),1)])]),default:n(()=>[o(d,{field:"quantity",header:"Un.",style:{width:"3%"}}),o(d,{header:"Referencia",field:"reference.code",sortable:"",style:{width:"15%"}},{body:n(t=>[o(Ae,{id:t.data.referenceId},null,8,["id"])]),_:1}),o(d,{field:"description",header:"Descripció",style:{width:"25%"}}),o(d,{field:"workOrderId",header:"Ordre fabr.",style:{width:"8%"}},{body:n(t=>[r(k).getWorkOrderCodeById(t.data.workOrderId)?(f(),V("div",et,[o(v,{size:"small",severity:g(t.data.workOrderId),label:r(k).getWorkOrderCodeById(t.data.workOrderId),onClick:M=>A(t.data.workOrderId)},null,8,["severity","label","onClick"])])):(f(),V("div",tt,[o(v,{disabled:e.salesOrder.deliveryNoteId!==null,size:"small",icon:r(j).PLUS_CIRCLE,value:"Generar OF",onClick:M=>U(t.data)},null,8,["disabled","icon","onClick"])]))]),_:1}),o(d,{field:"unitCost",header:"Cost un. teo.",style:{width:"8%"}},{body:n(t=>[x(h(r($)(t.data.unitCost)),1)]),_:1}),o(d,{field:"totalCost",header:"Cost teòric",style:{width:"8%"}},{body:n(t=>[x(h(r($)(t.data.totalCost)),1)]),_:1}),o(d,{header:"Cost un. r.",style:{width:"8%"}},{body:n(t=>[x(h(r($)(C(t.data))),1)]),_:1}),o(d,{header:"Cost real",style:{width:"6%"}},{body:n(t=>[x(h(r($)(r(k).getWorkOrderCost(t.data.workOrderId))),1)]),_:1}),o(d,{field:"discount",header:"% Bene.",style:{width:"6%"}},{body:n(t=>[x(h(t.data.profit)+" % ",1)]),_:1}),o(d,{field:"profit",header:"% Desc.",style:{width:"6%"}},{body:n(t=>[x(h(t.data.discount)+" % ",1)]),_:1}),o(d,{header:"Preu un.",style:{width:"6%"}},{body:n(t=>[x(h(r($)(t.data.unitPrice)),1)]),_:1}),o(d,{field:"amount",header:"Total",style:{width:"6%"}},{body:n(t=>[x(h(r($)(t.data.amount)),1)]),_:1}),e.salesOrder.deliveryNoteId?E("",!0):(f(),G(d,{key:0,style:{width:"5%"}},{body:n(t=>[!t.data.isDelivered&&!t.data.workOrderId?(f(),V("i",{key:0,class:H([r(j).TIMES,"grid_delete_column_button"]),onClick:M=>S(M,t.data)},null,10,rt)):E("",!0)]),_:1}))]),_:3},8,["value"]),o(R,{closable:O.value.closable,visible:O.value.visible,"onUpdate:visible":i[0]||(i[0]=t=>O.value.visible=t),header:O.value.title,modal:O.value.modal,style:{width:"50vw"}},{default:n(()=>[o(qe,{createWorkOrderDto:y.value,"filtered-work-masters":a.value,onSubmit:c},null,8,["createWorkOrderDto","filtered-work-masters"])]),_:1},8,["closable","visible","header","modal"])],64)}}});const lt=ae(st,[["__scopeId","data-v-fdf45e2d"]]),dt={class:"flex flex-wrap align-items-center justify-content-between gap-2"},it=u("span",{class:"text-l text-900 font-bold"},"Linies de la comanda",-1),nt={key:0},ut="Línia de comanda",xt=J({__name:"SalesOrder",setup(B){const I=T(),p=T(N.EDIT),L=he(),F=Ne(),k=Te(),D=ee(),m=le(),O=ie(),a=$e(),y=xe(),W=ne(),S=de(),C=ue(),U=me(),g=ve(),A=Re(),c=ce(),{salesOrder:e}=te(m),i=[{label:"Descarregar",icon:j.FILE_WORD,command:()=>Oe()}],d=T(!1),v=T(N.EDIT),w=T(void 0),R=async()=>{const s=L.params.id;await m.GetById(s),S.fetchReferencesByModule("sales"),W.fetchOneByName("SalesOrder"),W.fetchSecondaryByName("WorkOrder"),a.fetchSites(),y.fetchAll(),O.fetchCustomers(),A.fetchAll(),g.fetchBySalesOrder(s),U.workmasters||U.fetchAllActives();let l="";e.value&&(p.value=N.EDIT,l=`Comanda ${e.value.number}`,e.value.date=Z(e.value.date),e.value.expectedDate&&(e.value.expectedDate=Z(e.value.expectedDate)),e.value.deliveryNoteId?C.GetById(e.value.deliveryNoteId):C.deliveryNote&&(C.deliveryNote=void 0),e.value.budgetId?await c.GetById(e.value.budgetId):c.budget=void 0),k.setMenuItem({icon:j.BUILDING,backButtonVisible:!0,title:l})};oe(async()=>{await R()}),Ee(()=>{m.salesOrder=void 0,m.salesOrders=void 0,m.salesOrdersToDeliver=void 0,C.deliveryNote=void 0,g.workorders=void 0});const t=()=>{I.value.submitForm()},M=(s,l)=>{s===N.CREATE&&(l={id:We(),referenceId:"",quantity:1,profit:0,productionProfit:0,materialProfit:25,externalProfit:25,discount:0,unitCost:0,serviceCost:0,transportCost:0,productionCost:0,materialCost:0,unitPrice:0,totalCost:0,amount:0,salesOrderHeaderId:"",lastCost:0,workMasterCost:0,description:"",estimatedDeliveryDate:new Date,isDelivered:!1,isInvoiced:!1,workMasterId:null,workOrderId:null}),l.salesOrderHeaderId=e.value.id,w.value=Object.assign({},l),v.value=s,d.value=!0},fe=async s=>{if(!s.date)return D.add({severity:"error",summary:"Error al crear la comanda ",detail:"La data no pot estar buida",life:5e3}),!1;let l=!1,b="";l=await m.Update(s.id,s),b=l?"Comanda actualitzada":"Error a l'actualitzar la comanda",D.add({life:5e3,severity:l?"success":"error",summary:b}),l&&F.back()},pe=async s=>{if(s=s,v.value===N.CREATE)await m.CreateDetail(s);else if(v.value===N.EDIT){await m.UpdateDetail(s);const l=e.value.salesOrderDetails.findIndex(b=>b.id===s.id);e.value.salesOrderDetails[l]=s}d.value=!1},ye=async s=>{p.value===N.EDIT&&await m.DeleteDetail(s);const l=e.value.salesOrderDetails.filter(b=>b.id!==s.id);e.value.salesOrderDetails=l,d.value=!1},be=async s=>{const l=await g.create(s.workOrderDto);l.result?(s.orderDetail.workOrderId=l.content.id,await m.UpdateDetail(s.orderDetail)&&(D.add({severity:"success",summary:"Generació OF",detail:`Ordre de fabricació ${l.content.code} generada`,life:5e3}),g.fetchBySalesOrder(e.value.id))):D.add({severity:"error",summary:"Generació OF",detail:"Error al generar la ordre de fabricació",life:5e3})},_e=s=>{F.push({path:`/workorder/${s}`})},Oe=async()=>{var l;const s=await ze.SalesOrder.GetReportDataById(e.value.id);if(s){const b=`Comanda_${(l=e.value)==null?void 0:l.number}.docx`,q=await new Fe().Download(s,Ve.Order,b);q?Be(b,q):D.add({severity:"warn",summary:"Error",detail:"No s'ha pugut generar fulla de la comanda"})}};return(s,l)=>{const b=_("SplitButton"),K=_("Button"),q=_("TabPanel"),ke=_("TabView"),De=_("Dialog");return f(),V(se,null,[o(b,{label:"Guardar",onClick:t,model:i,size:"small",class:"grid_add_row_button"}),o(Ze,{class:"mt-3 mb-3",ref_key:"salesOrderForm",ref:I,salesOrder:"salesOrder",onSubmit:fe},null,512),o(ke,null,{default:n(()=>[o(q,{header:"Detall"},{default:n(()=>[r(e)?(f(),G(lt,{key:0,salesOrder:r(e),salesOrderDetails:r(e).salesOrderDetails,secondaryLifecycle:r(W).secondaryLifecycle,workorders:r(g).workorders,onEdit:l[1]||(l[1]=z=>M(r(N).EDIT,z)),onDelete:ye,onCreateWorkOrder:be,onOpenWorkOrder:_e},{header:n(()=>[u("div",dt,[it,r(C).deliveryNote?E("",!0):(f(),V("section",nt,[o(K,{size:"small",label:"Afegir línea",onClick:l[0]||(l[0]=z=>M(r(N).CREATE,{})),class:"mr-2"})]))])]),_:1},8,["salesOrder","salesOrderDetails","secondaryLifecycle","workorders"])):E("",!0)]),_:1}),o(q,{header:"Fitxers"},{default:n(()=>[r(e)?(f(),G(Ge,{key:0,entity:"SalesOrder",id:r(e).id,title:""},null,8,["id"])):E("",!0)]),_:1})]),_:1}),r(e)?(f(),G(De,{key:0,style:{width:"100%"},maximizable:!0,closable:!0,visible:d.value,"onUpdate:visible":l[2]||(l[2]=z=>d.value=z),header:ut,modal:!0},{default:n(()=>[w.value?(f(),G(Ue,{key:0,formAction:v.value,header:r(e),detail:w.value,onSubmit:pe},null,8,["formAction","header","detail"])):E("",!0)]),_:1},8,["visible"])):E("",!0)],64)}}});export{xt as default};
