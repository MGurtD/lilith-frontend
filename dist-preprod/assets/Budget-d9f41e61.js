import{d as j,z as de,h as f,a as b,q as M,w as p,V as ue,i as s,I as C,t as h,l as e,W as R,c as x,n as G,P,m as I,k as J,E as Q,r as k,e as c,v as U,G as H,p as ce,b as me,f as pe,F as _,x as fe,g as be,u as ve,H as _e,o as ye,a5 as ge,a0 as De,a1 as we,N as Se,a2 as Ce,K as he}from"./index-f6af8c81.js";import{u as Ie}from"./reference-75fb097d.js";import{u as Y}from"./customers-bf96fe43.js";import{u as Te}from"./plantmodel-2dcc063a.js";import{u as Z}from"./lifecycle-b04b6c31.js";import{u as Ve}from"./tax-320212e0.js";import{S as Ee}from"./index-a7d21bd0.js";import{u as Be}from"./workmaster-93e285b1.js";import{u as W}from"./budget-ec909643.js";import{L as ke}from"./LinkReference-0160ecf2.js";import{c as xe,a as z,F as Fe}from"./form-validator-ec7c2535.js";import{_ as Re}from"./FormBudgetOrderDetail.vue_vue_type_script_setup_true_lang-e8074e39.js";import{u as Ae}from"./order-476e20f8.js";import"./index-5443ddc0.js";import"./DropdownReference.vue_vue_type_script_setup_true_lang-b6b545e0.js";const $e=["onClick"],Le=j({__name:"TableBudgetDetails",props:{budget:{},details:{}},emits:["edit","delete"],setup(T,{emit:D}){const V=de(),E=W(),B=d=>{d.originalEvent.target.className.includes("grid_delete_column_button")||D("edit",d.data)},F=(d,t)=>{V.require({target:d.currentTarget,message:"Está segur que vol eliminar la línea?",icon:"pi pi-question-circle",acceptIcon:"pi pi-check",rejectIcon:"pi pi-times",accept:()=>{D("delete",t)}})};return(d,t)=>{const m=f("Column"),v=f("DataTable");return b(),M(v,{onRowClick:B,value:d.details,tableStyle:"min-width: 100%",class:"p-datatable-sm",sortMode:"single",sortField:"reference.code",selectionMode:"single",dataKey:"id",sortOrder:1},{header:p(()=>[ue(d.$slots,"header")]),default:p(()=>[s(m,{field:"quantity",header:"Un.",style:{width:"3%"}}),s(m,{header:"Referencia",field:"reference.code",sortable:"",style:{width:"15%"}},{body:p(l=>[s(ke,{id:l.data.referenceId},null,8,["id"])]),_:1}),s(m,{field:"description",header:"Descripció",style:{width:"25%"}}),s(m,{header:"Cost intern",style:{width:"10%"}},{body:p(l=>[C(h(e(R)(l.data.totalCost-l.data.serviceCost-l.data.transportCost)),1)]),_:1}),s(m,{header:"Cost extern",style:{width:"10%"}},{body:p(l=>[C(h(e(R)(l.data.serviceCost+l.data.transportCost)),1)]),_:1}),s(m,{field:"totalCost",header:"Cost total",style:{width:"10%"}},{body:p(l=>[C(h(e(R)(l.data.totalCost)),1)]),_:1}),s(m,{field:"profit",header:"Benefici",style:{width:"10%"}},{body:p(l=>[C(h(l.data.profit)+" % ",1)]),_:1}),s(m,{field:"discount",header:"Descompte",style:{width:"10%"}},{body:p(l=>[C(h(l.data.discount)+" % ",1)]),_:1}),s(m,{field:"unitPrice",header:"Preu un.",style:{width:"10%"}},{body:p(l=>[C(h(e(R)(l.data.unitPrice)),1)]),_:1}),s(m,{field:"amount",header:"Total",style:{width:"10%"}},{body:p(l=>[C(h(e(R)(l.data.amount)),1)]),_:1}),s(m,{style:{width:"5%"}},{body:p(l=>[e(E).order===void 0?(b(),x("i",{key:0,class:G([e(P).TIMES,"grid_delete_column_button"]),onClick:A=>F(A,l.data)},null,10,$e)):I("",!0)]),_:1})]),_:3},8,["value"])}}}),O=T=>(ce("data-v-b9221a78"),T=T(),me(),T),Ne={key:0},Ue={class:"four-columns mt-2"},Me=O(()=>c("label",{class:"block text-900 mb-2"},"Data Alta",-1)),Pe=O(()=>c("label",{class:"block text-900 mb-2"},"Data Acceptació",-1)),Oe={class:"three-columns mt-2"},qe=O(()=>c("label",{class:"block text-900 mb-2"},"Estat",-1)),ze=O(()=>c("label",{class:"block text-900 mb-2"},"Client",-1)),Ge={key:0,class:"mt-2"},je=j({__name:"FormBudget",emits:["submit","cancel"],setup(T,{expose:D,emit:V}){const E=W(),B=Y(),F=Z(),d=J(),{budget:t}=Q(E),m=xe().shape({customerId:z().required("El client es obligatori"),statusId:z().required("L'estat es obligatori"),exerciseId:z().required("L'exercici es obligatori")}),v=k({result:!1,errors:{}}),l=()=>{const w=new Fe(m);v.value=w.validate(t.value)};D({submitForm:async()=>{if(l(),v.value.result)q(),V("submit",t.value);else{let w="";Object.entries(v.value.errors).forEach(n=>{w+=`${n[1].map(y=>y)}.   `}),d.add({severity:"warn",summary:"Formulari inválid",detail:w,life:5e3})}}});const q=()=>{t.value&&(t.value.date=H(t.value.date),t.value.acceptanceDate&&(t.value.acceptanceDate=H(t.value.acceptanceDate)))};return(w,n)=>{var g,S;const y=f("BaseInput"),r=f("Calendar"),$=f("Dropdown");return b(),x("div",null,[e(t)?(b(),x("form",Ne,[c("section",Ue,[c("div",null,[s(y,{type:e(U).TEXT,label:"Pressupost",id:"number",modelValue:e(t).number,"onUpdate:modelValue":n[0]||(n[0]=i=>e(t).number=i),disabled:""},null,8,["type","modelValue"])]),c("div",null,[Me,s(r,{modelValue:e(t).date,"onUpdate:modelValue":n[1]||(n[1]=i=>e(t).date=i),dateFormat:"dd/mm/yy"},null,8,["modelValue"])]),c("div",null,[Pe,s(r,{modelValue:e(t).acceptanceDate,"onUpdate:modelValue":n[2]||(n[2]=i=>e(t).acceptanceDate=i),dateFormat:"dd/mm/yy"},null,8,["modelValue"])]),c("div",null,[s(y,{type:e(U).TEXT,disabled:!0,label:"Comanda",value:(g=e(E).order)==null?void 0:g.number},null,8,["type","value"])])]),c("section",Oe,[c("div",null,[qe,s($,{modelValue:e(t).statusId,"onUpdate:modelValue":n[3]||(n[3]=i=>e(t).statusId=i),editable:"",options:(S=e(F).lifecycle)==null?void 0:S.statuses,optionValue:"id",optionLabel:"name",class:G(["w-full",{"p-invalid":v.value.errors.statusId}])},null,8,["modelValue","options","class"])]),c("div",null,[ze,s($,{modelValue:e(t).customerId,"onUpdate:modelValue":n[4]||(n[4]=i=>e(t).customerId=i),editable:"",options:e(B).customers,optionValue:"id",optionLabel:"comercialName",class:G(["w-full",{"p-invalid":v.value.errors.customerId}])},null,8,["modelValue","options","class"])]),c("div",null,[s(y,{type:e(U).NUMERIC,label:"Dies entrega",id:"deliveryDays",modelValue:e(t).deliveryDays,"onUpdate:modelValue":n[5]||(n[5]=i=>e(t).deliveryDays=i)},null,8,["type","modelValue"])])]),e(t).notes&&e(t).notes.length>0?(b(),x("section",Ge,[c("div",null,[s(y,{type:e(U).TEXT,label:"Notes",id:"notes",modelValue:e(t).notes,"onUpdate:modelValue":n[6]||(n[6]=i=>e(t).notes=i),disabled:""},null,8,["type","modelValue"])])])):I("",!0)])):I("",!0)])}}});const We=pe(je,[["__scopeId","data-v-b9221a78"]]),Xe={class:"flex flex-wrap align-items-center justify-content-between gap-2"},Ke=c("span",{class:"text-l text-900 font-bold"},"Linies del pressupost",-1),He={key:0},Je="Línia del pressupost",mt=j({__name:"Budget",setup(T){const D=k(_.EDIT),V=k(),E=fe(),B=be(),F=ve(),d=J(),t=W(),m=Y(),v=Te(),l=_e(),A=Z(),q=Ie(),w=Be(),n=Ve(),y=Ae(),{budget:r}=Q(t),$=[{label:"Descarregar",icon:P.FILE_WORD,command:()=>re()},{label:"Crear comanda",icon:P.FLAG_FILL,command:()=>le()}],g=k(!1),S=k(_.EDIT),i=k(void 0),ee=async()=>{const o=E.params.id;await t.GetById(o),await t.GetAssociatedSalesOrders(o),q.fetchReferencesByModule("sales"),w.fetchAllActives(),A.fetchOneByName("Budget"),v.fetchSites(),l.fetchAll(),m.fetchCustomers(),n.fetchAll();let a="";r.value&&(D.value=_.EDIT,a=`Pressupost ${r.value.number}`),F.setMenuItem({icon:P.BUILDING,backButtonVisible:!0,title:a})};ye(async()=>{await ee()}),ge(()=>{t.budget=void 0,t.order=void 0});const te=()=>{var a;if(!((a=r.value)!=null&&a.date))return d.add({severity:"error",summary:"Error al crear la comanda ",detail:"La data no pot estar buida",life:5e3}),!1;V.value.submitForm()},X=(o,a)=>{o===_.CREATE&&(a={id:he(),referenceId:"",workMasterId:null,profit:0,productionProfit:0,materialProfit:25,externalProfit:25,discount:0,quantity:1,unitCost:0,productionCost:0,materialCost:0,unitPrice:0,serviceCost:0,transportCost:0,totalCost:0,amount:0,budgetId:r.value.id,description:""}),i.value=Object.assign({},a),S.value=o,g.value=!0},ae=async o=>{let a=!1,u="";a=await t.Update(o.id,o),u=a?"Pressupost actualitzat correctament":"Error a l'actualitzar el pressupost",d.add({life:5e3,severity:a?"success":"error",summary:u}),a&&B.back()},oe=async o=>{if(o=o,S.value===_.CREATE)await t.CreateDetail(o);else if(S.value===_.EDIT){await t.UpdateDetail(o);const a=r.value.details.findIndex(u=>u.id===o.id);r.value.details[a]=o}g.value=!1},se=async o=>{D.value===_.EDIT&&await t.DeleteDetail(o);const a=r.value.details.filter(u=>u.id!==o.id);r.value.details=a,g.value=!1},le=async()=>{var o,a;if(t.order){d.add({severity:"warn",summary:"Aquest pressupost ja té una comanda associada",life:5e3});return}if(r.value){const u=await y.CreateFromBudget(r.value);u.result?(d.add({severity:"success",summary:`Comanda ${(o=u.content)==null?void 0:o.number} creada correctament`,life:5e3}),B.push(`/salesorder/${(a=u.content)==null?void 0:a.id}`)):d.add({severity:"error",summary:"Error al crear la comanda ",detail:u.errors[0],life:5e3})}},re=async()=>{var a;const o=await Ee.Budget.GetReportDataById(r.value.id);if(o){const u=`Pressupost_${(a=r.value)==null?void 0:a.number}.docx`,L=await new Ce().Download(o,De.Budget,u);L?we(u,L):d.add({severity:"warn",summary:"Error",detail:"No s'ha pugut generar fulla del pressupost"})}};return(o,a)=>{const u=f("SplitButton"),K=f("Button"),L=f("TabPanel"),ne=f("TabView"),ie=f("Dialog");return b(),x(Se,null,[s(u,{label:"Guardar",onClick:te,model:$,size:"small",class:"grid_add_row_button"}),s(We,{class:"mt-3 mb-3",ref_key:"budgetForm",ref:V,onSubmit:ae},null,512),s(ne,null,{default:p(()=>[s(L,{header:"Detall"},{default:p(()=>[e(r)&&e(r).details?(b(),M(Le,{key:0,budget:e(r),details:e(r).details,onEdit:a[1]||(a[1]=N=>X(e(_).EDIT,N)),onDelete:se},{header:p(()=>[c("div",Xe,[Ke,e(t).order?I("",!0):(b(),x("section",He,[s(K,{size:"small",label:"Afegir línea",onClick:a[0]||(a[0]=N=>X(e(_).CREATE,{})),class:"mr-2"})]))])]),_:1},8,["budget","details"])):I("",!0)]),_:1})]),_:1}),e(r)?(b(),M(ie,{key:0,closable:!0,style:{width:"100%"},maximizable:!0,visible:g.value,"onUpdate:visible":a[2]||(a[2]=N=>g.value=N),header:Je,modal:!0},{default:p(()=>[e(r)&&i.value?(b(),M(Re,{key:0,formAction:S.value,header:e(r),detail:i.value,readonly:!1,onSubmit:oe},null,8,["formAction","header","detail"])):I("",!0)]),_:1},8,["visible"])):I("",!0)],64)}}});export{mt as default};
