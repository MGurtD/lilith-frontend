import{d as L,o as M,h as k,q as j,w as n,a as F,V as z,i as r,I as y,t as I,l,J as E,W as A,e as _,n as T,c as $,P as g,m as H,f as K,k as G,z as J,g as Q,u as W,a4 as X,r as V,M as Z,a5 as ee,T as q,N as te,K as se}from"./index-f6af8c81.js";import{u as ae}from"./lifecycle-b04b6c31.js";import{u as R}from"./invoice-2a899c66.js";import{_ as re}from"./ExerciseDatePicker.vue_vue_type_script_setup_true_lang-71eec8fe.js";import{_ as ie}from"./DropdownCustomers.vue_vue_type_script_setup_true_lang-0951f83c.js";import{u as oe}from"./customers-bf96fe43.js";import{u as ce}from"./masterData-85d8bfb5.js";import{_ as ne}from"./FormCreateOrderOrInvoice.vue_vue_type_script_setup_true_lang-749b01fd.js";import"./index-a7d21bd0.js";import"./form-validator-ec7c2535.js";const le=["onClick"],de=L({__name:"TableInvoices",props:{invoices:{},customers:{}},emits:["edit","delete"],setup(N,{emit:b}){const w=N,v=ae(),i=R();M(async()=>{await v.fetchOneByName("SalesInvoice")});const S=t=>{var a;const o=(a=w.customers)==null?void 0:a.find(d=>d.id===t);return o?o.comercialName:""},h=t=>{var a;const o=(a=v.lifecycle)==null?void 0:a.statuses.find(d=>d.id===t);return o?o.name:""},x=t=>t.salesInvoiceDueDates?t.salesInvoiceDueDates.length===0?E(t.invoiceDate):E(t.salesInvoiceDueDates[t.salesInvoiceDueDates.length-1].dueDate):"",f=t=>{const o=i.getVerifactuStatusById(t);return o==="OK"?"status-ok":o==="Error"?"status-error":o==="Pendent"?"status-pending":""},u=t=>{t.originalEvent.target.className.includes("grid_delete_column_button")||b("edit",t.data)},m=(t,o)=>{b("delete",o)};return(t,o)=>{const a=k("Column"),d=k("DataTable");return F(),j(d,{class:"small-datatable",tableStyle:"min-width: 100%",scrollable:"",scrollHeight:"80vh",sortMode:"multiple",value:t.invoices,paginator:"",rows:12,onRowClick:u},{header:n(()=>[z(t.$slots,"filter",{},void 0,!0)]),default:n(()=>[r(a,{field:"invoiceNumber",header:"Número",sortable:!0,style:{width:"10%"}}),r(a,{header:"Data",field:"purchaseInvoiceDate",sortable:"",style:{width:"15%"}},{body:n(s=>[y(I(l(E)(s.data.invoiceDate)),1)]),_:1}),r(a,{header:"Client",style:{width:"15%"}},{body:n(s=>[y(I(S(s.data.customerId)),1)]),_:1}),r(a,{header:"Estat",style:{width:"15%"}},{body:n(s=>[y(I(h(s.data.statusId)),1)]),_:1}),r(a,{header:"Venciment",style:{width:"15%"}},{body:n(s=>[y(I(x(s.data)),1)]),_:1}),r(a,{header:"Import",style:{width:"15%"}},{body:n(s=>[y(I(l(A)(s.data.netAmount)),1)]),_:1}),r(a,{header:"Verifactu",style:{width:"10%"}},{body:n(s=>[_("span",{class:T(f(s.data.integrationStatusId))},I(l(i).getVerifactuStatusById(s.data.integrationStatusId)),3)]),_:1}),r(a,{style:{width:"5%"}},{body:n(s=>{var D;return[s.data.statusId===((D=l(v).lifecycle)==null?void 0:D.initialStatusId)?(F(),$("i",{key:0,class:T([l(g).TIMES,"grid_delete_column_button"]),onClick:C=>m(C,s.data)},null,10,le)):H("",!0)]}),_:1})]),_:3},8,["value"])}}});const ue=K(de,[["__scopeId","data-v-9aec14af"]]),me={class:"flex flex-wrap align-items-center justify-content-between gap-1"},fe={class:"datatable-filter"},_e={class:"filter-field"},ve={class:"filter-field"},pe=_("label",null,"Client",-1),Ie={class:"datatable-buttons"},Pe=L({__name:"SalesInvoices",setup(N){const b=G(),w=J(),v=Q(),i=W(),S=X(),h=ce(),x=oe(),f=R(),u=V({customerId:void 0}),m=Z({visible:!1,title:"Crear factura",closable:!0,position:"center",modal:!0});M(async()=>{x.fetchCustomers(),await h.fetchMasterData(),a(),t(),await d(),i.setMenuItem({icon:g.MONEY_BILL,title:"Factures de venta"})}),ee(()=>{const e={customerId:u.value.customerId,exercisePicker:i.exercisePicker};S.addFilter("SalesInvoices","",e),f.invoices=void 0});const t=()=>{const e=S.getFilter("SalesInvoices","");e&&(u.value.customerId=e.customerId,e.exercisePicker&&(i.exercisePicker.exercise=e.exercisePicker.exercise,i.exercisePicker.dates=[new Date(e.exercisePicker.dates[0]),new Date(e.exercisePicker.dates[1])]))},o=()=>{i.cleanExercisePicker(),u.value.customerId=void 0},a=()=>{var p;const e=new Date().getFullYear().toString(),c=(p=h.exercises)==null?void 0:p.find(P=>P.name===e);c&&(i.exercisePicker.exercise=c,i.exercisePicker.dates=[new Date(i.exercisePicker.exercise.startDate),new Date(i.exercisePicker.exercise.endDate)])},d=async()=>{let e="",c="";i.exercisePicker.dates&&(e=q(i.exercisePicker.dates[0]),c=q(i.exercisePicker.dates[1])),await f.GetFiltered(e,c,void 0,u.value.customerId,void 0)},s=V({}),D=()=>({id:se(),customerId:"",exerciseId:"",date:new Date}),C=()=>{s.value=D(),m.visible=!0},U=async()=>{const e=await f.Create(s.value);if(e&&!(e!=null&&e.result)){const c=e.errors.length>0?e.errors[0]:"Error desconegut, contacte amb l'administrador.";b.add({severity:"warn",summary:"Error al crear la factura",detail:c,life:1e4});return}e&&v.push({path:`/sales-invoice/${s.value.id}`})},O=e=>{v.push({path:`/sales-invoice/${e.id}`})},Y=e=>{w.require({message:"Està segur que vol eliminar la factura?",icon:"pi pi-question-circle",acceptIcon:"pi pi-check",rejectIcon:"pi pi-times",accept:async()=>{await f.Delete(e.id)&&(b.add({severity:"success",summary:"Eliminada",life:3e3}),await d())}})};return(e,c)=>{const p=k("Button"),P=k("Dialog");return F(),$(te,null,[r(ue,{invoices:l(f).invoices,customers:l(x).customers,onEdit:O,onDelete:Y},{filter:n(()=>[_("div",me,[_("div",fe,[_("div",_e,[r(re,{exercises:l(h).exercises,onRangeSelected:d},null,8,["exercises"])]),_("div",ve,[pe,r(ie,{label:"",modelValue:u.value.customerId,"onUpdate:modelValue":c[0]||(c[0]=B=>u.value.customerId=B)},null,8,["modelValue"])])]),_("div",Ie,[r(p,{class:"datatable-button mr-2",icon:l(g).FILTER,rounded:"",raised:"",onClick:d},null,8,["icon"]),r(p,{class:"datatable-button mr-2",icon:l(g).FILTER_SLASH,rounded:"",raised:"",onClick:o},null,8,["icon"]),r(p,{icon:l(g).PLUS,rounded:"",raised:"",onClick:C},null,8,["icon"])])])]),_:1},8,["invoices","customers"]),r(P,{visible:m.visible,"onUpdate:visible":c[1]||(c[1]=B=>m.visible=B),header:m.title,closable:m.closable,modal:m.modal},{default:n(()=>[r(ne,{"create-request":s.value,onSubmit:U},null,8,["create-request"])]),_:1},8,["visible","header","closable","modal"])],64)}}});export{Pe as default};
