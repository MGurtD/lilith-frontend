import{d as U,k as Q,r as R,h as b,c as V,e as o,i as n,l as v,t as S,n as K,m as C,p as J,b as X,a as I,W as M,f as Z,z as De,Y as ee,o as te,q as O,w as f,V as he,P as T,I as B,J as z,ah as Ie,D as L,v as j,a6 as Ne,x as Se,g as ge,u as we,E as $e,M as oe,a5 as Ve,a0 as Ce,a1 as ke,am as Be,N as Re,a2 as qe,G as Fe}from"./index-f6af8c81.js";import{u as se}from"./invoice-2a899c66.js";import{u as Ee}from"./customers-bf96fe43.js";import{u as Y}from"./lifecycle-b04b6c31.js";import{u as ne}from"./tax-320212e0.js";import{u as xe}from"./deliveryNote-744866f1.js";import{u as re}from"./reference-75fb097d.js";import{c as ae,a as le,d as W,F as ce}from"./form-validator-ec7c2535.js";import{u as de}from"./masterData-85d8bfb5.js";import{L as Te}from"./LinkReference-0160ecf2.js";import{S as Ue}from"./index-a7d21bd0.js";import{u as Ae}from"./verifactu-fb627a8b.js";const q=m=>(J("data-v-74079c5c"),m=m(),X(),m),Le={key:0},Me={class:"four-columns"},Oe={class:"mt-2"},ze={class:"mt-2"},Pe=q(()=>o("label",{class:"block text-900 mb-2"},"Data Factura",-1)),Ge={class:"mt-2"},je=q(()=>o("label",{class:"block text-900 mb-2"},"Estat",-1)),Qe={class:"mt-2"},Ye=q(()=>o("label",{class:"block text-900 mb-2"},"Métode Pagament",-1)),He={class:"four-columns mt-2"},Ke=q(()=>o("label",{class:"block text-900 mb-2"},"Base",-1)),We={class:"summary-field"},Je=q(()=>o("label",{class:"block text-900 mb-2"},"Impostos",-1)),Xe={class:"summary-field"},Ze=q(()=>o("label",{class:"block text-900 mb-2"},"Total",-1)),et={class:"summary-field"},tt=q(()=>o("label",{class:"block text-900 mb-2"},"Verifactu",-1)),at=U({__name:"FormSalesInvoice",props:{invoice:{}},emits:["submit","cancel"],setup(m,{emit:g}){const c=m;Q();const _=de(),D=Y(),p=se();ae().shape({invoiceDate:le().required("La data és obligatoria"),paymentMethodId:le().required("El métode de pagament és obligatori")}),R({result:!1,errors:{}});const h=()=>{const r=p.getVerifactuStatusById(c.invoice.integrationStatusId);return r==="OK"?"status-ok":r==="Error"?"status-error":r==="Pendent"?"status-pending":""};return(r,d)=>{var t;const u=b("BaseInput"),a=b("Calendar"),s=b("Dropdown");return r.invoice?(I(),V("form",Le,[o("section",Me,[o("div",Oe,[n(u,{modelValue:r.invoice.invoiceNumber,"onUpdate:modelValue":d[0]||(d[0]=i=>r.invoice.invoiceNumber=i),label:"Número",disabled:!0},null,8,["modelValue"])]),o("div",ze,[Pe,n(a,{modelValue:r.invoice.invoiceDate,"onUpdate:modelValue":d[1]||(d[1]=i=>r.invoice.invoiceDate=i),dateFormat:"dd/mm/yy"},null,8,["modelValue"])]),o("div",Ge,[je,n(s,{modelValue:r.invoice.statusId,"onUpdate:modelValue":d[2]||(d[2]=i=>r.invoice.statusId=i),editable:"",options:(t=v(D).lifecycle)==null?void 0:t.statuses,optionValue:"id",optionLabel:"name",class:"w-full"},null,8,["modelValue","options"])]),o("div",Qe,[Ye,n(s,{modelValue:r.invoice.paymentMethodId,"onUpdate:modelValue":d[3]||(d[3]=i=>r.invoice.paymentMethodId=i),editable:"",options:v(_).paymentMethods,optionValue:"id",optionLabel:"name",class:"w-full"},null,8,["modelValue","options"])])]),o("section",He,[o("div",null,[Ke,o("span",We,S(v(M)(r.invoice.baseAmount)),1)]),o("div",null,[Je,o("span",Xe,S(v(M)(r.invoice.taxAmount)),1)]),o("div",null,[Ze,o("span",et,S(v(M)(r.invoice.netAmount)),1)]),o("div",null,[tt,o("span",{class:K(["summary-field",h()])},S(v(p).getVerifactuStatusById(r.invoice.integrationStatusId)),3)])])])):C("",!0)}}});const it=Z(at,[["__scopeId","data-v-74079c5c"]]),ot=["onClick"],lt={class:"vertical-align-middle ml-2 font-bold line-height-3"},st={key:0},nt={key:1},rt=["onClick"],ct=U({__name:"TableInvoiceDetails",props:{details:{},deliveryNotes:{},canDelete:{type:Boolean}},emits:["delete","deleteDeliveryNote"],setup(m,{emit:g}){const c=m,_=De(),D=Y(),p=ne(),h=re(),r=ee(()=>{let s=[];if(!c.details)return s;const t=c.details.filter(l=>!l.deliveryNoteDetailId).map(l=>({deliveryNoteId:"",deliveryNoteNumber:"Sense albarà",deliveryNoteDate:"",...l}));t.length>0&&s.push(...t);const i=c.details.filter(l=>l.deliveryNoteDetailId).map(l=>{var F;const e=(F=c.deliveryNotes)==null?void 0:F.find(E=>{var x;return E.id===((x=l.deliveryNoteDetail)==null?void 0:x.deliveryNoteId)}),w=e&&e.deliveryDate?`Entregat ${z(e.deliveryDate)}`:"No entregat";if(h.references){const E=h.references.find(x=>{var P;return x.id===((P=l.deliveryNoteDetail)==null?void 0:P.referenceId)});E&&(l.reference=E)}return{deliveryNoteId:e==null?void 0:e.id,deliveryNoteNumber:`Albarà ${e?`${e.number} - ${w}`:"--"}`,deliveryNoteDate:e&&e.deliveryDate?` - ${z(e.deliveryDate)}`:"",...l}});return i.length>0&&s.push(...i),console.log(i,s),Ie.orderBy(s,l=>[l.deliveryNoteNumber,l.description])});te(async()=>{await D.fetchOneByName("SalesInvoice")});const d=s=>{var i;const t=(i=p.taxes)==null?void 0:i.find(l=>l.id===s);if(t)return`${t.name}`},u=(s,t)=>{_.require({message:`Està segur que vol eliminar la línea ${t.description}?`,icon:"pi pi-question-circle",acceptIcon:"pi pi-check",rejectIcon:"pi pi-times",accept:async()=>{g("delete",t)}})},a=(s,t)=>{if(!c.deliveryNotes)return;const i=c.deliveryNotes.find(l=>l.id===t.deliveryNoteId);i&&_.require({message:`Està segur que vol treure l'${t.deliveryNoteNumber}?`,icon:"pi pi-question-circle",acceptIcon:"pi pi-check",rejectIcon:"pi pi-times",accept:async()=>{g("deleteDeliveryNote",i)}})};return(s,t)=>{const i=b("Column"),l=b("DataTable");return I(),O(l,{class:"p-datatable-sm",tableStyle:"min-width: 100%",scrollable:"",scrollHeight:"62vh",value:r.value,rowGroupMode:"subheader",groupRowsBy:"deliveryNoteNumber"},{header:f(()=>[he(s.$slots,"header")]),groupheader:f(e=>[s.canDelete&&e.data.deliveryNoteNumber!=="Sense albarà"?(I(),V("i",{key:0,class:K([v(T).TIMES,"grid_delete_column_button"]),onClick:w=>a(w,e.data)},null,10,ot)):C("",!0),B("   "),o("span",lt,S(e.data.deliveryNoteNumber),1)]),default:f(()=>[n(i,{header:"Albarà",field:"deliveryNoteNumber",style:{width:"5%"}}),n(i,{header:"",field:"",style:{width:"2%"}}),n(i,{header:"Quantitat",field:"quantity",style:{width:"10%"}}),n(i,{header:"Referència",field:"reference.code",style:{width:"15%"}},{body:f(e=>[e.data.deliveryNoteDetail?(I(),V("span",st,[n(Te,{id:e.data.deliveryNoteDetail.referenceId},null,8,["id"])])):(I(),V("span",nt,"--"))]),_:1}),n(i,{header:"Descripció",field:"description",style:{width:"40%"}}),n(i,{header:"Preu unitat",style:{width:"10%"}},{body:f(e=>[B(S(v(M)(e.data.unitPrice)),1)]),_:1}),n(i,{header:"Impost",style:{width:"10%"}},{body:f(e=>[B(S(d(e.data.taxId)),1)]),_:1}),n(i,{header:"Total",field:"totalCost",style:{width:"10%"}},{body:f(e=>[B(S(v(M)(e.data.amount)),1)]),_:1}),n(i,{style:{width:"10%"}},{body:f(e=>[!e.data.deliveryNoteDetailId&&s.canDelete?(I(),V("i",{key:0,class:K([v(T).TIMES,"grid_delete_column_button"]),onClick:w=>u(w,e.data)},null,10,rt)):C("",!0)]),_:1})]),_:3},8,["value"])}}}),dt={key:0},ut={class:"two-columns-7525"},vt={class:"mt-2"},mt={class:"mt-2"},pt=o("label",{class:"block text-900 mb-2"},"Impost",-1),yt={class:"three-columns"},ft={class:"mt-2"},_t={class:"mt-2"},bt={class:"mt-2"},Dt=U({__name:"FormSalesInvoiceDetail",props:{invoiceDetail:{}},emits:["submit","cancel"],setup(m,{emit:g}){const c=m,_=Q(),D=de(),p=()=>{const a=c.invoiceDetail;a.quantity&&a.quantity>0&&a.unitPrice&&(c.invoiceDetail.unitCost=a.unitPrice,c.invoiceDetail.amount=Ne.round(a.quantity*a.unitPrice,2),c.invoiceDetail.totalCost=c.invoiceDetail.amount)},h=ae().shape({quantity:W().min(1).required("La quantitat ha de ser superior a 1"),unitPrice:W().required("El preu unitat és obligatori")}),r=R({result:!1,errors:{}}),d=()=>{const a=new ce(h);r.value=a.validate(c.invoiceDetail)},u=async()=>{if(d(),r.value.result)g("submit",c.invoiceDetail);else{let a="";Object.entries(r.value.errors).forEach(s=>{a+=`${s[1].map(t=>t)}.   `}),_.add({severity:"warn",summary:"Formulari inválid",detail:a,life:5e3})}};return(a,s)=>{const t=b("Dropdown"),i=b("Button");return a.invoiceDetail?(I(),V("form",dt,[o("section",ut,[o("div",vt,[n(L,{label:"Descripció",modelValue:a.invoiceDetail.description,"onUpdate:modelValue":s[0]||(s[0]=l=>a.invoiceDetail.description=l)},null,8,["modelValue"])]),o("div",mt,[pt,n(t,{modelValue:a.invoiceDetail.taxId,"onUpdate:modelValue":s[1]||(s[1]=l=>a.invoiceDetail.taxId=l),editable:"",options:v(D).taxes,optionValue:"id",optionLabel:"name",class:"w-full"},null,8,["modelValue","options"])])]),o("section",yt,[o("div",ft,[n(L,{type:v(j).NUMERIC,label:"Quantitat",modelValue:a.invoiceDetail.quantity,"onUpdate:modelValue":[s[2]||(s[2]=l=>a.invoiceDetail.quantity=l),p]},null,8,["type","modelValue"])]),o("div",_t,[n(L,{type:v(j).CURRENCY,label:"Preu Unitat","model-value":a.invoiceDetail.unitPrice,"onUpdate:modelValue":[s[3]||(s[3]=l=>a.invoiceDetail.unitPrice=l),p]},null,8,["type","model-value"])]),o("div",bt,[n(L,{type:v(j).CURRENCY,label:"Total","model-value":a.invoiceDetail.amount,"onUpdate:modelValue":s[4]||(s[4]=l=>a.invoiceDetail.amount=l),disabled:""},null,8,["type","model-value"])])]),n(i,{label:"Crear",onClick:u,style:{float:"right"},size:"small",class:"mt-2"})])):C("",!0)}}}),ht={key:0},It={class:"mt-2"},Nt=U({__name:"FormRectificativeInvoice",props:{rectificativeInvoice:{},maximumQuantity:{}},emits:["submit","cancel"],setup(m,{emit:g}){const c=m,_=Q(),D=ae().shape({quantity:W().min(1,"La quantitat ha de ser superior a 1").required("La quanitat és obligatoria")}),p=R({result:!1,errors:{}}),h=()=>{const d=new ce(D);p.value=d.validate(c.rectificativeInvoice)},r=async()=>{if(h(),p.value.result){if(c.rectificativeInvoice.quantity>c.maximumQuantity){_.add({severity:"warn",summary:"Formulari invàlid",detail:"La quanitat introduïda no pot ser superior a la quantitat de la factura",life:5e3});return}g("submit",c.rectificativeInvoice)}else{let d="";Object.entries(p.value.errors).forEach(u=>{d+=`${u[1].map(a=>a)}.   `}),_.add({severity:"warn",summary:"Formulari invàlid",detail:d,life:5e3})}};return(d,u)=>{const a=b("Button");return d.rectificativeInvoice?(I(),V("form",ht,[o("section",null,[o("div",It,[n(L,{label:"Import a facturar sense IVA",modelValue:d.rectificativeInvoice.quantity,"onUpdate:modelValue":u[0]||(u[0]=s=>d.rectificativeInvoice.quantity=s),decimals:2,type:v(j).CURRENCY},null,8,["modelValue","type"])])]),n(a,{label:"Crear",onClick:r,style:{float:"right"},size:"small",class:"mt-2"})])):C("",!0)}}}),St=m=>(J("data-v-1516f95e"),m=m(),X(),m),gt={class:"selector-filter"},wt={class:"selector-filter-field"},$t=St(()=>o("label",{for:""},"Buscar",-1)),Vt={class:"selector-filter-button"},Ct={class:"flex align-items-center gap-2"},kt=U({__name:"SelectorDeliveryNotes",props:{deliveryNotes:{},headerVisible:{type:Boolean}},emits:["selected"],setup(m,{emit:g}){const c=m;te(()=>{_.fetchOneByName("DeliveryNote")});const _=Y(),D=R([]),p=R(""),h=ee(()=>{var u=[];return c.deliveryNotes&&(u=c.deliveryNotes.filter(a=>a.number.toString().includes(p.value))),u}),r=u=>{var s;const a=(s=_.lifecycle)==null?void 0:s.statuses.find(t=>t.id===u);return a?a.name:""},d=()=>{D.value.length!==0&&g("selected",D.value)};return(u,a)=>{const s=b("InputText"),t=b("Button"),i=b("Column"),l=b("DataTable");return I(),O(l,{class:"small-datatable",tableStyle:"min-width: 100%",scrollable:"",scrollHeight:"75vh",metaKeySelection:!1,value:h.value,selectionMode:"multiple",selection:D.value,"onUpdate:selection":a[1]||(a[1]=e=>D.value=e)},{header:f(()=>[o("header",gt,[o("div",wt,[$t,B("   "),n(s,{style:{width:"150px",height:"35px"},modelValue:p.value,"onUpdate:modelValue":a[0]||(a[0]=e=>p.value=e),size:"small"},null,8,["modelValue"])]),o("div",Vt,[n(t,{onClick:d,size:"small",icon:v(T).CHECK_SQUARE},null,8,["icon"])])])]),groupheader:f(e=>[o("div",Ct,[o("b",null,"Albarà d'entrega "+S(e.data.salesOrderNumber)+" - "+S(v(z)(e.data.salesOrderDate)),1)])]),default:f(()=>[n(i,{header:"Número",field:"number",style:{width:"10%"}}),n(i,{header:"Estat",field:"status",style:{width:"10%"}},{body:f(e=>[B(S(r(e.data.statusId)),1)]),_:1}),n(i,{header:"Data Entrega",field:"deliveryDate",style:{width:"10%"}},{body:f(e=>[B(S(e.data.deliveryDate?v(z)(e.data.deliveryDate):""),1)]),_:1})]),_:1},8,["value","selection"])}}});const Bt=Z(kt,[["__scopeId","data-v-1516f95e"]]),Rt=m=>(J("data-v-92d26da0"),m=m(),X(),m),qt={class:"button-panel"},Ft={class:"flex align-items-end justify-content-end"},Et={key:0},xt={class:"flex flex-wrap align-items-center justify-content-between gap-2"},Tt=Rt(()=>o("span",{class:"text-xl text-900 font-bold"},"Detall de la factura",-1)),Ut=U({__name:"SalesInvoice",setup(m){const g=[{label:"Descarregar",icon:T.FILE_WORD,command:()=>x()},{label:"Rectificativa",icon:T.FILE_IMPORT,command:()=>fe()}],c=Se(),_=ge(),D=we(),p=Q(),h=ne(),r=Ee(),d=Y(),u=se(),a=xe(),s=re();Ae();const{invoice:t}=$e(u),i={Free:0,FromDeliveryNote:1,Rectificative:2},l=R(0),e=oe({visible:!1,title:"",closable:!0,position:"center",modal:!0}),w=R("");te(async()=>{w.value=c.params.id,h.taxes||await h.fetchAll(),r.customers||await r.fetchCustomers(),await s.fetchReferencesByModule("sales"),await d.fetchOneByName("SalesInvoice"),await u.GetById(w.value),await a.GetByInvoiceId(w.value),t.value&&(t.value.invoiceDate=z(t.value.invoiceDate)),D.setMenuItem({icon:T.WALLET,title:`Factura de venta ${t.value.invoiceNumber} - ${t.value.customerComercialName}`,backButtonVisible:!0})}),Ve(()=>{u.invoice=void 0,a.deliveryNotes=void 0});const F=ee(()=>t.value!==void 0&&t.value.parentSalesInvoiceId===null),E=async()=>{t.value&&(t.value.invoiceDate=Fe(t.value.invoiceDate),await u.Update(t.value)&&_.back())},x=async()=>{var N;const y=await Ue.SalesInvoice.GetReportDataById(t.value.id);if(y){const k=`Factura_${(N=t.value)==null?void 0:N.invoiceNumber}.docx`,G=await new qe().Download(y,Ce.Invoice,k);G?ke(k,G):p.add({severity:"warn",summary:"Error",detail:"No s'ha pugut generar fulla de la comanda"})}},P=async()=>{t.value&&(await a.GetToInvoice(t.value.customerId),l.value=i.FromDeliveryNote,e.title="Selector d'albarans d'entrega",e.visible=!0)},ue=async y=>{for(let N=0;N<y.length;N++){const k=y[N];await u.AddDeliveryNote(t.value.id,k)}e.visible=!1,ie()},ve=async y=>{await u.RemoveDeliveryNote(t.value.id,y),ie()},ie=async()=>{d.fetchOneByName("SalesInvoice"),await a.GetByInvoiceId(w.value)},$=oe({}),me=()=>{var y;if(l.value=i.Free,t.value){$.salesInvoiceId=t.value.id,$.quantity=1,$.description="",$.unitPrice=0,$.amount=0,$.totalCost=0;const N=(y=h.taxes)==null?void 0:y.find(k=>k.percentatge===21);N&&($.taxId=N.id),e.title="Introducció de línea lliure",e.visible=!0}},pe=async()=>{await u.CreateInvoiceDetail($),e.visible=!1},ye=async y=>{await u.DeleteInvoiceDetail(y)},A=R(void 0),fe=()=>{A.value={id:t.value.id,quantity:0},e.visible=!0,e.title="Crear factura rectificativa",l.value=i.Rectificative},_e=async()=>{if(A.value){const y=await u.CreateRectificative(A.value);y&&y.result&&y.content?(p.add({summary:"Factura rectificativa",detail:`Creada correctament amb el número ${y.content.invoiceNumber}`,severity:"success",life:1e4}),_.back()):p.add({summary:"Factura rectificativa",detail:"Error en la creació de la factura",severity:"error",life:1e4})}};return(y,N)=>{const k=b("SplitButton"),H=b("Button"),G=b("Dialog");return I(),V(Re,null,[o("div",qt,[o("div",Ft,[n(k,{label:"Guardar",onClick:E,model:g,size:"small"})])]),v(t)?(I(),V("main",Et,[n(it,{class:"mt-3 mr-3",invoice:v(t)},null,8,["invoice"]),n(ct,{class:"mt-3",canDelete:F.value,details:v(t).salesInvoiceDetails,deliveryNotes:v(a).deliveryNotes,onDeleteDeliveryNote:ve,onDelete:ye},{header:f(()=>[o("div",xt,[Tt,o("div",null,[n(H,{size:"small",label:"Afegir albarà",onClick:P,disabled:!F.value},null,8,["disabled"]),B("    "),n(H,{size:"small",label:"Afegir linia lliure",onClick:me,disabled:!F.value},null,8,["disabled"])])])]),_:1},8,["canDelete","details","deliveryNotes"])])):C("",!0),n(G,{visible:e.visible,"onUpdate:visible":N[0]||(N[0]=be=>e.visible=be),header:e.title,closable:e.closable,modal:e.modal,style:Be({width:l.value===i.Rectificative?"20vw":l.value===i.Free?"50vw":"60vw"}),maximizable:l.value===i.FromDeliveryNote},{default:f(()=>[l.value===i.Free?(I(),O(Dt,{key:0,invoiceDetail:$,onSubmit:pe},null,8,["invoiceDetail"])):C("",!0),l.value===i.FromDeliveryNote?(I(),O(Bt,{key:1,headerVisible:!0,deliveryNotes:v(a).invoiceableDeliveryNotes,onSelected:ue},{header:f(()=>[]),_:1},8,["deliveryNotes"])):C("",!0),v(t)&&l.value===i.Rectificative&&A.value?(I(),O(Nt,{key:2,"rectificative-invoice":A.value,"maximum-quantity":v(t).baseAmount,onSubmit:_e},null,8,["rectificative-invoice","maximum-quantity"])):C("",!0)]),_:1},8,["visible","header","closable","modal","style","maximizable"])],64)}}});const Wt=Z(Ut,[["__scopeId","data-v-92d26da0"]]);export{Wt as default};
