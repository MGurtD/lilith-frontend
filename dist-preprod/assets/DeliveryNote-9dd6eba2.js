import{d as L,r as V,Y as C,h as N,a as g,q as E,w as b,e as d,I as T,i,l as f,P as F,t as w,J as R,p as K,b as Q,f as W,k as X,c as M,D as G,n as z,m as U,G as re,v as le,z as ie,V as de,W as q,F as J,x as ne,g as ue,u as ce,E as me,o as ve,a5 as fe,a0 as pe,a1 as ye,N as _e,a2 as be}from"./index-f6af8c81.js";import{u as Y}from"./customers-bf96fe43.js";import{u as Z}from"./lifecycle-b04b6c31.js";import{u as he}from"./masterData-85d8bfb5.js";import{c as Ne,a as x,F as De}from"./form-validator-ec7c2535.js";import{L as Se}from"./LinkReference-0160ecf2.js";import{u as we}from"./reference-75fb097d.js";import{u as ge}from"./plantmodel-2dcc063a.js";import{u as Ie}from"./deliveryNote-744866f1.js";import{u as Oe}from"./order-476e20f8.js";import{S as Ve}from"./index-a7d21bd0.js";import"./index-5443ddc0.js";const Ce=p=>(K("data-v-8f6728d6"),p=p(),Q(),p),Te={class:"selector-filter"},Be={class:"selector-filter-field"},ke=Ce(()=>d("label",{for:""},"Buscar",-1)),$e={class:"selector-filter-button"},xe={class:"flex align-items-center gap-2"},Ee=L({__name:"SelectorOrders",props:{orders:{},headerVisible:{type:Boolean}},emits:["selected"],setup(p,{emit:S}){const v=p,n=V([]),h=V(""),I=C(()=>{if(h.value==="")return v.orders||[];var e=[];return v.orders&&(e=v.orders.filter(s=>s.number.includes(h.value)||s.customerNumber.includes(h.value))),e}),y=()=>{if(n.value.length===0)return;const e=n.value;S("selected",e)};return(e,s)=>{const t=N("InputText"),c=N("Button"),r=N("Column"),o=N("DataTable");return g(),E(o,{class:"small-datatable",tableStyle:"min-width: 100%",scrollable:"",scrollHeight:"75vh",metaKeySelection:!1,value:I.value,selectionMode:"multiple",selection:n.value,"onUpdate:selection":s[1]||(s[1]=a=>n.value=a)},{header:b(()=>[d("header",Te,[d("div",Be,[ke,T("   "),i(t,{style:{width:"150px",height:"35px"},modelValue:h.value,"onUpdate:modelValue":s[0]||(s[0]=a=>h.value=a),size:"small"},null,8,["modelValue"])]),d("div",$e,[i(c,{onClick:y,size:"small",icon:f(F).CHECK_SQUARE},null,8,["icon"])])])]),groupheader:b(a=>[d("div",xe,[d("b",null,"Comanda "+w(a.data.number)+" - "+w(f(R)(a.data.date)),1)])]),default:b(()=>[i(r,{selectionMode:"multiple",style:{width:"3%"}}),i(r,{header:"Número",field:"number",style:{width:"10%"}}),i(r,{header:"Número client",field:"customerNumber",style:{width:"20%"}}),i(r,{header:"Data",field:"date",style:{width:"10%"}},{body:b(a=>[T(w(f(R)(a.data.date)),1)]),_:1})]),_:1},8,["value","selection"])}}});const Fe=W(Ee,[["__scopeId","data-v-8f6728d6"]]),P=p=>(K("data-v-f0037178"),p=p(),Q(),p),Re={key:0},Me={class:"three-columns"},Ue={class:"mt-1"},Le={class:"mt-1"},Ae=P(()=>d("label",{class:"block text-900 mb-2"},"Client",-1)),Ge={class:"mt-2"},qe={class:"three-columns"},ze={class:"mt-2"},Pe=P(()=>d("label",{class:"block text-900 mb-2"},"Estat",-1)),je={class:"mt-2"},He=P(()=>d("label",{class:"block text-900 mb-2"},"Data Entrega",-1)),Je={class:"mt-2"},Ke=L({__name:"FormDeliveryNote",props:{deliveryNote:{}},emits:["submit","cancel"],setup(p,{expose:S,emit:v}){const n=p,h=Y();he();const I=Z(),y=X(),e=C(()=>n.deliveryNote&&n.deliveryNote.salesInvoice?n.deliveryNote.salesInvoice.invoiceNumber:""),s=C(()=>n.deliveryNote&&n.deliveryNote.createdOn?R(n.deliveryNote.createdOn):""),t=Ne().shape({siteId:x().required("L'origen es obligatori"),customerId:x().required("El client es obligatori"),statusId:x().required("L'estat es obligatori"),exerciseId:x().required("L'exercici es obligatori")}),c=V({result:!1,errors:{}}),r=()=>{const a=new De(t);c.value=a.validate(n.deliveryNote)};return S({submitForm:async()=>{if(r(),c.value.result)n.deliveryNote.deliveryDate&&(n.deliveryNote.deliveryDate=re(n.deliveryNote.deliveryDate)),v("submit",n.deliveryNote);else{let a="";Object.entries(c.value.errors).forEach(u=>{a+=`${u[1].map(O=>O)}.   `}),y.add({severity:"warn",summary:"Formulari inválid",detail:a,life:5e3})}}}),(a,u)=>{var k;const O=N("Dropdown"),B=N("Calendar");return g(),M("div",null,[a.deliveryNote?(g(),M("form",Re,[d("section",Me,[d("div",Ue,[i(G,{type:f(le).TEXT,label:"Número Albarà",id:"salesOrderNumber",modelValue:a.deliveryNote.number,"onUpdate:modelValue":u[0]||(u[0]=_=>a.deliveryNote.number=_),disabled:""},null,8,["type","modelValue"])]),d("div",Le,[Ae,i(O,{modelValue:a.deliveryNote.customerId,"onUpdate:modelValue":u[1]||(u[1]=_=>a.deliveryNote.customerId=_),editable:"",options:f(h).customers,optionValue:"id",optionLabel:"comercialName",class:z(["w-full",{"p-invalid":c.value.errors.customerId}])},null,8,["modelValue","options","class"])]),d("div",Ge,[i(G,{modelValue:s.value,"onUpdate:modelValue":u[2]||(u[2]=_=>s.value=_),label:"Data Creació",disabled:!0},null,8,["modelValue"])])]),d("section",qe,[d("div",ze,[Pe,i(O,{modelValue:a.deliveryNote.statusId,"onUpdate:modelValue":u[3]||(u[3]=_=>a.deliveryNote.statusId=_),editable:"",options:(k=f(I).lifecycle)==null?void 0:k.statuses,optionValue:"id",optionLabel:"name",class:z(["w-full",{"p-invalid":c.value.errors.statusId}])},null,8,["modelValue","options","class"])]),d("div",je,[He,i(B,{modelValue:a.deliveryNote.deliveryDate,"onUpdate:modelValue":u[4]||(u[4]=_=>a.deliveryNote.deliveryDate=_),dateFormat:"dd/mm/yy",class:"mt-2"},null,8,["modelValue"])]),d("div",Je,[i(G,{modelValue:e.value,"onUpdate:modelValue":u[5]||(u[5]=_=>e.value=_),label:"Número de factura",disabled:!0},null,8,["modelValue"])])])])):U("",!0)])}}});const Qe=W(Ke,[["__scopeId","data-v-f0037178"]]),We=["onClick"],Xe={class:"vertical-align-middle ml-2 font-bold line-height-3"},Ye={class:"flex-right"},Ze=L({__name:"TableDeliveryNoteDetails",props:{orders:{},canDelete:{type:Boolean}},emits:["delete"],setup(p,{emit:S}){const v=p,n=C(()=>{if(!v.orders)return[];let e=[];for(let s=0;s<v.orders.length;s++){if(!v.orders[s].salesOrderDetails)continue;const t=v.orders[s];t.salesOrderDetails.forEach(c=>{e.push({salesOrderId:t.id,salesOrderNumber:t.number,salesOrderDate:t.date,customerNumber:t.customerNumber,...c})})}return e}),h=ie(),I=(e,s)=>{var c;if(!v.orders)return;const t=(c=v.orders)==null?void 0:c.find(r=>r.id===s.salesOrderId);t&&h.require({target:e.currentTarget,message:`Está segur que vol desassignar la comanda ${t.number}?`,icon:"pi pi-question-circle",acceptIcon:"pi pi-check",rejectIcon:"pi pi-times",accept:()=>{S("delete",t)}})},y=C(()=>v.orders?v.orders.reduce((e,s)=>s.salesOrderDetails?e+s.salesOrderDetails.reduce((t,c)=>t+c.amount,0):e,0):0);return(e,s)=>{const t=N("Column"),c=N("DataTable");return g(),E(c,{value:n.value,tableStyle:"min-width: 100%",class:"p-datatable-sm",rowGroupMode:"subheader",groupRowsBy:"salesOrderNumber",sortMode:"multiple",sortOrder:1,scrollable:"",scrollHeight:"60vh"},{header:b(()=>[de(e.$slots,"header")]),groupheader:b(r=>[e.canDelete?(g(),M("i",{key:0,class:z([f(F).TIMES,"grid_delete_column_button"]),onClick:o=>I(o,r.data)},null,10,We)):U("",!0),T("   "),d("span",Xe,"Comanda "+w(r.data.salesOrderNumber)+" (Núm. Client: "+w(r.data.customerNumber)+")",1)]),footer:b(()=>[d("div",Ye,[d("span",null," Total: "+w(f(q)(y.value)),1)])]),default:b(()=>[i(t,{field:"salesOrderNumber",header:"Comanda",style:{width:"5%"}}),i(t,{field:"",header:"",style:{width:"2%"}}),i(t,{field:"quantity",header:"Quantitat",style:{width:"5%"}}),i(t,{header:"Referència",field:"reference.code",sortable:"",style:{width:"15%"}},{body:b(r=>[i(Se,{id:r.data.referenceId},null,8,["id"])]),_:1}),i(t,{field:"description",header:"Descripció",style:{width:"30%"}}),i(t,{field:"unitPrice",header:"Preu un.",style:{width:"10%"}},{body:b(r=>[T(w(f(q)(r.data.unitPrice)),1)]),_:1}),i(t,{field:"amount",header:"Total",style:{width:"10%"}},{body:b(r=>[T(w(f(q)(r.data.amount)),1)]),_:1})]),_:3},8,["value"])}}}),et={class:"flex flex-wrap align-items-center justify-content-between gap-2"},tt=d("span",{class:"text-l text-900 font-bold"},"Linies de l'albarà",-1),ot="Selector de comandes",pt=L({__name:"DeliveryNote",setup(p){const S=V(),v=V(J.EDIT),n=ne(),h=ue(),I=ce(),y=Ie(),e=Oe(),s=Y(),t=ge(),c=we(),r=Z(),{deliveryNote:o}=me(y),a=[{label:"Descarregar",icon:F.FILE_WORD,command:()=>se()}],u=V(!1),O=V(""),B=C(()=>{if(!r.lifecycle||!r.lifecycle.statuses||o.value&&o.value.salesInvoiceId&&o.value.salesInvoiceId!==null)return!1;const m=r.lifecycle.statuses.find(l=>l.name==="Entregat");return m?m.id!==O.value:!1}),k=async()=>{const m=n.params.id;await y.GetById(m),O.value=y.deliveryNote.statusId,await e.GetByDeliveryNote(m),c.fetchReferencesByModule("sales"),t.fetchSites(),s.customers||s.fetchCustomers(),r.lifecycle||r.fetchOneByName("DeliveryNote");let l="";o.value&&(v.value=J.EDIT,l=`Albarà d'entrega ${o.value.number}`,o.value.deliveryDate&&(o.value.deliveryDate=R(o.value.deliveryDate))),I.setMenuItem({icon:F.BUILDING,backButtonVisible:!0,title:l})};ve(async()=>{await k()}),fe(()=>{y.deliveryNote=void 0,e.salesOrders=void 0,e.salesOrdersToDeliver=void 0});const _=()=>{var l;if(!((l=o.value)!=null&&l.createdOn))return A.add({severity:"error",summary:"Error al crear la comanda ",detail:"La data no pot estar buida",life:5e3}),!1;S.value.submitForm()},A=X(),ee=async m=>{let l=!1,D="";l=await y.Update(m.id,m),D=l?"Albarà actualitzat":"Error al actualitzar l'albarà",A.add({life:5e3,severity:l?"success":"error",summary:D}),l&&h.back()},te=async()=>{o.value&&await e.GetToDeliver(o.value.customerId),u.value=!0},oe=async m=>{for(let l=0;l<m.length;l++){const D=m[l];await y.AddOrder(o.value.id,D)}await e.GetByDeliveryNote(o.value.id),u.value=!1},ae=async m=>{await y.DeleteOrder(o.value.id,m),await e.GetByDeliveryNote(o.value.id)},se=async()=>{var l;const m=await Ve.DeliveryNote.GetReportDataById(o.value.id);if(m){const D=`AlbaraEntrega_${(l=o.value)==null?void 0:l.number}.docx`,$=await new be().Download(m,pe.DeliveryNote,D);$?ye(D,$):A.add({severity:"warn",summary:"Error",detail:"No s'ha pugut generar fulla de la comanda"})}};return(m,l)=>{const D=N("SplitButton"),j=N("Button"),$=N("Dialog");return g(),M(_e,null,[i(D,{label:"Guardar",onClick:_,model:a,size:"small",class:"grid_add_row_button"}),f(o)?(g(),E(Qe,{key:0,class:"mt-3 mb-3",ref_key:"deliveryNoteForm",ref:S,deliveryNote:f(o),onSubmit:ee},null,8,["deliveryNote"])):U("",!0),f(o)?(g(),E(Ze,{key:1,orders:f(e).salesOrders,canDelete:B.value,onDelete:ae},{header:b(()=>[d("div",et,[tt,d("div",null,[i(j,{disabled:!B.value,size:"small",label:"Afegir comanda",onClick:l[0]||(l[0]=H=>te())},null,8,["disabled"])])])]),_:1},8,["orders","canDelete"])):U("",!0),i($,{closable:!0,visible:u.value,"onUpdate:visible":l[1]||(l[1]=H=>u.value=H),header:ot,modal:!0,style:{width:"50rem"},breakpoints:{"1199px":"75vw","575px":"90vw"}},{default:b(()=>[i(Fe,{orders:f(e).salesOrdersToDeliver,onSelected:oe},null,8,["orders"])]),_:1},8,["visible"])],64)}}});export{pt as default};
