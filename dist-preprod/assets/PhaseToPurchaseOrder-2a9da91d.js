import{d as j,g as q,u as G,k as Y,a4 as z,r as c,o as K,P as g,a5 as $,h as p,q as J,w as v,l as h,a as X,e as d,i,I as Z,t as ee,T as E}from"./index-f6af8c81.js";import{u as re}from"./workorder-ba859771.js";import{S as ae}from"./suppliers.service-f3c59018.js";import{u as te}from"./reference-75fb097d.js";import{u as se}from"./masterData-85d8bfb5.js";import{u as oe}from"./order-65a50ff7.js";import{_ as ie}from"./ExerciseDatePicker.vue_vue_type_script_setup_true_lang-71eec8fe.js";import"./index-5443ddc0.js";import"./index-d3847f4f.js";const ne={class:"flex flex-wrap align-items-center justify-content-between gap-2"},ce=d("span",{class:"text-xl text-900 font-bold"},"Seleccionar fases",-1),de={class:"datatable-filter-3"},le={class:"filter-field"},ue={class:"datatable-buttons"},fe=d("div",{class:"flex flex-wrap align-items-center justify-content-between gap-2"},[d("div")],-1),ye=j({__name:"PhaseToPurchaseOrder",setup(me){const N=q(),o=G(),x=Y(),w=re(),b=new ae("/supplier"),D=te(),_=se(),V=oe(),F=z(),l=c([]),u=c({}),k=c({}),f=c(null),I=c({}),P=c([]),O=(e,r)=>{x.add({severity:"info",summary:e,detail:r,life:5e3})},L=()=>{if(o.exercisePicker.dates){const e=E(o.exercisePicker.dates[0]),r=E(o.exercisePicker.dates[1]);return[e,r]}return["",""]},m=c({}),U=(e,r)=>{H(e.id,r),r?l.value.push(e):l.value=l.value.filter((a,s)=>a.id!==e.id)},H=(e,r)=>{var s;(((s=w.workorderPhases)==null?void 0:s.findIndex(t=>t.id===e))!==-1||P.value.find(S=>S.phaseId===e))&&(m.value[e]=r)},R=async()=>{if(!o.exercisePicker.dates){O("Filtre Invàlid","Seleccioni un perióde");return}const[e,r]=L();r!=""&&await w.fetchExternalPhases(e,r)};K(async()=>{o.setMenuItem({icon:g.SHOPPING_CART,title:"Generació de comandes de compra"}),await _.fetchMasterData(),await D.fetchReferences(),T(),Q()});const M=async e=>{if(!(!e||!e.serviceReferenceId)&&!(u.value[e.id]||k.value[e.id]))try{k.value[e.id]=!0;const r=await b.getSuppliersReferenceById(e.serviceReferenceId);if(r===null){if(!f.value){const a=await b.getAll();f.value=a||[]}f.value&&(u.value[e.id]=f.value)}else u.value[e.id]=r}catch{}finally{k.value[e.id]=!1}},C=e=>{M(e)};$(()=>{const e={exercisePicker:o.exercisePicker};F.addFilter("ExternalPhasesToPurhcaseOrders","",e)});const Q=()=>{const e=F.getFilter("ExternalPhasesToPurhcaseOrders","");e&&e.exercisePicker&&(o.exercisePicker.exercise=e.exercisePicker.exercise,o.exercisePicker.dates=[new Date(e.exercisePicker.dates[0]),new Date(e.exercisePicker.dates[1])])},T=()=>{var a;const e=new Date().getFullYear().toString(),r=(a=_.exercises)==null?void 0:a.find(s=>s.name===e);r&&(o.exercisePicker.exercise=r,o.exercisePicker.dates=[new Date(o.exercisePicker.exercise.startDate),new Date(o.exercisePicker.exercise.endDate)])},A=()=>{T()},B=e=>D.getFullNameById(e)||"Desconeguda",W=async()=>{var r,a,s;if(l.value.length==0){O("OFs no seleccionades","Has de seleccionar una OF com a mínim");return}for(const t of l.value)console.log((r=t.workOrder)==null?void 0:r.id," - ",m.value[t.id]),P.value.push({workorderId:((a=t.workOrder)==null?void 0:a.id)||"",workorderDescription:t.description||"",phaseId:t.id,phaseDescription:t.description,serviceReferenceId:t.serviceReferenceId||"",serviceReferenceName:B(t.serviceReferenceId||""),supplierId:m.value[t.id],quantity:((s=t.workOrder)==null?void 0:s.plannedQuantity)||0});(await V.createFromWo(P.value)).result?(x.add({severity:"success",summary:"Creació comandes",detail:"Comandes creades correctament",life:5e3}),N.push("/purchase-orders")):x.add({severity:"error",summary:"Error creació",detail:"Error al crear la comanda",life:5e3})};return(e,r)=>{const a=p("Button"),s=p("Column"),t=p("Dropdown"),S=p("DataTable");return X(),J(S,{value:h(w).workorderPhases,class:"p-datatable-sm small-datatable",tableStyle:"min-width: 100%",scrollable:"",scrollHeight:"79vh","sort-order":1,"sort-field":"date",paginator:"",rows:25,dataKey:"id"},{header:v(()=>[d("div",ne,[ce,d("div",de,[d("div",le,[i(ie,{exercises:h(_).exercises,onRangeSelected:R},null,8,["exercises"])])]),d("div",ue,[i(a,{class:"datatable-button mr-2",icon:h(g).FILTER,rounded:"",raised:"",onClick:R},null,8,["icon"]),i(a,{class:"datatable-button mr-2",icon:h(g).FILTER_SLASH,rounded:"",raised:"",onClick:A},null,8,["icon"]),i(a,{size:"small",label:"Crear comandes",rounded:"",onClick:W})])]),fe]),default:v(()=>[i(s,{field:"workOrder.code",header:"Ordre de fabricació"}),i(s,{field:"description",header:"Fase",style:{width:"15%"}}),i(s,{header:"Referència"},{body:v(n=>[Z(ee(B(n.data.serviceReferenceId)),1)]),_:1}),i(s,{field:"workOrder.plannedQuantity",header:"Quantitat planificada"}),i(s,{header:"Proveïdor"},{body:v(n=>[i(t,{modelValue:I.value[n.data.id],"onUpdate:modelValue":y=>I.value[n.data.id]=y,options:u.value[n.data.id],placeholder:"Selecciona...",optionValue:"id",optionLabel:"comercialName",onShow:()=>C(n.data),onFocus:()=>C(n.data),onChange:y=>U(n.data,y.value),showClear:""},null,8,["modelValue","onUpdate:modelValue","options","onShow","onFocus","onChange"])]),_:1})]),_:1},8,["value"])}}});export{ye as default};
