import{d as G,j as P,k as z,u as H,P as J,E as K,r as f,Y as N,o as O,$ as W,h as k,c as v,i as r,w as c,l as u,a as m,e,t as i,aG as Y,I as $,J as V,W as q,N as Q,ab as X,aH as Z,p as ee,b as te,f as ae}from"./index-f6af8c81.js";import{s as se}from"./progressbar.esm-3f2772cf.js";import{u as oe}from"./verifactu-fb627a8b.js";const C=p=>(ee("data-v-401d2617"),p=p(),te(),p),ne={class:"verifactu-invoice-integration"},ie={class:"flex flex-wrap align-items-center justify-content-between gap-1"},le={class:"flex gap-2"},re={class:"form-label pr-1 auto-width-label"},ce={class:"datatable-buttons"},ue={class:"font-semibold"},de={class:"font-semibold"},ve={class:"text-sm text-gray-500"},me={class:"font-semibold"},fe={class:"text-center p-4"},_e=C(()=>e("i",{class:"pi pi-inbox text-4xl text-gray-400 mb-3"},null,-1)),be={class:"text-gray-500"},ge={key:0,class:"flex flex-column gap-3"},pe={class:"flex align-items-center justify-content-between"},he={class:"font-semibold"},ye={class:"text-sm text-color-secondary"},Ie={key:1,class:"flex flex-column gap-3"},De={class:"flex align-items-center justify-content-between"},xe={class:"font-semibold"},Ne=C(()=>e("span",{class:"ml-1"},"ok",-1)),we={class:"font-semibold"},Se=C(()=>e("span",{class:"ml-1"},"error",-1)),ke={class:"results-list"},Ce={class:"flex align-items-center gap-2"},$e={key:0,class:"pi pi-check text-green-500"},Ve={key:1,class:"pi pi-times text-red-500"},Te={class:"font-semibold"},je={class:"text-color-secondary"},Ae={class:"flex justify-content-end"},Be=G({__name:"InvoiceIntegration",setup(p){const{t:_}=P(),T=z(),w=oe();H().setMenuItem({title:_("verifactu.invoiceIntegration.title"),icon:J.UPLOAD});const{pendingInvoices:j,loading:A}=K(w),h=f(!1),y=f(!1),I=f(!1),d=f([]),l=f({total:0,current:0,currentInvoiceNumber:void 0}),B=N(()=>l.value.total>0?Math.floor(l.value.current/l.value.total*100):0),E=N(()=>d.value.filter(t=>t.status==="success").length),L=N(()=>d.value.filter(t=>t.status==="error").length),b=f({limitDate:new Date}),D=N(()=>j.value||[]),M=(t,n)=>(t||"").localeCompare(n||"",void 0,{numeric:!0,sensitivity:"base"}),S=()=>!!b.value.limitDate,U=()=>{S()&&x()},x=async()=>{if(S())try{await w.GetPendingIntegration(b.value.limitDate)}catch(t){console.error("Error loading invoices:",t),T.add({severity:"error",summary:_("common.error"),detail:_("verifactu.invoiceIntegration.messages.loadError"),life:5e3})}},F=async()=>{var n;if(!D.value.length)return;h.value=!0,d.value=[],y.value=!0,I.value=!0;const t=[...D.value].sort((o,s)=>M(String(o.invoiceNumber??""),String(s.invoiceNumber??"")));l.value.total=t.length,l.value.current=0,l.value.currentInvoiceNumber=void 0;try{for(const o of t){l.value.currentInvoiceNumber=String(o.invoiceNumber??"");try{const s=await w.SendToVerifactu(o.id);if(s!=null&&s.result)d.value.push({id:o.id,invoiceNumber:String(o.invoiceNumber??""),status:"success"}),l.value.current+=1;else{const g=((n=s==null?void 0:s.errors)==null?void 0:n.join(", "))||"Integration failed";d.value.push({id:o.id,invoiceNumber:String(o.invoiceNumber??""),status:"error",message:g});break}}catch(s){const g=(s==null?void 0:s.message)||"Unexpected error";d.value.push({id:o.id,invoiceNumber:String(o.invoiceNumber??""),status:"error",message:g});break}}}catch(o){console.error("Error integrating invoices:",o)}finally{I.value=!1,h.value=!1,await x()}},R=t=>{var o;const n=t==null?void 0:t.salesInvoiceDueDates;if(Array.isArray(n)&&n.length>0){const s=(o=n[n.length-1])==null?void 0:o.dueDate;if(s)return V(s)}return"-"};return O(()=>{x()}),W(()=>b.value.limitDate,()=>{S()&&x()}),(t,n)=>{const o=k("Button"),s=k("Column"),g=k("DataTable");return m(),v("div",ne,[r(g,{value:D.value,loading:u(A),dataKey:"id",responsiveLayout:"scroll"},{header:c(()=>[e("div",ie,[e("div",le,[e("label",re,i(t.$t("verifactu.invoiceIntegration.filters.toDate")),1),r(u(Y),{modelValue:b.value.limitDate,"onUpdate:modelValue":n[0]||(n[0]=a=>b.value.limitDate=a),dateFormat:"dd/mm/yy",placeholder:t.$t("verifactu.invoiceIntegration.filters.selectToDate"),showIcon:"",class:"date-input",onDateSelect:U},null,8,["modelValue","placeholder"])]),e("div",ce,[r(o,{label:t.$t("verifactu.invoiceIntegration.actions.integrateSelected"),size:"small",icon:"pi pi-upload",onClick:F,disabled:!D.value.length||h.value,loading:h.value,class:"filter-button"},null,8,["label","disabled","loading"])])])]),empty:c(()=>[e("div",fe,[_e,e("p",be,i(t.$t("verifactu.invoiceIntegration.table.empty")),1)])]),default:c(()=>[r(s,{field:"invoiceNumber",header:t.$t("verifactu.invoiceIntegration.table.columns.number")},{body:c(a=>[e("span",ue,i(a.data.invoiceNumber),1)]),_:1},8,["header"]),r(s,{field:"invoiceDate",header:t.$t("verifactu.invoiceIntegration.table.columns.date")},{body:c(a=>[$(i(u(V)(a.data.invoiceDate)),1)]),_:1},8,["header"]),r(s,{field:"dueDate",header:t.$t("verifactu.invoiceIntegration.table.columns.dueDate")},{body:c(a=>[$(i(R(a.data)),1)]),_:1},8,["header"]),r(s,{field:"customer.fiscalName",header:t.$t("verifactu.invoiceIntegration.table.columns.customer")},{body:c(a=>[e("div",null,[e("div",de,i(a.data.customerComercialName||a.data.customerTaxName),1),e("div",ve,i(a.data.customerVatNumber),1)])]),_:1},8,["header"]),r(s,{field:"totalAmount",header:t.$t("verifactu.invoiceIntegration.table.columns.amount")},{body:c(a=>[e("span",me,i(u(q)(a.data.netAmount+a.data.taxAmount)),1)]),_:1},8,["header"])]),_:1},8,["value","loading"]),r(u(Z),{visible:y.value,"onUpdate:visible":n[2]||(n[2]=a=>y.value=a),modal:!0,closable:!I.value,draggable:!1,style:{width:"40rem"},header:u(_)("verifactu.invoiceIntegration.title")},{default:c(()=>[I.value?(m(),v("div",ge,[e("div",pe,[e("span",he,i(l.value.current)+" / "+i(l.value.total),1),e("span",ye,i(l.value.currentInvoiceNumber||"-"),1)]),r(u(se),{value:B.value},null,8,["value"])])):(m(),v("div",Ie,[e("div",De,[e("div",null,[e("span",xe,i(E.value),1),Ne]),e("div",null,[e("span",we,i(L.value),1),Se])]),e("div",ke,[(m(!0),v(Q,null,X(d.value,a=>(m(),v("div",{key:a.id,class:"result-row flex align-items-center justify-content-between py-2 px-2 border-round surface-border border-1 mb-2"},[e("div",Ce,[a.status==="success"?(m(),v("i",$e)):(m(),v("i",Ve)),e("span",Te,i(a.invoiceNumber),1)]),e("small",je,i(a.message||""),1)]))),128))]),e("div",Ae,[r(o,{label:u(_)("common.close")||"Close",onClick:n[1]||(n[1]=a=>y.value=!1)},null,8,["label"])])]))]),_:1},8,["visible","closable","header"])])}}});const Fe=ae(Be,[["__scopeId","data-v-401d2617"]]);export{Fe as default};
